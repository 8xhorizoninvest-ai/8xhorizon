<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prop Farm Pro Â· Investor Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --ink:#0d1117;
  --ink2:#1c2333;
  --ink3:#2d3748;
  --paper:#f8f6f1;
  --paper2:#f0ede6;
  --paper3:#e8e4da;
  --gold:#c9a84c;
  --gold2:#e8c96a;
  --gold-glow:rgba(201,168,76,0.2);
  --green:#1a8f5a;
  --green2:#22b573;
  --green-glow:rgba(26,143,90,0.15);
  --red:#c0392b;
  --red-glow:rgba(192,57,43,0.15);
  --muted:#8a8070;
  --border:rgba(13,17,23,0.1);
  --border2:rgba(13,17,23,0.06);
  --radius:12px;
  --radius-lg:20px;
  --shadow:0 2px 20px rgba(0,0,0,0.08);
  --shadow-lg:0 8px 48px rgba(0,0,0,0.15);
}

body{font-family:'DM Sans',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;-webkit-font-smoothing:antialiased}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;min-height:100vh}
.screen.active{display:flex}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#loginScreen{
  background:var(--ink);
  align-items:center;justify-content:center;
  position:relative;overflow:hidden;
}
#loginScreen::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 70% 60% at 30% 40%,rgba(201,168,76,0.12) 0%,transparent 60%),
             radial-gradient(ellipse 50% 50% at 75% 70%,rgba(26,143,90,0.08) 0%,transparent 55%);
}
.login-grid{
  position:absolute;inset:0;
  background-image:linear-gradient(rgba(201,168,76,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(201,168,76,0.04) 1px,transparent 1px);
  background-size:60px 60px;
}
.login-box{
  position:relative;z-index:2;
  width:420px;max-width:95vw;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(201,168,76,0.2);
  border-radius:24px;
  padding:3rem;
  backdrop-filter:blur(20px);
  box-shadow:0 0 80px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.06);
}
.login-badge{
  display:inline-flex;align-items:center;gap:0.5rem;
  background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.25);
  color:var(--gold2);font-size:0.72rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;
  padding:0.3rem 0.75rem;border-radius:20px;margin-bottom:1.75rem;
}
.login-title{
  font-family:'Playfair Display',serif;
  font-size:2.2rem;font-weight:700;line-height:1.15;
  color:#fff;margin-bottom:0.5rem;
}
.login-title span{color:var(--gold2);}
.login-sub{color:rgba(255,255,255,0.45);font-size:0.9rem;margin-bottom:2.25rem;line-height:1.5;}
.google-btn{
  width:100%;padding:0.9rem 1.25rem;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:var(--radius);
  color:#fff;font-family:'DM Sans',sans-serif;font-size:0.9375rem;font-weight:500;
  cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:0.75rem;
  margin-bottom:0.875rem;
}
.google-btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2);transform:translateY(-1px);}
.google-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.google-logo{width:20px;height:20px;flex-shrink:0;}
.auth-msg{font-size:0.82rem;margin-top:0.75rem;padding:0.625rem 0.875rem;border-radius:8px;display:none;}
.auth-msg.error{background:rgba(192,57,43,0.15);color:#ff8a80;border:1px solid rgba(192,57,43,0.3);}
.auth-msg.show{display:block;}
.login-footer{margin-top:1.75rem;text-align:center;color:rgba(255,255,255,0.25);font-size:0.8rem;}

/* â”€â”€ LOADING â”€â”€ */
#loadingScreen{background:var(--paper);align-items:center;justify-content:center;flex-direction:column;gap:1rem;}
.loader{width:40px;height:40px;border:3px solid var(--paper3);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{color:var(--muted);font-size:0.9rem;font-weight:500;}

/* â”€â”€ PORTAL â”€â”€ */
#portalScreen{background:var(--paper);flex-direction:column;}
#adminScreen{background:var(--paper);flex-direction:column;}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  background:#fff;border-bottom:1px solid var(--border);
  padding:0 2rem;height:64px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
  box-shadow:0 1px 0 var(--border);
}
.topbar-brand{display:flex;align-items:center;gap:0.75rem;}
.topbar-brand .em{font-size:1.4rem;}
.topbar-brand .brand-name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--ink);}
.topbar-brand .brand-sub{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-top:1px;}
.topbar-right{display:flex;align-items:center;gap:0.875rem;}
.topbar-user{display:flex;align-items:center;gap:0.625rem;}
.user-pic{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--green));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;color:#fff;overflow:hidden;flex-shrink:0;}
.user-pic img{width:100%;height:100%;object-fit:cover;}
.user-name-sm{font-size:0.875rem;font-weight:500;color:var(--ink);}
.role-pill{padding:0.2rem 0.6rem;border-radius:20px;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;}
.pill-investor{background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.25);}
.pill-admin{background:rgba(26,143,90,0.1);color:var(--green);border:1px solid rgba(26,143,90,0.2);}
.btn-sm{padding:0.4rem 0.875rem;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.15s;border:1px solid var(--border);background:#fff;color:var(--ink);}
.btn-sm:hover{background:var(--paper2);border-color:var(--border);}

/* â”€â”€ MAIN CONTENT â”€â”€ */
.main{flex:1;padding:2.5rem 2rem;max-width:1000px;margin:0 auto;width:100%;}

/* â”€â”€ INVESTOR PORTAL â”€â”€ */
.portal-hero{
  background:linear-gradient(135deg,var(--ink) 0%,var(--ink2) 100%);
  border-radius:var(--radius-lg);padding:2.5rem;margin-bottom:2rem;
  position:relative;overflow:hidden;
}
.portal-hero::before{
  content:'';position:absolute;top:-40px;right:-40px;
  width:280px;height:280px;
  background:radial-gradient(circle,rgba(201,168,76,0.15) 0%,transparent 70%);
}
.portal-hero::after{
  content:'ğŸŒ¾';position:absolute;bottom:-10px;right:2rem;
  font-size:8rem;opacity:0.06;line-height:1;
}
.portal-hero-label{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--gold2);font-weight:600;margin-bottom:0.5rem;}
.portal-hero-name{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:#fff;margin-bottom:0.25rem;}
.portal-hero-sub{color:rgba(255,255,255,0.4);font-size:0.9rem;}
.portal-hero-right{position:absolute;right:2.5rem;top:50%;transform:translateY(-50%);text-align:right;}
.big-value{font-family:'DM Mono',monospace;font-size:2.8rem;font-weight:500;color:#fff;line-height:1;}
.big-value-label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.4);margin-top:0.4rem;}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.progress-section{background:#fff;border-radius:var(--radius-lg);border:1px solid var(--border);padding:2rem;margin-bottom:1.5rem;}
.progress-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;}
.progress-title{font-size:1rem;font-weight:600;color:var(--ink);}
.progress-pct{font-family:'DM Mono',monospace;font-size:1.5rem;font-weight:500;color:var(--gold);}
.prog-track{height:14px;background:var(--paper3);border-radius:7px;overflow:hidden;margin-bottom:0.75rem;position:relative;}
.prog-fill{height:100%;border-radius:7px;background:linear-gradient(90deg,#c9a84c,#e8c96a);transition:width 1.8s cubic-bezier(0.4,0,0.2,1);position:relative;}
.prog-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent);animation:shim 2.5s ease infinite;}
@keyframes shim{0%,100%{transform:translateX(-100%)}50%{transform:translateX(100%)}}
.prog-labels{display:flex;justify-content:space-between;font-size:0.78rem;color:var(--muted);}
.milestone-dots{display:flex;gap:0.5rem;margin-top:1.25rem;flex-wrap:wrap;}
.mdot{display:flex;align-items:center;gap:0.35rem;font-size:0.78rem;font-weight:500;padding:0.3rem 0.7rem;border-radius:20px;transition:all 0.2s;}
.mdot.done{background:rgba(26,143,90,0.1);color:var(--green);border:1px solid rgba(26,143,90,0.2);}
.mdot.active{background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.25);}
.mdot.upcoming{background:var(--paper2);color:var(--muted);border:1px solid var(--border2);}

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;transition:all 0.2s;}
.stat-card:hover{box-shadow:var(--shadow);transform:translateY(-2px);}
.stat-label{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);font-weight:600;margin-bottom:0.5rem;}
.stat-value{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;color:var(--ink);line-height:1;}
.stat-sub{font-size:0.78rem;color:var(--muted);margin-top:0.3rem;}
.stat-value.green{color:var(--green);}
.stat-value.gold{color:var(--gold);}
.stat-value.purple{color:#7c5cbf;}

/* â”€â”€ MILESTONE TABLE â”€â”€ */
.section-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600;color:var(--ink);margin-bottom:1rem;}
.table-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;padding:0.75rem 1.25rem;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);background:var(--paper2);border-bottom:1px solid var(--border);}
td{padding:0.9rem 1.25rem;border-bottom:1px solid var(--border2);font-size:0.9rem;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--paper2);}
.status-chip{display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.625rem;border-radius:20px;font-size:0.72rem;font-weight:600;}
.chip-done{background:rgba(26,143,90,0.1);color:var(--green);}
.chip-active{background:rgba(201,168,76,0.12);color:var(--gold);}
.chip-upcoming{background:var(--paper3);color:var(--muted);}

/* â”€â”€ NOT REGISTERED â”€â”€ */
.empty-state{text-align:center;padding:5rem 2rem;background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);}
.empty-icon{font-size:3.5rem;margin-bottom:1rem;}
.empty-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:600;color:var(--ink);margin-bottom:0.5rem;}
.empty-sub{color:var(--muted);font-size:0.9rem;max-width:360px;margin:0 auto;}

/* â”€â”€ ADMIN SCREEN â”€â”€ */
.admin-tabs{display:flex;gap:0.25rem;padding:0 2rem;border-bottom:1px solid var(--border);background:#fff;}
.atab{padding:0.875rem 1.25rem;border:none;background:none;font-family:'DM Sans',sans-serif;font-size:0.875rem;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s;margin-bottom:-1px;}
.atab:hover{color:var(--ink);}
.atab.active{color:var(--ink);border-bottom-color:var(--gold);font-weight:600;}
.admin-page{display:none;padding:2rem;max-width:1100px;margin:0 auto;width:100%;}
.admin-page.active{display:block;}

/* â”€â”€ ADMIN OVERVIEW â”€â”€ */
.admin-hero{background:linear-gradient(135deg,var(--ink),var(--ink2));border-radius:var(--radius-lg);padding:2rem;margin-bottom:1.5rem;}
.admin-hero-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:#fff;margin-bottom:0.25rem;}
.admin-hero-sub{color:rgba(255,255,255,0.45);font-size:0.875rem;}
.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-top:1.5rem;}
.admin-stat{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:1rem;}
.admin-stat-val{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;color:#fff;line-height:1;}
.admin-stat-val.gold{color:var(--gold2);}
.admin-stat-val.green{color:#69d9a8;}
.admin-stat-lbl{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.4);margin-top:0.35rem;font-weight:600;}

/* â”€â”€ FORM CARD â”€â”€ */
.form-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.75rem;margin-bottom:1.5rem;}
.form-card-title{font-weight:700;font-size:1rem;color:var(--ink);margin-bottom:0.25rem;}
.form-card-sub{font-size:0.82rem;color:var(--muted);margin-bottom:1.5rem;}
.lbl{display:block;font-size:0.78rem;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:0.4rem;}
.inp{width:100%;padding:0.75rem 1rem;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);color:var(--ink);font-family:'DM Sans',sans-serif;font-size:0.9375rem;transition:all 0.2s;}
.inp:focus{outline:none;border-color:var(--gold);background:#fff;box-shadow:0 0 0 3px rgba(201,168,76,0.1);}
.inp::placeholder{color:var(--muted);}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;}
.form-group{margin-bottom:1rem;}
.btn-primary{
  padding:0.8rem 1.5rem;background:var(--ink);color:#fff;
  border:none;border-radius:var(--radius);
  font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;
  transition:all 0.2s;display:inline-flex;align-items:center;gap:0.5rem;
}
.btn-primary:hover{background:var(--ink2);transform:translateY(-1px);}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.btn-gold{background:var(--gold);color:var(--ink);}
.btn-gold:hover{background:var(--gold2);}
.btn-danger-sm{padding:0.3rem 0.7rem;background:none;border:1px solid rgba(192,57,43,0.3);color:var(--red);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;transition:all 0.15s;}
.btn-danger-sm:hover{background:var(--red-glow);}

/* â”€â”€ PROFIT INPUT â”€â”€ */
.profit-input-row{display:flex;gap:0.75rem;align-items:flex-end;}
.profit-input-row .form-group{flex:1;margin-bottom:0;}
.profit-display{text-align:center;margin-top:1.25rem;padding:1rem;background:var(--paper);border-radius:var(--radius);border:1px solid var(--border);}
.profit-display-val{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;color:var(--green);}
.profit-display-lbl{font-size:0.78rem;color:var(--muted);margin-top:0.2rem;}

/* â”€â”€ INVESTOR TABLE â”€â”€ */
.inv-table-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:1.5rem;}
.inv-table-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.inv-table-title{font-weight:700;font-size:1rem;color:var(--ink);}

/* â”€â”€ TRADE LOG â”€â”€ */
.trade-filters{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.filter-chip{padding:0.35rem 0.875rem;background:var(--paper2);border:1px solid var(--border);border-radius:20px;font-size:0.78rem;font-weight:600;cursor:pointer;color:var(--muted);transition:all 0.15s;}
.filter-chip:hover{border-color:var(--gold);color:var(--ink);}
.filter-chip.active{background:var(--ink);color:#fff;border-color:var(--ink);}

/* â”€â”€ ALERT â”€â”€ */
.alert-bar{padding:0.875rem 1.25rem;border-radius:var(--radius);font-size:0.875rem;font-weight:500;margin-bottom:1.25rem;display:none;}
.alert-bar.show{display:flex;align-items:center;gap:0.625rem;}
.alert-bar.success{background:var(--green-glow);border:1px solid rgba(26,143,90,0.25);color:var(--green);}
.alert-bar.error{background:var(--red-glow);border:1px solid rgba(192,57,43,0.25);color:var(--red);}
.alert-bar.info{background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.25);color:var(--gold);}

@media(max-width:640px){
  .topbar{padding:0 1rem;}
  .main,.admin-page{padding:1.25rem 1rem;}
  .portal-hero{padding:1.5rem;}
  .portal-hero-right{position:static;transform:none;text-align:left;margin-top:1.25rem;}
  .big-value{font-size:2rem;}
  .admin-tabs{padding:0 1rem;overflow-x:auto;}
}
</style>
</head>
<body>

<!-- â•â• LOGIN â•â• -->
<div class="screen active" id="loginScreen">
  <div class="login-grid"></div>
  <div class="login-box">
    <div class="login-badge">ğŸŒ¾ Prop Farm Pro</div>
    <h1 class="login-title">Investor<br><span>Portal</span></h1>
    <p class="login-sub">Sign in to track your investment progress and milestones.</p>

    <button class="google-btn" id="googleBtn" onclick="signInGoogle()">
      <svg class="google-logo" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <div class="auth-msg" id="authMsg"></div>

    <div class="login-footer">Secure access Â· Prop Farm Pro Â© 2025</div>
  </div>
</div>

<!-- â•â• LOADING â•â• -->
<div class="screen" id="loadingScreen">
  <div class="loader"></div>
  <span class="loader-text">Loading your portalâ€¦</span>
</div>

<!-- â•â• INVESTOR PORTAL â•â• -->
<div class="screen" id="portalScreen" style="flex-direction:column;">
  <div class="topbar">
    <div class="topbar-brand">
      <span class="em">ğŸŒ¾</span>
      <div><div class="brand-name">Prop Farm Pro</div><div class="brand-sub">Investor Portal</div></div>
    </div>
    <div class="topbar-right">
      <div class="topbar-user">
        <div class="user-pic" id="investorAvatar">â€”</div>
        <span class="user-name-sm" id="investorName"></span>
        <span class="role-pill pill-investor">ğŸ’¼ Investor</span>
      </div>
      <button class="btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="main">
    <div class="alert-bar" id="portalAlert"></div>

    <!-- Not registered -->
    <div class="empty-state" id="portalEmpty" style="display:none;">
      <div class="empty-icon">ğŸ’¼</div>
      <div class="empty-title">Not Yet Registered</div>
      <div class="empty-sub">You haven't been added to the investor portal yet. Contact your account manager to get registered.</div>
    </div>

    <!-- Investor content -->
    <div id="portalContent" style="display:none;">
      <!-- Hero -->
      <div class="portal-hero">
        <div class="portal-hero-label">Your Investment Account</div>
        <div class="portal-hero-name" id="phName">â€”</div>
        <div class="portal-hero-sub" id="phEmail">â€”</div>
        <div class="portal-hero-right">
          <div class="big-value" id="phValue">$â€”</div>
          <div class="big-value-label">Current Account Value</div>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-section">
        <div class="progress-header">
          <div>
            <div class="progress-title">Progress to $800 Payout</div>
            <div style="font-size:0.82rem;color:var(--muted);margin-top:0.2rem;">Target reached at $4,600 master profit</div>
          </div>
          <div class="progress-pct" id="phPct">0%</div>
        </div>
        <div class="prog-track"><div class="prog-fill" id="phBar" style="width:0%"></div></div>
        <div class="prog-labels"><span id="phValueSmall">$â€”</span><span style="color:var(--gold);font-weight:600;">$800 Target</span></div>
        <div class="milestone-dots" id="phDots"></div>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-label">ğŸ“ Entry Point</div><div class="stat-value" id="phEntry">$â€”</div><div class="stat-sub">Your starting investment</div></div>
        <div class="stat-card"><div class="stat-label">ğŸ’° Profit Share</div><div class="stat-value green" id="phProfit">$â€”</div><div class="stat-sub">Allocated to you</div></div>
        <div class="stat-card"><div class="stat-label">ğŸ¯ Target Value</div><div class="stat-value gold">$800</div><div class="stat-sub">At $4,600 master profit</div></div>
        <div class="stat-card"><div class="stat-label">ğŸ“Š Multiplier</div><div class="stat-value purple" id="phMult">â€”</div><div class="stat-sub">Personal scaling factor</div></div>
      </div>

      <!-- Milestone table -->
      <div class="section-title">Milestone Log</div>
      <div class="table-card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Status</th><th>Your Value</th><th>Gain from Entry</th><th>Note</th></tr></thead>
            <tbody id="phMilestones"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• ADMIN SCREEN â•â• -->
<div class="screen" id="adminScreen" style="flex-direction:column;">
  <div class="topbar">
    <div class="topbar-brand">
      <span class="em">ğŸŒ¾</span>
      <div><div class="brand-name">Prop Farm Pro</div><div class="brand-sub">Admin Â· Investor Portal</div></div>
    </div>
    <div class="topbar-right">
      <div class="topbar-user">
        <div class="user-pic" id="adminAvatar">â€”</div>
        <span class="user-name-sm" id="adminName"></span>
        <span class="role-pill pill-admin">âš¡ Admin</span>
      </div>
      <button class="btn-sm" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <div class="admin-tabs">
    <button class="atab active" onclick="switchTab('overview')">Overview</button>
    <button class="atab" onclick="switchTab('investors')">Investors</button>
    <button class="atab" onclick="switchTab('trades')">Trade Log</button>
  </div>

  <!-- OVERVIEW TAB -->
  <div class="admin-page active" id="tab-overview">
    <div class="alert-bar" id="adminAlert"></div>
    <div class="admin-hero">
      <div class="admin-hero-title">Mirror Trading Control</div>
      <div class="admin-hero-sub">Update master profit Â· All investor display values sync automatically</div>
      <div class="admin-stats" id="adminStatsRow">
        <div class="admin-stat"><div class="admin-stat-val gold" id="asMasterProfit">$0</div><div class="admin-stat-lbl">Master Profit</div></div>
        <div class="admin-stat"><div class="admin-stat-val" id="asMasterBal">$50,000</div><div class="admin-stat-lbl">Master Balance</div></div>
        <div class="admin-stat"><div class="admin-stat-val green" id="asInvCount">0</div><div class="admin-stat-lbl">Active Investors</div></div>
        <div class="admin-stat"><div class="admin-stat-val gold" id="asGoalPct">0%</div><div class="admin-stat-lbl">Progress to Goal</div></div>
      </div>
    </div>

    <!-- Progress -->
    <div class="form-card">
      <div class="form-card-title">Master Account Progress</div>
      <div class="form-card-sub">$50,000 â†’ $54,600 target</div>
      <div class="prog-track" style="height:10px;margin-bottom:0.5rem;"><div class="prog-fill" id="adminBar" style="width:0%"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:0.78rem;color:var(--muted);margin-bottom:1.5rem;">
        <span id="adminBarLabel">$0 profit</span><span style="color:var(--gold);font-weight:600;">$4,600 goal</span>
      </div>
      <div class="profit-input-row">
        <div class="form-group">
          <label class="lbl">Current Master Profit ($)</label>
          <input type="number" class="inp" id="profitInput" placeholder="e.g. 2300" step="50" min="0" style="font-family:'DM Mono',monospace;">
        </div>
        <button class="btn-primary btn-gold" onclick="updateProfit()">âš¡ Update All Investors</button>
      </div>
      <div class="profit-display">
        <div class="profit-display-val" id="profitDisplayVal">$0.00</div>
        <div class="profit-display-lbl">Current master profit saved</div>
      </div>
    </div>
  </div>

  <!-- INVESTORS TAB -->
  <div class="admin-page" id="tab-investors">
    <div class="alert-bar" id="invAlert"></div>
    <div class="inv-table-card">
      <div class="inv-table-header">
        <div class="inv-table-title">Investor Accounts</div>
        <span style="font-size:0.8rem;color:var(--muted);">Each investor sees only their own scaled value</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Entry</th><th>Multiplier</th><th>Display Value</th><th>% to $800</th><th>Actions</th></tr></thead>
          <tbody id="invTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Add investor -->
    <div class="form-card">
      <div class="form-card-title">â• Register New Investor</div>
      <div class="form-card-sub">Add their email and entry point. They log in with Google to see their portal.</div>
      <div class="form-row">
        <div class="form-group"><label class="lbl">Name / Label</label><input type="text" class="inp" id="newInvName" placeholder="e.g. Investor A"></div>
        <div class="form-group"><label class="lbl">Email Address</label><input type="email" class="inp" id="newInvEmail" placeholder="investor@email.com"></div>
        <div class="form-group"><label class="lbl">Entry Point ($)</label><input type="number" class="inp" id="newInvEntry" placeholder="e.g. 115" min="1" style="font-family:'DM Mono',monospace;"></div>
      </div>
      <button class="btn-primary" onclick="addInvestor()">Add Investor</button>
    </div>
  </div>

  <!-- TRADES TAB -->
  <div class="admin-page" id="tab-trades">
    <div class="alert-bar" id="tradeAlert"></div>

    <!-- Log a trade -->
    <div class="form-card">
      <div class="form-card-title">ğŸ“ Log New Trade</div>
      <div class="form-card-sub">Trades are stored on the master account and used to calculate master profit.</div>
      <div class="form-row">
        <div class="form-group"><label class="lbl">Date</label><input type="date" class="inp" id="tradeDate"></div>
        <div class="form-group"><label class="lbl">Instrument / Market</label><input type="text" class="inp" id="tradeMarket" placeholder="e.g. NQ, ES, MNQ"></div>
        <div class="form-group"><label class="lbl">Direction</label>
          <select class="inp" id="tradeDir"><option value="Long">Long</option><option value="Short">Short</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="lbl">P&L ($)</label><input type="number" class="inp" id="tradePnL" placeholder="e.g. 250 or -150" step="0.01" style="font-family:'DM Mono',monospace;"></div>
        <div class="form-group"><label class="lbl">Contracts</label><input type="number" class="inp" id="tradeContracts" placeholder="1" min="1"></div>
        <div class="form-group"><label class="lbl">Notes (optional)</label><input type="text" class="inp" id="tradeNotes" placeholder="Quick note..."></div>
      </div>
      <button class="btn-primary" id="tradeSubmitBtn" onclick="logTrade()">Log Trade</button>
    </div>

    <!-- Recent trades -->
    <div class="section-title">Recent Trades</div>
    <div class="trade-filters">
      <span class="filter-chip active" onclick="filterTrades('all',this)">All</span>
      <span class="filter-chip" onclick="filterTrades('win',this)">Wins âœ…</span>
      <span class="filter-chip" onclick="filterTrades('loss',this)">Losses âŒ</span>
    </div>
    <div class="table-card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Date</th><th>Market</th><th>Direction</th><th>Contracts</th><th>P&L</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="tradeTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL  = 'https://gmhmtdgultwlleskvpao.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtaG10ZGd1bHR3bGxlc2t2cGFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzgyOTIsImV4cCI6MjA4NzExNDI5Mn0.D6MyCDPvW05CiVm6DOa0YX1z-lwmTRWDC9a8-gg9gA0';
const ADMIN_EMAIL = '8xhorizon.invest@gmail.com';
const IP_GOAL   = 4600;
const IP_TARGET = 800;
const IP_START  = 50000;

let sb, user, profile;
let masterProfit = 0, investors = [], allTrades = [], tradeFilter = 'all';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = n => '$' + parseFloat(n || 0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
const mult = entry => (IP_TARGET - entry) / IP_GOAL;
const dv   = (entry, mp) => entry + mp * mult(entry);
const pct  = (entry, mp) => Math.min(dv(entry,mp) / IP_TARGET * 100, 100);

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

function showAlert(elId, msg, type='success') {
  const el = document.getElementById(elId);
  if (!el) return;
  el.textContent = (type==='success'?'âœ“ ':type==='error'?'âœ• ':'') + msg;
  el.className = 'alert-bar show ' + type;
  setTimeout(() => el.classList.remove('show'), 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function signInGoogle() {
  const btn = document.getElementById('googleBtn');
  btn.disabled = true; btn.textContent = 'Redirectingâ€¦';
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.href.split('?')[0].split('#')[0] }
  });
  if (error) { showAuthMsg(error.message, 'error'); btn.disabled = false; btn.textContent = 'Continue with Google'; }
}

function showAuthMsg(msg, type) {
  const el = document.getElementById('authMsg');
  el.textContent = msg; el.className = 'auth-msg show ' + type;
}

async function doLogout() {
  await sb.auth.signOut();
  showScreen('loginScreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTE USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function routeUser(session) {
  showScreen('loadingScreen');
  user = session.user;

  // Load profile
  try {
    const { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
    profile = data;
  } catch(_) {}

  const isAdmin = user.email === ADMIN_EMAIL || profile?.role === 'admin';

  if (isAdmin) {
    await loadAdminData();
    renderAdmin();
    showScreen('adminScreen');
  } else {
    await loadInvestorData();
    renderInvestor();
    showScreen('portalScreen');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadState() {
  try {
    const { data } = await sb.from('investor_portal_config').select('value').eq('id','master_state').single();
    if (data) masterProfit = parseFloat(data.value?.profit || 0);
  } catch(_) { masterProfit = parseFloat(localStorage.getItem('pfp_master_profit')||'0'); }

  try {
    const { data } = await sb.from('investor_portal_investors').select('*').order('created_at',{ascending:true});
    if (data) { investors = data; return; }
  } catch(_) {}
  try { investors = JSON.parse(localStorage.getItem('pfp_investors')||'[]'); } catch(_) { investors=[]; }
}

async function loadInvestorData() { await loadState(); }

async function loadAdminData() {
  await loadState();
  try {
    const { data } = await sb.from('investor_trades').select('*').order('trade_date',{ascending:false}).limit(200);
    allTrades = data || [];
  } catch(_) { allTrades=[]; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVESTOR RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInvestor() {
  const name = profile?.username || profile?.display_name || user?.user_metadata?.full_name || user.email.split('@')[0];
  const photo = user?.user_metadata?.avatar_url;
  const av = document.getElementById('investorAvatar');
  if (photo) av.innerHTML = `<img src="${photo}" alt="">`;
  else av.textContent = name.substring(0,2).toUpperCase();
  document.getElementById('investorName').textContent = name;

  const myEmail = user.email || '';
  const myRec = investors.find(i => i.email?.toLowerCase() === myEmail.toLowerCase());

  if (!myRec) { document.getElementById('portalEmpty').style.display='block'; return; }

  document.getElementById('portalContent').style.display='block';
  const entry = parseFloat(myRec.entry_point) || 115;
  const m     = mult(entry);
  const val   = dv(entry, masterProfit);
  const share = masterProfit * m;
  const gpct  = pct(entry, masterProfit);
  const jpct  = Math.min((val - entry)/(IP_TARGET - entry)*100, 100);
  const atGoal = val >= IP_TARGET;

  document.getElementById('phName').textContent = myRec.name || name;
  document.getElementById('phEmail').textContent = myRec.email;
  document.getElementById('phValue').textContent = fmt(val);
  document.getElementById('phPct').textContent   = gpct.toFixed(1)+'%';
  document.getElementById('phValueSmall').textContent = fmt(val);
  document.getElementById('phEntry').textContent = fmt(entry);
  document.getElementById('phProfit').textContent = fmt(share);
  document.getElementById('phMult').textContent  = m.toFixed(4)+'x';

  setTimeout(()=>{document.getElementById('phBar').style.width = gpct.toFixed(1)+'%';},200);

  // Milestone dots
  const milestones = [{l:'ğŸŒ± Start',p:0},{l:'ğŸ“ˆ 25%',p:25},{l:'ğŸŒ¿ 50%',p:50},{l:'ğŸ”¥ 75%',p:75},{l:'ğŸ† Goal',p:100}];
  document.getElementById('phDots').innerHTML = milestones.map(md => {
    const cls = jpct >= md.p ? (jpct >= md.p && md.p === Math.max(...milestones.filter(x=>jpct>=x.p).map(x=>x.p)) ? 'active' : 'done') : 'upcoming';
    return `<span class="mdot ${cls}">${md.l}${cls==='done'?' âœ“':''}</span>`;
  }).join('');

  // Milestone table â€” no master profit exposed
  const mdata = [
    {mp:0,note:'Starting position'},{mp:500,note:'Early growth'},{mp:1000,note:'Building momentum'},
    {mp:1500,note:'33% milestone'},{mp:2000,note:'Halfway checkpoint'},{mp:2500,note:'Strong progress'},
    {mp:3000,note:'65% milestone'},{mp:3500,note:'Final stretch'},{mp:4000,note:'87% milestone'},
    {mp:4600,note:'ğŸ† Payout triggered!'}
  ];
  const maxMp = Math.max(...mdata.filter(x=>x.mp<=masterProfit).map(x=>x.mp),0);
  document.getElementById('phMilestones').innerHTML = mdata.map(md => {
    const v = dv(entry, md.mp), g = v - entry;
    const done = masterProfit >= md.mp, isCur = md.mp === maxMp;
    const chip = done ? (isCur ? `<span class="status-chip chip-active">â–¶ Current</span>` : `<span class="status-chip chip-done">âœ“ Reached</span>`) : `<span class="status-chip chip-upcoming">â³ Upcoming</span>`;
    return `<tr>
      <td>${chip}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:500;color:${v>=IP_TARGET?'var(--gold)':'var(--ink)'};">${fmt(v)}</td>
      <td style="font-family:'DM Mono',monospace;color:${g>=0?'var(--green)':'var(--red)'};">+${fmt(g)}</td>
      <td style="color:var(--muted);font-size:0.85rem;">${md.note}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin() {
  const name = profile?.username || user?.user_metadata?.full_name || user.email.split('@')[0];
  const photo = user?.user_metadata?.avatar_url;
  const av = document.getElementById('adminAvatar');
  if (photo) av.innerHTML = `<img src="${photo}" alt="">`;
  else av.textContent = name.substring(0,2).toUpperCase();
  document.getElementById('adminName').textContent = name;

  renderAdminOverview();
  renderInvestorTable();
  renderTradeTable();
}

function renderAdminOverview() {
  const gpct = Math.min(masterProfit/IP_GOAL*100,100);
  document.getElementById('asMasterProfit').textContent = fmt(masterProfit);
  document.getElementById('asMasterBal').textContent    = fmt(IP_START + masterProfit);
  document.getElementById('asInvCount').textContent     = investors.length;
  document.getElementById('asGoalPct').textContent      = gpct.toFixed(1)+'%';
  document.getElementById('adminBarLabel').textContent  = fmt(masterProfit)+' profit';
  document.getElementById('profitDisplayVal').textContent = fmt(masterProfit);
  document.getElementById('profitInput').value = masterProfit;
  setTimeout(()=>{document.getElementById('adminBar').style.width = gpct.toFixed(1)+'%';},200);
}

function renderInvestorTable() {
  const tbody = document.getElementById('invTableBody');
  if (!investors.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--muted);">No investors yet. Add one below.</td></tr>';
    return;
  }
  tbody.innerHTML = investors.map((inv,idx) => {
    const entry = parseFloat(inv.entry_point)||115;
    const m = mult(entry), v = dv(entry,masterProfit), p = Math.min(v/IP_TARGET*100,100);
    return `<tr>
      <td><strong>${inv.name||'â€”'}</strong></td>
      <td style="color:var(--muted);font-size:0.85rem;">${inv.email||'â€”'}</td>
      <td style="font-family:'DM Mono',monospace;">${fmt(entry)}</td>
      <td style="font-family:'DM Mono',monospace;color:#7c5cbf;">${m.toFixed(4)}x</td>
      <td style="font-family:'DM Mono',monospace;color:${v>=IP_TARGET?'var(--gold)':'var(--green)'};">${fmt(v)}</td>
      <td>
        <div style="display:flex;align-items:center;gap:0.5rem;">
          <div style="flex:1;height:6px;background:var(--paper3);border-radius:3px;overflow:hidden;max-width:70px;">
            <div style="height:100%;width:${p.toFixed(0)}%;background:${v>=IP_TARGET?'var(--gold)':'var(--green)'};border-radius:3px;transition:width 1s;"></div>
          </div>
          <span style="font-size:0.75rem;color:var(--muted);">${p.toFixed(0)}%</span>
        </div>
      </td>
      <td><button class="btn-danger-sm" onclick="removeInvestor(${idx})">âœ• Remove</button></td>
    </tr>`;
  }).join('');
}

function renderTradeTable() {
  const filtered = allTrades.filter(t => {
    const p = parseFloat(t.pnl||0);
    if (tradeFilter==='win') return p>0;
    if (tradeFilter==='loss') return p<0;
    return true;
  });
  const tbody = document.getElementById('tradeTableBody');
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--muted);">No trades yet.</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(t => {
    const p = parseFloat(t.pnl||0);
    return `<tr>
      <td style="color:var(--muted);font-size:0.85rem;">${t.trade_date}</td>
      <td><strong>${t.market||'â€”'}</strong></td>
      <td><span style="color:${t.direction==='Long'?'var(--green)':'var(--red)'};">${t.direction||'â€”'}</span></td>
      <td style="font-family:'DM Mono',monospace;">${t.contracts||'â€”'}</td>
      <td style="font-family:'DM Mono',monospace;font-weight:600;color:${p>=0?'var(--green)':'var(--red)'};">${fmt(p)}</td>
      <td style="color:var(--muted);font-size:0.85rem;">${t.notes||'â€”'}</td>
      <td><button class="btn-danger-sm" onclick="deleteTrade('${t.id}')">âœ•</button></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateProfit() {
  const val = parseFloat(document.getElementById('profitInput').value);
  if (isNaN(val) || val < 0) { showAlert('adminAlert','Please enter a valid profit amount.','error'); return; }
  masterProfit = Math.min(val, IP_GOAL * 2);
  try { await sb.from('investor_portal_config').upsert({id:'master_state',value:{profit:masterProfit}}); } catch(_){}
  localStorage.setItem('pfp_master_profit', masterProfit.toString());
  renderAdminOverview();
  renderInvestorTable();
  showAlert('adminAlert', `Master profit updated to ${fmt(masterProfit)}. All ${investors.length} investor(s) synced.`);
}

async function addInvestor() {
  const name  = document.getElementById('newInvName').value.trim();
  const email = document.getElementById('newInvEmail').value.trim();
  const entry = parseFloat(document.getElementById('newInvEntry').value);
  if (!name || !email || isNaN(entry) || entry <= 0) { showAlert('invAlert','Please fill all fields correctly.','error'); return; }
  if (investors.find(i=>i.email?.toLowerCase()===email.toLowerCase())) { showAlert('invAlert','This email is already registered.','error'); return; }

  const inv = {id: crypto.randomUUID(), name, email, entry_point: entry, created_at: new Date().toISOString()};
  try { await sb.from('investor_portal_investors').upsert(inv); } catch(_){}
  investors.push(inv);
  localStorage.setItem('pfp_investors', JSON.stringify(investors));
  document.getElementById('newInvName').value='';
  document.getElementById('newInvEmail').value='';
  document.getElementById('newInvEntry').value='';
  renderInvestorTable();
  document.getElementById('asInvCount').textContent = investors.length;
  showAlert('invAlert', `${name} added as investor with entry point ${fmt(entry)}.`);
}

async function removeInvestor(idx) {
  const inv = investors[idx];
  if (!confirm(`Remove ${inv.name || inv.email} from the portal?`)) return;
  try { await sb.from('investor_portal_investors').delete().eq('id',inv.id); } catch(_){}
  investors.splice(idx,1);
  localStorage.setItem('pfp_investors', JSON.stringify(investors));
  renderInvestorTable();
  document.getElementById('asInvCount').textContent = investors.length;
  showAlert('invAlert', `${inv.name||inv.email} removed.`);
}

async function logTrade() {
  const date      = document.getElementById('tradeDate').value;
  const market    = document.getElementById('tradeMarket').value.trim();
  const direction = document.getElementById('tradeDir').value;
  const pnl       = parseFloat(document.getElementById('tradePnL').value);
  const contracts = parseInt(document.getElementById('tradeContracts').value)||1;
  const notes     = document.getElementById('tradeNotes').value.trim();

  if (!date || !market || isNaN(pnl)) { showAlert('tradeAlert','Please fill date, market, and P&L.','error'); return; }

  const btn = document.getElementById('tradeSubmitBtn');
  btn.disabled=true; btn.textContent='Savingâ€¦';

  const trade = {id:crypto.randomUUID(), trade_date:date, market, direction, pnl, contracts, notes, created_at:new Date().toISOString()};
  try { await sb.from('investor_trades').insert(trade); } catch(_){}
  allTrades.unshift(trade);

  // Auto-update master profit with cumulative P&L
  const totalPnL = allTrades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
  const newProfit = Math.max(0, totalPnL);
  if (Math.abs(newProfit - masterProfit) > 0.01) {
    masterProfit = newProfit;
    try { await sb.from('investor_portal_config').upsert({id:'master_state',value:{profit:masterProfit}}); } catch(_){}
    localStorage.setItem('pfp_master_profit', masterProfit.toString());
    renderAdminOverview();
    renderInvestorTable();
  }

  document.getElementById('tradeDate').value='';
  document.getElementById('tradeMarket').value='';
  document.getElementById('tradePnL').value='';
  document.getElementById('tradeContracts').value='';
  document.getElementById('tradeNotes').value='';
  btn.disabled=false; btn.textContent='Log Trade';
  renderTradeTable();
  showAlert('tradeAlert', `Trade logged: ${direction} ${market} ${pnl>=0?'+':''}${fmt(pnl)}`);
}

async function deleteTrade(id) {
  if (!confirm('Delete this trade?')) return;
  try { await sb.from('investor_trades').delete().eq('id',id); } catch(_){}
  allTrades = allTrades.filter(t=>t.id!==id);
  // Recalc master profit
  const totalPnL = allTrades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
  masterProfit = Math.max(0, totalPnL);
  try { await sb.from('investor_portal_config').upsert({id:'master_state',value:{profit:masterProfit}}); } catch(_){}
  localStorage.setItem('pfp_master_profit', masterProfit.toString());
  renderAdminOverview();
  renderInvestorTable();
  renderTradeTable();
  showAlert('tradeAlert','Trade deleted and master profit recalculated.');
}

function filterTrades(f, el) {
  tradeFilter = f;
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderTradeTable();
}

function switchTab(name) {
  document.querySelectorAll('.atab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.admin-page').forEach(p=>p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  sb = window.supabase.createClient(SB_URL, SB_KEY);

  // Set today's date on trade form
  document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];

  sb.auth.onAuthStateChange(async (event, session) => {
    if ((event==='SIGNED_IN'||event==='INITIAL_SESSION') && session) {
      await routeUser(session);
    } else if (event==='SIGNED_OUT') {
      showScreen('loginScreen');
    }
  });

  try {
    const { data: { session } } = await sb.auth.getSession();
    if (session) { await routeUser(session); return; }
  } catch(_) {}

  showScreen('loginScreen');
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
