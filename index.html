<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8xHorizon ‚Äî Investor Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #060910;
            --bg-card: #0b0f1c;
            --bg-elevated: #111827;
            --bg-hover: #151e30;
            --border: rgba(255,255,255,0.07);
            --border-glow: rgba(99,179,237,0.2);
            --text: #eef2ff;
            --text-muted: #6b7fa8;
            --text-dim: #2d3a5a;
            --accent: #3b7ef8;
            --accent-glow: rgba(59,126,248,0.2);
            --success: #10d9a0;
            --success-glow: rgba(16,217,160,0.15);
            --danger: #f05c6a;
            --danger-glow: rgba(240,92,106,0.15);
            --warning: #f5a623;
            --warning-glow: rgba(245,166,35,0.15);
            --gold: #ffd166;
            --purple: #9b6ffa;
            --cyan: #06d6d6;
            --radius: 16px;
            --radius-sm: 10px;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 3px; }

        /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
        .auth-screen {
            position: fixed; inset: 0;
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            background: var(--bg);
            padding: 1rem;
        }
        .auth-screen.hidden { display: none !important; }

        .auth-bg-mesh {
            position: fixed; inset: 0; pointer-events: none;
            background:
                radial-gradient(ellipse 70% 50% at 20% 20%, rgba(59,126,248,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 80% 80%, rgba(155,111,250,0.1) 0%, transparent 60%),
                radial-gradient(ellipse 40% 30% at 50% 50%, rgba(16,217,160,0.04) 0%, transparent 50%);
        }
        .auth-grid-lines {
            position: fixed; inset: 0; pointer-events: none;
            background-image:
                linear-gradient(rgba(99,179,237,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99,179,237,0.03) 1px, transparent 1px);
            background-size: 48px 48px;
        }

        .auth-box {
            position: relative; z-index: 1;
            width: 420px; max-width: 95vw;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 3rem 2.5rem;
            box-shadow: var(--shadow), 0 0 80px rgba(59,126,248,0.06);
        }

        .auth-brand {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .auth-brand-mark {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 68px; height: 68px;
            background: linear-gradient(135deg, rgba(59,126,248,0.2), rgba(155,111,250,0.15));
            border: 1px solid rgba(59,126,248,0.3);
            border-radius: 20px;
            font-size: 2rem;
            margin-bottom: 1.25rem;
            filter: drop-shadow(0 0 20px rgba(59,126,248,0.4));
        }
        .auth-brand h1 {
            font-size: 1.625rem;
            font-weight: 800;
            letter-spacing: -0.04em;
            background: linear-gradient(135deg, #eef2ff 0%, #93b8ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.375rem;
        }
        .auth-brand p {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 400;
        }

        .auth-error {
            background: var(--danger-glow);
            border: 1px solid rgba(240,92,106,0.3);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            margin-bottom: 1.25rem;
            display: none;
        }
        .auth-error.show { display: block; }

        .google-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--bg-elevated);
            border: 1px solid rgba(99,179,237,0.2);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.875rem;
            transition: all 0.2s;
        }
        .google-btn:hover {
            background: var(--bg-hover);
            border-color: rgba(99,179,237,0.4);
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(59,126,248,0.15);
        }
        .google-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .auth-note {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.78rem;
            margin-top: 1.25rem;
            line-height: 1.6;
        }

        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ PENDING SCREEN ‚îÄ‚îÄ */
        .pending-box {
            width: 420px; max-width: 95vw;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 3rem 2.5rem;
            text-align: center;
            position: relative; z-index: 1;
        }
        .pending-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
        .pending-title { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .pending-sub { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.75rem; line-height: 1.6; }
        .pending-warning {
            background: var(--warning-glow);
            border: 1px solid rgba(245,166,35,0.3);
            border-radius: var(--radius-sm);
            padding: 0.875rem 1rem;
            color: var(--warning);
            font-size: 0.85rem;
            margin-bottom: 1.25rem;
        }

        /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.show { display: flex; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar {
            width: 240px; flex-shrink: 0;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: sticky; top: 0;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            display: flex; flex-direction: column;
            z-index: 200;
        }
        .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; margin-bottom: 1.75rem; }
        .sidebar-logo .logo-em { font-size: 1.5rem; }
        .sidebar-logo h2 { font-size: 1rem; font-weight: 800; letter-spacing: -0.03em; background: linear-gradient(135deg, #eef2ff, #93b8ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .user-chip {
            display: flex; align-items: center; gap: 0.75rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem;
            margin-bottom: 1.75rem;
        }
        .user-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 0.875rem; flex-shrink: 0;
            overflow: hidden;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { overflow: hidden; }
        .user-name { font-weight: 700; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .user-role.admin { color: var(--gold); }

        .nav-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); padding: 0 0.75rem; margin-bottom: 0.4rem; }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 600; font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text); }
        .nav-item.active { background: rgba(59,126,248,0.12); color: var(--accent); border: 1px solid rgba(59,126,248,0.2); }
        .nav-item .nav-icon { font-size: 1rem; width: 20px; text-align: center; }

        .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
        .logout-btn {
            width: 100%; padding: 0.625rem 0.75rem;
            background: none; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 0.75rem;
            color: var(--text-muted); font-family: 'Syne', sans-serif;
            font-size: 0.875rem; font-weight: 600;
            border-radius: var(--radius-sm); transition: all 0.15s;
        }
        .logout-btn:hover { background: var(--danger-glow); color: var(--danger); }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main { flex: 1; overflow-x: hidden; min-width: 0; }
        .topbar {
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            padding: 1.25rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50;
        }
        .page-title { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.03em; }
        .menu-btn { display: none; background: none; border: none; cursor: pointer; color: var(--text); font-size: 1.5rem; }

        .container { padding: 2rem; max-width: 1400px; }

        /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
        .page { display: none; }
        .page.active { display: block; }

        /* ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ */
        .alert {
            padding: 1rem 1.25rem; border-radius: var(--radius-sm);
            font-size: 0.875rem; font-weight: 600;
            margin-bottom: 1.5rem; display: none;
            animation: slideDown 0.3s ease;
        }
        .alert.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .alert-success { background: var(--success-glow); border: 1px solid rgba(16,217,160,0.3); color: var(--success); }
        .alert-error { background: var(--danger-glow); border: 1px solid rgba(240,92,106,0.3); color: var(--danger); }
        .alert-info { background: var(--accent-glow); border: 1px solid rgba(59,126,248,0.3); color: #93b8ff; }
        .alert-warning { background: var(--warning-glow); border: 1px solid rgba(245,166,35,0.3); color: var(--warning); }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1rem; font-weight: 700; letter-spacing: -0.02em; }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .card-body { padding: 1.5rem; }

        /* ‚îÄ‚îÄ METRICS ‚îÄ‚îÄ */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem;
            transition: all 0.2s;
        }
        .metric-card:hover { border-color: var(--border-glow); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(59,126,248,0.1); }
        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .metric-label { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-muted); }
        .metric-icon { font-size: 1.2rem; }
        .metric-value { font-size: 1.875rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; margin-bottom: 0.25rem; }
        .metric-sub { font-size: 0.78rem; color: var(--text-muted); }

        /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
        .form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-muted); margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Syne', sans-serif; font-size: 0.9375rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-input::placeholder { color: var(--text-dim); }
        .form-select { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: 'Syne', sans-serif; font-size: 0.9375rem; transition: all 0.2s; cursor: pointer; }
        .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-select option { background: var(--bg-elevated); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn { padding: 0.75rem 1.25rem; border: none; border-radius: var(--radius-sm); font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-primary:hover { background: #5a95ff; transform: translateY(-1px); box-shadow: 0 0 30px rgba(59,126,248,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--border-glow); background: var(--bg-hover); }
        .btn-danger { background: var(--danger-glow); color: var(--danger); border: 1px solid rgba(240,92,106,0.3); }
        .btn-danger:hover { background: rgba(240,92,106,0.25); }
        .btn-success { background: var(--success-glow); color: var(--success); border: 1px solid rgba(16,217,160,0.3); }
        .btn-success:hover { background: rgba(16,217,160,0.2); }
        .btn-gold { background: rgba(255,209,102,0.12); color: var(--gold); border: 1px solid rgba(255,209,102,0.3); }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 1.5rem; }
        .table-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 0.75rem 1rem; text-align: left; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--text-muted); background: var(--bg-elevated); border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
        .badge { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.625rem; border-radius: 20px; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.03em; }
        .badge-success { background: var(--success-glow); color: var(--success); border: 1px solid rgba(16,217,160,0.3); }
        .badge-warning { background: var(--warning-glow); color: var(--warning); border: 1px solid rgba(245,166,35,0.3); }
        .badge-danger { background: var(--danger-glow); color: var(--danger); border: 1px solid rgba(240,92,106,0.3); }
        .badge-accent { background: var(--accent-glow); color: #93b8ff; border: 1px solid rgba(59,126,248,0.3); }
        .badge-gold { background: rgba(255,209,102,0.12); color: var(--gold); border: 1px solid rgba(255,209,102,0.3); }

        /* ‚îÄ‚îÄ ADMIN BANNER ‚îÄ‚îÄ */
        .admin-banner {
            display: flex; align-items: center; gap: 1rem;
            background: linear-gradient(135deg, rgba(255,209,102,0.08), rgba(245,166,35,0.05));
            border: 1px solid rgba(255,209,102,0.2);
            border-radius: var(--radius); padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
        }
        .admin-banner-icon { font-size: 1.5rem; }
        .admin-banner-text strong { display: block; font-size: 0.95rem; font-weight: 700; color: var(--gold); margin-bottom: 0.2rem; }
        .admin-banner-text span { font-size: 0.82rem; color: var(--text-muted); }

        /* ‚îÄ‚îÄ INVESTOR PORTAL ‚îÄ‚îÄ */
        .ip-milestone-dot { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.72rem; font-weight: 700; }
        .ip-milestone-dot::before { content: ''; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .ip-milestone-dot.reached::before { background: var(--success); box-shadow: 0 0 6px rgba(16,217,160,0.6); }
        .ip-milestone-dot.pending::before { background: var(--text-dim); }
        .ip-milestone-dot.reached { color: var(--success); }
        .ip-milestone-dot.pending { color: var(--text-dim); }

        @keyframes shimmer { 0%,100%{transform:translateX(-100%)} 50%{transform:translateX(100%)} }

        /* ‚îÄ‚îÄ OVERLAY (mobile sidebar) ‚îÄ‚îÄ */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 150; }
        .overlay.show { display: block; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
            .menu-btn { display: flex !important; align-items: center; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .metrics-grid { grid-template-columns: 1fr 1fr; }
            .topbar { padding: 1rem; }
        }
        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="auth-screen" id="authScreen">
    <div class="auth-bg-mesh"></div>
    <div class="auth-grid-lines"></div>
    <div class="auth-box">
        <div class="auth-brand">
            <div class="auth-brand-mark">üíº</div>
            <h1>8xHorizon</h1>
            <p>Investor Portal ‚Äî Sign in to continue</p>
        </div>

        <div class="auth-error" id="authError"></div>

        <button class="google-btn" id="googleBtn" onclick="handleGoogleAuth()">
            <svg width="20" height="20" viewBox="0 0 18 18">
                <path fill="#EA4335" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/>
                <path fill="#4285F4" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/>
                <path fill="#FBBC05" d="M3.88 10.78A5.54 5.54 0 013.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 000 9c0 1.45.35 2.82.96 4.04l2.92-2.26z"/>
                <path fill="#34A853" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/>
            </svg>
            <span id="googleBtnTxt">Continue with Google</span>
            <div class="spinner" id="googleSpinner"></div>
        </button>

        <div class="auth-note">Sign in or sign up instantly. No password needed.</div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="dashboard" id="dashboard">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="logo-em">üíº</span>
            <h2>8xHorizon</h2>
        </div>

        <div class="user-chip">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">Investor</div>
            </div>
        </div>

        <nav class="nav-section">
            <div class="nav-label">Portal</div>
            <div class="nav-item active" data-page="investorPortal" onclick="navTo('investorPortal')">
                <span class="nav-icon">üìà</span>My Portfolio
            </div>
        </nav>

        <nav class="nav-section" id="adminNavSection" style="display:none;">
            <div class="nav-label">Admin</div>
            <div class="nav-item" data-page="adminPanel" onclick="navTo('adminPanel')" id="adminNavItem">
                <span class="nav-icon">üëë</span>Admin Panel
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="handleLogout()">
                <span>üö™</span> Sign Out
            </button>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:1rem;">
                <button class="menu-btn" onclick="openSidebar()">‚ò∞</button>
                <div class="page-title" id="pageTitle">Investor Portal</div>
            </div>
            <div style="display:flex;align-items:center;gap:0.75rem;">
                <button class="btn btn-secondary" style="padding:0.5rem 0.875rem;font-size:0.8rem;" onclick="refreshPortal()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="container">
            <div class="alert" id="mainAlert"></div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVESTOR PORTAL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page active" id="investorPortalPage">

                <!-- INVESTOR VIEW -->
                <div id="ipInvestorSection" style="display:none;">

                    <!-- Goal banner -->
                    <div id="ipGoalBanner" style="background:linear-gradient(135deg,rgba(59,126,248,0.1),rgba(155,111,250,0.07));border:1px solid rgba(59,126,248,0.2);border-radius:var(--radius);padding:1.5rem 2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;">
                        <span style="font-size:2.25rem;flex-shrink:0;" id="ipBannerEmoji">üéØ</span>
                        <div style="flex:1;min-width:200px;">
                            <div style="font-size:1.05rem;font-weight:800;margin-bottom:0.2rem;" id="ipBannerTitle">Progress to Your $800 Target</div>
                            <div style="color:var(--text-muted);font-size:0.85rem;" id="ipBannerSub">Your account grows as the master account hits profit milestones</div>
                        </div>
                        <div style="flex:2;min-width:220px;">
                            <div style="display:flex;justify-content:space-between;font-size:0.75rem;font-weight:700;color:var(--text-muted);margin-bottom:0.5rem;">
                                <span>Your Value</span><span style="color:var(--gold)">Target: $800</span>
                            </div>
                            <div style="height:10px;background:var(--bg-elevated);border-radius:5px;overflow:hidden;">
                                <div id="ipGoalFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:5px;transition:width 1.5s ease;"></div>
                            </div>
                            <div style="text-align:right;font-size:0.72rem;color:var(--text-muted);margin-top:0.35rem;" id="ipGoalPct">0% to $800 goal</div>
                        </div>
                    </div>

                    <!-- Big display value -->
                    <div style="background:var(--bg-card);border:1px solid rgba(59,126,248,0.2);border-radius:var(--radius);padding:2rem;margin-bottom:1.5rem;position:relative;overflow:hidden;box-shadow:0 0 60px rgba(59,126,248,0.05);">
                        <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--purple),var(--cyan));"></div>
                        <div style="display:flex;align-items:center;gap:2rem;flex-wrap:wrap;">
                            <div style="flex:1;min-width:180px;">
                                <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;">Your Account Value</div>
                                <div id="ipDisplayValue" style="font-family:'JetBrains Mono',monospace;font-size:clamp(2.2rem,5vw,3.75rem);font-weight:700;letter-spacing:-0.03em;line-height:1;color:var(--text);margin-bottom:0.5rem;">$‚Äî</div>
                                <div style="color:var(--text-muted);font-size:0.875rem;">Entry: <strong id="ipEntryDisplay">‚Äî</strong> &nbsp;¬∑&nbsp; Profit Share: <strong id="ipProfitShare">‚Äî</strong></div>
                            </div>
                            <div style="flex:2;min-width:240px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;font-size:0.75rem;font-weight:700;color:var(--text-muted);margin-bottom:0.625rem;">
                                    <span>Journey to Payout</span>
                                    <span id="ipTargetLabel" style="font-family:'JetBrains Mono',monospace;color:var(--gold);font-weight:700;">$800 Goal</span>
                                </div>
                                <div style="height:14px;background:var(--bg-elevated);border-radius:7px;overflow:hidden;border:1px solid var(--border);">
                                    <div id="ipJourneyFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:7px;transition:width 2s cubic-bezier(0.4,0,0.2,1);position:relative;">
                                        <div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);animation:shimmer 2.5s ease infinite;"></div>
                                    </div>
                                </div>
                                <div id="ipMilestoneRow" style="display:flex;gap:1rem;margin-top:0.875rem;flex-wrap:wrap;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Stat cards -->
                    <div class="metrics-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Entry Point</span><span class="metric-icon">üìç</span></div><div class="metric-value" id="ipStatEntry">$‚Äî</div><div class="metric-sub">Your starting investment</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Profit Allocated</span><span class="metric-icon">üìà</span></div><div class="metric-value" id="ipStatProfit" style="color:var(--success)">$‚Äî</div><div class="metric-sub">Scaled from master profit</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Target Value</span><span class="metric-icon">üèÜ</span></div><div class="metric-value" style="color:var(--gold)">$800</div><div class="metric-sub">At $4,600 master profit</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Multiplier</span><span class="metric-icon">‚úñÔ∏è</span></div><div class="metric-value" id="ipStatMult" style="color:var(--purple)">‚Äî</div><div class="metric-sub">Personal scaling factor</div></div>
                    </div>

                    <!-- Milestone table -->
                    <div class="table-card">
                        <div class="table-header">
                            <div><span class="card-title">üìã Milestone Log</span><div class="card-sub">Key profit checkpoints in your journey</div></div>
                        </div>
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr><th>Status</th><th>Master Profit</th><th>Your Value</th><th>Gain from Entry</th><th>Note</th></tr>
                                </thead>
                                <tbody id="ipMilestoneBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Not registered -->
                <div id="ipNotRegistered" style="display:none;">
                    <div style="text-align:center;padding:5rem 2rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);">
                        <div style="font-size:3.5rem;margin-bottom:1.25rem;">üîí</div>
                        <h3 style="font-size:1.3rem;font-weight:800;margin-bottom:0.625rem;letter-spacing:-0.02em;">Not Yet Registered</h3>
                        <p style="color:var(--text-muted);font-size:0.9rem;max-width:360px;margin:0 auto;line-height:1.6;">You haven't been added to the investor portal yet.<br>Contact your account manager to get registered.</p>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PANEL PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page" id="adminPanelPage">

                <div class="admin-banner">
                    <span class="admin-banner-icon">üëë</span>
                    <div class="admin-banner-text">
                        <strong>Admin Panel ‚Äî Full Visibility</strong>
                        <span>Approve users, manage investors, update master profit, view all accounts.</span>
                    </div>
                </div>

                <!-- Tabs -->
                <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem;border-bottom:1px solid var(--border);padding-bottom:0;overflow-x:auto;">
                    <button class="btn btn-secondary admin-tab active" data-tab="users" onclick="switchAdminTab('users')" style="border-radius:8px 8px 0 0;border-bottom:2px solid var(--accent);margin-bottom:-1px;">üë• Users</button>
                    <button class="btn btn-secondary admin-tab" data-tab="investors" onclick="switchAdminTab('investors')" style="border-radius:8px 8px 0 0;margin-bottom:-1px;">üíº Investors</button>
                    <button class="btn btn-secondary admin-tab" data-tab="profit" onclick="switchAdminTab('profit')" style="border-radius:8px 8px 0 0;margin-bottom:-1px;">‚ö° Master Profit</button>
                </div>

                <!-- Users Tab -->
                <div id="adminTab_users" class="admin-tab-content">
                    <div class="metrics-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Users</span><span class="metric-icon">üë•</span></div><div class="metric-value" id="adminTotalUsers">‚Äî</div><div class="metric-sub">Registered accounts</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Pending Approval</span><span class="metric-icon">‚è≥</span></div><div class="metric-value" id="adminPendingCount" style="color:var(--warning)">‚Äî</div><div class="metric-sub">Awaiting access</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Approved</span><span class="metric-icon">‚úÖ</span></div><div class="metric-value" id="adminApprovedCount" style="color:var(--success)">‚Äî</div><div class="metric-sub">Active users</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Investors</span><span class="metric-icon">üíº</span></div><div class="metric-value" id="adminInvestorMetric" style="color:var(--purple)">‚Äî</div><div class="metric-sub">Registered investors</div></div>
                    </div>

                    <div class="table-card">
                        <div class="table-header">
                            <div><span class="card-title">User Management</span><div class="card-sub">Approve, promote, or remove users</div></div>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <input type="text" class="form-input" id="adminUserSearch" placeholder="Search email‚Ä¶" style="padding:0.4rem 0.75rem;font-size:0.85rem;width:200px;" oninput="filterAdminUsers()">
                                <button class="btn btn-secondary" onclick="loadAdminData()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">üîÑ Refresh</button>
                            </div>
                        </div>
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr><th>User</th><th>Status</th><th>Role</th><th>Joined</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="adminUsersBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Investors Tab -->
                <div id="adminTab_investors" class="admin-tab-content" style="display:none;">
                    <div class="metrics-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Master Balance</span><span class="metric-icon">üè¶</span></div><div class="metric-value" id="ipMasterBal" style="color:var(--accent)">$50,000</div><div class="metric-sub">Starting: $50,000</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Current Profit</span><span class="metric-icon">üìà</span></div><div class="metric-value" id="ipMasterProfit" style="color:var(--success)">$0</div><div class="metric-sub" id="ipProfitPct">0% of $4,600 goal</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Goal Profit</span><span class="metric-icon">üéØ</span></div><div class="metric-value" style="color:var(--gold)">$4,600</div><div class="metric-sub">Triggers $800 payout</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Investors</span><span class="metric-icon">üë•</span></div><div class="metric-value" id="ipInvestorCount" style="color:var(--purple)">0</div><div class="metric-sub">Active investor accounts</div></div>
                    </div>

                    <!-- Investor table -->
                    <div class="table-card" style="margin-bottom:1.5rem;">
                        <div class="table-header">
                            <div><span class="card-title">Investor Accounts</span><div class="card-sub">Each investor sees their own scaled Display Value</div></div>
                        </div>
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr><th>Name / Label</th><th>Email</th><th>Entry Point</th><th>Multiplier</th><th>Display Value</th><th>% to $800</th><th>Actions</th></tr>
                                </thead>
                                <tbody id="ipInvestorTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add investor -->
                    <div class="form-card">
                        <h3 style="margin-bottom:0.5rem;font-size:1rem;font-weight:800;">‚ûï Register New Investor</h3>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Add an investor's email and entry point. They'll see their scaled account when they log in.</p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Name / Label</label>
                                <input type="text" class="form-input" id="ipNewName" placeholder="e.g. Investor A">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="ipNewEmail" placeholder="investor@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Entry Point ($)</label>
                                <input type="number" class="form-input" id="ipNewEntry" placeholder="e.g. 115" min="1" style="font-family:'JetBrains Mono',monospace;">
                            </div>
                        </div>
                        <div style="display:flex;gap:0.75rem;padding-top:1rem;border-top:1px solid var(--border);">
                            <button class="btn btn-primary" style="width:auto;" onclick="ipAddInvestor()">‚ûï Add Investor</button>
                            <button class="btn btn-secondary" onclick="ipClearNewForm()">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Master Profit Tab -->
                <div id="adminTab_profit" class="admin-tab-content" style="display:none;">

                    <!-- Progress bar -->
                    <div class="card" style="margin-bottom:1.5rem;">
                        <div class="card-header">
                            <div><div class="card-title">Master Account Progress</div><div class="card-sub">$50,000 ‚Üí $54,600 target</div></div>
                        </div>
                        <div class="card-body">
                            <div style="display:flex;justify-content:space-between;font-size:0.75rem;font-weight:700;color:var(--text-muted);margin-bottom:0.5rem;">
                                <span id="ipProgLabel">$0 profit</span>
                                <span style="color:var(--gold)">$4,600 goal</span>
                            </div>
                            <div style="height:14px;background:var(--bg-elevated);border-radius:7px;overflow:hidden;border:1px solid var(--border);">
                                <div id="ipProgFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:7px;transition:width 1.5s cubic-bezier(0.4,0,0.2,1);position:relative;">
                                    <div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);animation:shimmer 2.5s ease infinite;"></div>
                                </div>
                            </div>
                            <div style="text-align:right;font-size:0.72rem;color:var(--text-muted);margin-top:0.4rem;" id="ipProgPct">0.0% to goal</div>
                        </div>
                    </div>

                    <div class="form-card">
                        <h3 style="margin-bottom:0.5rem;font-size:1rem;font-weight:800;">‚ö° Update Master Profit</h3>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Enter the current profit on the master PA account. All investor display values update instantly.</p>
                        <div style="display:flex;gap:0.875rem;flex-wrap:wrap;align-items:flex-end;">
                            <div class="form-group" style="margin-bottom:0;flex:1;min-width:200px;">
                                <label class="form-label">Current Master Profit ($)</label>
                                <input type="number" class="form-input" id="ipProfitInput" placeholder="e.g. 2300" step="50" min="0" style="font-family:'JetBrains Mono',monospace;">
                            </div>
                            <button class="btn btn-primary" style="width:auto;white-space:nowrap;" onclick="ipUpdateProfit()">‚ö° Update All Investors</button>
                        </div>
                    </div>
                </div>

            </div><!-- /adminPanelPage -->

        </div><!-- /container -->
    </main>
</div><!-- /dashboard -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://gmhmtdgultwlleskvpao.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtaG10ZGd1bHR3bGxlc2t2cGFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzgyOTIsImV4cCI6MjA4NzExNDI5Mn0.D6MyCDPvW05CiVm6DOa0YX1z-lwmTRWDC9a8-gg9gA0';
let sb = null;
let currentUser = null;
let currentProfile = null;

function initSB() {
    if (sb) return true;
    try {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                // Tell Supabase to detect the OAuth token from the URL hash
                detectSessionInUrl: true,
                persistSession: true,
                autoRefreshToken: true,
                // Use the GitHub Pages URL as the site URL
                flowType: 'implicit'
            }
        });
        return true;
    }
    catch(e) { console.error('Supabase init failed:', e); return false; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVESTOR PORTAL CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IP_MASTER_START  = 50000;
const IP_GOAL_PROFIT   = 4600;
const IP_PAYOUT_TARGET = 800;

let ipMasterProfit = 0;
let ipInvestors = [];

function ipCalcMultiplier(entry) { return (IP_PAYOUT_TARGET - entry) / IP_GOAL_PROFIT; }
function ipCalcDisplayValue(entry, profit) { return entry + profit * ipCalcMultiplier(entry); }
function fmtCurrency(v) { return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2, maximumFractionDigits:2 }).format(v); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleGoogleAuth() {
    if (!initSB()) return;
    const btn = document.getElementById('googleBtn');
    const txt = document.getElementById('googleBtnTxt');
    const spin = document.getElementById('googleSpinner');
    btn.disabled = true;
    txt.textContent = 'Redirecting‚Ä¶';
    spin.style.display = 'inline-block';
    try {
        // Hardcoded to the exact GitHub Pages index.html URL
        const baseUrl = 'https://8xhorizoninvest-ai.github.io/8xhorizon/index.html';
        const { error } = await sb.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: baseUrl }
        });
        if (error) {
            btn.disabled = false; txt.textContent = 'Continue with Google'; spin.style.display = 'none';
            showAuthError('Google sign-in failed: ' + error.message);
        }
    } catch(e) {
        btn.disabled = false; txt.textContent = 'Continue with Google'; spin.style.display = 'none';
        showAuthError('Error: ' + e.message);
    }
}

function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 8000);
}

async function handleLogout() {
    currentUser = null; currentProfile = null;
    await sb.auth.signOut();
    document.getElementById('dashboard').classList.remove('show');
    document.getElementById('authScreen').classList.remove('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SESSION & PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ensureProfile(session) {
    if (!currentUser) return;
    const { data, error } = await sb.from('investor_profiles').select('*').eq('id', currentUser.id).single();
    if (!error && data) { currentProfile = data; return; }
    // Create profile
    const name = (session.user.user_metadata?.full_name || session.user.user_metadata?.name || session.user.email?.split('@')[0] || 'User');
    const { data: newP } = await sb.from('investor_profiles').upsert({
        id: currentUser.id,
        email: session.user.email || null,
        name: name,
        role: 'user',
        approved: false,
        avatar_url: session.user.user_metadata?.avatar_url || null
    }).select().single();
    currentProfile = newP;
}

async function loadProfile() {
    if (!currentUser) return;
    const { data } = await sb.from('investor_profiles').select('*').eq('id', currentUser.id).single();
    if (data) currentProfile = data;
}

function routeUser() {
    const isAdmin = currentProfile?.role === 'admin';
    const isApproved = isAdmin || currentProfile?.approved === true;
    if (isApproved) {
        showDashboard();
    } else {
        showPendingScreen();
    }
}

function showPendingScreen() {
    document.getElementById('authScreen').classList.remove('hidden');
    const box = document.querySelector('.auth-box');
    const name = currentProfile?.name || currentUser?.email || 'User';
    box.innerHTML = `
        <div class="auth-brand">
            <div class="auth-brand-mark">‚è≥</div>
            <h1>Awaiting Approval</h1>
            <p>Your account is pending admin approval</p>
        </div>
        <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1.25rem;text-align:center;margin-bottom:1.25rem;">
            <div style="font-size:2rem;margin-bottom:0.5rem;">üå±</div>
            <div style="font-weight:700;margin-bottom:0.35rem;">Hi ${name}!</div>
            <div style="color:var(--text-muted);font-size:0.875rem;line-height:1.6;">Your account was created successfully.<br>An admin will approve your access shortly.</div>
        </div>
        <div class="pending-warning">‚ö†Ô∏è Access restricted until approved by <strong>8xhorizon.invest@gmail.com</strong></div>
        <button class="google-btn" style="margin-bottom:0.75rem;" onclick="window.location.reload()">üîÑ Refresh to Check Status</button>
        <button class="btn btn-secondary" style="width:100%;" onclick="sb.auth.signOut().then(()=>window.location.reload())">Sign Out</button>
    `;
}

function showDashboard() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.add('show');

    const isAdmin = currentProfile?.role === 'admin';
    const name = currentProfile?.name || currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'User';
    const initials = name.substring(0, 2).toUpperCase();

    // Avatar
    const avatarEl = document.getElementById('userAvatar');
    if (currentProfile?.avatar_url) {
        avatarEl.innerHTML = `<img src="${currentProfile.avatar_url}" alt="avatar">`;
    } else {
        avatarEl.textContent = initials;
    }
    document.getElementById('userName').textContent = name;
    document.getElementById('userRole').textContent = isAdmin ? 'üëë Admin' : 'Investor';
    document.getElementById('userRole').className = 'user-role' + (isAdmin ? ' admin' : '');

    // Show admin nav
    document.getElementById('adminNavSection').style.display = isAdmin ? 'block' : 'none';

    // Load data
    loadPortalData();
    if (isAdmin) loadAdminData();
}

async function checkSession() {
    if (!initSB()) return;
    let handled = false;

    // MUST register listener FIRST before getSession()
    // This catches the SIGNED_IN event fired when Supabase
    // parses the #access_token hash on return from Google OAuth
    sb.auth.onAuthStateChange(async (event, session) => {
        if ((event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') && session && !handled) {
            handled = true;
            currentUser = session.user;
            // Clean the URL hash so it doesn't linger
            if (window.location.hash && window.location.hash.includes('access_token')) {
                history.replaceState(null, '', window.location.pathname);
            }
            await ensureProfile(session);
            routeUser();
        } else if (event === 'SIGNED_OUT') {
            handled = false;
            currentUser = null; currentProfile = null;
            document.getElementById('dashboard').classList.remove('show');
            document.getElementById('authScreen').classList.remove('hidden');
        }
    });

    // Small delay to let Supabase parse the hash token first
    await new Promise(r => setTimeout(r, 100));

    try {
        const { data: { session } } = await sb.auth.getSession();
        if (session && !handled) {
            handled = true;
            currentUser = session.user;
            if (window.location.hash && window.location.hash.includes('access_token')) {
                history.replaceState(null, '', window.location.pathname);
            }
            await ensureProfile(session);
            routeUser();
            return;
        }
    } catch(e) { console.error('Session check error:', e); }

    // If still no session after all that, show login
    if (!handled) {
        const as = document.getElementById('authScreen');
        if (as) { as.classList.remove('hidden'); }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const titles = { investorPortal: 'My Portfolio', adminPanel: 'Admin Panel' };
    const pages = { investorPortal: 'investorPortalPage', adminPanel: 'adminPanelPage' };
    document.getElementById(pages[page])?.classList.add('active');
    document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
    document.getElementById('pageTitle').textContent = titles[page] || page;
    closeSidebar();
    if (page === 'adminPanel') loadAdminData();
    if (page === 'investorPortal') loadPortalData();
}

function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('overlay').classList.add('show'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }

function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab').forEach(t => {
        const isActive = t.dataset.tab === tab;
        t.classList.toggle('active', isActive);
        t.style.borderBottom = isActive ? '2px solid var(--accent)' : '';
        t.style.color = isActive ? 'var(--text)' : '';
    });
    document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');
    document.getElementById('adminTab_' + tab).style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ALERT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAlert(msg, type = 'info') {
    const el = document.getElementById('mainAlert');
    el.className = `alert alert-${type} show`;
    el.textContent = msg;
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVESTOR PORTAL ‚Äî DATA LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPortalData() {
    // Load master profit
    try {
        const { data } = await sb.from('investor_portal_config').select('value').eq('id', 'master_state').single();
        if (data) ipMasterProfit = parseFloat(data.value?.profit || 0);
    } catch(_) {}

    // Load investors
    try {
        const { data } = await sb.from('investor_portal_investors').select('*').order('created_at', { ascending: true });
        if (data) ipInvestors = data;
    } catch(_) {}

    const isAdmin = currentProfile?.role === 'admin';
    const myEmail = currentUser?.email || '';
    const myProfile = ipInvestors.find(i => i.email?.toLowerCase() === myEmail.toLowerCase());

    document.getElementById('ipInvestorSection').style.display = (myProfile || isAdmin) ? 'block' : 'none';
    document.getElementById('ipNotRegistered').style.display = (!myProfile && !isAdmin) ? 'block' : 'none';

    if (myProfile) {
        ipRenderInvestorView(parseFloat(myProfile.entry_point) || 115);
    } else if (isAdmin && ipInvestors.length > 0) {
        ipRenderInvestorView(parseFloat(ipInvestors[0].entry_point) || 115);
    }
}

async function refreshPortal() {
    await loadPortalData();
    if (currentProfile?.role === 'admin') await loadAdminData();
    showAlert('‚úì Refreshed', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVESTOR VIEW RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ipRenderInvestorView(entry) {
    const mult  = ipCalcMultiplier(entry);
    const dv    = ipCalcDisplayValue(entry, ipMasterProfit);
    const profitShare = ipMasterProfit * mult;
    const journeyPct  = Math.min((dv - entry) / (IP_PAYOUT_TARGET - entry) * 100, 100);
    const goalPct     = Math.min(dv / IP_PAYOUT_TARGET * 100, 100);
    const atGoal      = dv >= IP_PAYOUT_TARGET;

    if (atGoal) {
        document.getElementById('ipBannerEmoji').textContent = 'üéâ';
        document.getElementById('ipBannerTitle').textContent = 'Goal Reached! Congratulations!';
        document.getElementById('ipBannerSub').textContent = 'Your account has hit the $800 payout target.';
    }
    document.getElementById('ipGoalFill').style.width = goalPct.toFixed(1) + '%';
    document.getElementById('ipGoalPct').textContent = goalPct.toFixed(1) + '% to $800 goal';

    const dvEl = document.getElementById('ipDisplayValue');
    dvEl.textContent = fmtCurrency(dv);
    dvEl.style.color = atGoal ? 'var(--gold)' : 'var(--text)';
    if (atGoal) dvEl.style.textShadow = '0 0 30px rgba(255,209,102,0.4)';

    document.getElementById('ipEntryDisplay').textContent = fmtCurrency(entry);
    document.getElementById('ipProfitShare').textContent = fmtCurrency(profitShare);

    const jFill = document.getElementById('ipJourneyFill');
    jFill.style.width = journeyPct.toFixed(1) + '%';
    jFill.style.background = atGoal
        ? 'linear-gradient(90deg, var(--gold), #ffb700)'
        : 'linear-gradient(90deg, var(--accent), var(--purple))';
    document.getElementById('ipTargetLabel').textContent = atGoal ? 'üéâ Goal Reached!' : '$800 Goal';

    const milestones = [200, 400, 600, 800];
    document.getElementById('ipMilestoneRow').innerHTML = milestones.map(m => {
        const reached = dv >= m;
        return `<span class="ip-milestone-dot ${reached?'reached':'pending'}">${fmtCurrency(m)}</span>`;
    }).join('');

    document.getElementById('ipStatEntry').textContent = fmtCurrency(entry);
    document.getElementById('ipStatProfit').textContent = fmtCurrency(profitShare);
    document.getElementById('ipStatMult').textContent = mult.toFixed(4) + 'x';

    const profits = [0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4600];
    document.getElementById('ipMilestoneBody').innerHTML = profits.map((p, i) => {
        const val  = ipCalcDisplayValue(entry, p);
        const gain = val - entry;
        const passed  = ipMasterProfit >= p;
        const current = p <= ipMasterProfit && (i === profits.length - 1 || profits[i+1] > ipMasterProfit);
        const badge = current
            ? `<span class="badge badge-success">‚ñ∂ Current</span>`
            : passed
            ? `<span class="badge badge-accent">‚úì Passed</span>`
            : `<span style="color:var(--text-dim);font-size:0.72rem;">‚óã Pending</span>`;
        return `<tr>
            <td>${badge}</td>
            <td style="font-family:'JetBrains Mono',monospace;">${fmtCurrency(p)} profit</td>
            <td style="font-family:'JetBrains Mono',monospace;color:var(--success);">${fmtCurrency(val)}</td>
            <td style="font-family:'JetBrains Mono',monospace;color:var(--success);">+${fmtCurrency(gain)}</td>
            <td>${p === IP_GOAL_PROFIT ? '<span class="badge badge-gold">üéØ PAYOUT TARGET</span>' : ''}</td>
        </tr>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVESTOR ADMIN FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ipRenderAdminInvestors() {
    const bal = IP_MASTER_START + ipMasterProfit;
    const pct = Math.min(ipMasterProfit / IP_GOAL_PROFIT * 100, 100);
    document.getElementById('ipMasterBal').textContent = fmtCurrency(bal);
    document.getElementById('ipMasterProfit').textContent = fmtCurrency(ipMasterProfit);
    document.getElementById('ipProfitPct').textContent = pct.toFixed(1) + '% of $4,600 goal';
    document.getElementById('ipInvestorCount').textContent = ipInvestors.length;
    document.getElementById('ipProgLabel').textContent = fmtCurrency(ipMasterProfit) + ' profit';
    document.getElementById('ipProgFill').style.width = pct.toFixed(1) + '%';
    document.getElementById('ipProgPct').textContent = pct.toFixed(1) + '% to goal';
    document.getElementById('ipProfitInput').value = ipMasterProfit;

    const tbody = document.getElementById('ipInvestorTableBody');
    if (!ipInvestors.length) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No investors yet. Add one below.</td></tr>';
    } else {
        tbody.innerHTML = ipInvestors.map((inv, idx) => {
            const entry = parseFloat(inv.entry_point) || 115;
            const mult  = ipCalcMultiplier(entry);
            const dv    = ipCalcDisplayValue(entry, ipMasterProfit);
            const pct2  = Math.min(dv / IP_PAYOUT_TARGET * 100, 100);
            return `<tr>
                <td><strong>${inv.name || '‚Äî'}</strong></td>
                <td style="color:var(--text-muted);font-size:0.82rem;">${inv.email || '‚Äî'}</td>
                <td style="font-family:'JetBrains Mono',monospace;">${fmtCurrency(entry)}</td>
                <td style="font-family:'JetBrains Mono',monospace;color:var(--purple);">${mult.toFixed(4)}x</td>
                <td style="font-family:'JetBrains Mono',monospace;color:${dv >= IP_PAYOUT_TARGET ? 'var(--gold)' : 'var(--success)'};">${fmtCurrency(dv)}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div style="flex:1;height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;max-width:80px;">
                            <div style="height:100%;width:${pct2.toFixed(0)}%;background:${dv>=IP_PAYOUT_TARGET?'var(--gold)':'var(--accent)'};border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.72rem;color:var(--text-muted);">${pct2.toFixed(0)}%</span>
                    </div>
                </td>
                <td><button class="btn btn-secondary" style="padding:0.25rem 0.6rem;font-size:0.72rem;" onclick="ipRemoveInvestor(${idx})">‚úï Remove</button></td>
            </tr>`;
        }).join('');
    }
}

async function ipUpdateProfit() {
    const val = parseFloat(document.getElementById('ipProfitInput').value);
    if (isNaN(val) || val < 0) { showAlert('Enter a valid profit amount', 'error'); return; }
    ipMasterProfit = Math.min(Math.max(0, val), IP_GOAL_PROFIT * 2);
    try { await sb.from('investor_portal_config').upsert({ id:'master_state', value:{ profit:ipMasterProfit } }); } catch(_) {}
    ipRenderAdminInvestors();
    showAlert('‚úì Master profit updated to ' + fmtCurrency(ipMasterProfit), 'success');
}

async function ipAddInvestor() {
    const name  = document.getElementById('ipNewName').value.trim();
    const email = document.getElementById('ipNewEmail').value.trim();
    const entry = parseFloat(document.getElementById('ipNewEntry').value);
    if (!name || !email || isNaN(entry) || entry <= 0) { showAlert('Please fill all fields with valid values', 'error'); return; }
    if (ipInvestors.find(i => i.email?.toLowerCase() === email.toLowerCase())) { showAlert('Investor with this email already exists', 'error'); return; }
    const inv = { id: crypto.randomUUID(), name, email, entry_point: entry, created_at: new Date().toISOString() };
    try { await sb.from('investor_portal_investors').upsert(inv); } catch(_) {}
    ipInvestors.push(inv);
    ipClearNewForm();
    ipRenderAdminInvestors();
    showAlert(`‚úì ${name} added as investor`, 'success');
}

async function ipRemoveInvestor(idx) {
    const inv = ipInvestors[idx];
    if (!confirm(`Remove ${inv.name || inv.email} from the investor portal?`)) return;
    try { await sb.from('investor_portal_investors').delete().eq('id', inv.id); } catch(_) {}
    ipInvestors.splice(idx, 1);
    ipRenderAdminInvestors();
    showAlert(`Removed ${inv.name || inv.email}`, 'success');
}

function ipClearNewForm() {
    document.getElementById('ipNewName').value = '';
    document.getElementById('ipNewEmail').value = '';
    document.getElementById('ipNewEntry').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN USER MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _adminProfiles = [];

async function loadAdminData() {
    try {
        const { data: profiles } = await sb.from('investor_profiles').select('*').order('created_at', { ascending: false });
        _adminProfiles = profiles || [];

        const total = _adminProfiles.length;
        const pending = _adminProfiles.filter(p => !p.approved && p.role !== 'admin').length;
        const approved = _adminProfiles.filter(p => p.approved || p.role === 'admin').length;

        document.getElementById('adminTotalUsers').textContent = total;
        document.getElementById('adminPendingCount').textContent = pending;
        document.getElementById('adminApprovedCount').textContent = approved;
        document.getElementById('adminInvestorMetric').textContent = ipInvestors.length || '‚Äî';

        renderAdminUsers(_adminProfiles);

        // Also refresh investor tab data
        await loadPortalData();
        ipRenderAdminInvestors();
    } catch(err) {
        showAlert('Failed to load admin data: ' + err.message, 'error');
    }
}

function renderAdminUsers(profiles) {
    const tbody = document.getElementById('adminUsersBody');
    if (!profiles.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted);">No users found</td></tr>';
        return;
    }
    tbody.innerHTML = profiles.map(p => {
        const isApproved = p.approved === true || p.role === 'admin';
        const isPending  = !isApproved;
        if (isPending) {
            // Highlight pending rows
        }
        const statusBadge = isPending
            ? `<span class="badge badge-warning">‚è≥ Pending</span>`
            : `<span class="badge badge-success">‚úì Approved</span>`;
        const roleBadge = p.role === 'admin'
            ? `<span class="badge badge-gold">üëë Admin</span>`
            : `<span class="badge badge-accent">User</span>`;
        const joined = p.created_at ? new Date(p.created_at).toLocaleDateString() : '‚Äî';
        return `<tr style="${isPending ? 'background:rgba(245,166,35,0.03);' : ''}" data-email="${(p.email||'').toLowerCase()}">
            <td>
                <div style="font-weight:700;font-size:0.875rem;">${p.name || p.email || '‚Äî'}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${p.email || ''}</div>
            </td>
            <td>${statusBadge}</td>
            <td>${roleBadge}</td>
            <td style="color:var(--text-muted);font-size:0.82rem;">${joined}</td>
            <td>
                <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                    ${isPending
                        ? `<button class="btn btn-success" style="padding:0.3rem 0.6rem;font-size:0.72rem;" onclick="approveUser('${p.id}','${p.email}')">‚úì Approve</button>`
                        : `<button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.72rem;" onclick="revokeUser('${p.id}','${p.email}')">‚úï Revoke</button>`
                    }
                    <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.72rem;" onclick="toggleRole('${p.id}','${p.role||'user'}','${p.email}')">${p.role === 'admin' ? '‚Üì Demote' : '‚Üë Admin'}</button>
                    <button class="btn btn-danger" style="padding:0.3rem 0.6rem;font-size:0.72rem;" onclick="removeUser('${p.id}','${p.email}')">üóë</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function filterAdminUsers() {
    const q = document.getElementById('adminUserSearch').value.toLowerCase();
    document.querySelectorAll('#adminUsersBody tr').forEach(row => {
        row.style.display = !q || (row.dataset.email || '').includes(q) ? '' : 'none';
    });
}

async function approveUser(userId, email) {
    const { error } = await sb.from('investor_profiles').update({ approved: true }).eq('id', userId);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì ${email} approved`, 'success');
    loadAdminData();
}

async function revokeUser(userId, email) {
    if (!confirm(`Revoke access for ${email}?`)) return;
    const { error } = await sb.from('investor_profiles').update({ approved: false }).eq('id', userId);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`Access revoked for ${email}`, 'success');
    loadAdminData();
}

async function toggleRole(userId, currentRole, email) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const approved = newRole === 'admin' ? true : undefined;
    const update = approved !== undefined ? { role: newRole, approved } : { role: newRole };
    if (!confirm(`Change ${email} to role: ${newRole}?`)) return;
    const { error } = await sb.from('investor_profiles').update(update).eq('id', userId);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì ${email} is now ${newRole}`, 'success');
    loadAdminData();
}

async function removeUser(userId, email) {
    if (!confirm(`‚ö†Ô∏è Permanently delete all data for ${email}? This cannot be undone.`)) return;
    await sb.from('investor_profiles').delete().eq('id', userId);
    showAlert(`Deleted ${email}`, 'success');
    loadAdminData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', checkSession);
</script>
</body>
</html>
