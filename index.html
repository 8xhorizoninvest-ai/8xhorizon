<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        /* ══════════════════════════════════════
           THEME SYSTEM — default: Midnight Blue
           ══════════════════════════════════════ */
        :root {
            --bg: #0a0e1a;
            --bg-card: #0f1629;
            --bg-elevated: #1a2035;
            --bg-hover: #1e2844;
            --border: rgba(99,179,237,0.12);
            --border-glow: rgba(99,179,237,0.3);
            --text: #e8f0ff;
            --text-muted: #7a8bb5;
            --text-dim: #3d4f78;
            --accent: #3b7ef8;
            --accent-glow: rgba(59,126,248,0.25);
            --accent-hover: #5a95ff;
            --success: #22d3a0;
            --success-glow: rgba(34,211,160,0.2);
            --danger: #f05c6a;
            --danger-glow: rgba(240,92,106,0.2);
            --warning: #f5a623;
            --warning-glow: rgba(245,166,35,0.2);
            --purple: #9b6ffa;
            --cyan: #06d6d6;
            --gold: #ffd166;
            --radius: 14px;
            --radius-sm: 8px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 40px rgba(59,126,248,0.15);
        }

        /* ── THEME: Aurora (White + Purple + Sky) ── */
        [data-theme="aurora"] {
            --bg: #f0f4ff;
            --bg-card: #ffffff;
            --bg-elevated: #eef1fb;
            --bg-hover: #e4eaff;
            --border: rgba(139,92,246,0.18);
            --border-glow: rgba(139,92,246,0.45);
            --text: #1a1040;
            --text-muted: #6b5fa8;
            --text-dim: #a89fd4;
            --accent: #7c3aed;
            --accent-glow: rgba(124,58,237,0.25);
            --accent-hover: #6d28d9;
            --success: #059669;
            --success-glow: rgba(5,150,105,0.2);
            --danger: #dc2626;
            --danger-glow: rgba(220,38,38,0.15);
            --warning: #d97706;
            --warning-glow: rgba(217,119,6,0.15);
            --purple: #7c3aed;
            --cyan: #0284c7;
            --gold: #b45309;
            --shadow: 0 4px 24px rgba(124,58,237,0.12);
            --shadow-glow: 0 0 40px rgba(124,58,237,0.18);
        }

        /* ── THEME: Cosmic (Deep Purple + Violet) ── */
        [data-theme="cosmic"] {
            --bg: #0d0720;
            --bg-card: #130a2e;
            --bg-elevated: #1e1040;
            --bg-hover: #261550;
            --border: rgba(167,139,250,0.15);
            --border-glow: rgba(167,139,250,0.4);
            --text: #ede9ff;
            --text-muted: #9d86e9;
            --text-dim: #4a3882;
            --accent: #a855f7;
            --accent-glow: rgba(168,85,247,0.3);
            --accent-hover: #c084fc;
            --success: #34d399;
            --success-glow: rgba(52,211,153,0.2);
            --danger: #f87171;
            --danger-glow: rgba(248,113,113,0.2);
            --warning: #fbbf24;
            --warning-glow: rgba(251,191,36,0.2);
            --purple: #c084fc;
            --cyan: #22d3ee;
            --gold: #fcd34d;
            --shadow: 0 4px 24px rgba(0,0,0,0.6);
            --shadow-glow: 0 0 40px rgba(168,85,247,0.2);
        }

        /* ── THEME: Ocean (Sky Blue + Teal) ── */
        [data-theme="ocean"] {
            --bg: #020c18;
            --bg-card: #041525;
            --bg-elevated: #082035;
            --bg-hover: #0c2a42;
            --border: rgba(14,165,233,0.15);
            --border-glow: rgba(14,165,233,0.4);
            --text: #e0f4ff;
            --text-muted: #5da8cc;
            --text-dim: #235470;
            --accent: #0ea5e9;
            --accent-glow: rgba(14,165,233,0.28);
            --accent-hover: #38bdf8;
            --success: #2dd4bf;
            --success-glow: rgba(45,212,191,0.2);
            --danger: #fb7185;
            --danger-glow: rgba(251,113,133,0.2);
            --warning: #f59e0b;
            --warning-glow: rgba(245,158,11,0.2);
            --purple: #818cf8;
            --cyan: #22d3ee;
            --gold: #fbbf24;
            --shadow: 0 4px 24px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 40px rgba(14,165,233,0.18);
        }

        /* ── THEME: Ember (Dark + Orange + Red) ── */
        [data-theme="ember"] {
            --bg: #0f0a04;
            --bg-card: #1a1008;
            --bg-elevated: #251805;
            --bg-hover: #2e2008;
            --border: rgba(251,146,60,0.15);
            --border-glow: rgba(251,146,60,0.4);
            --text: #fff5e8;
            --text-muted: #c28a55;
            --text-dim: #6b4520;
            --accent: #f97316;
            --accent-glow: rgba(249,115,22,0.28);
            --accent-hover: #fb923c;
            --success: #86efac;
            --success-glow: rgba(134,239,172,0.2);
            --danger: #fca5a5;
            --danger-glow: rgba(252,165,165,0.2);
            --warning: #fcd34d;
            --warning-glow: rgba(252,211,77,0.2);
            --purple: #c084fc;
            --cyan: #67e8f9;
            --gold: #fde68a;
            --shadow: 0 4px 24px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 40px rgba(249,115,22,0.15);
        }

        /* ══════ THEME SWITCHER WIDGET ══════ */
        #themeSwitcherBtn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 8000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: #fff;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow), 0 0 0 3px rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #themeSwitcherBtn:hover { transform: scale(1.1); box-shadow: 0 6px 30px var(--accent-glow); }

        #themeSwitcherPanel {
            position: fixed;
            bottom: 5.5rem;
            right: 1.5rem;
            z-index: 8000;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 1.25rem;
            width: 260px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05);
            transform: scale(0.9) translateY(10px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.34,1.56,0.64,1);
        }
        #themeSwitcherPanel.open {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: all;
        }
        .ts-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        .ts-themes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }
        .ts-theme-btn {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.7rem 0.5rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.18s;
            background: var(--bg-elevated);
            position: relative;
            overflow: hidden;
        }
        .ts-theme-btn:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.25); }
        .ts-theme-btn.active { border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
        .ts-theme-btn.active::after { content:'✓'; position:absolute; top:4px; right:6px; font-size:0.6rem; color:var(--accent); font-weight:800; }
        .ts-swatch { display: flex; gap: 3px; }
        .ts-swatch span { width: 10px; height: 10px; border-radius: 50%; display: block; }
        .ts-label { font-size: 0.68rem; font-weight: 700; color: var(--text-muted); text-align: center; }

        /* ══ AURORA (light) component overrides ══ */
        [data-theme="aurora"] body { background: #f0f4ff; }
        [data-theme="aurora"] .sidebar { background: #ffffff; border-right-color: rgba(139,92,246,0.15); }
        [data-theme="aurora"] .sidebar-logo h2 { background: linear-gradient(135deg, #1a1040, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        [data-theme="aurora"] .nav-item { color: #4b4080; }
        [data-theme="aurora"] .nav-item:hover, [data-theme="aurora"] .nav-item.active { background: rgba(124,58,237,0.08); color: #7c3aed; }
        [data-theme="aurora"] .topbar { background: rgba(240,244,255,0.95); border-bottom-color: rgba(139,92,246,0.15); }
        [data-theme="aurora"] .table-card, [data-theme="aurora"] .form-card { background: #ffffff; border-color: rgba(139,92,246,0.12); }
        [data-theme="aurora"] th { background: rgba(124,58,237,0.05); color: #4b4080; }
        [data-theme="aurora"] .hero { background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 50%, #0284c7 100%); }
        [data-theme="aurora"] .logout-btn { background: rgba(220,38,38,0.08); color: #dc2626; border-color: rgba(220,38,38,0.2); }
        [data-theme="aurora"] .logout-btn:hover { background: rgba(220,38,38,0.15); }
        [data-theme="aurora"] .sidebar-footer { border-top-color: rgba(139,92,246,0.12); }
        [data-theme="aurora"] .user-chip { background: rgba(124,58,237,0.06); border-color: rgba(139,92,246,0.12); }
        [data-theme="aurora"] .nav-label { color: #a89fd4; }
        [data-theme="aurora"] .page-title { color: #1a1040; }
        [data-theme="aurora"] .icon-btn { background: rgba(124,58,237,0.08); color: #7c3aed; border-color: rgba(139,92,246,0.2); }
        [data-theme="aurora"] .metric-card { background: #fff; border-color: rgba(139,92,246,0.12); color: #1a1040; }
        [data-theme="aurora"] .card-title { color: #1a1040; }
        [data-theme="aurora"] #themeSwitcherPanel { box-shadow: 0 12px 40px rgba(124,58,237,0.15), 0 0 0 1px rgba(139,92,246,0.15); }
        /* ════════════════════════════════════════ */

        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; min-height: 100vh; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 3px; }

        /* ── AUTH SCREEN ── */
        .auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: flex-start; justify-content: center; z-index: 9999; transition: opacity 0.4s ease; overflow-y: auto; padding: 1.5rem 1rem; }
        .auth-screen.hidden { opacity: 0; pointer-events: none; display: none !important; }
        .auth-bg { position: fixed; inset: 0; background: radial-gradient(ellipse 80% 60% at 50% -20%, rgba(59,126,248,0.15) 0%, transparent 70%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(155,111,250,0.1) 0%, transparent 60%); pointer-events: none; }
        .auth-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(99,179,237,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(99,179,237,0.04) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 30%, transparent 100%); pointer-events: none; }
        .auth-box { position: relative; z-index: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 3rem; width: 460px; max-width: 95vw; box-shadow: var(--shadow), 0 0 60px rgba(59,126,248,0.08); margin: auto; align-self: flex-start; }
        .auth-logo { text-align: center; margin-bottom: 2rem; }
        .auth-logo .logo-icon { font-size: 3rem; display: block; margin-bottom: 0.75rem; filter: drop-shadow(0 0 20px rgba(59,126,248,0.6)); }
        .auth-logo h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.03em; background: linear-gradient(135deg, #e8f0ff 0%, #7ab4ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-logo p { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }
        .auth-tabs { display: flex; background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 4px; margin-bottom: 2rem; gap: 4px; }
        .auth-tab { flex: 1; padding: 0.5rem; border: none; border-radius: 6px; font-family: inherit; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text-muted); }
        .auth-tab.active { background: var(--accent); color: white; box-shadow: 0 0 12px var(--accent-glow); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .forgot-link { text-align: right; margin-top: -0.75rem; margin-bottom: 1rem; }
        .forgot-link a { color: var(--accent); font-size: 0.8rem; text-decoration: none; cursor: pointer; }
        .forgot-link a:hover { text-decoration: underline; }

        /* ── FORM BASICS ── */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-input::placeholder { color: var(--text-dim); }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-select { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; transition: all 0.2s; cursor: pointer; }
        .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-select option { background: var(--bg-elevated); }
        .form-textarea { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; min-height: 100px; resize: vertical; transition: all 0.2s; }
        .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; margin-bottom: 1.25rem; }
        .form-footer { display: flex; gap: 0.75rem; padding-top: 1.25rem; border-top: 1px solid var(--border); }
        .checkbox-label { display: flex; align-items: center; gap: 0.625rem; cursor: pointer; font-size: 0.9rem; }
        .checkbox-label input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }

        /* ── BUTTONS ── */
        .btn { padding: 0.875rem 1.5rem; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 0 30px rgba(59,126,248,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary.full-width { width: 100%; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--border-glow); }
        .btn-danger { background: var(--danger-glow); color: var(--danger); border: 1px solid rgba(240,92,106,0.3); }
        .btn-danger:hover { background: rgba(240,92,106,0.3); }
        .btn-oauth { width: 100%; background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); margin-bottom: 0.75rem; }
        .btn-oauth:hover { border-color: var(--border-glow); background: var(--bg-hover); }
        .btn-success { background: rgba(34,211,160,0.15); color: var(--success); border: 1px solid rgba(34,211,160,0.3); }
        .btn-success:hover { background: rgba(34,211,160,0.25); }

        /* ── MESSAGES ── */
        .auth-error { background: var(--danger-glow); border: 1px solid rgba(240,92,106,0.3); color: var(--danger); padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .auth-error.show { display: block; }
        .auth-success { background: var(--success-glow); border: 1px solid rgba(34,211,160,0.3); color: var(--success); padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .auth-success.show { display: block; }
        .divider { display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0; color: var(--text-dim); font-size: 0.8rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* ── DASHBOARD ── */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.show { display: flex; }

        /* ── SIDEBAR ── */
        .sidebar { width: 260px; flex-shrink: 0; background: var(--bg-card); border-right: 1px solid var(--border); height: 100vh; position: sticky; top: 0; overflow-y: auto; padding: 1.5rem 1rem; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 200; }
        .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; margin-bottom: 1.5rem; }
        .sidebar-logo .logo-em { font-size: 1.75rem; filter: drop-shadow(0 0 8px rgba(59,126,248,0.5)); }
        .sidebar-logo h2 { font-size: 1.125rem; font-weight: 700; letter-spacing: -0.02em; background: linear-gradient(135deg, #e8f0ff, #7ab4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-chip { display: flex; align-items: center; gap: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem; margin-bottom: 1.5rem; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .user-role.admin { color: var(--gold); }
        .user-role.investor { color: var(--purple); }

        /* ── INVESTOR MODE: CSS-level block on all trader pages ── */
        body.role-investor #traderNavMain,
        body.role-investor #traderNavActions { display: none !important; }

        body.role-investor .page#overviewPage,
        body.role-investor .page#cyclePerformancePage,
        body.role-investor .page#templatesPage,
        body.role-investor .page#accountsPage,
        body.role-investor .page#analyticsPage,
        body.role-investor .page#riskMonitorPage,
        body.role-investor .page#addTradePage,
        body.role-investor .page#logPayoutPage,
        body.role-investor .page#tradeLogPage,
        body.role-investor .page#deleteDataPage,
        body.role-investor .page#shareJournalPage,
        body.role-investor .page#psychologyPage,
        body.role-investor .page#settingsPage { display: none !important; }

        body.role-investor .nav-item[data-page="settings"] { display: none !important; }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); padding: 0 0.75rem; margin-bottom: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-weight: 500; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text); }
        .nav-item.active { background: rgba(59,126,248,0.15); color: var(--accent); border: 1px solid rgba(59,126,248,0.2); }
        .nav-item .nav-icon { font-size: 1.1rem; width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
        .logout-btn { width: 100%; padding: 0.625rem 0.75rem; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: var(--text-muted); font-family: inherit; font-size: 0.9rem; font-weight: 500; border-radius: var(--radius-sm); transition: all 0.15s; }
        .logout-btn:hover { background: var(--danger-glow); color: var(--danger); }

        /* ── MAIN ── */
        .main { flex: 1; overflow-x: hidden; min-width: 0; }
        .topbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .page-title { font-size: 1.375rem; font-weight: 700; letter-spacing: -0.02em; }
        .menu-btn { display: none; background: none; border: none; cursor: pointer; color: var(--text); font-size: 1.5rem; }
        .topbar-right { display: flex; align-items: center; gap: 0.75rem; }
        .icon-btn { width: 38px; height: 38px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--text-muted); }
        .icon-btn:hover { border-color: var(--border-glow); color: var(--text); }
        .container { padding: 2rem; max-width: 1600px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; }
        .overlay.show { display: block; }

        /* ── PAGES ── */
        .page { display: none; }
        .page.active { display: block; }

        /* ── ALERT ── */
        .alert { padding: 1rem 1.25rem; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 500; margin-bottom: 1.5rem; display: none; animation: slideDown 0.3s ease; }
        .alert.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .alert-success { background: var(--success-glow); border: 1px solid rgba(34,211,160,0.3); color: var(--success); }
        .alert-error { background: var(--danger-glow); border: 1px solid rgba(240,92,106,0.3); color: var(--danger); }
        .alert-info { background: var(--accent-glow); border: 1px solid rgba(59,126,248,0.3); color: #7ab4ff; }
        .alert-warning { background: var(--warning-glow); border: 1px solid rgba(245,166,35,0.3); color: var(--warning); }

        /* ── HERO ── */
        .hero { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; position: relative; overflow: hidden; }
        .hero-glow { position: absolute; top: -60px; right: -60px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(59,126,248,0.12) 0%, transparent 70%); pointer-events: none; }
        .hero-greeting { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .hero-title { font-size: 2rem; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 1.5rem; }
        .hero-title span { background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-stats { display: flex; gap: 2.5rem; flex-wrap: wrap; }
        .hero-stat-value { font-size: 1.75rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; }
        .hero-stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }

        /* ── METRICS ── */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card { background: linear-gradient(145deg,var(--bg-card),#0d1527); border: 1px solid var(--border); border-radius: 18px; padding: 1.5rem; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position:relative; overflow:hidden; }
        .metric-card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,rgba(99,179,237,0.12),transparent); pointer-events:none; }
        .metric-card:hover { border-color: var(--border-glow); transform: translateY(-2px); box-shadow: var(--shadow-glow); }
        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .metric-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .metric-icon { font-size: 1.25rem; }
        .metric-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; margin-bottom: 0.25rem; }
        .metric-sub { font-size: 0.8rem; color: var(--text-muted); }
        .metric-sub.pos { color: var(--success); }
        .metric-sub.neg { color: var(--danger); }

        /* ── CARDS ── */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1rem; font-weight: 700; letter-spacing: -0.01em; }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .card-body { padding: 1.5rem; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .chart-grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .chart-wrap { position: relative; height: 260px; }
        .chart-wrap-sm { position: relative; height: 200px; }

        /* ── STATS ROW ── */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }

        /* ── QUICK ACTIONS ── */
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .action-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem; }
        .action-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px var(--accent-glow); }
        .action-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
        .action-icon.blue { background: rgba(59,126,248,0.15); }
        .action-icon.green { background: rgba(34,211,160,0.15); }
        .action-icon.purple { background: rgba(155,111,250,0.15); }
        .action-icon.gold { background: rgba(255,209,102,0.15); }
        .action-icon.teal { background: rgba(6,214,214,0.15); }
        .action-info h4 { font-size: 0.875rem; font-weight: 700; margin-bottom: 0.2rem; }
        .action-info p { font-size: 0.75rem; color: var(--text-muted); }

        /* ── ACCOUNT CARDS ── */
        .accounts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .acc-card { background: linear-gradient(145deg, var(--bg-card), #0d1527); border: 1px solid var(--border); border-radius: 18px; padding: 1.35rem; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position: relative; overflow: hidden; }
        .acc-card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,rgba(99,179,237,0.12),transparent); pointer-events:none; }
        .acc-card:hover { border-color: var(--border-glow); transform: translateY(-3px); box-shadow: 0 16px 50px rgba(0,0,0,0.45), 0 0 25px rgba(59,126,248,0.07); }
        .acc-card.at-risk { border-color: rgba(240,92,106,0.45); background: linear-gradient(145deg,rgba(240,92,106,0.04),#0d1527); animation: atRiskPulse 2.5s ease infinite; }
        .acc-card.warning-card { border-color: rgba(245,166,35,0.45); animation: warnPulse 3s ease infinite; }
        .acc-card.goal-reached { border-color: rgba(34,211,160,0.45); background: linear-gradient(145deg,rgba(34,211,160,0.04),#0d1527); }
        @keyframes atRiskPulse { 0%,100%{box-shadow:0 0 0 0 rgba(240,92,106,0)} 50%{box-shadow:0 0 20px 0 rgba(240,92,106,0.15)} }
        @keyframes warnPulse { 0%,100%{box-shadow:0 0 0 0 rgba(245,166,35,0)} 50%{box-shadow:0 0 18px 0 rgba(245,166,35,0.12)} }
        .acc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.9rem; }
        .acc-num { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .acc-nickname { font-size: 0.7rem; color: var(--cyan); font-weight: 600; margin-top: 2px; letter-spacing:0.03em; }
        .badge { padding: 0.25rem 0.65rem; border-radius: 20px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; border: 1px solid transparent; }
        .badge-success { background: rgba(34,211,160,0.12); color: var(--success); border-color:rgba(34,211,160,0.3); }
        .badge-active { background: rgba(59,126,248,0.12); color: var(--accent); border-color:rgba(59,126,248,0.25); }
        .badge-danger { background: rgba(240,92,106,0.12); color: var(--danger); border-color:rgba(240,92,106,0.3); }
        .badge-warning { background: rgba(245,166,35,0.12); color: var(--warning); border-color:rgba(245,166,35,0.3); }
        .badge-muted { background: rgba(122,139,181,0.1); color: var(--text-dim); }
        .badge-admin { background: rgba(255,209,102,0.12); color: var(--gold); border-color:rgba(255,209,102,0.3); }
        .badge-gold { background: rgba(255,209,102,0.12); color: var(--gold); border-color:rgba(255,209,102,0.3); }
        /* Enhanced progress bar */
        .acc-progress { margin-bottom: 1rem; }
        .prog-header { display: flex; justify-content: space-between; font-size: 0.78rem; margin-bottom: 0.45rem; }
        .prog-bar { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
        .prog-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.9s cubic-bezier(0.4,0,0.2,1); position: relative; }
        .prog-fill::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.15) 50%,transparent 100%); background-size:200% 100%; animation:shimmer 2s ease infinite; }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .prog-fill.red { background: linear-gradient(90deg, #c0392b, var(--danger)); }
        .prog-fill.green { background: linear-gradient(90deg, #16a34a, var(--success)); box-shadow:0 0 8px rgba(34,211,160,0.4); }
        .prog-fill.negative { background: linear-gradient(90deg, var(--danger), rgba(240,92,106,0.7)); box-shadow:0 0 6px rgba(240,92,106,0.35); }
        /* Dual bar (for negative showing drawdown + progress center) */
        .prog-dual { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; display: flex; overflow: hidden; }
        .prog-dual-neg { background: linear-gradient(90deg, rgba(240,92,106,0.6), rgba(240,92,106,0.85)); transition: width 0.9s ease; }
        .prog-dual-gap { flex: 1; }
        .acc-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .acc-stat-lbl { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.2rem; }
        .acc-stat-val { font-size: 0.95rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .acc-name-edit { display: flex; align-items: center; gap: 0.4rem; margin-top: 0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); }
        .acc-name-input { flex: 1; padding: 0.3rem 0.6rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem; font-family: inherit; }
        .acc-name-input:focus { outline: none; border-color: var(--accent); box-shadow:0 0 0 2px var(--accent-glow); }
        /* Toast notification system */
        #alertToastContainer { position:fixed; top:1.25rem; right:1.25rem; z-index:99999; display:flex; flex-direction:column; gap:0.625rem; pointer-events:none; max-width:400px; }
        .alert-toast { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:1rem 1.25rem; width:100%; box-shadow:0 8px 40px rgba(0,0,0,0.5); display:flex; align-items:flex-start; gap:0.875rem; pointer-events:all; animation:toastIn 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards; }
        .alert-toast.removing { animation:toastOut 0.3s ease forwards; }
        .alert-toast.toast-warning { border-color:rgba(245,166,35,0.5); background:linear-gradient(135deg,#0f1629,rgba(245,166,35,0.05)); }
        .alert-toast.toast-danger { border-color:rgba(240,92,106,0.5); background:linear-gradient(135deg,#0f1629,rgba(240,92,106,0.05)); }
        .alert-toast.toast-success { border-color:rgba(34,211,160,0.5); background:linear-gradient(135deg,#0f1629,rgba(34,211,160,0.05)); }
        .alert-toast.toast-info { border-color:rgba(59,126,248,0.5); background:linear-gradient(135deg,#0f1629,rgba(59,126,248,0.05)); }
        .toast-icon { font-size:1.4rem; flex-shrink:0; line-height:1; }
        .toast-body { flex:1; min-width:0; }
        .toast-title { font-size:0.84rem; font-weight:700; margin-bottom:0.2rem; }
        .toast-msg { font-size:0.76rem; color:var(--text-muted); line-height:1.5; }
        .toast-close { cursor:pointer; color:var(--text-dim); font-size:1.1rem; flex-shrink:0; background:none; border:none; padding:0; line-height:1; transition:color 0.15s; }
        .toast-close:hover { color:var(--text); }
        @keyframes toastIn { from{opacity:0;transform:translateX(30px) scale(0.93)} to{opacity:1;transform:translateX(0) scale(1)} }
        @keyframes toastOut { from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(30px)} }

        /* ── TEMPLATE CARDS ── */
        .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .tmpl-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; transition: all 0.2s; }
        .tmpl-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .tmpl-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem; }
        .tmpl-icon { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .tmpl-name { font-size: 1.05rem; font-weight: 700; }
        .tmpl-desc { font-size: 0.8rem; color: var(--text-muted); }
        .tmpl-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; text-align: center; }
        .tmpl-stat-val { font-size: 1.3rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .tmpl-stat-lbl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
        .tmpl-details { border-top: 1px solid var(--border); padding-top: 1rem; display: grid; gap: 0.5rem; }
        .tmpl-row { display: flex; justify-content: space-between; font-size: 0.85rem; }
        .tmpl-row span:first-child { color: var(--text-muted); }
        .tmpl-row span:last-child { font-weight: 600; font-family: 'JetBrains Mono', monospace; }

        /* ── FORM CARD ── */
        .form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; max-width: 900px; }

        /* ── TABLE ── */
        .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .table-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 0.75rem 1.25rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); background: var(--bg-elevated); border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 0.875rem 1.25rem; border-bottom: 1px solid rgba(99,179,237,0.06); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg-hover); }

        /* ── FILTER PILLS ── */
        .filter-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
        .pill { padding: 0.4rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.15s; color: var(--text-muted); }
        .pill:hover { border-color: var(--border-glow); color: var(--text); }
        .pill.active { background: rgba(59,126,248,0.15); border-color: rgba(59,126,248,0.4); color: var(--accent); }

        /* ── ADMIN ── */
        .admin-banner { background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(155,111,250,0.1)); border: 1px solid rgba(255,209,102,0.3); border-radius: var(--radius); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .admin-banner-icon { font-size: 1.5rem; }
        .admin-banner-text strong { color: var(--gold); display: block; font-size: 0.875rem; }
        .admin-banner-text span { color: var(--text-muted); font-size: 0.8rem; }
        .admin-view-banner { background: rgba(155,111,250,0.1); border: 1px solid rgba(155,111,250,0.3); border-radius: var(--radius-sm); padding: 0.75rem 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .admin-view-banner span { color: var(--purple); font-size: 0.875rem; }

        /* ── RISK INFO ── */
        .risk-info { margin-top: 0.75rem; padding: 0.625rem; border-radius: var(--radius-sm); font-size: 0.8rem; font-weight: 500; }
        .risk-info.safe { background: rgba(34,211,160,0.1); color: var(--success); }
        .risk-info.warning { background: var(--warning-glow); color: var(--warning); }
        .risk-info.danger { background: var(--danger-glow); color: var(--danger); }

        /* ── SECTION HEADER ── */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }

        /* ── LOADING ── */
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state { display: flex; align-items: center; justify-content: center; padding: 4rem; color: var(--text-muted); flex-direction: column; gap: 1rem; }
        .loading-state .spinner { border-top-color: var(--accent); border-color: rgba(59,126,248,0.3); width: 32px; height: 32px; border-width: 3px; }

        /* ══════════════════════════════════════════ */
        /* ── PSYCHOLOGY PAGE STYLES ── */
        /* ══════════════════════════════════════════ */
        .psych-hero { background: linear-gradient(135deg, rgba(155,111,250,0.15), rgba(59,126,248,0.1)); border: 1px solid rgba(155,111,250,0.25); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; text-align: center; position: relative; overflow: hidden; }
        .psych-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 60% 60% at 50% 0%, rgba(155,111,250,0.15) 0%, transparent 70%); }
        .psych-hero-emoji { font-size: 3.5rem; display: block; margin-bottom: 1rem; filter: drop-shadow(0 0 20px rgba(155,111,250,0.5)); position: relative; }
        .psych-hero-title { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 0.5rem; position: relative; }
        .psych-hero-subtitle { color: var(--text-muted); font-size: 0.9rem; position: relative; }
        .daily-quote-card { background: linear-gradient(135deg, rgba(59,126,248,0.1), rgba(155,111,250,0.08)); border: 1px solid rgba(155,111,250,0.3); border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; text-align: center; position: relative; }
        .daily-quote-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--purple); margin-bottom: 1rem; }
        .daily-quote-text { font-size: 1.25rem; font-weight: 500; line-height: 1.6; color: var(--text); margin-bottom: 1rem; font-style: italic; }
        .daily-quote-author { font-size: 0.85rem; color: var(--text-muted); }
        .quote-nav { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .quote-nav-btn { width: 36px; height: 36px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--text-muted); }
        .quote-nav-btn:hover { border-color: var(--purple); color: var(--purple); }
        .quote-counter { font-size: 0.8rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
        .psych-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .psych-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
        .psych-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; }
        .psych-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .psych-card-title { font-size: 1rem; font-weight: 700; }
        .rule-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .rule-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: var(--radius-sm); }
        .rule-num { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; color: white; }
        .rule-text { font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .mood-btn { padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; text-align: center; font-size: 1.5rem; transition: all 0.15s; }
        .mood-btn:hover { border-color: var(--accent); transform: scale(1.05); }
        .mood-btn.selected { border-color: var(--accent); background: rgba(59,126,248,0.15); }
        .mood-label { font-size: 0.65rem; color: var(--text-muted); display: block; margin-top: 0.3rem; font-family: inherit; }
        .affirmation-list { display: flex; flex-direction: column; gap: 0.625rem; }
        .affirmation-item { padding: 0.75rem 1rem; background: var(--bg-elevated); border-left: 3px solid var(--purple); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 0.875rem; color: var(--text-muted); }
        .checklist-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: all 0.15s; }
        .checklist-item:hover { background: var(--bg-hover); }
        .checklist-item.done { opacity: 0.5; }
        .checklist-item.done .checklist-text { text-decoration: line-through; }
        .checklist-checkbox { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border-glow); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .checklist-item.done .checklist-checkbox { background: var(--success); border-color: var(--success); }
        .checklist-text { font-size: 0.875rem; color: var(--text-muted); }
        .journal-textarea { width: 100%; min-height: 120px; padding: 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9rem; resize: vertical; }
        .journal-textarea:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 0 3px rgba(155,111,250,0.15); }
        .streak-display { text-align: center; padding: 1.5rem; }
        .streak-number { font-size: 3.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--gold), var(--warning)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .streak-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
        .trading-tips { display: grid; gap: 0.75rem; }
        .tip-item { padding: 1rem; background: var(--bg-elevated); border-radius: var(--radius-sm); border-left: 3px solid var(--cyan); }
        .tip-title { font-size: 0.8rem; font-weight: 700; color: var(--cyan); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
        .tip-text { font-size: 0.85rem; color: var(--text-muted); }
        .mantra-banner { background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(245,166,35,0.08)); border: 1px solid rgba(255,209,102,0.25); border-radius: 16px; padding: 1.5rem 2rem; text-align: center; margin-bottom: 1.5rem; }
        .mantra-text { font-size: 1.4rem; font-weight: 700; color: var(--gold); letter-spacing: -0.01em; }
        .mantra-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.4rem; }

        /* ── PUBLIC JOURNAL STYLES ── */
        .share-banner { background: linear-gradient(135deg, rgba(6,214,214,0.1), rgba(59,126,248,0.08)); border: 1px solid rgba(6,214,214,0.25); border-radius: var(--radius); padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .share-banner-left { display: flex; align-items: center; gap: 1rem; }
        .share-icon { font-size: 1.5rem; }
        .share-info strong { display: block; color: var(--cyan); font-size: 0.9rem; }
        .share-info span { color: var(--text-muted); font-size: 0.8rem; }
        .share-link-input { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .share-link-box { padding: 0.5rem 0.875rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; min-width: 200px; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .share-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
        .toggle-switch { position: relative; width: 44px; height: 24px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .toggle-switch.on { background: var(--cyan); border-color: var(--cyan); }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: all 0.2s; }
        .toggle-switch.on::after { left: 23px; }

        /* ── PUBLIC VIEW ── */
        .public-view { position: fixed; inset: 0; background: var(--bg); z-index: 99999; overflow-y: auto; display: none; }
        .public-view.show { display: block; }
        .public-topbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .public-brand { display: flex; align-items: center; gap: 0.75rem; }
        .public-brand .logo { font-size: 1.5rem; }
        .public-brand h2 { font-size: 1.1rem; font-weight: 700; }
        .public-badge { padding: 0.3rem 0.75rem; background: rgba(6,214,214,0.15); border: 1px solid rgba(6,214,214,0.3); border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: var(--cyan); }
        .public-container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .public-header { background: linear-gradient(135deg, rgba(59,126,248,0.1), rgba(155,111,250,0.08)); border: 1px solid var(--border); border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem; }
        .public-avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; flex-shrink: 0; }
        .public-user-info h2 { font-size: 1.5rem; font-weight: 700; }
        .public-user-info p { color: var(--text-muted); font-size: 0.875rem; }

        /* ── RESPONSIVE ── */
        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .menu-btn { display: flex !important; }
            .chart-grid, .chart-grid-3 { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .metrics-grid { grid-template-columns: 1fr 1fr; }
            .hero-stats { gap: 1.5rem; }
            .topbar { padding: 1rem; }
            .auth-box { padding: 2rem 1.5rem; }
        }
        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
        /* ── ONBOARDING ── */
        .onboard-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:1rem; }
        .onboard-overlay.hidden { display:none; }
        .onboard-card { background:var(--bg-card);border:1px solid var(--border);border-radius:24px;padding:2.5rem;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .onboard-progress { display:flex;gap:0.5rem;justify-content:center;margin-bottom:2rem; }
        .onboard-dot { width:8px;height:8px;border-radius:50%;background:var(--bg-elevated);border:1px solid var(--border);transition:all 0.2s; }
        .onboard-dot.active { background:var(--accent);border-color:var(--accent);transform:scale(1.3); }
        .onboard-dot.done { background:var(--success);border-color:var(--success); }
        .onboard-step { display:none; }
        .onboard-step.active { display:block; }
        .onboard-emoji { font-size:3rem;text-align:center;margin-bottom:1rem;filter:drop-shadow(0 0 20px rgba(59,126,248,0.5)); }
        .onboard-title { font-size:1.5rem;font-weight:700;text-align:center;letter-spacing:-0.02em;margin-bottom:0.5rem; }
        .onboard-sub { color:var(--text-muted);text-align:center;font-size:0.9rem;margin-bottom:1.5rem; }
        .onboard-nav { display:flex;gap:0.75rem;margin-top:1.5rem; }
        .onboard-nav .btn { flex:1; }
        /* ── PROFILE MODAL ── */
        .modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:center;justify-content:center;padding:1rem; }
        .modal-overlay.hidden { display:none; }
        .modal-card { background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2rem;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem; }
        .modal-title { font-size:1.2rem;font-weight:700; }
        .modal-close { width:32px;height:32px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:all 0.15s; }
        .modal-close:hover { border-color:var(--danger);color:var(--danger); }
        /* ── CONTRACT EDITOR ── */
        .contract-editor { background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.25rem; }
        .contract-row { display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem; }
        .contract-row:last-child { margin-bottom:0; }
        .contract-label { flex:1;font-size:0.875rem;font-weight:600; }
        .contract-input { width:80px;padding:0.4rem 0.6rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.875rem;text-align:center; }
        .contract-input:focus { outline:none;border-color:var(--accent); }

        /* ── INVESTOR PORTAL ── */
        .ip-milestone-dot { display:inline-flex;align-items:center;gap:0.35rem;font-size:0.72rem;font-weight:600; }
        .ip-milestone-dot::before { content:''; width:8px;height:8px;border-radius:50%;flex-shrink:0; }
        .ip-milestone-dot.reached::before { background:var(--success);box-shadow:0 0 6px rgba(34,211,160,0.5); }
        .ip-milestone-dot.pending::before { background:var(--text-dim); }
        .ip-milestone-dot.reached { color:var(--success); }
        .ip-milestone-dot.pending { color:var(--text-dim); }
    </style>
</head>
<body>

<!-- PUBLIC JOURNAL VIEW (shown when ?journal=userId) -->
<div class="public-view" id="publicView">
    <div class="public-topbar">
        <div class="public-brand">
            <span class="logo">🌾</span>
            <h2>My Journal</h2>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <span class="public-badge">📖 Public Journal</span>
            <button class="btn btn-secondary" style="padding:0.4rem 0.875rem;font-size:0.8rem;" onclick="document.getElementById('publicView').classList.remove('show')">✕ Close</button>
        </div>
    </div>
    <div class="public-container">
        <div class="public-header">
            <div class="public-avatar" id="publicAvatar">T</div>
            <div class="public-user-info">
                <h2 id="publicUserName">Trader</h2>
                <p id="publicUserSub">Public trading journal • Updated live</p>
            </div>
        </div>
        <div class="metrics-grid" id="publicMetrics"></div>
        <div style="margin-bottom:1.5rem;" class="table-card">
            <div class="table-header"><span class="card-title">Trade History</span><span id="publicTradeCount" style="color:var(--text-muted);font-size:0.85rem;"></span></div>
            <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Cycle</th></tr></thead><tbody id="publicTradeBody"></tbody></table></div>
        </div>
    </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- AUTH SCREEN — full login built into dashboard -->
<div class="auth-screen" id="authScreen">
    <div class="auth-bg"></div>
    <div class="auth-grid"></div>
    <div class="auth-box">
        <div class="auth-logo">
            <span class="logo-icon">🌾</span>
            <h1>My Journal</h1>
            <p>Sign in to your trading dashboard</p>
        </div>

        <div class="auth-error" id="authError"></div>
        <div class="auth-success" id="authSuccess"></div>

        <!-- GOOGLE ONLY -->
        <div style="margin-bottom:1.5rem;">
            <button class="btn btn-oauth" id="authGoogleBtn" onclick="authDoGoogle()" style="width:100%;padding:1rem 1.5rem;font-size:1rem;border-radius:10px;display:flex;align-items:center;justify-content:center;gap:0.875rem;border-color:rgba(99,179,237,0.25);transition:all 0.2s;">
                <svg width="22" height="22" viewBox="0 0 18 18" style="flex-shrink:0;">
                    <path fill="#EA4335" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/>
                    <path fill="#4285F4" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/>
                    <path fill="#FBBC05" d="M3.88 10.78A5.54 5.54 0 013.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 000 9c0 1.45.35 2.82.96 4.04l2.92-2.26z"/>
                    <path fill="#34A853" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/>
                </svg>
                <span id="authGoogleTxt">Continue with Google</span>
                <div class="spinner" id="authGoogleSpinner" style="display:none;width:16px;height:16px;border-width:2px;"></div>
            </button>
        </div>

        <div style="text-align:center;color:var(--text-dim);font-size:0.8rem;line-height:1.6;">
            Sign in or create your account instantly.<br>No password required.
        </div>

        <!-- Hidden stubs so rest of JS doesn't break -->
        <input type="hidden" id="loginUsername">
        <input type="hidden" id="loginPassword">
        <input type="hidden" id="signupUsername">
        <input type="hidden" id="signupPassword">
        <input type="hidden" id="signupConfirm">
        <input type="hidden" id="resetEmail">
        <span id="authLoginTxt" style="display:none"></span>
        <span id="authLoginSpinner" style="display:none"></span>
        <span id="authSignupTxt" style="display:none"></span>
        <span id="authSignupSpinner" style="display:none"></span>
        <span id="authResetTxt" style="display:none"></span>
        <span id="authResetSpinner" style="display:none"></span>
        <button id="authLoginBtn" style="display:none"></button>
        <button id="authSignupBtn" style="display:none"></button>
        <button id="authResetBtn" style="display:none"></button>
    </div>
</div>

<!-- ONBOARDING OVERLAY -->
<div class="onboard-overlay hidden" id="onboardOverlay">
  <div class="onboard-card" id="onboardCard">

    <!-- ── TEMPLATE: TRADER ── -->
    <div id="obTemplate_trader" style="display:none;">
      <div class="onboard-progress" id="onboardProgress"></div>
      <div class="onboard-step active" id="onboardStep0">
        <div class="onboard-emoji">🌾</div>
        <div class="onboard-title">Welcome to My Journal!</div>
        <div class="onboard-sub">Set up your trader profile — only takes a minute.</div>
        <div class="form-group">
          <label class="form-label">Username <span style="color:var(--text-muted);font-size:0.8rem;">(your public trading name)</span></label>
          <input type="text" class="form-input" id="obUsername" placeholder="FarmKing47" maxlength="30" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,\'\')">
        </div>
        <div class="form-group">
          <label class="form-label">Display Name <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
          <input type="text" class="form-input" id="obDisplayName" placeholder="The Prop King" maxlength="40">
        </div>
        <div class="form-group">
          <label class="form-label">Journal Bio <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
          <input type="text" class="form-input" id="obBio" placeholder="Futures trader farming consistent profits 🌾" maxlength="120">
        </div>
        <div class="form-group">
          <label class="form-label">Firm Name <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
          <input type="text" class="form-input" id="obFirmName" placeholder="e.g. Topstep, Apex, FTMO" maxlength="40">
        </div>
        <div class="form-group">
          <label class="form-label">Social / YouTube Link <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
          <input type="url" class="form-input" id="obSocialLink" placeholder="https://youtube.com/@yourhandle">
        </div>
      </div>
      <div class="onboard-step" id="onboardStep1">
        <div class="onboard-emoji">🎯</div>
        <div class="onboard-title">Set Your Farming Goals</div>
        <div class="onboard-sub">You can change these anytime in Settings.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div class="form-group"><label class="form-label">Account Goal (# of PA accounts)</label><input type="number" class="form-input" id="obAccountGoal" value="20" min="1" max="200"></div>
          <div class="form-group"><label class="form-label">Starting Balance / Account</label><input type="number" class="form-input" id="obStartBal" value="50000" min="1000"></div>
          <div class="form-group"><label class="form-label">Goal per Account ($)</label><input type="number" class="form-input" id="obGoalAcc" value="4600" min="0"></div>
          <div class="form-group"><label class="form-label">Payout per Account ($)</label><input type="number" class="form-input" id="obPayoutAcc" value="2000" min="0"></div>
          <div class="form-group"><label class="form-label">Daily Target Min ($)</label><input type="number" class="form-input" id="obDailyMin" value="250" min="0"></div>
          <div class="form-group"><label class="form-label">Daily Target Max ($)</label><input type="number" class="form-input" id="obDailyMax" value="300" min="0"></div>
          <div class="form-group"><label class="form-label">Max Daily Drawdown ($)</label><input type="number" class="form-input" id="obMaxDD" value="2500" min="0"></div>
        </div>
      </div>
      <div class="onboard-nav">
        <button class="btn btn-secondary" id="onboardBackBtn" onclick="onboardBack()" style="display:none;">← Back</button>
        <button class="btn btn-primary" id="onboardNextBtn" onclick="onboardNext()">Next →</button>
      </div>
    </div>

    <!-- ── TEMPLATE: INVESTOR ── -->
    <div id="obTemplate_investor" style="display:none;">
      <div class="onboard-emoji">💼</div>
      <div class="onboard-title">Welcome, Investor!</div>
      <div class="onboard-sub">You have been granted investor access. Complete your profile to continue.</div>
      <div style="background:rgba(59,126,248,0.08);border:1px solid rgba(59,126,248,0.2);border-radius:var(--radius-sm);padding:0.875rem;margin:1rem 0 1.5rem;font-size:0.85rem;color:var(--text-muted);">
        💼 Your investor portal shows your account value, profit share, and milestone progress.
      </div>
      <div class="form-group">
        <label class="form-label">Your Full Name</label>
        <input type="text" class="form-input" id="obInvName" placeholder="John Smith" maxlength="60">
      </div>
      <div class="form-group">
        <label class="form-label">Display Alias <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
        <input type="text" class="form-input" id="obInvDisplay" placeholder="e.g. The Farmer" maxlength="40">
      </div>
      <div class="form-group">
        <label class="form-label">Contact Email <span style="color:var(--text-muted);font-size:0.8rem;">(for payout notifications)</span></label>
        <input type="email" class="form-input" id="obInvEmail" placeholder="you@email.com">
      </div>
      <div class="onboard-nav" style="margin-top:1.5rem;">
        <button class="btn btn-primary" style="width:100%;" onclick="saveInvestorOnboarding()">💼 Enter Investor Portal →</button>
      </div>
    </div>

    <!-- ── TEMPLATE: JOURNAL VIEWER ── -->
    <div id="obTemplate_journal" style="display:none;">
      <div class="onboard-emoji">📖</div>
      <div class="onboard-title">Welcome, Journal Viewer!</div>
      <div class="onboard-sub">You have view access to trading journals. Set up your profile.</div>
      <div style="background:rgba(34,211,160,0.08);border:1px solid rgba(34,211,160,0.2);border-radius:var(--radius-sm);padding:0.875rem;margin:1rem 0 1.5rem;font-size:0.85rem;color:var(--text-muted);">
        📊 You can browse public trading journals and performance stats.
      </div>
      <div class="form-group">
        <label class="form-label">Your Name / Username</label>
        <input type="text" class="form-input" id="obJournalName" placeholder="YourName" maxlength="40">
      </div>
      <div class="form-group">
        <label class="form-label">Email <span style="color:var(--text-muted);font-size:0.8rem;">(optional, for updates)</span></label>
        <input type="email" class="form-input" id="obJournalEmail" placeholder="you@email.com">
      </div>
      <div class="onboard-nav" style="margin-top:1.5rem;">
        <button class="btn btn-primary" style="width:100%;" onclick="saveJournalOnboarding()">📖 View Journals →</button>
      </div>
    </div>

  </div>
</div>



<!-- PROFILE MODAL (edit profile from settings) -->
<div class="modal-overlay hidden" id="profileModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">✏️ Edit Profile</div>
      <button class="modal-close" onclick="closeProfileModal()">✕</button>
    </div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input type="text" class="form-input" id="profileUsername" maxlength="30" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
    </div>
    <div class="form-group">
      <label class="form-label">Display Name</label>
      <input type="text" class="form-input" id="profileDisplayName" maxlength="40">
    </div>
    <div class="form-group">
      <label class="form-label">Journal Bio / Tagline</label>
      <input type="text" class="form-input" id="profileBio" maxlength="120">
    </div>
    <div class="form-group">
      <label class="form-label">Firm Name</label>
      <input type="text" class="form-input" id="profileFirmName" maxlength="40">
    </div>
    <div class="form-group">
      <label class="form-label">Social / YouTube Link</label>
      <input type="url" class="form-input" id="profileSocialLink">
    </div>
    <div style="background:rgba(59,126,248,0.07);border:1px solid rgba(59,126,248,0.2);border-radius:8px;padding:0.875rem;margin-bottom:1.25rem;font-size:0.82rem;color:var(--text-muted);">
      💡 Link your email for password recovery: <input type="email" class="form-input" id="profileEmail" placeholder="trader@example.com" style="margin-top:0.5rem;">
    </div>
    <div class="form-footer">
      <button class="btn btn-primary" onclick="saveProfileModal()">💾 Save Profile</button>
      <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="logo-em">🌾</span>
            <h2>Prop Farm</h2>
        </div>

        <div class="user-chip">
            <div class="user-avatar" id="userAvatar">T</div>
            <div class="user-info">
                <div class="user-name" id="userName">Trader</div>
                <div class="user-role" id="userRole">Member</div>
            </div>
        </div>

        <!-- TRADER nav — hidden for pure investors -->
        <nav class="nav-section" id="traderNavMain">
            <div class="nav-label">Main</div>
            <div class="nav-item active" data-page="overview"><span class="nav-icon">📊</span>Overview</div>
            <div class="nav-item" data-page="cyclePerformance"><span class="nav-icon">🔄</span>Cycle Performance</div>
            <div class="nav-item" data-page="templates"><span class="nav-icon">📋</span>Templates</div>
            <div class="nav-item" data-page="accounts"><span class="nav-icon">💼</span>Accounts</div>
            <div class="nav-item" data-page="analytics"><span class="nav-icon">📈</span>Analytics</div>
            <div class="nav-item" data-page="riskMonitor"><span class="nav-icon">⚠️</span>Risk Monitor</div>
        </nav>

        <!-- TRADER actions — hidden for pure investors -->
        <nav class="nav-section" id="traderNavActions">
            <div class="nav-label">Actions</div>
            <div class="nav-item" data-page="addTrade"><span class="nav-icon">➕</span>Add Trade</div>
            <div class="nav-item" data-page="logPayout"><span class="nav-icon">💰</span>Log Payout</div>
            <div class="nav-item" data-page="tradeLog"><span class="nav-icon">📝</span>Trade Log</div>
            <div class="nav-item" data-page="deleteData"><span class="nav-icon">🗑️</span>Delete Data</div>
            <div class="nav-item" onclick="window.location.href='pamm_calculator_dashboard.html'"><span class="nav-icon">📊</span><span>PAMM Calculator</span></div>
            <div class="nav-item" onclick="window.location.href='economic-calendar.html'"><span class="nav-icon">📅</span><span>Economic Calendar</span></div>
        </nav>

        <!-- INVESTOR nav — shown only when investor or admin -->
        <nav class="nav-section" id="investorNavSection" style="display:none;">
            <div class="nav-label">Investor</div>
            <div class="nav-item" data-page="investorPortal" id="investorPortalNavItem"><span class="nav-icon">💼</span>Investor Portal</div>
        </nav>

        <nav class="nav-section">
            <div class="nav-label">Config</div>
            <div class="nav-item" data-page="settings"><span class="nav-icon">⚙️</span>Settings</div>
            <div class="nav-item" data-page="adminPanel" id="adminNavItem" style="display:none;"><span class="nav-icon">👑</span>Admin Panel</div>
            <div class="nav-item" data-page="debugPanel" id="debugNavItem" style="display:none;"><span class="nav-icon">🔧</span>Debug Panel</div>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="handleLogout()"><span>🚪</span> Sign Out</button>
        </div>
    </aside>

    <!-- TOAST ALERT CONTAINER -->
    <div id="alertToastContainer"></div>

    <!-- MAIN -->
    <main class="main" id="main">
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-btn" id="menuBtn" onclick="toggleSidebar()">☰</button>
                <h1 class="page-title" id="pageTitle">Overview</h1>
            </div>
            <div class="topbar-right">
                <button class="icon-btn" onclick="refreshData()" title="Refresh data">↻</button>
                <button class="icon-btn" onclick="exportCSV()" title="Export CSV">📥</button>
            </div>
        </div>

        <div class="container">
            <div class="alert" id="alert"></div>

            <!-- ──────────────────── OVERVIEW ──────────────────── -->
            <div class="page active" id="overviewPage">
                <div id="adminViewingBanner" class="admin-view-banner" style="display:none;">
                    <span>👁️ Viewing as admin: <strong id="adminViewingLabel">—</strong></span>
                    <button class="btn btn-secondary" style="padding:0.3rem 0.875rem;font-size:0.8rem;" onclick="exitAdminView()">Exit View</button>
                </div>
                <div class="hero">
                    <div class="hero-glow"></div>
                    <div class="hero-greeting" id="heroGreeting">Welcome back, <span id="heroName">Trader</span></div>
                    <div class="hero-title"><span id="heroTitle">Building Your</span> Trading Empire</div>
                    <div class="hero-stats">
                        <div><div class="hero-stat-value" id="heroTotalPnL">$0</div><div class="hero-stat-label">Total P&L</div></div>
                        <div><div class="hero-stat-value" id="heroProgress">0%</div><div class="hero-stat-label">Portfolio Progress</div></div>
                        <div><div class="hero-stat-value" id="heroAccounts">0/20</div><div class="hero-stat-label">Accounts at Goal</div></div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-card" onclick="navigateTo('addTrade')"><div class="action-icon blue">➕</div><div class="action-info"><h4>Add Trade</h4><p>Log new position</p></div></div>
                    <div class="action-card" onclick="refreshData()"><div class="action-icon green">🔄</div><div class="action-info"><h4>Refresh</h4><p>Sync from database</p></div></div>
                    <div class="action-card" onclick="navigateTo('shareJournal')"><div class="action-icon teal">🔗</div><div class="action-info"><h4>Share Journal</h4><p>Public trade link</p></div></div>
                    <div class="action-card" onclick="navigateTo('psychology')"><div class="action-icon purple">🧠</div><div class="action-info"><h4>Psychology</h4><p>Mindset & motivation</p></div></div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">💰</span></div><div class="metric-value" id="totalPnL">$0</div><div class="metric-sub" id="pnlSub">All time</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">🎯</span></div><div class="metric-value" id="winRate">0%</div><div class="metric-sub" id="winStatsSub">0 / 0 trades</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Profit Factor</span><span class="metric-icon">📊</span></div><div class="metric-value" id="profitFactor">0.00</div><div class="metric-sub" id="pfSub">—</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Streak</span><span class="metric-icon">🔥</span></div><div class="metric-value" id="winStreak">0</div><div class="metric-sub" id="streakSub">No active streak</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Trades</span><span class="metric-icon">📈</span></div><div class="metric-value" id="totalTrades">0</div><div class="metric-sub" id="tradesSub">Across all accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Avg Trade</span><span class="metric-icon">💵</span></div><div class="metric-value" id="avgTrade">$0</div><div class="metric-sub">Per trade</div></div>
                </div>

                <div class="stats-row">
                    <div class="stat-card"><div class="stat-val" id="bestDay">$0</div><div class="stat-lbl">Best Day</div></div>
                    <div class="stat-card"><div class="stat-val" id="worstDay">$0</div><div class="stat-lbl">Worst Day</div></div>
                    <div class="stat-card"><div class="stat-val" id="avgWin">$0</div><div class="stat-lbl">Avg Win</div></div>
                    <div class="stat-card"><div class="stat-val" id="avgLoss">$0</div><div class="stat-lbl">Avg Loss</div></div>
                    <div class="stat-card"><div class="stat-val" id="longestStreak">0</div><div class="stat-lbl">Longest Streak</div></div>
                    <div class="stat-card"><div class="stat-val" id="payoutProgress">0%</div><div class="stat-lbl">Payout Progress</div></div>
                </div>

                <div class="chart-grid">
                    <div class="card"><div class="card-header"><div class="card-title">Portfolio Growth</div><div class="card-sub">Cumulative P&L over time</div></div><div class="card-body"><div class="chart-wrap"><canvas id="growthChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Win Rate by Condition</div></div><div class="card-body"><div class="chart-wrap"><canvas id="winRateChart"></canvas></div></div></div>
                </div>

                <div class="chart-grid-3">
                    <div class="card"><div class="card-header"><div class="card-title">Daily P&L</div><div class="card-sub">Last 14 days</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="dailyChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Risk Distribution</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="riskChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Account Status</div><div class="card-sub" id="accStatusSub">Portfolio overview</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="accountStatusChart"></canvas></div></div></div>
                </div>

                <div class="section-header">
                    <div class="section-title">Top Performing Templates</div>
                    <button class="btn btn-secondary" onclick="navigateTo('templates')" style="padding:0.5rem 1rem;font-size:0.85rem;">View All</button>
                </div>
                <div class="templates-grid" id="topTemplatesGrid"></div>
            </div>

            <!-- ──────────────────── PSYCHOLOGY ──────────────────── -->
            <div class="page" id="psychologyPage">
                <div class="psych-hero">
                    <span class="psych-hero-emoji">🧠</span>
                    <div class="psych-hero-title">Trading Psychology</div>
                    <div class="psych-hero-subtitle">Your mindset is your greatest edge. Protect it daily.</div>
                </div>

                <div class="mantra-banner">
                    <div class="mantra-text" id="mantraText">"Plant the seed. Trust the process. Harvest the reward."</div>
                    <div class="mantra-sub">🌾 The Farmer's Mantra</div>
                </div>

                <!-- Daily Quote -->
                <div class="daily-quote-card">
                    <div class="daily-quote-label">✨ Daily Motivation</div>
                    <div class="daily-quote-text" id="dailyQuoteText">Loading...</div>
                    <div class="daily-quote-author" id="dailyQuoteAuthor">—</div>
                    <div class="quote-nav">
                        <button class="quote-nav-btn" onclick="prevQuote()">←</button>
                        <span class="quote-counter" id="quoteCounter">1 / 20</span>
                        <button class="quote-nav-btn" onclick="nextQuote()">→</button>
                    </div>
                </div>

                <div class="psych-grid">
                    <!-- Mood tracker -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(59,126,248,0.15);">😊</div>
                            <div class="psych-card-title">Today's Trading Mindset</div>
                        </div>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">How are you feeling before the session?</p>
                        <div class="mood-grid">
                            <button class="mood-btn" onclick="selectMood(this,'🔥','In the zone')"><span class="mood-label">🔥</span><span class="mood-label">In the Zone</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'😎','Calm & ready')"><span class="mood-label">😎</span><span class="mood-label">Calm & Ready</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'😌','Neutral')"><span class="mood-label">😌</span><span class="mood-label">Neutral</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'😤','A little tense')"><span class="mood-label">😤</span><span class="mood-label">A little Tense</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'😰','Anxious')"><span class="mood-label">😰</span><span class="mood-label">Anxious</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'🚫','Sit this out')"><span class="mood-label">🚫</span><span class="mood-label">Sit This Out</span></button>
                        </div>
                        <div id="moodAdvice" style="margin-top:1rem;padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-muted);display:none;"></div>
                    </div>

                    <!-- Pre-trade checklist -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(34,211,160,0.15);">✅</div>
                            <div class="psych-card-title">Pre-Trade Checklist</div>
                        </div>
                        <div id="checklistItems">
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Checked economic calendar for news events</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Reviewed yesterday's trades and lessons</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Know my max loss for today</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Risk is within my template rules</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">I'm trading from logic, not emotion</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">I accept that I might lose today</span></div>
                        </div>
                        <div id="checklistStatus" style="margin-top:0.75rem;font-size:0.8rem;color:var(--text-muted);text-align:center;"></div>
                        <button class="btn btn-secondary" style="width:100%;margin-top:0.75rem;padding:0.5rem;" onclick="resetChecklist()">Reset Checklist</button>
                    </div>

                    <!-- The Farmer's Rules -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(255,209,102,0.15);">📜</div>
                            <div class="psych-card-title">The Farmer's Golden Rules</div>
                        </div>
                        <div class="rule-list">
                            <div class="rule-item"><div class="rule-num">1</div><div class="rule-text">Protect the field first. Small consistent days beat revenge trading every time.</div></div>
                            <div class="rule-item"><div class="rule-num">2</div><div class="rule-text">$250–$300/day is a great harvest. Don't get greedy with the crops.</div></div>
                            <div class="rule-item"><div class="rule-num">3</div><div class="rule-text">Bad weather days happen. A losing day is data, not failure.</div></div>
                            <div class="rule-item"><div class="rule-num">4</div><div class="rule-text">The 45-day first cycle is your planting season. Be patient.</div></div>
                            <div class="rule-item"><div class="rule-num">5</div><div class="rule-text">One red day cannot destroy 44 green ones. Stay focused on the season.</div></div>
                        </div>
                    </div>

                    <!-- Daily affirmations -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(155,111,250,0.15);">💪</div>
                            <div class="psych-card-title">Daily Affirmations</div>
                        </div>
                        <div class="affirmation-list">
                            <div class="affirmation-item">I am a disciplined trader who follows my system.</div>
                            <div class="affirmation-item">I control risk, not results.</div>
                            <div class="affirmation-item">I trade the process, not the profit.</div>
                            <div class="affirmation-item">Every day I show up, I grow stronger.</div>
                            <div class="affirmation-item">My account is protected because I protect it.</div>
                            <div class="affirmation-item">I am building generational wealth one trade at a time.</div>
                        </div>
                    </div>

                    <!-- Trading tips -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(6,214,214,0.15);">💡</div>
                            <div class="psych-card-title">Prop Farm Mindset Tips</div>
                        </div>
                        <div class="trading-tips">
                            <div class="tip-item"><div class="tip-title">On Losing Days</div><div class="tip-text">A loss is tuition. The lesson is in your notes. Review, don't revenge trade.</div></div>
                            <div class="tip-item"><div class="tip-title">On Consecutive Wins</div><div class="tip-text">When on a hot streak, size down not up. The market humbles overconfidence.</div></div>
                            <div class="tip-item"><div class="tip-title">On Waiting</div><div class="tip-text">The best trade is often no trade. Patience is a position.</div></div>
                            <div class="tip-item"><div class="tip-title">On the Fail Line</div><div class="tip-text">Every $50 you keep above the fail line is $50 you earned. Treat it like gold.</div></div>
                        </div>
                    </div>

                    <!-- Win streak + journal -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(255,209,102,0.15);">🔥</div>
                            <div class="psych-card-title">Your Win Streak</div>
                        </div>
                        <div class="streak-display">
                            <div class="streak-number" id="psychStreakNum">0</div>
                            <div class="streak-label">Consecutive Wins</div>
                        </div>
                        <div style="margin-top:1.25rem;">
                            <label class="form-label">Today's Trading Journal Note</label>
                            <textarea class="journal-textarea" id="journalNote" placeholder="What happened today? What did you learn? What will you do differently?..." oninput="saveJournalNote()"></textarea>
                            <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.75rem;color:var(--text-dim);">
                                <span id="journalSaveStatus">Auto-saves as you type</span>
                                <span id="journalCharCount">0 chars</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ──────────────────── SHARE JOURNAL ──────────────────── -->
            <div class="page" id="shareJournalPage">
                <div class="share-banner">
                    <div class="share-banner-left">
                        <span class="share-icon">🔗</span>
                        <div class="share-info">
                            <strong>Public Journal Sharing</strong>
                            <span>Share your trading progress with anyone — no login required</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                        <div class="share-toggle">
                            <span style="color:var(--text-muted);font-size:0.85rem;" id="shareStatusLabel">Sharing Off</span>
                            <div class="toggle-switch" id="shareToggle" onclick="toggleSharing()"></div>
                        </div>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;font-size:1.05rem;font-weight:700;">📎 Your Journal Share Link</h3>
                    <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:1.25rem;">Anyone with this link can view your trade journal in read-only mode. Enable sharing above to make it live.</p>
                    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap;">
                        <div class="share-link-box" id="shareLinkDisplay" style="flex:1;max-width:none;padding:0.875rem;">
                            Enable sharing to generate your link
                        </div>
                    </div>
                    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" style="padding:0.5rem 1.25rem;font-size:0.875rem;" onclick="copyShareLink()">📋 Copy Link</button>
                        <button class="btn btn-secondary" style="padding:0.5rem 1.25rem;font-size:0.875rem;" onclick="previewJournal()">👁️ Preview Journal</button>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;font-size:1.05rem;font-weight:700;">🎨 Journal Customization</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Display Name (shown publicly)</label>
                            <input type="text" class="form-input" id="journalDisplayName" placeholder="e.g. FX Farmer, The Prop King...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Journal Bio / Tagline</label>
                            <input type="text" class="form-input" id="journalBio" placeholder="e.g. Prop trader farming consistent profits 🌾">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">What data to show publicly</label>
                        <div style="display:grid;gap:0.5rem;">
                            <label class="checkbox-label"><input type="checkbox" id="showPnL" checked> Show P&L amounts</label>
                            <label class="checkbox-label"><input type="checkbox" id="showWinRate" checked> Show win rate</label>
                            <label class="checkbox-label"><input type="checkbox" id="showTrades" checked> Show individual trades</label>
                            <label class="checkbox-label"><input type="checkbox" id="showAccounts"> Show account numbers (PA #1, etc.)</label>
                        </div>
                    </div>
                    <div class="form-footer">
                        <button class="btn btn-primary" style="width:auto;" onclick="saveJournalSettings()">💾 Save Settings</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Journal Preview</div>
                        <div class="card-sub">This is what visitors will see</div>
                    </div>
                    <div class="card-body">
                        <div class="metrics-grid" id="journalPreviewMetrics"></div>
                        <div class="table-card" style="margin-top:1rem;">
                            <div class="table-wrap"><table><thead><tr><th>Date</th><th>P&L</th><th>Condition</th><th>Cycle</th></tr></thead><tbody id="journalPreviewBody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ──────────────────── CYCLE PERFORMANCE ──────────────────── -->
            <div class="page" id="cyclePerformancePage">
                <p style="color:var(--text-muted);margin-bottom:1.5rem;">Track your farming journey across your <strong id="cycleAccText">active accounts</strong>. First cycle target: $4,600 profit per account in 45 days. After first payout: monthly $2,000 per account in 8–20 days.</p>
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">First Payout Progress</span><span class="metric-icon">🎯</span></div><div class="metric-value" id="firstPayoutProg">0%</div><div class="metric-sub" id="firstPayoutSub">Not yet qualified</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Payouts Earned</span><span class="metric-icon">💰</span></div><div class="metric-value" id="totalPayoutsAmt">$0</div><div class="metric-sub" id="payoutCountSub">0 payouts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Current Cycle</span><span class="metric-icon">📅</span></div><div class="metric-value" id="currentCycleStatus">Cycle 1</div><div class="metric-sub" id="cycleInfoSub">Building to first payout</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Daily Average</span><span class="metric-icon">📊</span></div><div class="metric-value" id="dailyAvg">$0</div><div class="metric-sub" id="dailyTarget">Target: $250–$300</div></div>
                </div>
                <div class="alert alert-info show">🌾 <strong>The Farmer Mentality:</strong> Plant daily wins ($250–$300). Protect the field. Stay patient (45 days first cycle). Take the harvest when accounts mature.</div>
                <div class="table-card" style="margin-bottom:1.5rem;">
                    <div class="table-header"><span class="card-title">Cycle-by-Cycle Comparison</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Cycle</th><th>Total P&L</th><th>Trades</th><th>Trading Days</th><th>Avg/Day</th><th>Win Rate</th><th>Best Day</th><th>Worst Day</th><th>Status</th></tr></thead><tbody id="cycleCompBody"></tbody></table></div>
                </div>
                <div class="chart-grid">
                    <div class="card"><div class="card-header"><div class="card-title">Cycle P&L Comparison</div></div><div class="card-body"><div class="chart-wrap"><canvas id="cyclePnLChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Daily Average by Cycle</div></div><div class="card-body"><div class="chart-wrap"><canvas id="cycleDailyChart"></canvas></div></div></div>
                </div>
                <div class="section-header" style="margin-top:1.5rem;"><div class="section-title">Cycle Details</div></div>
                <div class="templates-grid" id="cycleDetailsGrid"></div>
            </div>

            <!-- ──────────────────── TEMPLATES ──────────────────── -->
            <div class="page" id="templatesPage">
                <div class="section-header"><div class="section-title">Market Conditions</div></div>
                <div class="templates-grid" id="marketCondGrid"></div>
                <div class="section-header"><div class="section-title">Risk Templates</div></div>
                <div class="templates-grid" id="riskTemplGrid"></div>
            </div>

            <!-- ──────────────────── ACCOUNTS ──────────────────── -->
            <div class="page" id="accountsPage">
                <div class="section-header">
                    <div class="section-title" id="accountsTitle">Portfolio Accounts</div>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="padding:0.5rem 1rem;font-size:0.85rem;">Export CSV</button>
                </div>
                <div style="background:rgba(6,214,214,0.08);border:1px solid rgba(6,214,214,0.2);border-radius:var(--radius-sm);padding:0.875rem 1.25rem;margin-bottom:1.25rem;font-size:0.875rem;color:var(--cyan);">
                    💡 Click the pencil icon on any account to give it a custom name (e.g. "Main Warrior", "Backup Farm")
                </div>
                <div class="filter-pills">
                    <div class="pill active" onclick="filterAccounts('all',event)">All</div>
                    <div class="pill" onclick="filterAccounts('active',event)">Active Only</div>
                    <div class="pill" onclick="filterAccounts('goal',event)">Goal Reached</div>
                    <div class="pill" onclick="filterAccounts('profitable',event)">Profitable</div>
                </div>
                <div class="accounts-grid" id="accountsGrid"></div>
            </div>

            <!-- ──────────────────── ANALYTICS ──────────────────── -->
            <div class="page" id="analyticsPage">
                <div class="table-card">
                    <div class="table-header"><span class="card-title">Template Comparison</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Template</th><th>Total P&L</th><th>Trades</th><th>Win Rate</th><th>Avg Win</th><th>Avg Loss</th><th>Best Trade</th><th>Profit Factor</th></tr></thead><tbody id="analyticsBody"></tbody></table></div>
                </div>
            </div>

            <!-- ──────────────────── RISK MONITOR ──────────────────── -->
            <div class="page" id="riskMonitorPage">
                <div class="alert alert-info show" style="margin-bottom:1.5rem;"><strong>Trailing Drawdown Rules:</strong> Starting Balance: $50,000 | Max Drawdown: $2,500 | Fail Line: $47,500 | Safety Net: $52,600 (fail line locks at $50,100 forever once reached)</div>
                <div class="accounts-grid" id="riskGrid"></div>
            </div>

            <!-- ──────────────────── ADD TRADE ──────────────────── -->
            <div class="page" id="addTradePage">
                <div class="form-card">
                    <form id="tradeForm" onsubmit="handleTradeSubmit(event)">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="noTradeDay" onchange="toggleNoTradeDay(this.checked)">
                                📅 No-Trade Day (rest day / market closed)
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="copierMode" onchange="toggleCopierMode(this.checked)">
                                🔄 Trade Copier Mode (copy to multiple accounts)
                            </label>
                        </div>

                        <div class="form-grid" id="tradeFormGrid">
                            <div id="singleAccWrap">
                                <div class="form-group">
                                    <label class="form-label">PA Account *</label>
                                    <select class="form-select" id="tradeAccount" required></select>
                                </div>
                            </div>
                            <div id="multiAccWrap" style="display:none;grid-column:1/-1;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Lead Account *</label>
                                        <select class="form-select" id="leadAccount"></select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Follower Accounts *</label>
                                        <div style="border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;background:var(--bg-elevated);max-height:180px;overflow-y:auto;">
                                            <div id="followerCheckboxes" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Cycle *</label>
                                <select class="form-select" id="tradeCycle" required>
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                    <option value="7">Cycle 7</option><option value="8">Cycle 8</option><option value="9">Cycle 9</option>
                                    <option value="10">Cycle 10</option><option value="11">Cycle 11</option><option value="12">Cycle 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Market Condition *</label>
                                <select class="form-select" id="tradeCondition" required>
                                    <option value="">Select</option>
                                    <option value="High Impact News">High Impact News</option>
                                    <option value="No Impact">No Impact</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Template *</label>
                                <select class="form-select" id="tradeRisk" required onchange="updateContracts(this.value)">
                                    <option value="">Select risk</option>
                                    <option value="100">$100 (1 contract)</option>
                                    <option value="200">$200 (2 contracts)</option>
                                    <option value="300">$300 (3 contracts)</option>
                                    <option value="400">$400 (4 contracts)</option>
                                    <option value="500">$500 (5 contracts)</option>
                                    <option value="600">$600 (6 contracts)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trade Date *</label>
                                <input type="date" class="form-input" id="tradeDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P&L ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="tradePnL" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contracts</label>
                                <input type="number" class="form-input" id="tradeContracts" readonly style="opacity:0.6;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="tradeNotes" placeholder="Entry reason, market conditions, lessons learned..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="tradeSubmitBtn" style="width:auto;">
                                <span id="tradeSubmitText">Submit Trade</span>
                                <span id="tradeSubmitSpinner" class="spinner" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetTradeForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ──────────────────── LOG PAYOUT ──────────────────── -->
            <div class="page" id="logPayoutPage">
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Available for Withdrawal</span><span class="metric-icon">💵</span></div><div class="metric-value" id="availableWithdrawal">$0</div><div class="metric-sub" id="withdrawalStatus">Not qualified yet</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Withdrawn</span><span class="metric-icon">💰</span></div><div class="metric-value" id="totalWithdrawn">$0</div><div class="metric-sub" id="withdrawnCount">0 payouts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Current Phase</span><span class="metric-icon">🔄</span></div><div class="metric-value" id="cyclePhase">Cycle 1</div><div class="metric-sub" id="phaseInfo">Building to first payout</div></div>
                </div>
                <div class="form-card">
                    <h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">Record New Payout</h3>
                    <form id="payoutForm" onsubmit="handlePayoutSubmit(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Payout Type *</label>
                                <select class="form-select" id="payoutType" required>
                                    <option value="">Select type</option>
                                    <option value="first_min">First Payout – Minimum ($2,600 qualified)</option>
                                    <option value="first_full">First Payout – Full ($4,600 = $2k withdrawal)</option>
                                    <option value="monthly">Monthly Payout ($2,000)</option>
                                    <option value="custom">Custom Amount</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Withdrawal Amount ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="withdrawalAmount" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payout Date *</label>
                                <input type="date" class="form-input" id="payoutDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account *</label>
                                <select class="form-select" id="payoutAccount" required></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cycle Completed *</label>
                                <select class="form-select" id="cycleCompleted" required>
                                    <option value="">Select</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Cycle Starting *</label>
                                <select class="form-select" id="newCycle" required>
                                    <option value="">Select</option>
                                    <option value="2">Cycle 2</option><option value="3">Cycle 3</option><option value="4">Cycle 4</option>
                                    <option value="5">Cycle 5</option><option value="6">Cycle 6</option><option value="7">Cycle 7</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="payoutNotes" placeholder="First milestone reached! Ready for monthly farming cycle..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="payoutSubmitBtn" style="width:auto;">
                                <span id="payoutSubmitText">💰 Log Payout</span>
                                <span id="payoutSubmitSpinner" class="spinner" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetPayoutForm()">Clear</button>
                        </div>
                    </form>
                </div>
                <div class="table-card" style="margin-top:1.5rem;">
                    <div class="table-header"><span class="card-title">Payout History</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Cycle Completed</th><th>New Cycle</th><th>Notes</th></tr></thead><tbody id="payoutHistBody"></tbody></table></div>
                </div>
            </div>

            <!-- ──────────────────── TRADE LOG ──────────────────── -->
            <div class="page" id="tradeLogPage">
                <div class="table-card">
                    <div class="table-header">
                        <span class="card-title">All Trades (Last 200)</span>
                        <div style="display:flex;gap:0.5rem;">
                            <input type="text" class="form-input" id="tradeLogSearch" placeholder="Search account, condition..." style="padding:0.4rem 0.75rem;font-size:0.85rem;width:200px;" oninput="filterTradeLog()">
                        </div>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Contracts</th><th>Cycle</th><th>Notes</th></tr></thead><tbody id="tradeLogBody"></tbody></table></div>
                </div>
            </div>

            <!-- ──────────────────── DELETE DATA ──────────────────── -->
            <div class="page" id="deleteDataPage">
                <div class="alert alert-error show">⚠️ Deleted data cannot be recovered. All deletions are permanent and immediate.</div>
                <div class="form-card">
                    <h3 style="margin-bottom:1.5rem;font-size:1.1rem;">Delete Options</h3>
                    <div style="display:grid;gap:1.25rem;">
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">🔄 Delete by Cycle</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Remove all trades from a specific cycle</p>
                            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                                <select class="form-select" id="deleteCycleSelect" style="flex:1;min-width:160px;">
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                    <option value="7">Cycle 7</option><option value="8">Cycle 8</option><option value="9">Cycle 9</option>
                                    <option value="10">Cycle 10</option><option value="11">Cycle 11</option><option value="12">Cycle 12</option>
                                </select>
                                <button class="btn btn-secondary" onclick="deleteByCycle()">Delete Cycle</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">💼 Delete by Account</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Remove all trades from a specific account</p>
                            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                                <select class="form-select" id="deleteAccSelect" style="flex:1;min-width:160px;"><option value="">Select account</option></select>
                                <button class="btn btn-secondary" onclick="deleteByAccount()">Delete Account</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid rgba(240,92,106,0.3);border-radius:var(--radius);background:rgba(240,92,106,0.03);">
                            <h4 style="margin-bottom:0.5rem;color:var(--danger);">💣 Delete ALL Data</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">⚠️ Permanently deletes ALL your trades AND all payout records!</p>
                            <button class="btn btn-danger" onclick="confirmDeleteAll()">Delete Everything</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ──────────────────── SETTINGS ──────────────────── -->
            <div class="page" id="settingsPage">

                <!-- Profile Card -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                    <h3 style="font-size:1.05rem;font-weight:700;">👤 My Profile</h3>
                    <button class="btn btn-secondary" style="padding:0.4rem 1rem;font-size:0.85rem;" onclick="openProfileModal()">✏️ Edit Profile</button>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
                    <div><div class="form-label">Username</div><div id="profileDisplayUsername" style="font-weight:600;font-size:1rem;">—</div></div>
                    <div><div class="form-label">Display Name</div><div id="profileDisplayName2" style="font-weight:600;">—</div></div>
                    <div><div class="form-label">Bio</div><div id="profileDisplayBio" style="color:var(--text-muted);font-size:0.875rem;">—</div></div>
                    <div><div class="form-label">Firm</div><div id="profileDisplayFirm" style="font-weight:600;">—</div></div>
                  </div>
                </div>

                <!-- Stats -->
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Account Goal</span><span class="metric-icon">🎯</span></div><div class="metric-value" id="settingsGoal">20</div><div class="metric-sub">Total accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Active Accounts</span><span class="metric-icon">💼</span></div><div class="metric-value" id="settingsActive">0</div><div class="metric-sub">With trades</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Portfolio Goal</span><span class="metric-icon">💰</span></div><div class="metric-value" id="settingsPortGoal">$92K</div><div class="metric-sub" id="settingsPortCalc">$4,600 × 20 accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Potential Payout</span><span class="metric-icon">🌾</span></div><div class="metric-value" id="settingsPayout">$40K</div><div class="metric-sub" id="settingsPayCalc">$2,000 × 20 accounts</div></div>
                </div>

                <!-- Trading Goals -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1.25rem;font-size:1.05rem;font-weight:700;">🎯 Trading Goals & Configuration</h3>
                    <form id="settingsForm" onsubmit="handleSettingsSave(event)">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.25rem;">
                          <div class="form-group">
                            <label class="form-label">Account Goal</label>
                            <select class="form-select" id="accountGoalSelect" onchange="handleGoalSelectChange(this.value)">
                                <option value="1">1 Account</option>
                                <option value="5">5 Accounts</option>
                                <option value="10">10 Accounts</option>
                                <option value="20" selected>20 Accounts</option>
                                <option value="50">50 Accounts</option>
                                <option value="100">100 Accounts</option>
                                <option value="custom">Custom...</option>
                            </select>
                          </div>
                          <div class="form-group" id="customGoalWrap" style="display:none;">
                            <label class="form-label">Custom Account Count</label>
                            <input type="number" class="form-input" id="customGoalInput" min="1" max="200" placeholder="1–200">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Goal per Account ($)</label>
                            <input type="number" class="form-input" id="settingsGoalPerAcc" value="4600" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Payout per Account ($)</label>
                            <input type="number" class="form-input" id="settingsPayoutPerAcc" value="2000" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Daily Target Min ($)</label>
                            <input type="number" class="form-input" id="settingsDailyMin" value="250" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Daily Target Max ($)</label>
                            <input type="number" class="form-input" id="settingsDailyMax" value="300" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Max Daily Drawdown ($)</label>
                            <input type="number" class="form-input" id="settingsMaxDD" value="2500" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Starting Balance ($)</label>
                            <input type="number" class="form-input" id="settingsStartBal" value="50000" min="0">
                          </div>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" style="width:auto;">💾 Save Settings</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSettings()">Reset to Default</button>
                        </div>
                    </form>
                </div>

                <!-- Contract Size Editor -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                  <h3 style="margin-bottom:0.5rem;font-size:1.05rem;font-weight:700;">📋 Risk Template Contract Sizes</h3>
                  <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Edit the number of contracts for each risk level. These update the Add Trade dropdown and template stats.</p>
                  <div class="contract-editor" id="contractEditor"></div>
                  <button class="btn btn-primary" style="width:auto;margin-top:0.75rem;" onclick="saveContractSizes()">💾 Save Contract Sizes</button>
                </div>

                <!-- Account table -->
                <div class="table-card" style="margin-top:1.5rem;">
                    <div class="table-header"><span class="card-title">All Configured Accounts</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Account</th><th>Nickname</th><th>Status</th><th>P&L</th><th>Progress</th><th>Trades</th><th>Win Rate</th><th>To Goal</th></tr></thead><tbody id="settingsAccBody"></tbody></table></div>
                </div>
            </div>

            <!-- ──────────────────── ADMIN PANEL ──────────────────── -->
            <div class="page" id="adminPanelPage">
                <div class="admin-banner">
                    <span class="admin-banner-icon">👑</span>
                    <div class="admin-banner-text">
                        <strong>Admin Panel — Full Visibility</strong>
                        <span>View all users, manage roles, view any user's trades, remove users.</span>
                    </div>
                </div>

                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Users</span><span class="metric-icon">👥</span></div><div class="metric-value" id="adminTotalUsers">—</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Trades</span><span class="metric-icon">📈</span></div><div class="metric-value" id="adminTotalTrades">—</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Combined P&L</span><span class="metric-icon">💰</span></div><div class="metric-value" id="adminTotalPnL">—</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Active Today</span><span class="metric-icon">🟢</span></div><div class="metric-value" id="adminActiveToday">—</div></div>
                </div>

                <div class="table-card" style="margin-bottom:1.5rem;">
                    <div class="table-header">
                        <span class="card-title">User Management</span>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <input type="text" class="form-input" id="adminUserSearch" placeholder="Search email..." style="padding:0.4rem 0.75rem;font-size:0.85rem;width:200px;" oninput="filterAdminUsers()">
                            <button class="btn btn-secondary" onclick="loadAdminData()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">🔄 Refresh</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table><thead><tr><th>User</th><th>Status</th><th>Role</th><th>Trades</th><th>P&L</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="adminUsersBody"></tbody></table>
                    </div>
                </div>

                <div id="adminUserTradesWrap" style="display:none;margin-bottom:1.5rem;">
                    <div class="section-header">
                        <div class="section-title">Trades for: <span id="adminViewingUserLabel" style="color:var(--accent);">—</span></div>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="btn btn-secondary" onclick="viewUserDashboard()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">👁️ View Dashboard</button>
                            <button class="btn btn-secondary" onclick="closeUserTrades()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">✕ Close</button>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Cycle</th><th>Notes</th></tr></thead><tbody id="adminUserTradesBody"></tbody></table></div>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;">🔑 Manage User Role</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Promote or demote any registered user.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">User Email</label>
                            <input type="text" class="form-input" id="roleUserEmail" placeholder="trader@example.com or username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Role</label>
                            <select class="form-select" id="roleUserRole">
                                <option value="user">User (standard)</option>
                                <option value="investor">💼 Investor (portal access)</option>
                                <option value="admin">Admin (full access)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:auto;" onclick="updateUserRole()">Update Role</button>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;">🔒 Reset User Password</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Send a password reset email to any user.</p>
                    <div class="form-group" style="max-width:400px;">
                        <label class="form-label">User Email</label>
                        <input type="email" class="form-input" id="resetUserEmail" placeholder="trader@example.com">
                    </div>
                    <button class="btn btn-secondary" style="width:auto;" onclick="adminResetUserPassword()">📧 Send Reset Email</button>
                </div>

                <div class="form-card" style="border-color:rgba(240,92,106,0.2);background:rgba(240,92,106,0.02);">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;color:var(--danger);">🗑️ Remove User Data</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">⚠️ Permanently deletes all trades and payouts for a user. Cannot be undone.</p>
                    <div class="form-group" style="max-width:400px;">
                        <label class="form-label">User Email</label>
                        <input type="email" class="form-input" id="removeUserEmail" placeholder="trader@example.com">
                    </div>
                    <button class="btn btn-danger" style="width:auto;" onclick="adminRemoveUserData()">Delete All User Data</button>
                </div>
            </div>

            <!-- ──────────────────── INVESTOR PORTAL ──────────────────── -->
            <div class="page" id="investorPortalPage">

                <!-- ── ADMIN VIEW ── -->
                <div id="ipAdminSection" style="display:none;">
                    <div class="admin-banner" style="background:linear-gradient(135deg,rgba(255,209,102,0.1),rgba(245,166,35,0.06));border-color:rgba(255,209,102,0.25);margin-bottom:1.5rem;position:relative;">
                        <span class="admin-banner-icon">💼</span>
                        <div class="admin-banner-text">
                            <strong>Investor Portal — Admin Controls</strong>
                            <span>Manage investors, approve mode requests, monitor account health.</span>
                        </div>
                        <!-- Notification Bell -->
                        <div style="margin-left:auto;position:relative;">
                            <button class="icon-btn" id="ipBellBtn" onclick="ipToggleNotifPanel()" style="width:auto;padding:0 0.75rem;gap:0.4rem;font-size:0.85rem;">
                                🔔 <span id="ipBellLabel">Requests</span>
                                <span id="ipBellBadge" style="display:none;background:var(--danger);color:#fff;border-radius:10px;padding:0 5px;font-size:0.68rem;font-weight:700;line-height:1.6;"></span>
                            </button>
                            <!-- Notification dropdown -->
                            <div id="ipNotifPanel" style="display:none;position:absolute;right:0;top:calc(100% + 8px);width:380px;background:var(--bg-card);border:1px solid var(--border-glow);border-radius:var(--radius);box-shadow:var(--shadow),0 0 40px rgba(0,0,0,0.4);z-index:500;max-height:440px;overflow-y:auto;">
                                <div style="padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);font-weight:700;font-size:0.875rem;display:flex;justify-content:space-between;align-items:center;">
                                    <span>🔔 Mode Requests</span>
                                    <span id="ipNotifCount" style="color:var(--text-muted);font-size:0.78rem;">—</span>
                                </div>
                                <div id="ipNotifList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- PA Health Panel — admin-only, real numbers -->
                    <div class="card" style="margin-bottom:1.5rem;border-color:rgba(59,126,248,0.25);">
                        <div class="card-header"><div class="card-title">🏦 PA Health Panel</div><div class="card-sub">Real account data — never shown to investors</div></div>
                        <div class="card-body" style="padding:1.25rem 1.5rem;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;">
                                <div style="padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);text-align:center;">
                                    <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.35rem;">PA Balance</div>
                                    <div id="ipAdminPaBal" style="font-family:'JetBrains Mono',monospace;font-size:1.35rem;font-weight:700;color:var(--accent);">—</div>
                                </div>
                                <div style="padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);text-align:center;">
                                    <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.35rem;">Profit vs Goal</div>
                                    <div id="ipAdminPaProgress" style="font-family:'JetBrains Mono',monospace;font-size:1.35rem;font-weight:700;color:var(--success);">—</div>
                                </div>
                                <div style="padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);text-align:center;">
                                    <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.35rem;">Warning Level</div>
                                    <div id="ipAdminWarnDot" style="font-size:1.5rem;">🟢</div>
                                </div>
                                <div style="padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);text-align:center;">
                                    <div style="font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.35rem;">At-Risk Investors</div>
                                    <div id="ipAdminAtRisk" style="font-family:'JetBrains Mono',monospace;font-size:1.35rem;font-weight:700;color:var(--warning);">—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Overview stats -->
                    <div class="metrics-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Investors</span><span class="metric-icon">👥</span></div><div class="metric-value" id="ipInvestorCount" style="color:var(--purple)">0</div><div class="metric-sub">Active accounts</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">PA Accounts Used</span><span class="metric-icon">🔗</span></div><div class="metric-value" id="ipLinkedCount" style="color:var(--cyan)">0</div><div class="metric-sub">Linked to investors</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">At Payout Goal</span><span class="metric-icon">🏆</span></div><div class="metric-value" id="ipAtGoalCount" style="color:var(--gold)">0</div><div class="metric-sub">Investors at target</div></div>
                        <div class="metric-card"><div class="metric-header"><span class="metric-label">Pending Requests</span><span class="metric-icon">🔔</span></div><div class="metric-value" id="ipPendingCount" style="color:var(--warning)">0</div><div class="metric-sub">Awaiting response</div></div>
                    </div>

                    <!-- Investor list table -->
                    <div class="table-card" style="margin-bottom:1.5rem;">
                        <div class="table-header">
                            <div><span class="card-title">Investor Accounts</span></div>
                        </div>
                        <div class="table-wrap">
                            <table>
                                <thead><tr><th>Name</th><th>Email</th><th>Linked Account</th><th>Entry</th><th>Mode</th><th>Current Value</th><th>Progress</th><th>Warning</th><th>Actions</th></tr></thead>
                                <tbody id="ipInvestorTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add investor form -->
                    <div class="form-card" style="margin-bottom:1.5rem;">
                        <h3 style="margin-bottom:0.4rem;font-size:1rem;font-weight:700;">➕ Add / Update Investor</h3>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Search by email or username, pick their linked account, set entry / payout / mode.</p>

                        <div class="form-grid" style="margin-bottom:1rem;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label">Search User (email or username)</label>
                                <div style="position:relative;">
                                    <input type="text" class="form-input" id="ipUserSearch" placeholder="Start typing..." oninput="ipSearchUsers()" autocomplete="off">
                                    <div id="ipUserDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg-elevated);border:1px solid var(--border-glow);border-radius:var(--radius-sm);z-index:200;max-height:180px;overflow-y:auto;margin-top:2px;box-shadow:var(--shadow);"></div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label">Selected</label>
                                <div id="ipSelectedUser" style="padding:0.75rem 1rem;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-muted);min-height:44px;display:flex;align-items:center;gap:0.5rem;">
                                    <span>No user selected</span>
                                </div>
                                <input type="hidden" id="ipSelectedUserId">
                                <input type="hidden" id="ipSelectedUserEmail">
                                <input type="hidden" id="ipSelectedUserName">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Link to Account</label>
                                <select class="form-select" id="ipLinkAccountSelect" onchange="ipPreviewFormula()">
                                    <option value="">— Select Account —</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Starting Mode</label>
                                <select class="form-select" id="ipNewMode">
                                    <option value="conservative">🛡 Conservative</option>
                                    <option value="base">⚡ Base</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Entry Amount ($)</label>
                                <input type="number" class="form-input" id="ipNewEntry" placeholder="115" value="115" min="1" oninput="ipPreviewFormula()" style="font-family:'JetBrains Mono',monospace;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payout Target ($)</label>
                                <input type="number" class="form-input" id="ipNewPayout" placeholder="800" value="800" min="1" oninput="ipPreviewFormula()" style="font-family:'JetBrains Mono',monospace;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Display Name (optional)</label>
                                <input type="text" class="form-input" id="ipNewName" placeholder="e.g. Bryan, Catty...">
                            </div>
                        </div>

                        <!-- Live formula preview -->
                        <div id="ipFormulaPreview" style="margin-bottom:1rem;padding:0.875rem 1.25rem;background:var(--bg-elevated);border-radius:var(--radius-sm);border:1px solid var(--border);font-size:0.82rem;color:var(--text-muted);display:none;">
                            <div style="display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center;">
                                <span>Multiplier: <span id="ipFormulaMultiplier" style="color:var(--purple);font-family:'JetBrains Mono',monospace;">0.1489</span></span>
                                <span>Entry: <span id="ipFormulaEntry" style="color:var(--gold);font-family:'JetBrains Mono',monospace;">$115</span></span>
                                <span>Account P&L: <span id="ipFormulaPaPnl" style="color:var(--success);font-family:'JetBrains Mono',monospace;">—</span> → Investor value: <span id="ipFormulaCurrentVal" style="color:var(--gold);font-family:'JetBrains Mono',monospace;">—</span></span>
                            </div>
                        </div>

                        <div class="form-footer">
                            <button class="btn btn-primary" style="width:auto;" onclick="ipAddInvestor()">➕ Add Investor</button>
                            <button class="btn btn-secondary" onclick="ipClearNewForm()">Clear</button>
                        </div>
                    </div>
                </div><!-- /ipAdminSection -->

                <!-- ── INVESTOR VIEW ── -->
                <div id="ipInvestorSection" style="display:none;">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&display=swap');

                        /* ═══════════════════════════
                           INVESTOR PORTAL — CLEAN COLUMN LAYOUT
                           ═══════════════════════════ */
                        .ipv { font-family: 'Space Grotesk', sans-serif; }

                        /* ─── HERO HEADER ─── */
                        .ipv-banner {
                            position: relative;
                            border-radius: 20px;
                            overflow: hidden;
                            margin-bottom: 1.25rem;
                            padding: 2rem 2.5rem;
                            background: linear-gradient(135deg, #080e1f 0%, #0c1530 45%, #0a1020 100%);
                            border: 1px solid rgba(74,142,255,0.18);
                            box-shadow: 0 8px 48px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.04);
                        }
                        .ipv-banner::before {
                            content: '';
                            position: absolute;
                            inset: 0;
                            background:
                                radial-gradient(ellipse 50% 100% at 100% 50%, rgba(74,142,255,0.1) 0%, transparent 60%),
                                radial-gradient(ellipse 30% 60% at 0% 100%, rgba(167,139,250,0.07) 0%, transparent 60%),
                                radial-gradient(ellipse 40% 40% at 50% 0%, rgba(240,192,64,0.04) 0%, transparent 60%);
                            pointer-events: none;
                        }
                        .ipv-banner-inner {
                            position: relative; z-index: 1;
                            display: grid;
                            grid-template-columns: 1fr auto;
                            align-items: center;
                            gap: 2rem;
                        }
                        @media(max-width:640px){ .ipv-banner-inner{ grid-template-columns:1fr; } }
                        .ipv-banner-left {}
                        .ipv-label {
                            font-size: 0.58rem;
                            font-weight: 700;
                            letter-spacing: 0.25em;
                            text-transform: uppercase;
                            color: rgba(74,142,255,0.7);
                            margin-bottom: 0.5rem;
                        }
                        .ipv-value {
                            font-family: 'Syne', sans-serif;
                            font-size: clamp(2.8rem, 7vw, 4.5rem);
                            font-weight: 800;
                            line-height: 1;
                            letter-spacing: -0.04em;
                            color: #fff;
                            margin-bottom: 0.75rem;
                        }
                        .ipv-badges {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            flex-wrap: wrap;
                        }
                        .ipv-gain {
                            padding: 0.25rem 0.7rem;
                            border-radius: 20px;
                            font-size: 0.78rem;
                            font-weight: 700;
                            background: rgba(46,204,154,0.15);
                            border: 1px solid rgba(46,204,154,0.35);
                            color: #2ecc9a;
                        }
                        .ipv-gain.neg { background:rgba(240,92,106,0.12); border-color:rgba(240,92,106,0.35); color:#f05c6a; }
                        .ip-mode-badge { display:inline-flex; align-items:center; gap:0.3rem; padding:0.25rem 0.65rem; border-radius:20px; font-size:0.72rem; font-weight:700; border:1px solid; }
                        .ip-mode-badge.conservative { background:rgba(46,204,154,0.1); color:#2ecc9a; border-color:rgba(46,204,154,0.35); }
                        .ip-mode-badge.base { background:rgba(167,139,250,0.12); color:#a78bfa; border-color:rgba(167,139,250,0.4); }
                        .ip-mode-badge.pending { background:rgba(245,166,35,0.1); color:#f5a623; border-color:rgba(245,166,35,0.35); }
                        .ipv-banner-right {
                            display: flex;
                            flex-direction: column;
                            gap: 0.625rem;
                            align-items: flex-end;
                        }
                        @media(max-width:640px){ .ipv-banner-right{ align-items:flex-start; } }
                        .ipv-kpipair {
                            display: flex;
                            gap: 0.625rem;
                        }
                        .ipv-kpi {
                            background: rgba(255,255,255,0.04);
                            border: 1px solid rgba(255,255,255,0.08);
                            border-radius: 14px;
                            padding: 0.75rem 1.1rem;
                            min-width: 95px;
                            text-align: center;
                        }
                        .ipv-kpi-lbl { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.28); margin-bottom: 0.35rem; }
                        .ipv-kpi-val { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; }

                        /* ─── PROGRESS ROW ─── */
                        .ipv-prog-row {
                            position: relative; z-index: 1;
                            margin-top: 1.5rem;
                            display: flex;
                            flex-direction: column;
                            gap: 0.45rem;
                        }
                        .ipv-prog-labels {
                            display: flex;
                            justify-content: space-between;
                            font-size: 0.7rem;
                            font-weight: 700;
                            color: rgba(255,255,255,0.35);
                        }
                        .ipv-prog-labels span:last-child { color: #f0c040; }
                        .ipv-prog-track {
                            height: 8px;
                            background: rgba(255,255,255,0.06);
                            border-radius: 4px;
                            overflow: hidden;
                            position: relative;
                        }
                        .ipv-prog-fill {
                            height: 100%;
                            border-radius: 4px;
                            background: linear-gradient(90deg, #4a8eff 0%, #a78bfa 55%, #f0c040 100%);
                            box-shadow: 0 0 12px rgba(74,142,255,0.5);
                            transition: width 2s cubic-bezier(0.4,0,0.2,1);
                        }
                        .ipv-prog-pct { font-size: 0.68rem; font-weight: 700; color: rgba(255,255,255,0.4); text-align: center; }

                        /* ─── STAT ROW (replaces bento grid) ─── */
                        .ipv-stat-row {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 0.75rem;
                            margin-bottom: 1.25rem;
                        }
                        @media(max-width:860px){ .ipv-stat-row{ grid-template-columns: repeat(2,1fr); } }
                        @media(max-width:440px){ .ipv-stat-row{ grid-template-columns: 1fr; } }

                        .ipv-stat {
                            background: rgba(255,255,255,0.025);
                            border: 1px solid rgba(255,255,255,0.07);
                            border-radius: 16px;
                            padding: 1rem 1.25rem;
                            display: flex;
                            align-items: center;
                            gap: 0.875rem;
                            transition: border-color 0.2s;
                        }
                        .ipv-stat:hover { border-color: rgba(255,255,255,0.14); }
                        .ipv-stat-icon {
                            width: 38px; height: 38px; border-radius: 10px;
                            display: flex; align-items: center; justify-content: center;
                            font-size: 1.1rem; flex-shrink: 0;
                        }
                        .ipv-stat-body {}
                        .ipv-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; line-height: 1.1; margin-bottom: 0.2rem; }
                        .ipv-stat-lbl { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.25); }

                        /* ─── MAIN TWO-COLUMN LAYOUT ─── */
                        .ipv-main-cols {
                            display: grid;
                            grid-template-columns: 1fr 340px;
                            gap: 1rem;
                            margin-bottom: 1.25rem;
                            align-items: start;
                        }
                        @media(max-width:960px){ .ipv-main-cols{ grid-template-columns: 1fr; } }

                        /* ─── CHART CARD ─── */
                        .ipv-chart-card {
                            background: rgba(6,11,25,0.95);
                            border: 1px solid rgba(255,255,255,0.07);
                            border-radius: 20px;
                            overflow: hidden;
                            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                        }
                        .ipv-chart-header {
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 1rem 1.4rem;
                            border-bottom: 1px solid rgba(255,255,255,0.06);
                        }
                        .ipv-chart-title { font-size: 0.85rem; font-weight: 700; color: rgba(255,255,255,0.8); }
                        .ipv-chart-legend { display:flex; gap:1rem; align-items:center; }
                        .ipv-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:3px; }
                        .ipv-chart-body { padding: 1.25rem 1rem 1rem; position: relative; height: 300px; }

                        /* ─── SIDE PANEL (ring + email) ─── */
                        .ipv-side-panel {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        /* ring progress card */
                        .ipv-ring-card {
                            background: rgba(255,255,255,0.025);
                            border: 1px solid rgba(255,255,255,0.08);
                            border-radius: 20px;
                            padding: 1.5rem;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 1.1rem;
                        }
                        .ipv-ring-wrap { position: relative; width: 130px; height: 130px; flex-shrink: 0; }
                        .ipv-ring-svg { transform: rotate(-90deg); width: 130px; height: 130px; }
                        .ipv-ring-track { fill:none; stroke:rgba(255,255,255,0.06); stroke-width:10; }
                        .ipv-ring-fill { fill:none; stroke-width:10; stroke-linecap:round; stroke-dasharray:376.99; stroke-dashoffset:376.99; transition:stroke-dashoffset 2s cubic-bezier(0.4,0,0.2,1),stroke 0.5s; filter:drop-shadow(0 0 8px currentColor); }
                        .ipv-ring-center { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
                        .ipv-ring-pct { font-family:'Syne',sans-serif; font-size:1.6rem; font-weight:800; line-height:1; }
                        .ipv-ring-sub { font-size:0.5rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:rgba(255,255,255,0.3); margin-top:0.3rem; }
                        .ipv-ring-info { width:100%; }
                        .ipv-ring-title { font-size:0.75rem; font-weight:700; color:rgba(255,255,255,0.55); margin-bottom:0.6rem; text-align:center; }
                        .ipv-ring-actions { display:flex; flex-direction:column; gap:0.4rem; }

                        /* ─── MAIN BODY TWO-COLUMN ─── */
                        .ipv-body {
                            display: grid;
                            grid-template-columns: 1fr 300px;
                            gap: 1rem;
                            margin-bottom: 1.25rem;
                            align-items: start;
                        }
                        @media(max-width:960px){ .ipv-body{ grid-template-columns:1fr; } }

                        /* side stats column */
                        .ipv-side-stats {
                            display: flex;
                            flex-direction: column;
                            gap: 0.75rem;
                        }
                        .ipv-stat-card {
                            background: rgba(255,255,255,0.025);
                            border: 1px solid rgba(255,255,255,0.07);
                            border-radius: 14px;
                            padding: 0.875rem 1rem;
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                            transition: border-color 0.2s;
                        }
                        .ipv-stat-card:hover { border-color: rgba(255,255,255,0.14); }
                        .ipv-stat-icon {
                            width: 34px; height: 34px; border-radius: 9px;
                            display: flex; align-items: center; justify-content: center;
                            font-size: 1rem; flex-shrink: 0;
                        }
                        .ipv-stat-info {}
                        .ipv-stat-val { font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:700; line-height:1.1; margin-bottom:0.15rem; }
                        .ipv-stat-lbl { font-size:0.58rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:rgba(255,255,255,0.25); }

                        /* ─── EMAIL CARD ─── */
                        .ipv-email-card {
                            background: rgba(255,255,255,0.025);
                            border: 1px solid rgba(255,255,255,0.08);
                            border-radius: 14px;
                            padding: 1rem;
                        }
                        .ipv-email-title { font-size:0.78rem; font-weight:700; color:rgba(255,255,255,0.7); margin-bottom:0.3rem; }
                        .ipv-email-sub { font-size:0.65rem; color:rgba(255,255,255,0.28); margin-bottom:0.875rem; line-height:1.5; }
                        .ipv-email-btn {
                            width:100%; padding:0.6rem 0.875rem;
                            background:linear-gradient(135deg,rgba(74,142,255,0.16),rgba(167,139,250,0.1));
                            border:1px solid rgba(74,142,255,0.3); border-radius:10px;
                            color:#7ab4ff; font-family:'Space Grotesk',sans-serif; font-size:0.78rem; font-weight:700;
                            cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:0.4rem;
                        }
                        .ipv-email-btn:hover { background:linear-gradient(135deg,rgba(74,142,255,0.26),rgba(167,139,250,0.18)); border-color:rgba(74,142,255,0.45); color:#a8d4ff; }
                        .ipv-email-btn:disabled { opacity:0.5; cursor:not-allowed; }
                        .ipv-email-schedule { display:flex; align-items:center; justify-content:space-between; margin-top:0.75rem; padding:0.5rem 0.625rem; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:8px; }
                        .ipv-email-schedule-lbl { font-size:0.63rem; color:rgba(255,255,255,0.32); }
                        .ipv-auto-toggle { position:relative; width:34px; height:18px; background:rgba(255,255,255,0.08); border-radius:9px; cursor:pointer; transition:all 0.2s; border:none; flex-shrink:0; }
                        .ipv-auto-toggle.on { background:rgba(74,142,255,0.5); }
                        .ipv-auto-toggle::after { content:''; position:absolute; top:2px; left:2px; width:14px; height:14px; background:white; border-radius:50%; transition:all 0.2s; opacity:0.6; }
                        .ipv-auto-toggle.on::after { left:18px; opacity:1; }

                        /* milestone track */
                        .ipv-ms-card {
                            background: rgba(255,255,255,0.025);
                            border: 1px solid rgba(255,255,255,0.08);
                            border-radius: 20px;
                            padding: 1.4rem;
                        }
                        .ipv-ms-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.2rem; }
                        .ipv-ms-title { font-size:0.85rem; font-weight:700; }
                        .ipv-ms-sub { font-size:0.62rem; color:rgba(255,255,255,0.3); }
                        .ipv-ms-track { display:flex; align-items:flex-start; overflow-x:auto; padding-bottom:0.4rem; scrollbar-width:none; gap:0; }
                        .ipv-ms-track::-webkit-scrollbar { display:none; }
                        .ipv-ms-node { display:flex; flex-direction:column; align-items:center; flex-shrink:0; min-width:52px; position:relative; }
                        .ipv-ms-line { position:absolute; top:13px; left:calc(50% + 13px); width:calc(100% - 13px); height:2px; z-index:0; }
                        .ipv-ms-dot { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.6rem; font-weight:800; border:2px solid; position:relative; z-index:1; transition:all 0.3s; }
                        .ipv-ms-dot.done  { background:rgba(46,204,154,0.2); border-color:#2ecc9a; color:#2ecc9a; box-shadow:0 0 10px rgba(46,204,154,0.4); }
                        .ipv-ms-dot.now   { background:rgba(74,142,255,0.2); border-color:#4a8eff; color:#4a8eff; box-shadow:0 0 16px rgba(74,142,255,0.6); animation:msP 1.8s ease infinite; }
                        .ipv-ms-dot.pend  { background:transparent; border-color:rgba(255,255,255,0.1); color:rgba(255,255,255,0.18); }
                        .ipv-ms-dot.goal  { background:rgba(240,192,64,0.2); border-color:#f0c040; color:#f0c040; box-shadow:0 0 14px rgba(240,192,64,0.4); }
                        @keyframes msP { 0%,100%{box-shadow:0 0 10px rgba(74,142,255,0.4)} 50%{box-shadow:0 0 24px rgba(74,142,255,0.8)} }
                        .ipv-ms-lbl { font-size:0.5rem; font-weight:700; margin-top:0.35rem; color:rgba(255,255,255,0.22); white-space:nowrap; font-family:'JetBrains Mono',monospace; }
                        .ipv-ms-lbl.done { color:#2ecc9a; } .ipv-ms-lbl.now { color:#4a8eff; } .ipv-ms-lbl.goal { color:#f0c040; }

                        /* ─── SESSIONS ─── */
                        .ipv-sessions {
                            background: rgba(255,255,255,0.02);
                            border: 1px solid rgba(255,255,255,0.07);
                            border-radius: 20px;
                            overflow: hidden;
                            margin-bottom: 1rem;
                        }
                        .ipv-sessions-head {
                            display: flex; justify-content:space-between; align-items:center;
                            padding: 1rem 1.4rem;
                            border-bottom: 1px solid rgba(255,255,255,0.06);
                            background: rgba(255,255,255,0.01);
                        }
                        .ipv-sessions-title { font-size:0.85rem; font-weight:700; }

                        /* ─── ALERT BANNERS ─── */
                        .ipv-alert { display:none; align-items:center; gap:0.875rem; flex-wrap:wrap; border-radius:14px; padding:0.85rem 1.1rem; margin-bottom:0.875rem; position:relative; overflow:hidden; }
                        .ipv-alert.show { display:flex; }
                        .ipv-alert.l1 { background:rgba(245,166,35,0.07); border:1px solid rgba(245,166,35,0.2); }
                        .ipv-alert.l2 { background:rgba(240,100,50,0.08); border:1px solid rgba(240,100,50,0.25); }
                        .ipv-alert.l3 { background:rgba(240,92,106,0.09); border:1px solid rgba(240,92,106,0.28); }
                        .ipv-alert-stripe { position:absolute; left:0; top:0; bottom:0; width:3px; border-radius:2px 0 0 2px; }
                        .ipv-alert.l1 .ipv-alert-stripe { background:#f5a623; }
                        .ipv-alert.l2 .ipv-alert-stripe { background:#f06432; }
                        .ipv-alert.l3 .ipv-alert-stripe { background:#f05c6a; }
                        .ipv-alert-body { flex:1; min-width:160px; }
                        .ipv-alert-title { font-size:0.8rem; font-weight:700; margin-bottom:0.15rem; }
                        .ipv-alert-text { font-size:0.73rem; color:rgba(255,255,255,0.42); line-height:1.5; }

                        /* ─── TERMINATED ─── */
                        .ipv-terminated {
                            display:none; text-align:center;
                            border-radius:20px; padding:3rem 2rem; margin-bottom:1rem;
                            background: linear-gradient(160deg,#100408,#160509);
                            border: 1px solid rgba(240,92,106,0.25);
                            box-shadow: 0 0 60px rgba(240,92,106,0.08);
                        }
                        .ipv-terminated.show { display:block; }

                        /* ─── PULSE DOT ─── */
                        .ipv-pulse { width:8px; height:8px; border-radius:50%; background:#f05c6a; display:inline-block; animation:pdot 1.2s ease infinite; }
                        @keyframes pdot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(1.5)} }

                        /* ─── MODAL ─── */
                        #ipModeModal { position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); z-index:9000; display:flex; align-items:center; justify-content:center; padding:1rem; }
                        .ip-modal-card { background:#0c1525; border:1px solid rgba(255,255,255,0.1); border-radius:24px; padding:2rem; width:100%; max-width:420px; box-shadow:0 40px 100px rgba(0,0,0,0.6); animation:slideDown 0.25s ease; }
                        .ip-mode-opt { padding:1rem 1.25rem; border:2px solid rgba(255,255,255,0.07); border-radius:12px; cursor:pointer; transition:all 0.2s; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.875rem; }
                        .ip-mode-opt:hover { border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.03); }
                        .ip-mode-opt.selected-cons { border-color:#2ecc9a; background:rgba(46,204,154,0.07); }
                        .ip-mode-opt.selected-base { border-color:#a78bfa; background:rgba(167,139,250,0.07); }
                        .ip-mode-opt-icon { font-size:1.5rem; flex-shrink:0; }
                        .ip-mode-opt-title { font-weight:700; font-size:0.9rem; }
                        .ip-mode-opt-sub { font-size:0.78rem; color:rgba(255,255,255,0.35); margin-top:0.15rem; }

                        /* ─── HERO ALIASES (ensure ipv-hero / ipv-hero-top work) ─── */
                        .ipv-hero { position:relative; border-radius:20px; overflow:hidden; margin-bottom:1.25rem; padding:2rem 2.5rem;
                            background:linear-gradient(135deg,#080e1f 0%,#0c1530 45%,#0a1020 100%);
                            border:1px solid rgba(74,142,255,0.18); box-shadow:0 8px 48px rgba(0,0,0,0.55),inset 0 1px 0 rgba(255,255,255,0.04); }
                        .ipv-hero::before { content:''; position:absolute; inset:0; pointer-events:none;
                            background:radial-gradient(ellipse 50% 100% at 100% 50%,rgba(74,142,255,0.1) 0%,transparent 60%),
                            radial-gradient(ellipse 30% 60% at 0% 100%,rgba(167,139,250,0.07) 0%,transparent 60%); }
                        .ipv-hero-top { position:relative; z-index:1; display:flex; align-items:center; justify-content:space-between; gap:2rem; flex-wrap:wrap; }
                        .ipv-overline { font-size:0.58rem; font-weight:700; letter-spacing:0.25em; text-transform:uppercase; color:rgba(74,142,255,0.7); margin-bottom:0.5rem; }
                        .ipv-kpi-row { display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; flex-shrink:0; }
                        .ipv-kpi-pill { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:0.6rem 0.9rem; display:flex; flex-direction:column; align-items:center; gap:0.2rem; min-width:75px; }
                        .ipv-kpi-pill-lbl { font-size:0.52rem; font-weight:700; letter-spacing:0.12em; text-transform:uppercase; color:rgba(255,255,255,0.28); }
                        .ipv-kpi-pill-val { font-family:'JetBrains Mono',monospace; font-size:1rem; font-weight:700; }
                    </style>

                    <canvas id="ipParticleCanvas" style="display:none;"></canvas>

                    <div class="ipv">

                        <!-- ── ALERT BANNERS ── -->
                        <div id="ipWarnL1" class="ipv-alert l1">
                            <div class="ipv-alert-stripe"></div>
                            <span style="font-size:1.2rem;">📉</span>
                            <div class="ipv-alert-body">
                                <div class="ipv-alert-title" style="color:#f5c842;">Drawdown Period Detected</div>
                                <div class="ipv-alert-text">Your portfolio is experiencing a drawdown. Consider switching to Conservative strategy.</div>
                            </div>
                            <button class="btn" style="flex-shrink:0;padding:0.35rem 0.9rem;font-size:0.75rem;font-weight:700;background:rgba(245,166,35,0.12);color:#f5c842;border:1px solid rgba(245,166,35,0.3);border-radius:8px;" onclick="ipOpenModeModal('conservative')">Switch →</button>
                        </div>
                        <div id="ipWarnL2" class="ipv-alert l2">
                            <div class="ipv-alert-stripe"></div>
                            <span style="font-size:1.2rem;">⚠️</span>
                            <div class="ipv-alert-body">
                                <div class="ipv-alert-title" style="color:#f07a42;">Elevated Risk — Action Recommended</div>
                                <div class="ipv-alert-text">Your account value has declined significantly. Your account manager has been alerted.</div>
                            </div>
                            <button class="btn" style="flex-shrink:0;padding:0.35rem 0.9rem;font-size:0.75rem;font-weight:700;background:rgba(240,100,50,0.12);color:#f07a42;border:1px solid rgba(240,100,50,0.3);border-radius:8px;" onclick="ipOpenModeModal('conservative')">Act Now</button>
                        </div>
                        <div id="ipWarnL3" class="ipv-alert l3">
                            <div class="ipv-alert-stripe"></div>
                            <span style="font-size:1.2rem;">🔴</span>
                            <div class="ipv-alert-body">
                                <div class="ipv-alert-title" style="color:#f05c6a;">Critical — Portfolio Under Review</div>
                                <div class="ipv-alert-text">Trading has been paused. Your account manager is actively reviewing.</div>
                            </div>
                            <span style="display:inline-flex;align-items:center;gap:0.4rem;font-size:0.75rem;font-weight:700;color:#f05c6a;flex-shrink:0;"><span class="ipv-pulse"></span>Live Review</span>
                        </div>
                        <div id="ipWarnL4" class="ipv-terminated">
                            <div style="font-size:2.8rem;margin-bottom:1rem;filter:drop-shadow(0 0 20px rgba(240,92,106,0.6));">🛑</div>
                            <div style="font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;color:#f05c6a;margin-bottom:0.6rem;">Investment Cycle Closed</div>
                            <div style="color:rgba(245,160,168,0.6);font-size:0.88rem;max-width:380px;margin:0 auto 1.5rem;line-height:1.8;">This investment cycle has concluded. Your account manager will be in touch to discuss results and next steps.</div>
                            <div style="display:inline-flex;align-items:center;gap:0.5rem;background:rgba(240,92,106,0.1);border:1px solid rgba(240,92,106,0.25);border-radius:10px;padding:0.5rem 1.25rem;color:#f05c6a;font-size:0.8rem;font-weight:700;"><span class="ipv-pulse"></span>Account Manager Will Be In Contact</div>
                        </div>

                        <!-- ── HERO CARD ── -->
                        <div class="ipv-hero" id="ipInvHeader">
                            <div class="ipv-hero-top">
                                <div>
                                    <div class="ipv-overline">Your Account Value</div>
                                    <div class="ipv-value" id="ipDisplayValue">$—</div>
                                    <div class="ipv-badges">
                                        <span class="ipv-gain" id="ipCycleGainBadge">+0.00%</span>
                                        <span style="font-size:0.7rem;color:rgba(255,255,255,0.28);">this cycle</span>
                                        <span id="ipModeBadge" class="ip-mode-badge conservative">🛡 Conservative</span>
                                        <span id="ipPendingBadge" style="display:none;" class="ip-mode-badge pending">⏳ Pending</span>
                                    </div>
                                </div>
                                <div class="ipv-kpi-row">
                                    <div class="ipv-kpi-pill">
                                        <span class="ipv-kpi-pill-lbl">Entry</span>
                                        <span class="ipv-kpi-pill-val" id="ipEntryDisplay" style="color:rgba(255,255,255,0.65);">—</span>
                                    </div>
                                    <div class="ipv-kpi-pill">
                                        <span class="ipv-kpi-pill-lbl" style="color:rgba(240,192,64,0.6);">Target</span>
                                        <span class="ipv-kpi-pill-val" id="ipPayoutDisplay" style="color:#f0c040;">—</span>
                                    </div>
                                    <button id="ipModeReqBtn" class="btn" style="padding:0.4rem 0.9rem;font-size:0.75rem;font-weight:700;background:rgba(74,142,255,0.1);color:#4a8eff;border:1px solid rgba(74,142,255,0.25);border-radius:10px;white-space:nowrap;" onclick="ipOpenModeModal()">↕ Change Strategy</button>
                                </div>
                            </div>
                            <div class="ipv-prog-row" id="ipProgressSection">
                                <div class="ipv-prog-labels">
                                    <span id="ipInvProgLeft2">—</span>
                                    <span id="ipInvProgPct" style="color:rgba(255,255,255,0.45);">0% to payout</span>
                                    <span id="ipInvProgRight">—</span>
                                </div>
                                <div class="ipv-prog-track">
                                    <div class="ipv-prog-fill" id="ipInvProgFill" style="width:0%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── MAIN BODY: chart + side stats ── -->
                        <div class="ipv-body" id="ipEquitySection">
                            <div class="ipv-chart-card">
                                <div class="ipv-chart-header">
                                    <span class="ipv-chart-title">📈 Portfolio Equity Curve</span>
                                    <div class="ipv-chart-legend">
                                        <span style="font-size:0.65rem;color:rgba(255,255,255,0.35);display:flex;align-items:center;gap:0.3rem;">
                                            <span class="ipv-dot" style="background:#f0c040;box-shadow:0 0 5px rgba(240,192,64,0.7);"></span>Your Value
                                        </span>
                                        <span style="font-size:0.65rem;color:rgba(255,255,255,0.2);display:flex;align-items:center;gap:0.3rem;">
                                            <span class="ipv-dot" style="background:rgba(255,255,255,0.22);"></span>Target Path
                                        </span>
                                    </div>
                                </div>
                                <div class="ipv-chart-body">
                                    <canvas id="ipEquityChart" style="width:100%;height:100%;"></canvas>
                                </div>
                            </div>
                            <div class="ipv-side-stats">
                                <div class="ipv-stat-card">
                                    <div class="ipv-stat-icon" style="background:rgba(46,204,154,0.1);">📈</div>
                                    <div class="ipv-stat-info">
                                        <div class="ipv-stat-val" id="ipStatBest" style="color:#2ecc9a;">—</div>
                                        <div class="ipv-stat-lbl">Best Session</div>
                                    </div>
                                </div>
                                <div class="ipv-stat-card">
                                    <div class="ipv-stat-icon" style="background:rgba(240,92,106,0.1);">📉</div>
                                    <div class="ipv-stat-info">
                                        <div class="ipv-stat-val" id="ipStatWorst" style="color:#f05c6a;">—</div>
                                        <div class="ipv-stat-lbl">Worst Session</div>
                                    </div>
                                </div>
                                <div class="ipv-stat-card">
                                    <div class="ipv-stat-icon" style="background:rgba(74,142,255,0.1);">📊</div>
                                    <div class="ipv-stat-info">
                                        <div class="ipv-stat-val" id="ipStatSessions" style="color:#4a8eff;">—</div>
                                        <div class="ipv-stat-lbl">Total Sessions</div>
                                    </div>
                                </div>
                                <div class="ipv-stat-card">
                                    <div class="ipv-stat-icon" style="background:rgba(167,139,250,0.1);">🎯</div>
                                    <div class="ipv-stat-info">
                                        <div class="ipv-stat-val" id="ipStatWinRate" style="color:#a78bfa;">—</div>
                                        <div class="ipv-stat-lbl">Win Rate</div>
                                    </div>
                                </div>
                                <div class="ipv-ring-card">
                                    <div class="ipv-ring-wrap">
                                        <svg class="ipv-ring-svg" width="90" height="90" viewBox="0 0 130 130">
                                            <circle class="ipv-ring-track" cx="65" cy="65" r="60"/>
                                            <circle class="ipv-ring-fill" id="ipRingFill" cx="65" cy="65" r="60" stroke="#4a8eff"/>
                                        </svg>
                                        <div class="ipv-ring-center">
                                            <div class="ipv-ring-pct" id="ipRingPct" style="color:#4a8eff;">0%</div>
                                            <div class="ipv-ring-sub">payout</div>
                                        </div>
                                    </div>
                                    <div class="ipv-ring-info">
                                        <div class="ipv-ring-title">Payout Progress</div>
                                        <div style="font-size:0.68rem;color:rgba(255,255,255,0.28);margin-top:0.2rem;">
                                            <span id="ipEntryDisplay2">—</span> → <span id="ipPayoutDisplay2" style="color:#f0c040;">—</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- ── EMAIL REPORT CARD ── -->
                                <div class="ipv-email-card">
                                    <div class="ipv-email-title">📧 Email Report</div>
                                    <div class="ipv-email-sub">Send today's trading stats to your investor.</div>
                                    <button class="ipv-email-btn" id="ipEmailReportBtn" onclick="ipSendEmailReport()">
                                        <span>📤</span> Send Report Now
                                    </button>
                                    <div class="ipv-email-schedule">
                                        <div class="ipv-email-schedule-lbl">
                                            <div style="font-weight:700;color:rgba(255,255,255,0.45);margin-bottom:1px;">Auto 5:00 PM daily</div>
                                            <div id="ipAutoEmailStatus" style="font-size:0.58rem;">Off — toggle to enable</div>
                                        </div>
                                        <button class="ipv-auto-toggle" id="ipAutoToggle" onclick="ipToggleAutoEmail()" title="Auto-send at 5pm"></button>
                                    </div>
                                    <div id="ipEmailFeedback" style="display:none;margin-top:0.6rem;padding:0.45rem 0.625rem;border-radius:8px;font-size:0.7rem;font-weight:600;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── MILESTONES ── -->
                        <div class="ipv-ms-card" id="ipMilestonesSection" style="margin-bottom:1.25rem;">
                            <div class="ipv-ms-head">
                                <div class="ipv-ms-title">🚀 Your Journey</div>
                                <span class="ipv-ms-sub" id="ipMilestonesLabel">checkpoints</span>
                            </div>
                            <div class="ipv-ms-track" id="ipMilestoneChips"></div>
                        </div>

                        <!-- ── SESSION HISTORY ── -->
                        <div class="ipv-sessions" id="ipTradeSection">
                            <div class="ipv-sessions-head">
                                <div class="ipv-sessions-title">Session History</div>
                                <span id="ipTradeCount" style="font-size:0.68rem;color:rgba(255,255,255,0.3);">0 sessions</span>
                            </div>
                            <div style="max-height:420px;overflow-y:auto;" id="ipTradeBody"></div>
                        </div>

                    </div><!-- /ipv -->
                </div><!-- /ipInvestorSection -->

                <!-- Not registered -->
                <div id="ipNotRegistered" style="display:none;">
                    <div style="text-align:center;padding:4rem 2rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);">
                        <div style="font-size:3rem;margin-bottom:1rem;">💼</div>
                        <h3 style="font-size:1.2rem;font-weight:700;margin-bottom:0.5rem;">Not Yet Registered</h3>
                        <p style="color:var(--text-muted);font-size:0.9rem;max-width:380px;margin:0 auto;">You haven't been added to the investor portal yet. Contact your account manager to get registered.</p>
                    </div>
                </div>

            </div><!-- /investorPortalPage -->

            <!-- ── MODE REQUEST MODAL ── -->
            <div id="ipModeModal" style="display:none;" onclick="if(event.target===this)ipCloseModeModal()">
                <div class="ip-modal-card">
                    <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:0.35rem;">🔄 Request Strategy Change</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Select your preferred strategy. Your account manager will review your request.</p>

                    <div id="ipModeOptCons" class="ip-mode-opt" onclick="ipSelectModeOption('conservative')">
                        <div class="ip-mode-opt-icon">🛡</div>
                        <div><div class="ip-mode-opt-title">Conservative</div><div class="ip-mode-opt-sub">Lower risk, steadier growth — ideal during uncertain markets.</div></div>
                    </div>
                    <div id="ipModeOptBase" class="ip-mode-opt" onclick="ipSelectModeOption('base')">
                        <div class="ip-mode-opt-icon">⚡</div>
                        <div><div class="ip-mode-opt-title">Base</div><div class="ip-mode-opt-sub">More active trading — higher potential during strong market conditions.</div></div>
                    </div>

                    <div class="form-group" style="margin-top:0.5rem;">
                        <label class="form-label">Message to your account manager <span style="color:var(--text-dim);font-weight:400;text-transform:none;">(optional)</span></label>
                        <textarea class="form-textarea" id="ipModeReqMsg" placeholder="e.g. I'd prefer to reduce risk for now..." style="min-height:72px;font-size:0.875rem;"></textarea>
                    </div>

                    <div style="display:flex;gap:0.75rem;margin-top:1rem;">
                        <button class="btn btn-primary" id="ipModeSubmitBtn" style="flex:1;" onclick="ipSubmitModeRequest()">Send Request</button>
                        <button class="btn btn-secondary" onclick="ipCloseModeModal()">Cancel</button>
                    </div>
                </div>
            </div>

        </div><!-- /container -->
    </main>
</div><!-- /dashboard -->

<!-- ══════════════════════════════════════════════════════════════
     PROP FARM PRO — FULL DEBUG PANEL (admin only)
══════════════════════════════════════════════════════════════ -->
<div id="debugPanelOverlay" style="display:none;position:fixed;inset:0;background:#080c18;z-index:8000;overflow-y:auto;font-family:'Space Grotesk',sans-serif;color:#e8f0ff;">

  <!-- Top bar -->
  <div style="position:sticky;top:0;z-index:10;background:#080c18;border-bottom:1px solid rgba(99,179,237,0.15);padding:0.875rem 1.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.75rem;">
    <div style="display:flex;align-items:center;gap:0.875rem;">
      <span style="font-size:1.6rem;filter:drop-shadow(0 0 10px rgba(59,126,248,0.7));">🔧</span>
      <div>
        <div style="font-size:1.1rem;font-weight:700;letter-spacing:-0.01em;">My Journal — Full Debug Panel</div>
        <div style="font-size:0.72rem;color:#7a8bb5;">Every feature tested in real-time. Admin eyes only.</div>
      </div>
    </div>
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
      <button onclick="dbgRunAll()" id="dbgRunAllBtn" style="background:#3b7ef8;color:#fff;border:none;border-radius:8px;padding:0.5rem 1.1rem;font-size:0.82rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:0.4rem;">
        <span id="dbgRunAllSpinner" style="display:none;width:12px;height:12px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;"></span>
        ▶ Run All Tests
      </button>
      <button onclick="dbgClearAll()" style="background:transparent;color:#7a8bb5;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.5rem 0.875rem;font-size:0.82rem;cursor:pointer;">🗑 Clear</button>
      <button onclick="closeDebugPanel()" style="background:transparent;color:#7a8bb5;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.5rem 0.875rem;font-size:0.82rem;cursor:pointer;">✕ Close</button>
    </div>
  </div>

  <div style="max-width:1200px;margin:0 auto;padding:1.5rem;">

    <!-- Tab bar -->
    <div id="dbgTabs" style="display:flex;gap:0.25rem;margin-bottom:1.5rem;background:#0f1629;border-radius:10px;padding:0.3rem;flex-wrap:wrap;">
      <button class="dbg-tab active" data-tab="overview"  onclick="dbgShowTab('overview')">📊 Overview</button>
      <button class="dbg-tab" data-tab="auth"      onclick="dbgShowTab('auth')">🔐 Auth</button>
      <button class="dbg-tab" data-tab="users"     onclick="dbgShowTab('users')">👥 Users</button>
      <button class="dbg-tab" data-tab="trades"    onclick="dbgShowTab('trades')">📈 Trades</button>
      <button class="dbg-tab" data-tab="investor"  onclick="dbgShowTab('investor')">💼 Investor</button>
      <button class="dbg-tab" data-tab="database"  onclick="dbgShowTab('database')">🗄 Database</button>
      <button class="dbg-tab" data-tab="fixes"     onclick="dbgShowTab('fixes')">⚡ Quick Fixes</button>
      <button class="dbg-tab" data-tab="log"       onclick="dbgShowTab('log')">📋 Full Log</button>
    </div>

    <!-- ── OVERVIEW TAB ── -->
    <div id="dbgTab_overview" class="dbg-tab-panel">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:0.75rem;margin-bottom:1.25rem;">
        <div class="dsc" id="dsc_auth"><div class="dsc-icon">🔐</div><div class="dsc-lbl">Auth</div><div class="dsc-val" id="dscv_auth">—</div></div>
        <div class="dsc" id="dsc_role"><div class="dsc-icon">🏷</div><div class="dsc-lbl">My Role</div><div class="dsc-val" id="dscv_role">—</div></div>
        <div class="dsc" id="dsc_profile"><div class="dsc-icon">👤</div><div class="dsc-lbl">Profile</div><div class="dsc-val" id="dscv_profile">—</div></div>
        <div class="dsc" id="dsc_db"><div class="dsc-icon">🗄</div><div class="dsc-lbl">DB</div><div class="dsc-val" id="dscv_db">—</div></div>
        <div class="dsc" id="dsc_users"><div class="dsc-icon">👥</div><div class="dsc-lbl">Total Users</div><div class="dsc-val" id="dscv_users">—</div></div>
        <div class="dsc" id="dsc_trades"><div class="dsc-icon">📈</div><div class="dsc-lbl">Total Trades</div><div class="dsc-val" id="dscv_trades">—</div></div>
        <div class="dsc" id="dsc_investors"><div class="dsc-icon">💼</div><div class="dsc-lbl">Investors</div><div class="dsc-val" id="dscv_investors">—</div></div>
        <div class="dsc" id="dsc_issues"><div class="dsc-icon">⚠</div><div class="dsc-lbl">Issues Found</div><div class="dsc-val" id="dscv_issues">—</div></div>
      </div>
      <div style="background:#0f1629;border:1px solid rgba(99,179,237,0.12);border-radius:10px;padding:1.25rem;">
        <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#7a8bb5;margin-bottom:0.875rem;">Test Results Summary</div>
        <div id="dbgOverviewResults" style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;line-height:2;color:#7a8bb5;">Click "Run All Tests" to see results...</div>
      </div>
    </div>

    <!-- ── AUTH TAB ── -->
    <div id="dbgTab_auth" class="dbg-tab-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
        <div class="dbg-box">
          <div class="dbg-box-title">🔐 Current Session</div>
          <div id="dbgAuthInfo" style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;line-height:1.9;color:#7a8bb5;">Run tests to see session info...</div>
        </div>
        <div class="dbg-box">
          <div class="dbg-box-title">👤 Current Profile (DB)</div>
          <div id="dbgProfileInfo" style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;line-height:1.9;color:#7a8bb5;">Run tests to see profile...</div>
        </div>
      </div>
      <div class="dbg-box">
        <div class="dbg-box-title">🧪 Auth Flow Tests</div>
        <div id="dbgAuthTests" style="font-family:'JetBrains Mono',monospace;font-size:0.78rem;line-height:1.9;color:#7a8bb5;">Run tests...</div>
      </div>
    </div>

    <!-- ── USERS TAB ── -->
    <div id="dbgTab_users" class="dbg-tab-panel" style="display:none;">
      <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;">
        <input type="text" id="dbgUserFilter" placeholder="Filter users..." oninput="dbgFilterUsers()" style="background:#0f1629;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;width:200px;">
        <select id="dbgRoleFilter" onchange="dbgFilterUsers()" style="background:#0f1629;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;">
          <option value="">All roles</option>
          <option value="admin">admin</option>
          <option value="investor">investor</option>
          <option value="user">user</option>
        </select>
        <select id="dbgApprovedFilter" onchange="dbgFilterUsers()" style="background:#0f1629;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;">
          <option value="">All approval status</option>
          <option value="approved">approved</option>
          <option value="pending">pending</option>
        </select>
        <button onclick="dbgLoadUsers()" style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.875rem;color:#e8f0ff;font-size:0.82rem;cursor:pointer;">⟳ Reload</button>
        <span id="dbgUserCount" style="color:#7a8bb5;font-size:0.78rem;margin-left:0.5rem;"></span>
      </div>
      <div style="overflow-x:auto;border-radius:10px;border:1px solid rgba(99,179,237,0.12);">
        <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
          <thead><tr style="background:#0f1629;">
            <th class="dth">Username</th><th class="dth">Email</th><th class="dth">Role</th>
            <th class="dth">Approved</th><th class="dth">Email ✓</th><th class="dth">Trades</th>
            <th class="dth">Onboarded</th><th class="dth">Created</th><th class="dth">Actions</th>
          </tr></thead>
          <tbody id="dbgUsersBody"><tr><td colspan="9" style="text-align:center;padding:2rem;color:#7a8bb5;">Click Reload or Run All Tests</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ── TRADES TAB ── -->
    <div id="dbgTab_trades" class="dbg-tab-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem;margin-bottom:1rem;">
        <div class="dbg-box" style="text-align:center;"><div style="font-size:1.5rem;">📈</div><div class="dsc-lbl">Total Trades</div><div class="dsc-val" id="dbgTotalTrades" style="font-size:1.4rem;">—</div></div>
        <div class="dbg-box" style="text-align:center;"><div style="font-size:1.5rem;">💰</div><div class="dsc-lbl">Total P&L</div><div class="dsc-val" id="dbgTotalPnl" style="font-size:1.4rem;">—</div></div>
        <div class="dbg-box" style="text-align:center;"><div style="font-size:1.5rem;">📅</div><div class="dsc-lbl">Payouts</div><div class="dsc-val" id="dbgTotalPayouts" style="font-size:1.4rem;">—</div></div>
        <div class="dbg-box" style="text-align:center;"><div style="font-size:1.5rem;">👤</div><div class="dsc-lbl">Your Trades</div><div class="dsc-val" id="dbgMyTrades" style="font-size:1.4rem;">—</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
        <div class="dbg-box">
          <div class="dbg-box-title">🧪 Trade Write Test</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;">Inserts a test trade, reads it back, then deletes it. Confirms insert + select + delete work.</div>
          <button onclick="dbgTestTradeWrite()" style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.4rem 0.875rem;color:#e8f0ff;font-size:0.8rem;cursor:pointer;">▶ Run Trade Write Test</button>
          <div id="dbgTradeWriteResult" style="margin-top:0.75rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>
        <div class="dbg-box">
          <div class="dbg-box-title">🧪 Payout Write Test</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;">Inserts a test payout, reads it back, then deletes it. Confirms payout flow works end-to-end.</div>
          <button onclick="dbgTestPayoutWrite()" style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.4rem 0.875rem;color:#e8f0ff;font-size:0.8rem;cursor:pointer;">▶ Run Payout Write Test</button>
          <div id="dbgPayoutWriteResult" style="margin-top:0.75rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>
      </div>
      <div class="dbg-box">
        <div class="dbg-box-title">📊 Trades Per User (top 20)</div>
        <div id="dbgTradesPerUser" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:#7a8bb5;">Run tests to load...</div>
      </div>
    </div>

    <!-- ── INVESTOR TAB ── -->
    <div id="dbgTab_investor" class="dbg-tab-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
        <div class="dbg-box">
          <div class="dbg-box-title">💼 Investor Portal Write Test</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;">Inserts a test investor record, reads it, deletes it. Confirms RLS allows admin to write to investor_portal_investors.</div>
          <button onclick="dbgTestInvestorWrite()" style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.4rem 0.875rem;color:#e8f0ff;font-size:0.8rem;cursor:pointer;">▶ Run Investor Write Test</button>
          <div id="dbgInvestorWriteResult" style="margin-top:0.75rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>
        <div class="dbg-box">
          <div class="dbg-box-title">📨 Mode Request Write Test</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;">Tests that investor_mode_requests table accepts inserts and updates (approve/deny flow).</div>
          <button onclick="dbgTestModeRequestWrite()" style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.4rem 0.875rem;color:#e8f0ff;font-size:0.8rem;cursor:pointer;">▶ Run Mode Request Test</button>
          <div id="dbgModeReqResult" style="margin-top:0.75rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>
      </div>
      <div class="dbg-box" style="margin-bottom:1rem;">
        <div class="dbg-box-title">💼 All Investor Records</div>
        <div id="dbgInvestorRecords" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:#7a8bb5;overflow-x:auto;">Run tests to load...</div>
      </div>
      <div class="dbg-box">
        <div class="dbg-box-title">⚠ Role / Portal Mismatch Check</div>
        <div id="dbgInvestorMismatch" style="font-size:0.82rem;color:#7a8bb5;">Run tests to check...</div>
      </div>
    </div>

    <!-- ── DATABASE TAB ── -->
    <div id="dbgTab_database" class="dbg-tab-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-bottom:1rem;">
        <div class="dbg-box">
          <div class="dbg-box-title">🗄 Tables & RLS</div>
          <div id="dbgTablesInfo" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.9;color:#7a8bb5;">Run tests...</div>
        </div>
        <div class="dbg-box">
          <div class="dbg-box-title">🔑 Supabase Config</div>
          <div id="dbgConfigInfo" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.9;color:#7a8bb5;">Run tests...</div>
        </div>
      </div>
      <div class="dbg-box">
        <div class="dbg-box-title">🧪 RLS Policy Tests (read/write per table)</div>
        <div id="dbgRLSTests" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.9;color:#7a8bb5;">Run tests...</div>
      </div>
    </div>

    <!-- ── QUICK FIXES TAB ── -->
    <div id="dbgTab_fixes" class="dbg-tab-panel" style="display:none;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">

        <div class="dbg-box">
          <div class="dbg-box-title">🔑 Set User Role</div>
          <input type="text" id="dbgFixSearch" placeholder="Email or username..." oninput="dbgFixSearchUsers()" style="width:100%;background:#0a0e1a;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;margin-bottom:0.35rem;">
          <div id="dbgFixDropdown" style="display:none;background:#1a2035;border:1px solid rgba(99,179,237,0.25);border-radius:8px;max-height:140px;overflow-y:auto;margin-bottom:0.5rem;"></div>
          <div id="dbgFixSelected" style="padding:0.4rem 0.75rem;background:#0a0e1a;border:1px solid rgba(99,179,237,0.12);border-radius:8px;font-size:0.78rem;color:#7a8bb5;margin-bottom:0.5rem;">No user selected</div>
          <select id="dbgFixRoleSelect" style="width:100%;background:#0a0e1a;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;margin-bottom:0.5rem;">
            <option value="user">👤 user</option>
            <option value="investor">💼 investor</option>
            <option value="admin">👑 admin</option>
          </select>
          <button onclick="dbgApplyRoleFix()" style="width:100%;background:#3b7ef8;color:#fff;border:none;border-radius:8px;padding:0.5rem;font-size:0.82rem;font-weight:700;cursor:pointer;">Apply Role</button>
          <div id="dbgFixRoleResult" style="margin-top:0.5rem;font-size:0.75rem;"></div>
        </div>

        <div class="dbg-box">
          <div class="dbg-box-title">✉️ Sync Missing Emails</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;line-height:1.5;">Copies emails from auth session cache into profiles table. Fixes role lookups that fail because email column is null. This is the most common cause of "can't add investor".</div>
          <button onclick="dbgSyncEmails()" style="width:100%;background:#22d3a0;color:#000;border:none;border-radius:8px;padding:0.5rem;font-size:0.82rem;font-weight:700;cursor:pointer;">Sync All Emails Now</button>
          <div id="dbgSyncEmailResult" style="margin-top:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>

        <div class="dbg-box">
          <div class="dbg-box-title">✅ Approve All Pending</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;line-height:1.5;">Sets approved=true for every user currently stuck in pending. Use this if new users can't get in.</div>
          <button onclick="dbgApproveAll()" style="width:100%;background:#f5a623;color:#000;border:none;border-radius:8px;padding:0.5rem;font-size:0.82rem;font-weight:700;cursor:pointer;">Approve All Pending</button>
          <div id="dbgApproveResult" style="margin-top:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;"></div>
        </div>

        <div class="dbg-box">
          <div class="dbg-box-title">👁 Inspect Any User</div>
          <input type="text" id="dbgInspectInput" placeholder="Email or username..." style="width:100%;background:#0a0e1a;border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:0.45rem 0.75rem;color:#e8f0ff;font-size:0.82rem;margin-bottom:0.5rem;">
          <button onclick="dbgInspectUser()" style="width:100%;background:#1a2035;border:1px solid rgba(99,179,237,0.25);border-radius:8px;padding:0.5rem;font-size:0.82rem;color:#e8f0ff;cursor:pointer;">Inspect</button>
          <div id="dbgInspectResult" style="margin-top:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.8;color:#7a8bb5;"></div>
        </div>

        <div class="dbg-box">
          <div class="dbg-box-title">🔄 Refresh My Session</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;line-height:1.5;">Reloads your profile from DB and refreshes the nav, role badge, and all views without a page reload.</div>
          <button onclick="dbgRefreshMySession()" style="width:100%;background:#1a2035;border:1px solid rgba(99,179,237,0.25);border-radius:8px;padding:0.5rem;font-size:0.82rem;color:#e8f0ff;cursor:pointer;">Refresh Session</button>
          <div id="dbgRefreshResult" style="margin-top:0.5rem;font-size:0.75rem;"></div>
        </div>

        <div class="dbg-box">
          <div class="dbg-box-title">🗑 Delete Test Data</div>
          <div style="font-size:0.78rem;color:#7a8bb5;margin-bottom:0.75rem;line-height:1.5;">Removes all test trades/records created by debug write tests. Safe — only deletes rows with debug marker.</div>
          <button onclick="dbgCleanTestData()" style="width:100%;background:#1a2035;border:1px solid rgba(240,92,106,0.3);border-radius:8px;padding:0.5rem;font-size:0.82rem;color:#f05c6a;cursor:pointer;">Clean Test Data</button>
          <div id="dbgCleanResult" style="margin-top:0.5rem;font-size:0.75rem;"></div>
        </div>

      </div>
    </div>

    <!-- ── FULL LOG TAB ── -->
    <div id="dbgTab_log" class="dbg-tab-panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;">
        <div style="display:flex;gap:0.35rem;">
          <button onclick="dbgLogFilter('all')"  class="dbg-log-filter active" data-f="all">All</button>
          <button onclick="dbgLogFilter('ok')"   class="dbg-log-filter" data-f="ok">✓ Pass</button>
          <button onclick="dbgLogFilter('err')"  class="dbg-log-filter" data-f="err">✗ Fail</button>
          <button onclick="dbgLogFilter('warn')" class="dbg-log-filter" data-f="warn">⚠ Warn</button>
        </div>
        <span id="dbgLogCountEl" style="color:#7a8bb5;font-size:0.75rem;font-family:'JetBrains Mono',monospace;"></span>
      </div>
      <div id="dbgFullLog" style="background:#0a0e1a;border:1px solid rgba(99,179,237,0.12);border-radius:10px;padding:1rem 1.25rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;line-height:1.9;max-height:65vh;overflow-y:auto;">
        <span style="color:#3d4f78;">Run All Tests to populate the log...</span>
      </div>
    </div>

  </div><!-- /max-width -->
</div><!-- /debugPanelOverlay -->

<style>
@keyframes spin { to { transform:rotate(360deg); } }
.dbg-tab { background:transparent; border:none; border-radius:8px; padding:0.4rem 0.875rem; font-size:0.8rem; color:#7a8bb5; cursor:pointer; font-family:'Space Grotesk',sans-serif; font-weight:600; white-space:nowrap; transition:all 0.15s; }
.dbg-tab:hover { background:#1a2035; color:#e8f0ff; }
.dbg-tab.active { background:#3b7ef8; color:#fff; }
.dbg-tab-panel { }
.dbg-box { background:#0f1629; border:1px solid rgba(99,179,237,0.12); border-radius:10px; padding:1.1rem 1.25rem; }
.dbg-box-title { font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:0.07em; color:#7a8bb5; margin-bottom:0.875rem; }
.dsc { background:#0f1629; border:1px solid rgba(99,179,237,0.12); border-radius:10px; padding:0.875rem; text-align:center; transition:border-color 0.2s; }
.dsc-icon { font-size:1.3rem; margin-bottom:0.2rem; }
.dsc-lbl { font-size:0.62rem; font-weight:700; text-transform:uppercase; letter-spacing:0.07em; color:#7a8bb5; margin-bottom:0.2rem; }
.dsc-val { font-family:'JetBrains Mono',monospace; font-size:0.9rem; font-weight:700; color:#e8f0ff; }
.dsc.ok  { border-color:rgba(34,211,160,0.4); background:rgba(34,211,160,0.03); }
.dsc.warn{ border-color:rgba(245,166,35,0.4);  background:rgba(245,166,35,0.03); }
.dsc.err { border-color:rgba(240,92,106,0.4);  background:rgba(240,92,106,0.03); }
.dth { text-align:left; padding:0.5rem 0.875rem; font-size:0.62rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:#7a8bb5; border-bottom:1px solid rgba(99,179,237,0.12); white-space:nowrap; }
.dtd { padding:0.45rem 0.875rem; font-size:0.78rem; border-bottom:1px solid rgba(99,179,237,0.06); }
.dl-ok   { color:#22d3a0; }
.dl-err  { color:#f05c6a; }
.dl-warn { color:#f5a623; }
.dl-info { color:#7ab4ff; }
.dl-head { color:#e8f0ff; font-weight:700; border-top:1px solid rgba(99,179,237,0.12); padding-top:0.2rem; margin-top:0.3rem; }
.dl-dim  { color:#3d4f78; }
.dbg-log-filter { background:#1a2035; border:1px solid rgba(99,179,237,0.15); border-radius:6px; padding:0.25rem 0.6rem; font-size:0.72rem; color:#7a8bb5; cursor:pointer; font-family:'Space Grotesk',sans-serif; }
.dbg-log-filter.active { background:#3b7ef8; color:#fff; border-color:#3b7ef8; }
</style>


<script>
// ═══════════════════════════════════════════════════════
//  CONFIG
// ═══════════════════════════════════════════════════════
const STARTING_BALANCE = 50000;
const MAX_DRAWDOWN = 2500;
const SAFETY_NET = 52600;
const GOAL_PER_ACCOUNT = 4600;
const PAYOUT_PER_ACCOUNT = 2000;
const DAILY_TARGET_MIN = 250;
const DAILY_TARGET_MAX = 300;

// ─── State ───
let sbClient = null;
let currentUser = null;
let currentProfile = null;
let allData = [];
let payoutData = [];
let charts = {};
let accountFilter = 'all';
let USER_ACCOUNT_GOAL = 20;
let adminViewingUserId = null;
let adminViewingEmail = null;
let adminAllProfiles = [];
let adminAllTrades = [];
let journalSharing = false;

// Account nicknames stored in localStorage
function getNicknames() {
    try { return JSON.parse(localStorage.getItem('acc_nicknames') || '{}'); } catch { return {}; }
}
function saveNickname(accNum, name) {
    const n = getNicknames();
    if (name.trim()) n[accNum] = name.trim();
    else delete n[accNum];
    localStorage.setItem('acc_nicknames', JSON.stringify(n));
}
function getNickname(accNum) { return getNicknames()[accNum] || ''; }
function getAccLabel(accNum) {
    const n = getNickname(accNum);
    return n ? `PA #${accNum} — ${n}` : `PA Account #${accNum}`;
}

// ─── Quotes ───
const QUOTES = [
    { text: "The stock market is a device for transferring money from the impatient to the patient.", author: "Warren Buffett" },
    { text: "In trading, the one who wins is not who is right most often, but who loses least when wrong.", author: "Unknown" },
    { text: "Risk comes from not knowing what you're doing.", author: "Warren Buffett" },
    { text: "The goal of a successful trader is to make the best trades. Money is secondary.", author: "Alexander Elder" },
    { text: "Every battle is won before it is fought.", author: "Sun Tzu" },
    { text: "The market pays you to be disciplined.", author: "Unknown" },
    { text: "Don't think about what the market's going to do; you have absolutely no control over that. Think about what you're going to do if it gets there.", author: "William O'Neil" },
    { text: "Amateurs think about how much money they can make. Professionals think about how much money they could lose.", author: "Unknown" },
    { text: "It's not whether you're right or wrong that's important, but how much money you make when you're right and how much you lose when you're wrong.", author: "George Soros" },
    { text: "The key to trading success is emotional discipline. If intelligence were the key, there would be a lot more people making money trading.", author: "Victor Sperandeo" },
    { text: "Trade what you see, not what you think.", author: "Unknown" },
    { text: "A plan without action is just a dream. Action without a plan is just a disaster.", author: "Unknown" },
    { text: "The farmer does not plant seeds and dig them up every day to check. He trusts the process.", author: "Prop Farm Wisdom" },
    { text: "Consistency over perfection. Show up every day.", author: "Prop Farm Wisdom" },
    { text: "Protect the account. The account protects the dream.", author: "Prop Farm Wisdom" },
    { text: "Small daily wins compound into life-changing wealth.", author: "Prop Farm Wisdom" },
    { text: "Discipline is choosing between what you want now and what you want most.", author: "Abraham Lincoln" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "Do not pray for easy lives. Pray to be stronger men.", author: "John F. Kennedy" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" }
];
let quoteIdx = 0;

const MOOD_ADVICE = {
    '🔥': { text: "You're in the zone! Stick to your rules — hot streaks can turn into overtrading fast. Stay disciplined.", color: 'var(--success)' },
    '😎': { text: "Calm and ready is the perfect trading state. Execute your plan with confidence.", color: 'var(--success)' },
    '😌': { text: "Neutral is fine. Don't force trades. Wait for your setup. One good trade beats five mediocre ones.", color: 'var(--accent)' },
    '😤': { text: "⚠️ Tension detected. Size down today. A smaller win builds confidence. Don't let tension become mistakes.", color: 'var(--warning)' },
    '😰': { text: "🚨 Anxious traders make bad decisions. Consider sitting out or trading with 50% size. Protect the account.", color: 'var(--danger)' },
    '🚫': { text: "Smart move recognizing you're not ready. A no-trade day is a zero — which beats a red day every time. Rest up.", color: 'var(--purple)' }
};

// ═══════════════════════════════════════════════════════
//  SUPABASE INIT
// ═══════════════════════════════════════════════════════
function initSupabase() {
    const url = 'https://gmhmtdgultwlleskvpao.supabase.co';
    const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtaG10ZGd1bHR3bGxlc2t2cGFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzgyOTIsImV4cCI6MjA4NzExNDI5Mn0.D6MyCDPvW05CiVm6DOa0YX1z-lwmTRWDC9a8-gg9gA0';
    try { sbClient = window.supabase.createClient(url, key, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage } }); window._SUPA_URL = url; window._SUPA_KEY = key; return true; }
    catch (e) { console.error('Supabase init error:', e); return false; }
}

async function ensureProfile(session) {
    await loadProfile();
    if (!currentProfile) {
        const pending = window._pendingUsername;
        const googleName = (session.user.user_metadata?.full_name || session.user.user_metadata?.name || '').split(' ')[0].replace(/[^a-zA-Z0-9_]/g,'');
        const uname = pending || googleName || session.user.email?.split('@')[0]?.replace(/[^a-zA-Z0-9_]/g,'') || 'Trader';
        try {
            const { data } = await sbClient.from('profiles').upsert({
                id: currentUser.id,
                email: session.user.email || null,
                username: uname,
                role: 'user',
                approved: true,
                account_goal: 20
            }).select().single();
            currentProfile = data;
        } catch(e) { console.error('Profile create error:', e); }
        window._pendingUsername = null;
    } else if (!currentProfile.email && session.user.email && !session.user.email.includes('@propfarmpro.app')) {
        // Update email in profiles if missing (important for role lookups)
        try {
            await sbClient.from('profiles').update({ email: session.user.email }).eq('id', currentUser.id);
            currentProfile.email = session.user.email;
        } catch(e) {}
    }
}

async function checkSession() {
    if (!initSupabase()) return;

    // Public journal view
    const params = new URLSearchParams(window.location.search);
    const journalUserId = params.get('journal');
    if (journalUserId) { loadPublicJournal(journalUserId); return; }

    // ── Step 1: Check for an existing session immediately (handles every page refresh) ──
    let sessionHandled = false;
    try {
        const { data: { session } } = await sbClient.auth.getSession();
        if (session) {
            sessionHandled = true;
            currentUser = session.user;
            await ensureProfile(session);
            routeUser();
        }
    } catch(e) { console.error('Session check error:', e); }

    // ── Step 2: Listen for future auth changes (login, logout, token refresh) ──
    sbClient.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session && !sessionHandled) {
            sessionHandled = true;
            currentUser = session.user;
            await ensureProfile(session);
            routeUser();
        } else if (event === 'TOKEN_REFRESHED' && session) {
            currentUser = session.user;
            // Token silently refreshed — no re-render needed
        } else if (event === 'SIGNED_OUT') {
            sessionHandled = false;
            currentUser = null;
            currentProfile = null;
            hideDashboard();
        }
    });

    // ── Step 3: No session found — show login ──
    if (!sessionHandled) {
        const as = document.getElementById('authScreen');
        if (as) { as.style.display = ''; as.classList.remove('hidden'); }
    }
}

function routeUser() {
    const isAdmin = currentProfile?.role === 'admin';
    const isApproved = isAdmin || currentProfile?.approved === true;
    if (isApproved) {
        showDashboard();
    } else {
        showPendingScreen();
    }
}

function showPendingScreen() {
    const as = document.getElementById('authScreen');
    if (as) { as.style.display = ''; as.classList.remove('hidden'); }
    // Replace auth box content with pending message
    const box = document.querySelector('.auth-box');
    if (box) {
        box.innerHTML = `
        <div class="auth-logo">
            <span class="logo-icon">⏳</span>
            <h1>Awaiting Approval</h1>
            <p>Your account is pending admin approval</p>
        </div>
        <div style="text-align:center;padding:1.5rem;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:1.5rem;">
            <div style="font-size:2.5rem;margin-bottom:0.75rem;">🌾</div>
            <div style="font-weight:600;margin-bottom:0.5rem;">Hi ${currentProfile?.username || currentUser?.email || 'Trader'}!</div>
            <div style="color:var(--text-muted);font-size:0.9rem;line-height:1.6;">Your account has been created successfully.<br>An admin will approve your access shortly.</div>
        </div>
        <div style="background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.3);border-radius:var(--radius-sm);padding:0.875rem;color:var(--warning);font-size:0.85rem;text-align:center;margin-bottom:1rem;">
            ⚠️ Access restricted until approved by <strong>8xhorizon.invest@gmail.com</strong>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-bottom:0.75rem;" onclick="window.location.reload()">🔄 Refresh (Check Approval Status)</button>
        <button class="btn btn-secondary" style="width:100%;" onclick="sbClient.auth.signOut()">Sign Out</button>
        `;
    }
}

async function loadProfile() {
    if (!currentUser) return;
    try {
        const { data, error } = await sbClient.from('profiles').select('*').eq('id', currentUser.id).single();
        if (!error && data) { currentProfile = data; USER_ACCOUNT_GOAL = data.account_goal || 20; }
    } catch (e) { console.error('Load profile error:', e); }
}

checkSession();

// ═══════════════════════════════════════════════════════
//  PUBLIC JOURNAL
// ═══════════════════════════════════════════════════════
async function loadPublicJournal(userId) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('publicView').classList.add('show');

    try {
        const [{ data: profile }, { data: trades }] = await Promise.all([
            sbClient.from('profiles').select('email, account_goal').eq('id', userId).single(),
            sbClient.from('trades').select('*').eq('user_id', userId).order('trade_date', { ascending: false }).limit(200)
        ]);

        const displayName = profile?.email?.split('@')[0] || 'Trader';
        const initials = displayName.substring(0, 2).toUpperCase();
        document.getElementById('publicAvatar').textContent = initials;
        document.getElementById('publicUserName').textContent = displayName + "'s Trading Journal";
        document.getElementById('publicUserSub').textContent = `${trades?.length || 0} trades • Public Journal`;
        document.getElementById('publicTradeCount').textContent = (trades?.length || 0) + ' trades';

        const validTrades = (trades || []).filter(t => !t.no_trade_day);
        const pnl = validTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = validTrades.filter(t => parseFloat(t.pnl || 0) > 0);
        const winRate = validTrades.length > 0 ? Math.round(wins.length / validTrades.length * 100) : 0;
        const streak = calcStreak(validTrades);

        document.getElementById('publicMetrics').innerHTML = `
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">💰</span></div><div class="metric-value" style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</div><div class="metric-sub">${validTrades.length} trades</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">🎯</span></div><div class="metric-value">${winRate}%</div><div class="metric-sub">${wins.length} wins / ${validTrades.length} trades</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Streak</span><span class="metric-icon">🔥</span></div><div class="metric-value">${streak.current}</div><div class="metric-sub">Longest: ${streak.longest}</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Best Trade</span><span class="metric-icon">⭐</span></div><div class="metric-value">${fmtCurrency(validTrades.length ? Math.max(...validTrades.map(t => parseFloat(t.pnl || 0))) : 0)}</div><div class="metric-sub">All time</div></div>
        `;

        const tbody = document.getElementById('publicTradeBody');
        tbody.innerHTML = '';
        (trades || []).slice(0, 100).forEach(t => {
            if (t.no_trade_day) return;
            const pnl = parseFloat(t.pnl || 0);
            const row = tbody.insertRow();
            row.innerHTML = `<td>${t.trade_date}</td><td>PA #${t.account}</td><td>${t.market_condition || '—'}</td><td>$${t.risk_template}</td><td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.cycle}</td>`;
        });
    } catch (err) {
        document.getElementById('publicUserName').textContent = 'Journal Not Found';
        document.getElementById('publicUserSub').textContent = 'This journal is not available or sharing is disabled.';
    }
}

function getShareLink() {
    return `${window.location.origin}${window.location.pathname}?journal=${currentUser?.id}`;
}

function toggleSharing() {
    journalSharing = !journalSharing;
    const toggle = document.getElementById('shareToggle');
    const label = document.getElementById('shareStatusLabel');
    const linkBox = document.getElementById('shareLinkDisplay');
    toggle.classList.toggle('on', journalSharing);
    label.textContent = journalSharing ? 'Sharing On ✓' : 'Sharing Off';
    label.style.color = journalSharing ? 'var(--success)' : 'var(--text-muted)';
    linkBox.textContent = journalSharing ? getShareLink() : 'Enable sharing to generate your link';
    localStorage.setItem('journal_sharing', journalSharing ? '1' : '0');
    showAlert(journalSharing ? '✓ Journal sharing enabled! Your link is ready.' : '✓ Sharing disabled.', journalSharing ? 'success' : 'info');
}

function copyShareLink() {
    if (!journalSharing) { showAlert('Enable sharing first!', 'error'); return; }
    const link = getShareLink();
    navigator.clipboard.writeText(link).then(() => showAlert('✓ Link copied to clipboard!', 'success'));
}

function previewJournal() {
    if (currentUser) {
        window.open(getShareLink(), '_blank');
    }
}

function saveJournalSettings() {
    const settings = {
        displayName: document.getElementById('journalDisplayName').value,
        bio: document.getElementById('journalBio').value,
        showPnL: document.getElementById('showPnL').checked,
        showWinRate: document.getElementById('showWinRate').checked,
        showTrades: document.getElementById('showTrades').checked,
        showAccounts: document.getElementById('showAccounts').checked
    };
    localStorage.setItem('journal_settings', JSON.stringify(settings));
    showAlert('✓ Journal settings saved!', 'success');
    updateShareJournalPage();
}

function updateShareJournalPage() {
    // Restore sharing state
    journalSharing = localStorage.getItem('journal_sharing') === '1';
    const toggle = document.getElementById('shareToggle');
    const label = document.getElementById('shareStatusLabel');
    const linkBox = document.getElementById('shareLinkDisplay');
    toggle.classList.toggle('on', journalSharing);
    label.textContent = journalSharing ? 'Sharing On ✓' : 'Sharing Off';
    label.style.color = journalSharing ? 'var(--success)' : 'var(--text-muted)';
    if (currentUser) linkBox.textContent = journalSharing ? getShareLink() : 'Enable sharing to generate your link';

    // Restore settings
    try {
        const s = JSON.parse(localStorage.getItem('journal_settings') || '{}');
        if (s.displayName) document.getElementById('journalDisplayName').value = s.displayName;
        if (s.bio) document.getElementById('journalBio').value = s.bio;
        if (s.showPnL !== undefined) document.getElementById('showPnL').checked = s.showPnL;
        if (s.showWinRate !== undefined) document.getElementById('showWinRate').checked = s.showWinRate;
        if (s.showTrades !== undefined) document.getElementById('showTrades').checked = s.showTrades;
        if (s.showAccounts !== undefined) document.getElementById('showAccounts').checked = s.showAccounts;
    } catch {}

    // Preview
    const trades = allData.filter(t => !t.no_trade_day);
    const pnl = sumPnL(trades);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const wr = trades.length > 0 ? Math.round(wins.length / trades.length * 100) : 0;
    document.getElementById('journalPreviewMetrics').innerHTML = `
        <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">💰</span></div><div class="metric-value" style="color:${pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(pnl)}</div><div class="metric-sub">${trades.length} trades</div></div>
        <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">🎯</span></div><div class="metric-value">${wr}%</div><div class="metric-sub">${wins.length} / ${trades.length}</div></div>
    `;
    const tbody = document.getElementById('journalPreviewBody');
    tbody.innerHTML = '';
    [...allData].filter(t=>!t.no_trade_day).sort((a,b)=>new Date(b.trade_date)-new Date(a.trade_date)).slice(0,10).forEach(t => {
        const p = parseFloat(t.pnl||0);
        const row = tbody.insertRow();
        row.innerHTML = `<td>${t.trade_date}</td><td style="color:${p>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(p)}</td><td>${t.market_condition||'—'}</td><td>${t.cycle}</td>`;
    });
}

// ═══════════════════════════════════════════════════════
//  PSYCHOLOGY
// ═══════════════════════════════════════════════════════
function showQuote(idx) {
    const q = QUOTES[idx];
    document.getElementById('dailyQuoteText').textContent = '"' + q.text + '"';
    document.getElementById('dailyQuoteAuthor').textContent = '— ' + q.author;
    document.getElementById('quoteCounter').textContent = (idx + 1) + ' / ' + QUOTES.length;
}
function nextQuote() { quoteIdx = (quoteIdx + 1) % QUOTES.length; showQuote(quoteIdx); }
function prevQuote() { quoteIdx = (quoteIdx - 1 + QUOTES.length) % QUOTES.length; showQuote(quoteIdx); }

function selectMood(btn, emoji, label) {
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const advice = MOOD_ADVICE[emoji];
    const el = document.getElementById('moodAdvice');
    if (advice) {
        el.textContent = advice.text;
        el.style.color = advice.color;
        el.style.borderLeft = '3px solid ' + advice.color;
        el.style.display = 'block';
    }
    localStorage.setItem('today_mood', emoji);
}

function toggleCheck(item) {
    item.classList.toggle('done');
    if (item.classList.contains('done')) {
        item.querySelector('.checklist-checkbox').textContent = '✓';
        item.querySelector('.checklist-checkbox').style.color = 'white';
    } else {
        item.querySelector('.checklist-checkbox').textContent = '';
    }
    const total = document.querySelectorAll('.checklist-item').length;
    const done = document.querySelectorAll('.checklist-item.done').length;
    const status = document.getElementById('checklistStatus');
    if (done === total) { status.textContent = '✅ All checks passed! You\'re ready to trade.'; status.style.color = 'var(--success)'; }
    else { status.textContent = `${done} / ${total} completed`; status.style.color = 'var(--text-muted)'; }
}

function resetChecklist() {
    document.querySelectorAll('.checklist-item').forEach(item => {
        item.classList.remove('done');
        item.querySelector('.checklist-checkbox').textContent = '';
    });
    document.getElementById('checklistStatus').textContent = '';
}

let journalSaveTimer;
function saveJournalNote() {
    const text = document.getElementById('journalNote').value;
    document.getElementById('journalCharCount').textContent = text.length + ' chars';
    clearTimeout(journalSaveTimer);
    journalSaveTimer = setTimeout(() => {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem('journal_' + today, text);
        document.getElementById('journalSaveStatus').textContent = '✓ Saved ' + new Date().toLocaleTimeString();
    }, 800);
}

function loadTodayJournal() {
    const today = new Date().toISOString().split('T')[0];
    const saved = localStorage.getItem('journal_' + today) || '';
    document.getElementById('journalNote').value = saved;
    document.getElementById('journalCharCount').textContent = saved.length + ' chars';
}

function updatePsychPage() {
    // today's quote (based on day of year)
    const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    quoteIdx = dayOfYear % QUOTES.length;
    showQuote(quoteIdx);
    // streak
    const trades = allData.filter(t => !t.no_trade_day);
    const streak = calcStreak(trades);
    document.getElementById('psychStreakNum').textContent = streak.current;
    // restore mood
    const savedMood = localStorage.getItem('today_mood');
    if (savedMood) {
        document.querySelectorAll('.mood-btn').forEach(btn => {
            if (btn.querySelector('.mood-label')?.textContent === savedMood) btn.classList.add('selected');
        });
    }
    // load journal
    loadTodayJournal();
}

// ═══════════════════════════════════════════════════════
//  AUTH HANDLERS
// ═══════════════════════════════════════════════════════
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t, i) => {
        const tabs = ['login','signup','reset'];
        t.classList.toggle('active', tabs[i] === tab);
    });
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    const map = { login: 'authLoginForm', signup: 'authSignupForm', reset: 'authResetForm' };
    document.getElementById(map[tab])?.classList.add('active');
    clearAuthMessages();
}

function setBtnLoading(prefix, loading) {
    const btn = document.getElementById('auth' + prefix.charAt(0).toUpperCase() + prefix.slice(1) + 'Btn') || document.getElementById(prefix + 'Btn');
    const text = document.getElementById('auth' + prefix.charAt(0).toUpperCase() + prefix.slice(1) + 'Txt') || document.getElementById(prefix + 'BtnText');
    const spin = document.getElementById('auth' + prefix.charAt(0).toUpperCase() + prefix.slice(1) + 'Spinner') || document.getElementById(prefix + 'Spinner');
    if (btn) btn.disabled = loading;
    if (text) text.style.display = loading ? 'none' : 'inline';
    if (spin) spin.style.display = loading ? 'inline-block' : 'none';
}

function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 8000);
}
function showAuthSuccess(msg) {
    const el = document.getElementById('authSuccess');
    el.textContent = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 10000);
}
function clearAuthMessages() {
    document.getElementById('authError').classList.remove('show');
    document.getElementById('authSuccess').classList.remove('show');
}

async function handleLogin(e) {
    e.preventDefault();
    clearAuthMessages();
    setBtnLoading('login', true);
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username || !password) {
        setBtnLoading('login', false);
        showAuthError('Please enter your username and password.');
        return;
    }
    try {
        // Try to find email from username in profiles table
        const { data: profile } = await sbClient
            .from('profiles')
            .select('email')
            .ilike('username', username)
            .maybeSingle();

        // Use real email if found, otherwise fall back to internal @propfarmpro.app address
        const email = (profile?.email && !profile.email.includes('@propfarmpro.app'))
            ? profile.email
            : (profile?.email || `${username.toLowerCase()}@propfarmpro.app`);

        const { error } = await sbClient.auth.signInWithPassword({ email, password });
        setBtnLoading('login', false);
        if (error) {
            if (error.message.includes('Invalid login credentials')) {
                showAuthError('❌ Wrong username or password. Check your details and try again.');
            } else {
                showAuthError(error.message);
            }
        }
    } catch(err) {
        setBtnLoading('login', false);
        showAuthError('Sign in error: ' + err.message);
    }
}

async function handleSignup(e) {
    e.preventDefault();
    clearAuthMessages();
    const username = document.getElementById('signupUsername').value.trim();
    const pass = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;
    if (!username || username.length < 3) { showAuthError('Username must be at least 3 characters.'); return; }
    if (pass !== confirm) { showAuthError('Passwords do not match.'); return; }
    setBtnLoading('signup', true);
    // Check username taken
    const { data: existing } = await sbClient.from('profiles').select('id').ilike('username', username).maybeSingle();
    if (existing) { setBtnLoading('signup', false); showAuthError('❌ Username already taken. Choose a different one.'); return; }
    window._pendingUsername = username;
    const internalEmail = `${username.toLowerCase()}@propfarmpro.app`;
    const { data, error } = await sbClient.auth.signUp({ email: internalEmail, password: pass, options: { data: { username } } });
    setBtnLoading('signup', false);
    if (error) { showAuthError(error.message); window._pendingUsername = null; return; }
    if (data?.session) { showAuthSuccess('✅ Account created! Setting up your profile...'); return; }
    showAuthSuccess('✅ Account created! Signing you in...');
}

async function handlePasswordReset(e) {
    e.preventDefault();
    clearAuthMessages();
    setBtnLoading('reset', true);
    const input = document.getElementById('resetEmail').value.trim();
    let emailToReset = input;
    if (!input.includes('@')) {
        const { data: profile } = await sbClient.from('profiles').select('email').ilike('username', input).maybeSingle();
        if (!profile?.email || profile.email.includes('@propfarmpro.app')) {
            setBtnLoading('reset', false);
            showAuthError('No recovery email linked to this account. Link one in Settings → My Profile first.');
            return;
        }
        emailToReset = profile.email;
    }
    const { error } = await sbClient.auth.resetPasswordForEmail(emailToReset, { redirectTo: window.location.href });
    setBtnLoading('reset', false);
    if (error) { showAuthError(error.message); return; }
    showAuthSuccess('✅ Reset link sent! Check your inbox and spam folder.');
}

async function handleGoogleAuth() {
    clearAuthMessages();
    const btn = document.getElementById('authGoogleBtn');
    const txt = document.getElementById('authGoogleTxt');
    const spin = document.getElementById('authGoogleSpinner');
    if (btn) btn.disabled = true;
    if (txt) txt.textContent = 'Redirecting…';
    if (spin) spin.style.display = '';
    try {
        const { error } = await sbClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.href.split('?')[0].split('#')[0]
            }
        });
        if (error) {
            if (btn) btn.disabled = false;
            if (txt) txt.textContent = 'Continue with Google';
            if (spin) spin.style.display = 'none';
            showAuthError('Google sign-in failed: ' + error.message);
        }
    } catch(e) {
        if (btn) btn.disabled = false;
        if (txt) txt.textContent = 'Continue with Google';
        if (spin) spin.style.display = 'none';
        showAuthError('Google sign-in error: ' + e.message);
    }
}

async function handleLogout() {
    adminViewingUserId = null;
    adminViewingEmail = null;
    _dashboardShown = false;
    await sbClient.auth.signOut();
}

// ═══════════════════════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════════════════════
let _dashboardShown = false;

function showDashboard() {
    const isFirstShow = !_dashboardShown;
    _dashboardShown = true;

    const as = document.getElementById('authScreen');
    if (as) { as.classList.add('hidden'); as.style.display = 'none'; }
    document.getElementById('dashboard').classList.add('show');

    const displayName = currentProfile?.username
        || currentProfile?.display_name
        || currentUser?.user_metadata?.full_name?.split(' ')[0]
        || currentUser?.user_metadata?.name?.split(' ')[0]
        || currentUser?.email?.split('@')[0]?.replace(/@propfarmpro\.app$/, '')
        || 'Trader';

    const initials  = displayName.substring(0, 2).toUpperCase();
    const isAdmin    = currentProfile?.role === 'admin';
    const isInvestor = currentProfile?.role === 'investor';

    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('userName').textContent   = displayName;
    document.getElementById('heroName').textContent   = displayName;

    // Always enforce nav visibility based on role
    updateSidebarRole();

    populateDropdowns();
    setTodayDates();
    buildContractEditor();

    if (isInvestor) {
        // Investors ONLY see Investor Portal — always redirect, every time
        // Make sure trader pages are hidden even if somehow active
        document.querySelectorAll('.page.active').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item.active').forEach(n => n.classList.remove('active'));
        navigateTo('investorPortal');
    } else {
        loadDashboardData();
        // Restore overview as active if no page is active
        if (!document.querySelector('.page.active')) {
            navigateTo('overview');
        }
    }

    // Onboarding: only for new regular users
    if (isFirstShow && !isAdmin && !isInvestor && !currentProfile?.onboarded) {
        setTimeout(() => startOnboarding(), 800);
    }

    // Start 5 PM email scheduler for admins
    if (isAdmin && isFirstShow) {
        setTimeout(() => ipStartEmailScheduler(), 2000);
    }
}

function hideDashboard() {
    _dashboardShown = false;
    allData = [];
    payoutData = [];
    destroyCharts();
    document.getElementById('dashboard').classList.remove('show');
    document.getElementById('authScreen').classList.remove('hidden');
    switchAuthTab('login');
}

// ═══════════════════════════════════════════════════════
//  DATA LOADING
// ═══════════════════════════════════════════════════════
async function loadDashboardData() {
    const uid = adminViewingUserId || currentUser?.id;
    if (!uid) return;
    try {
        const [{ data: trades, error: te }, { data: payouts, error: pe }] = await Promise.all([
            sbClient.from('trades').select('*').eq('user_id', uid).order('trade_date', { ascending: true }),
            sbClient.from('payouts').select('*').eq('user_id', uid).order('payout_date', { ascending: true })
        ]);
        if (te) throw te;
        allData = trades || [];
        payoutData = pe ? [] : (payouts || []);
        updateAllViews();
        // Reset per-session alert state so fresh alerts can show on new load
        window._alertedAccounts = {};
    } catch (err) {
        console.error('Load data error:', err);
        showAlert('Failed to load data: ' + err.message, 'error');
    }
}

// ─── Sidebar role chip — call this any time role may have changed ───
function updateSidebarRole() {
    const role       = currentProfile?.role || 'user';
    const isAdmin    = role === 'admin';
    const isInvestor = role === 'investor';

    let label, cls;
    if (isAdmin)         { label = '👑 Admin';    cls = 'user-role admin'; }
    else if (isInvestor) { label = '💼 Investor'; cls = 'user-role investor'; }
    else                 { label = 'Member';      cls = 'user-role'; }

    const roleEl = document.getElementById('userRole');
    if (roleEl) { roleEl.textContent = label; roleEl.className = cls; }

    // Trader nav sections: hidden for pure investors
    const showTrader = isAdmin || !isInvestor;
    const traderMain    = document.getElementById('traderNavMain');
    const traderActions = document.getElementById('traderNavActions');
    if (traderMain)    traderMain.style.display    = showTrader ? '' : 'none';
    if (traderActions) traderActions.style.display = showTrader ? '' : 'none';

    // Investor nav section
    const invNavSection = document.getElementById('investorNavSection');
    if (invNavSection) invNavSection.style.display = (isAdmin || isInvestor) ? '' : 'none';

    // Admin-only items
    const adminNav = document.getElementById('adminNavItem');
    if (adminNav) adminNav.style.display = isAdmin ? 'flex' : 'none';
    const dbgNav = document.getElementById('debugNavItem');
    if (dbgNav) dbgNav.style.display = isAdmin ? 'flex' : 'none';

    // Add CSS body class so investor can never accidentally see trader pages
    document.body.classList.toggle('role-investor', isInvestor);
    document.body.classList.toggle('role-admin', isAdmin);
    document.body.classList.toggle('role-user', !isAdmin && !isInvestor);
}

async function refreshData() {
    showAlert('Syncing...', 'info');
    await loadProfile();
    updateSidebarRole();
    await loadDashboardData();
    showAlert('✓ Data refreshed', 'success');
}

// ═══════════════════════════════════════════════════════
//  TRADE SUBMISSION
// ═══════════════════════════════════════════════════════
async function handleTradeSubmit(e) {
    e.preventDefault();
    setBtnLoadingCustom('tradeSubmit', true);

    const isNoTrade = document.getElementById('noTradeDay').checked;
    const isCopier = document.getElementById('copierMode').checked;
    const cycle = parseInt(document.getElementById('tradeCycle').value) || 1;
    const date = document.getElementById('tradeDate').value;
    const notes = document.getElementById('tradeNotes').value || '';
    const ts = new Date().toISOString();
    const userId = currentUser.id;

    if (!date) { showAlert('Please select a trade date', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }

    let trades = [];

    if (isNoTrade) {
        trades.push({ user_id: userId, account: 'N/A', account_type: 'no_trade', market_condition: 'No Trade', risk_template: '0', trade_date: date, cycle, pnl: 0, contracts: 0, notes: notes || 'No-trade day', no_trade_day: true, timestamp: ts });
    } else if (isCopier) {
        const lead = document.getElementById('leadAccount').value;
        const followers = [...document.querySelectorAll('.follower-checkbox:checked')].map(c => c.value);
        const pnlRaw = document.getElementById('tradePnL').value;
        const condition = document.getElementById('tradeCondition').value;
        const risk = document.getElementById('tradeRisk').value;
        if (!lead || !followers.length || !condition || !risk || pnlRaw === '') { showAlert('Fill all required fields', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const pnl = parseFloat(pnlRaw);
        const contracts = parseInt(risk) / 100;
        [lead, ...followers].forEach((acc, i) => {
            trades.push({ user_id: userId, account: String(acc), account_type: i === 0 ? 'lead' : 'follower', copy_group: ts, market_condition: condition, risk_template: risk, trade_date: date, cycle, pnl, contracts, notes, no_trade_day: false, timestamp: ts });
        });
    } else {
        const acc = document.getElementById('tradeAccount').value;
        const pnlRaw = document.getElementById('tradePnL').value;
        const condition = document.getElementById('tradeCondition').value;
        const risk = document.getElementById('tradeRisk').value;
        if (!acc || !condition || !risk || pnlRaw === '') { showAlert('Fill all required fields', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const pnl = parseFloat(pnlRaw);
        if (isNaN(pnl)) { showAlert('P&L must be a number', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const contracts = parseInt(risk) / 100;
        trades.push({ user_id: userId, account: String(acc), account_type: 'single', market_condition: condition, risk_template: risk, trade_date: date, cycle, pnl, contracts, notes, no_trade_day: false, timestamp: ts });
    }

    try {
        const { error } = await sbClient.from('trades').insert(trades);
        if (error) throw error;
        showAlert('✓ ' + trades.length + ' trade(s) logged!', 'success');
        resetTradeForm();
        navigateTo('overview');
        loadDashboardData(); // intentionally not awaited — runs in background
    } catch (err) {
        showAlert('Failed: ' + (err.message || 'Unknown error'), 'error');
    } finally { setBtnLoadingCustom('tradeSubmit', false); }
}

function setBtnLoadingCustom(id, loading) {
    const btn = document.getElementById(id + 'Btn');
    const text = document.getElementById(id + 'Text');
    const spin = document.getElementById(id + 'Spinner');
    if (btn) btn.disabled = loading;
    if (text) text.style.display = loading ? 'none' : 'inline';
    if (spin) spin.style.display = loading ? 'inline-block' : 'none';
}

// ═══════════════════════════════════════════════════════
//  PAYOUT SUBMISSION
// ═══════════════════════════════════════════════════════
async function handlePayoutSubmit(e) {
    e.preventDefault();
    setBtnLoadingCustom('payoutSubmit', true);
    const payout = {
        user_id: currentUser.id,
        payout_type: document.getElementById('payoutType').value,
        amount: parseFloat(document.getElementById('withdrawalAmount').value),
        payout_date: document.getElementById('payoutDate').value,
        account: document.getElementById('payoutAccount').value,
        cycle_completed: parseInt(document.getElementById('cycleCompleted').value),
        new_cycle: parseInt(document.getElementById('newCycle').value),
        notes: document.getElementById('payoutNotes').value
    };
    const { error } = await sbClient.from('payouts').insert([payout]);
    setBtnLoadingCustom('payoutSubmit', false);
    if (error) { showAlert('✗ Failed: ' + error.message, 'error'); return; }
    showAlert('✓ Payout logged!', 'success');
    resetPayoutForm();
    await loadDashboardData();
}

// ═══════════════════════════════════════════════════════
//  DELETE
// ═══════════════════════════════════════════════════════
async function deleteByCycle() {
    const cycle = document.getElementById('deleteCycleSelect').value;
    if (!cycle) { showAlert('Select a cycle first', 'error'); return; }
    if (!confirm(`Delete ALL trades from Cycle ${cycle}?`)) return;
    const { error } = await sbClient.from('trades').delete().eq('user_id', currentUser.id).eq('cycle', parseInt(cycle));
    if (error) { showAlert('Delete failed: ' + error.message, 'error'); return; }
    showAlert(`✓ Cycle ${cycle} trades deleted`, 'success');
    await loadDashboardData();
}

async function deleteByAccount() {
    const acc = document.getElementById('deleteAccSelect').value;
    if (!acc) { showAlert('Select an account first', 'error'); return; }
    if (!confirm(`Delete ALL trades from PA Account #${acc}?`)) return;
    const { error } = await sbClient.from('trades').delete().eq('user_id', currentUser.id).eq('account', acc);
    if (error) { showAlert('Delete failed: ' + error.message, 'error'); return; }
    showAlert(`✓ Account #${acc} trades deleted`, 'success');
    await loadDashboardData();
}

async function confirmDeleteAll() {
    if (!confirm('⚠️ Delete ALL your trades AND payouts? IRREVERSIBLE!')) return;
    const confirmed = prompt('Type "DELETE ALL" to confirm:');
    if (confirmed !== 'DELETE ALL') { showAlert('Cancelled', 'info'); return; }
    await Promise.all([
        sbClient.from('trades').delete().eq('user_id', currentUser.id),
        sbClient.from('payouts').delete().eq('user_id', currentUser.id)
    ]);
    showAlert('✓ All data deleted', 'success');
    await loadDashboardData();
}

// ═══════════════════════════════════════════════════════
//  SETTINGS
// ═══════════════════════════════════════════════════════
async function handleSettingsSave(e) {
    e.preventDefault();
    let goal = parseInt(document.getElementById('accountGoalSelect').value);
    if (isNaN(goal)) goal = parseInt(document.getElementById('customGoalInput').value);
    if (!goal || goal < 1 || goal > 200) { showAlert('Enter a valid goal (1–200)', 'error'); return; }

    const updates = {
        id: currentUser.id,
        account_goal: goal,
        goal_per_account: parseFloat(document.getElementById('settingsGoalPerAcc')?.value) || 4600,
        payout_per_account: parseFloat(document.getElementById('settingsPayoutPerAcc')?.value) || 2000,
        daily_target_min: parseFloat(document.getElementById('settingsDailyMin')?.value) || 250,
        daily_target_max: parseFloat(document.getElementById('settingsDailyMax')?.value) || 300,
        max_drawdown: parseFloat(document.getElementById('settingsMaxDD')?.value) || 2500,
        starting_balance: parseFloat(document.getElementById('settingsStartBal')?.value) || 50000,
    };

    const { error } = await sbClient.from('profiles').upsert(updates);
    if (error) { showAlert('Save failed: ' + error.message, 'error'); return; }
    currentProfile = { ...currentProfile, ...updates };
    USER_ACCOUNT_GOAL = goal;
    applyProfileToConfig(updates);
    populateDropdowns();
    updateAllViews();
    showAlert(`✓ Settings saved!`, 'success');
}

function handleGoalSelectChange(val) {
    document.getElementById('customGoalWrap').style.display = val === 'custom' ? 'block' : 'none';
}
function resetSettings() { document.getElementById('accountGoalSelect').value = '20'; document.getElementById('customGoalWrap').style.display = 'none'; }

// ═══════════════════════════════════════════════════════
//  ACCOUNT NAMING
// ═══════════════════════════════════════════════════════
function saveAccNickname(accNum, inputEl) {
    saveNickname(accNum, inputEl.value);
    populateDropdowns();
    updateAllViews();
    showAlert(`✓ Account #${accNum} named "${inputEl.value || '(cleared'}"`, 'success');
}

// ═══════════════════════════════════════════════════════
//  ADMIN PANEL
// ═══════════════════════════════════════════════════════
async function loadAdminData() {
    if (currentProfile?.role !== 'admin') return;
    document.getElementById('adminUsersBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
    try {
        const [{ data: profiles }, { data: allTrades }] = await Promise.all([
            sbClient.from('profiles').select('*').order('created_at', { ascending: false }),
            sbClient.from('trades').select('*')
        ]);
        adminAllProfiles = profiles || [];
        adminAllTrades = allTrades || [];
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('adminTotalUsers').textContent = adminAllProfiles.length;
        document.getElementById('adminTotalTrades').textContent = adminAllTrades.length;
        const combinedPnL = adminAllTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        document.getElementById('adminTotalPnL').textContent = fmtCurrency(combinedPnL);
        const activeToday = new Set(adminAllTrades.filter(t => t.trade_date === today).map(t => t.user_id)).size;
        document.getElementById('adminActiveToday').textContent = activeToday;
        renderAdminUsers(adminAllProfiles);
    } catch (err) { showAlert('Failed to load admin data: ' + err.message, 'error'); }
}

function renderAdminUsers(profiles) {
    const tbody = document.getElementById('adminUsersBody');
    tbody.innerHTML = '';
    if (!profiles.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No users found</td></tr>'; return; }
    profiles.forEach(profile => {
        const userTrades = adminAllTrades.filter(t => t.user_id === profile.id);
        const userPnL = userTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const isApproved = profile.approved === true || profile.role === 'admin';
        const isPending = !isApproved;
        const row = tbody.insertRow();
        row.dataset.email = (profile.email || '').toLowerCase();
        if (isPending) row.style.background = 'rgba(245,166,35,0.05)';
        row.innerHTML = `
            <td>
                <strong>${profile.username || profile.email || '—'}</strong>
                <div style="font-size:0.75rem;color:var(--text-muted);">${profile.email || ''}</div>
            </td>
            <td>
                ${isPending
                    ? '<span class="badge" style="background:rgba(245,166,35,0.15);color:var(--warning);border:1px solid rgba(245,166,35,0.3);">⏳ Pending</span>'
                    : '<span class="badge badge-success">✓ Approved</span>'
                }
            </td>
            <td><span class="badge ${profile.role === 'admin' ? 'badge-gold' : profile.role === 'investor' ? 'badge-gold' : 'badge-active'}" style="${profile.role === 'investor' ? 'background:rgba(255,209,102,0.12);color:var(--gold);border:1px solid rgba(255,209,102,0.3);' : ''}">${profile.role || 'user'}</span></td>
            <td>${userTrades.length}</td>
            <td style="color:${userPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(userPnL)}</td>
            <td>${profile.created_at ? new Date(profile.created_at).toLocaleDateString() : '—'}</td>
            <td><div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                ${isPending
                    ? `<button class="btn btn-success" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="approveUser('${profile.id}','${profile.email}')">✓ Approve</button>`
                    : `<button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="revokeUser('${profile.id}','${profile.email}')">✕ Revoke</button>`
                }
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="viewUserTrades('${profile.id}','${profile.email}')">👁 Trades</button>
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="viewUserDashboardById('${profile.id}','${profile.email}')">📊 View</button>
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="quickToggleRole('${profile.id}','${profile.role || 'user'}','${profile.email}')">${profile.role === 'admin' ? '↓ Demote' : '↑ Admin'}</button>
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;border-color:rgba(255,209,102,0.4);color:${profile.role === 'investor' ? 'var(--gold)' : 'var(--text-muted)'};" onclick="quickSetInvestor('${profile.id}','${profile.role || 'user'}','${profile.email}')">${profile.role === 'investor' ? '💼 Investor' : '💼 Investor'}</button>
                <button class="btn btn-danger" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="adminRemoveUserDataById('${profile.id}','${profile.email}')">🗑</button>
            </div></td>`;
    });
}

async function approveUser(userId, email) {
    const { error } = await sbClient.from('profiles').update({ approved: true }).eq('id', userId);
    if (error) { showAlert('Error approving user: ' + error.message, 'error'); return; }
    showAlert(`✓ ${email} approved — they can now access the dashboard`, 'success');
    loadAdminData();
}

async function revokeUser(userId, email) {
    if (!confirm(`Revoke access for ${email}?`)) return;
    const { error } = await sbClient.from('profiles').update({ approved: false }).eq('id', userId);
    if (error) { showAlert('Error revoking user: ' + error.message, 'error'); return; }
    showAlert(`Access revoked for ${email}`, 'success');
    loadAdminData();
}

function filterAdminUsers() {
    const q = document.getElementById('adminUserSearch').value.toLowerCase();
    document.querySelectorAll('#adminUsersBody tr').forEach(row => { row.style.display = !q || (row.dataset.email || '').includes(q) ? '' : 'none'; });
}

async function viewUserTrades(userId, email) {
    const { data: trades } = await sbClient.from('trades').select('*').eq('user_id', userId).order('trade_date', { ascending: false }).limit(100);
    document.getElementById('adminViewingUserLabel').textContent = email;
    document.getElementById('adminUserTradesWrap').style.display = 'block';
    const tbody = document.getElementById('adminUserTradesBody');
    tbody.innerHTML = '';
    if (!trades?.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No trades</td></tr>'; return; }
    trades.forEach(t => {
        const pnl = parseFloat(t.pnl || 0);
        const row = tbody.insertRow();
        row.innerHTML = `<td>${t.trade_date}</td><td>PA #${t.account}</td><td>${t.market_condition||'—'}</td><td>$${t.risk_template||'—'}</td><td style="color:${pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.cycle}</td><td>${t.notes||'—'}</td>`;
    });
    document.getElementById('adminUserTradesWrap').scrollIntoView({ behavior: 'smooth' });
}
function closeUserTrades() { document.getElementById('adminUserTradesWrap').style.display = 'none'; }

async function viewUserDashboardById(userId, email) {
    adminViewingUserId = userId;
    adminViewingEmail = email;
    document.getElementById('adminViewingLabel').textContent = email;
    document.getElementById('adminViewingBanner').style.display = 'flex';
    await loadDashboardData();
    navigateTo('overview');
}
function viewUserDashboard() { if (adminViewingUserId) viewUserDashboardById(adminViewingUserId, adminViewingEmail); }
function exitAdminView() {
    adminViewingUserId = null; adminViewingEmail = null;
    document.getElementById('adminViewingBanner').style.display = 'none';
    loadDashboardData();
}

async function quickToggleRole(userId, currentRole, email) {
    // If currently admin → demote to user. If user/investor → promote to admin.
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    if (!confirm(`Change ${email}'s role to ${newRole}?`)) return;
    const { error } = await sbClient.from('profiles').update({ role: newRole }).eq('id', userId);
    if (error) { showAlert('Role update failed: ' + error.message, 'error'); return; }
    showAlert(`✓ ${email} is now ${newRole}`, 'success');
    // If this is the logged-in user, refresh their sidebar too
    if (currentUser && userId === currentUser.id) { await loadProfile(); updateSidebarRole(); }
    loadAdminData();
}

async function quickSetInvestor(userId, currentRole, email) {
    const newRole = currentRole === 'investor' ? 'user' : 'investor';
    const msg = newRole === 'investor'
        ? `Grant investor access to ${email}?\n\nThey will see the Investor Portal tab with their linked PA account.\n\nNote: If this user signed in via Google, make sure their email matches what you'll use in the Add Investor form.`
        : `Remove investor role from ${email}? They'll become a regular user.`;
    if (!confirm(msg)) return;
    const updates = { role: newRole, approved: true };
    // Also store the email in the profiles table so role lookup works
    if (newRole === 'investor' && email && !email.includes('@propfarmpro.app')) {
        updates.email = email;
    }
    const { error } = await sbClient.from('profiles').update(updates).eq('id', userId);
    if (error) { showAlert('Role update failed: ' + error.message, 'error'); return; }
    showAlert(`✓ ${email} is now ${newRole}`, 'success');
    // If this is the logged-in user, refresh their sidebar too
    if (currentUser && userId === currentUser.id) { await loadProfile(); updateSidebarRole(); }
    loadAdminData();
}

async function updateUserRole() {
    const emailOrUsername = document.getElementById('roleUserEmail').value.trim();
    const role = document.getElementById('roleUserRole').value;
    if (!emailOrUsername) { showAlert('Enter a user email or username', 'error'); return; }

    // Try to find profile by email first, then by username
    let profile = null;
    const { data: byEmail } = await sbClient.from('profiles').select('id,email').eq('email', emailOrUsername).maybeSingle();
    if (byEmail) {
        profile = byEmail;
    } else {
        // Try by username (case-insensitive)
        const { data: byUsername } = await sbClient.from('profiles').select('id,email').ilike('username', emailOrUsername).maybeSingle();
        if (byUsername) profile = byUsername;
    }

    // If still not found, try searching admin cached profiles for partial match
    if (!profile && adminAllProfiles.length) {
        const lc = emailOrUsername.toLowerCase();
        const found = adminAllProfiles.find(p =>
            (p.email||'').toLowerCase() === lc ||
            (p.username||'').toLowerCase() === lc
        );
        if (found) profile = found;
    }

    if (!profile) { showAlert('User not found. Make sure they have signed up and check the exact email/username.', 'error'); return; }

    const updates = { role };
    // When setting investor role, also ensure they are approved
    if (role === 'investor' || role === 'admin') updates.approved = true;

    const { error } = await sbClient.from('profiles').update(updates).eq('id', profile.id);
    if (error) { showAlert('Failed: ' + error.message, 'error'); return; }
    showAlert(`✓ ${emailOrUsername} role updated to ${role}`, 'success');
    document.getElementById('roleUserEmail').value = '';
    // If this is the logged-in user, refresh their sidebar too
    if (currentUser && profile.id === currentUser.id) { await loadProfile(); updateSidebarRole(); }
    loadAdminData();
}

async function adminResetUserPassword() {
    const email = document.getElementById('resetUserEmail').value.trim();
    if (!email) { showAlert('Enter a user email', 'error'); return; }
    const { error } = await sbClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
    if (error) { showAlert('Failed: ' + error.message, 'error'); return; }
    showAlert(`✓ Reset email sent to ${email}`, 'success');
    document.getElementById('resetUserEmail').value = '';
}

async function adminRemoveUserData() {
    const email = document.getElementById('removeUserEmail').value.trim();
    if (!email) { showAlert('Enter a user email', 'error'); return; }
    const { data: profile } = await sbClient.from('profiles').select('id').eq('email', email).single();
    if (!profile) { showAlert('User not found', 'error'); return; }
    await adminRemoveUserDataById(profile.id, email);
    document.getElementById('removeUserEmail').value = '';
}

async function adminRemoveUserDataById(userId, email) {
    if (!confirm(`Delete ALL trades and payouts for ${email}? Cannot be undone.`)) return;
    const [{ error: e1 }, { error: e2 }] = await Promise.all([
        sbClient.from('trades').delete().eq('user_id', userId),
        sbClient.from('payouts').delete().eq('user_id', userId)
    ]);
    if (e1 || e2) { showAlert('Delete failed', 'error'); return; }
    showAlert(`✓ All data for ${email} deleted`, 'success');
    loadAdminData();
}

// ═══════════════════════════════════════════════════════
//  VIEW UPDATES
// ═══════════════════════════════════════════════════════
function updateAllViews() {
    updateHero();
    updateMetrics();
    updateStats();
    updateCharts();
    updateTemplates();
    updateAccounts();
    updateAnalytics();
    updateTradeLog();
    updateRiskMonitor();
    updateCyclePerformance();
    updatePayoutPage();
    updateSettingsPage();
    updatePsychPage();
    updateShareJournalPage();
}

function updateHero() {
    const totalPnL = sumPnL(allData);
    const goal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
    const progress = Math.min((totalPnL / goal) * 100, 100);
    const atGoal = getAccountsAtGoal();
    document.getElementById('heroTotalPnL').textContent = fmtCurrency(totalPnL);
    document.getElementById('heroProgress').textContent = Math.round(progress) + '%';
    document.getElementById('heroAccounts').textContent = `${atGoal}/${USER_ACCOUNT_GOAL}`;
    document.getElementById('heroTitle').textContent = totalPnL >= goal ? 'Harvesting Your' : 'Building Your';
}

function updateMetrics() {
    const pnl = sumPnL(allData);
    const trades = allData.filter(t => !t.no_trade_day);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const losses = trades.filter(t => parseFloat(t.pnl || 0) < 0);
    const winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
    const totalWinsAmt = wins.reduce((s, t) => s + parseFloat(t.pnl), 0);
    const totalLossAmt = Math.abs(losses.reduce((s, t) => s + parseFloat(t.pnl), 0));
    const pf = totalLossAmt > 0 ? totalWinsAmt / totalLossAmt : 0;
    const avg = trades.length > 0 ? pnl / trades.length : 0;
    const streak = calcStreak(trades);
    const progress = Math.min((pnl / (USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT)) * 100, 100);

    document.getElementById('totalPnL').textContent = fmtCurrency(pnl);
    document.getElementById('pnlSub').textContent = `All time • ${allData.length} entries`;
    document.getElementById('winRate').textContent = Math.round(winRate) + '%';
    document.getElementById('winStatsSub').textContent = `${wins.length} wins / ${trades.length} trades`;
    document.getElementById('profitFactor').textContent = pf.toFixed(2);
    document.getElementById('pfSub').textContent = pf > 1.5 ? '🔥 Excellent' : pf > 1 ? 'Good' : pf > 0 ? 'Needs work' : '—';
    document.getElementById('winStreak').textContent = streak.current;
    document.getElementById('streakSub').textContent = streak.current > 0 ? `🔥 ${streak.current} wins in a row!` : 'No active streak';
    document.getElementById('totalTrades').textContent = trades.length;
    document.getElementById('tradesSub').textContent = `Across ${USER_ACCOUNT_GOAL} accounts`;
    document.getElementById('avgTrade').textContent = fmtCurrency(avg);
    document.getElementById('payoutProgress').textContent = Math.round(progress) + '%';
}

function updateStats() {
    const trades = allData.filter(t => !t.no_trade_day);
    if (!trades.length) return;
    const daily = {};
    trades.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
    const days = Object.values(daily);
    document.getElementById('bestDay').textContent = fmtCurrency(days.length ? Math.max(...days) : 0);
    document.getElementById('worstDay').textContent = fmtCurrency(days.length ? Math.min(...days) : 0);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const losses = trades.filter(t => parseFloat(t.pnl || 0) < 0);
    const avgW = wins.length ? wins.reduce((s, t) => s + parseFloat(t.pnl), 0) / wins.length : 0;
    const avgL = losses.length ? losses.reduce((s, t) => s + parseFloat(t.pnl), 0) / losses.length : 0;
    document.getElementById('avgWin').textContent = fmtCurrency(avgW);
    document.getElementById('avgLoss').textContent = fmtCurrency(avgL);
    document.getElementById('longestStreak').textContent = calcStreak(trades).longest;
}

function updateCharts() {
    destroyCharts();
    const trades = allData.filter(t => !t.no_trade_day);
    if (!trades.length) return;

    const C = { blue: '#3b7ef8', purple: '#9b6ffa', green: '#22d3a0', red: '#f05c6a', gold: '#ffd166', cyan: '#06d6d6' };
    const grid = 'rgba(99,179,237,0.06)';
    const baseOpts = { responsive: true, maintainAspectRatio: false, animation: { duration: 700, easing: 'easeOutQuart' }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15,22,41,0.95)', borderColor: 'rgba(99,179,237,0.2)', borderWidth: 1, titleColor: '#e8f0ff', bodyColor: '#7a8bb5', padding: 10, cornerRadius: 10, titleFont: { family: 'Space Grotesk', weight: '700' } } } };

    const dates = [...new Set(trades.map(t => t.trade_date))].sort();
    let sum = 0;
    const cumulative = dates.map(d => { sum += trades.filter(t => t.trade_date === d).reduce((s, t) => s + parseFloat(t.pnl || 0), 0); return sum; });
    // Color gradient: green if positive, red if last value is negative
    const lastVal = cumulative[cumulative.length - 1] || 0;
    const lineColor = lastVal >= 0 ? C.blue : C.red;
    const fillColor = lastVal >= 0 ? 'rgba(59,126,248,0.08)' : 'rgba(240,92,106,0.06)';
    charts.growth = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: { labels: dates, datasets: [{ data: cumulative, borderColor: lineColor, backgroundColor: fillColor, fill: true, tension: 0.4, borderWidth: 2.5, pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: lineColor, pointHoverBorderColor: '#fff', pointHoverBorderWidth: 2 }] },
        options: { ...baseOpts, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: grid }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', maxTicksLimit: 8, font: { size: 10 } }, border: { display: false } } } }
    });

    const condStats = {};
    trades.forEach(t => { const c = t.market_condition || 'Other'; if (!condStats[c]) condStats[c] = { w: 0, t: 0 }; condStats[c].t++; if (parseFloat(t.pnl || 0) > 0) condStats[c].w++; });
    const condLabels = Object.keys(condStats);
    charts.winRate = new Chart(document.getElementById('winRateChart'), {
        type: 'doughnut',
        data: { labels: condLabels, datasets: [{ data: condLabels.map(l => condStats[l].t > 0 ? ((condStats[l].w / condStats[l].t) * 100).toFixed(0) : 0), backgroundColor: [C.blue, C.purple, C.green, C.gold], borderWidth: 2, borderColor: '#0a0e1a', hoverBorderColor: '#0a0e1a', hoverOffset: 5 }] },
        options: { ...baseOpts, cutout: '74%', plugins: { ...baseOpts.plugins, legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 8, boxWidth: 10 } } } }
    });

    const daily = {};
    trades.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
    const dKeys = Object.keys(daily).sort().slice(-14);
    charts.daily = new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: { labels: dKeys.map(d => d.substring(5)), datasets: [{ data: dKeys.map(k => daily[k]), backgroundColor: dKeys.map(k => daily[k] >= 0 ? 'rgba(34,211,160,0.65)' : 'rgba(240,92,106,0.65)'), hoverBackgroundColor: dKeys.map(k => daily[k] >= 0 ? 'rgba(34,211,160,0.9)' : 'rgba(240,92,106,0.9)'), borderRadius: 6, borderSkipped: false }] },
        options: { ...baseOpts, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: grid }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
    });

    const riskC = {};
    trades.forEach(t => { const r = '$' + (t.risk_template || '?'); riskC[r] = (riskC[r] || 0) + 1; });
    charts.risk = new Chart(document.getElementById('riskChart'), {
        type: 'doughnut',
        data: { labels: Object.keys(riskC), datasets: [{ data: Object.values(riskC), backgroundColor: [C.blue, C.purple, C.green, C.gold, C.cyan, C.red], borderWidth: 2, borderColor: '#0a0e1a', hoverOffset: 5 }] },
        options: { ...baseOpts, cutout: '60%', plugins: { ...baseOpts.plugins, legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 6, boxWidth: 10 } } } }
    });

    const atGoal = getAccountsAtGoal();
    const active = getActiveAccountCount() - atGoal;
    const inactive = Math.max(0, USER_ACCOUNT_GOAL - getActiveAccountCount());
    document.getElementById('accStatusSub').textContent = `${USER_ACCOUNT_GOAL} accounts total`;
    charts.accStatus = new Chart(document.getElementById('accountStatusChart'), {
        type: 'doughnut',
        data: { labels: ['At Goal', 'In Progress', 'Not Started'], datasets: [{ data: [atGoal, active, inactive], backgroundColor: [C.green, C.blue, 'rgba(122,139,181,0.2)'], borderWidth: 2, borderColor: '#0a0e1a', hoverOffset: 5 }] },
        options: { ...baseOpts, cutout: '72%', plugins: { ...baseOpts.plugins, legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 6, boxWidth: 10 } } } }
    });
}

function destroyCharts() { Object.values(charts).forEach(c => { try { c?.destroy(); } catch (e) {} }); charts = {}; }

function updateTemplates() {
    const tpls = groupByTemplate(allData);
    const render = (grid, names) => {
        grid.innerHTML = '';
        names.forEach(name => grid.appendChild(createTemplateCard(name, tpls[name] || emptyTemplate())));
    };
    render(document.getElementById('marketCondGrid'), ['High Impact News', 'No Impact']);
    render(document.getElementById('riskTemplGrid'), [100, 200, 300, 400, 500, 600].map(r => `$${r} Risk`));
    const topGrid = document.getElementById('topTemplatesGrid');
    topGrid.innerHTML = '';
    const sorted = Object.entries(tpls).filter(([, d]) => d.trades > 0).sort((a, b) => b[1].totalPnL - a[1].totalPnL).slice(0, 3);
    if (!sorted.length) { topGrid.innerHTML = '<p style="color:var(--text-muted);">No trades yet. Add your first trade!</p>'; return; }
    sorted.forEach(([name, data]) => topGrid.appendChild(createTemplateCard(name, data)));
}

function emptyTemplate() { return { totalPnL: 0, trades: 0, winRate: 0, avgWin: 0, avgLoss: 0, bestTrade: 0 }; }

function createTemplateCard(name, data) {
    const el = document.createElement('div');
    el.className = 'tmpl-card';
    el.innerHTML = `
        <div class="tmpl-header">
            <div class="tmpl-icon">${tmplIcon(name)}</div>
            <div><div class="tmpl-name">${name}</div><div class="tmpl-desc">${tmplDesc(name)}</div></div>
        </div>
        <div class="tmpl-stats">
            <div><div class="tmpl-stat-val" style="color:${data.totalPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(data.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div>
            <div><div class="tmpl-stat-val">${data.trades}</div><div class="tmpl-stat-lbl">Trades</div></div>
            <div><div class="tmpl-stat-val">${Math.round(data.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div>
        </div>
        <div class="tmpl-details">
            <div class="tmpl-row"><span>Avg Win</span><span>${fmtCurrency(data.avgWin)}</span></div>
            <div class="tmpl-row"><span>Avg Loss</span><span>${fmtCurrency(data.avgLoss)}</span></div>
            <div class="tmpl-row"><span>Best Trade</span><span>${fmtCurrency(data.bestTrade)}</span></div>
        </div>`;
    return el;
}

function updateAccounts() {
    const grid = document.getElementById('accountsGrid');
    grid.innerHTML = '';
    const byAcc = groupByAccount(allData);
    let shown = 0;
    const alertsTriggered = [];

    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        if (accountFilter === 'active' && acc.trades === 0) continue;
        if (accountFilter === 'goal' && acc.pnl < GOAL_PER_ACCOUNT) continue;
        if (accountFilter === 'profitable' && acc.pnl <= 0) continue;

        const atGoal = acc.pnl >= GOAL_PER_ACCOUNT;
        const balance = STARTING_BALANCE + acc.pnl;
        const isNegPnl = acc.pnl < 0;
        const nickname = getNickname(i);

        // Progress bar logic: show correct proportion
        // For positive PnL: fill toward GOAL_PER_ACCOUNT
        // For negative PnL: show red bar representing drawdown vs MAX_DRAWDOWN
        let progBarHTML;
        if (acc.pnl >= 0) {
            const pct = Math.min((acc.pnl / GOAL_PER_ACCOUNT) * 100, 100);
            const fillClass = atGoal ? 'green' : '';
            progBarHTML = `<div class="prog-bar"><div class="prog-fill ${fillClass}" style="width:${pct}%"></div></div>`;
        } else {
            // Negative: show how much of the max drawdown has been used
            const drawdownUsed = Math.min(Math.abs(acc.pnl) / MAX_DRAWDOWN * 100, 100);
            progBarHTML = `<div class="prog-bar"><div class="prog-fill negative" style="width:${drawdownUsed}%"></div></div>`;
        }

        const progressPct = acc.pnl >= 0 ? Math.round(Math.min((acc.pnl / GOAL_PER_ACCOUNT) * 100, 100)) : -Math.round(Math.min((Math.abs(acc.pnl) / MAX_DRAWDOWN) * 100, 100));
        const progressLabel = acc.pnl >= 0 ? `${progressPct}% to goal` : `${Math.abs(progressPct)}% drawdown`;
        const pnlColor = acc.pnl > 0 ? 'var(--success)' : acc.pnl < 0 ? 'var(--danger)' : 'var(--text-muted)';

        // Low balance alert check
        const cushion = balance - (STARTING_BALANCE - MAX_DRAWDOWN);
        if (acc.trades > 0 && cushion < 500 && cushion > 0) {
            alertsTriggered.push({ type: 'warning', account: i, nickname, cushion, balance });
        } else if (acc.trades > 0 && cushion <= 0) {
            alertsTriggered.push({ type: 'danger', account: i, nickname, cushion, balance });
        }

        // Card class
        let cardClass = 'acc-card';
        if (atGoal) cardClass += ' goal-reached';
        else if (cushion <= 0 && acc.trades > 0) cardClass += ' at-risk';
        else if (cushion < 500 && acc.trades > 0) cardClass += ' warning-card';

        const card = document.createElement('div');
        card.className = cardClass;
        card.innerHTML = `
            <div class="acc-header">
                <div>
                    <div class="acc-num">PA #${i}</div>
                    ${nickname ? `<div class="acc-nickname">✏️ ${nickname}</div>` : ''}
                </div>
                <span class="badge ${atGoal ? 'badge-success' : acc.trades > 0 ? 'badge-active' : 'badge-muted'}">${atGoal ? '✓ GOAL' : acc.trades > 0 ? 'ACTIVE' : 'EMPTY'}</span>
            </div>
            <div class="acc-progress">
                <div class="prog-header">
                    <span style="color:${pnlColor};font-weight:700;">${fmtCurrency(acc.pnl)}</span>
                    <span style="color:${acc.pnl >= 0 ? 'var(--text-muted)' : 'var(--danger)'};">${progressLabel}</span>
                </div>
                ${progBarHTML}
            </div>
            <div class="acc-stats">
                <div><div class="acc-stat-lbl">Trades</div><div class="acc-stat-val">${acc.trades}</div></div>
                <div><div class="acc-stat-lbl">Win Rate</div><div class="acc-stat-val">${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</div></div>
                <div><div class="acc-stat-lbl">To Goal</div><div class="acc-stat-val" style="color:var(--text-muted)">${fmtCurrency(Math.max(GOAL_PER_ACCOUNT - acc.pnl, 0))}</div></div>
                <div><div class="acc-stat-lbl">Balance</div><div class="acc-stat-val" style="color:${balance < STARTING_BALANCE ? 'var(--danger)' : 'var(--success)'}">${fmtCurrency(balance)}</div></div>
            </div>
            <div class="acc-name-edit">
                <input type="text" class="acc-name-input" value="${nickname}" placeholder="✏️ Give this account a name..." maxlength="30" id="accName${i}">
                <button class="btn btn-secondary" style="padding:0.3rem 0.75rem;font-size:0.8rem;" onclick="saveAccNickname(${i}, document.getElementById('accName${i}'))">Save</button>
            </div>`;
        grid.appendChild(card);
        shown++;
    }
    if (!shown) grid.innerHTML = '<p style="color:var(--text-muted);padding:2rem;">No accounts match this filter.</p>';
    document.getElementById('accountsTitle').textContent = `${USER_ACCOUNT_GOAL} Portfolio Accounts`;

    // Fire low balance toasts (once per session per account, throttled)
    if (!window._alertedAccounts) window._alertedAccounts = {};
    alertsTriggered.forEach(a => {
        const key = `acc_alert_${a.account}_${a.type}`;
        if (!window._alertedAccounts[key]) {
            window._alertedAccounts[key] = true;
            const label = a.nickname ? `PA #${a.account} (${a.nickname})` : `PA #${a.account}`;
            if (a.type === 'danger') {
                showToast('danger', '🔴 Account At Risk!', `${label} has hit or exceeded the max drawdown. Balance: ${fmtCurrency(a.balance)}`);
            } else {
                showToast('warning', '⚠️ Low Cushion Alert', `${label} is within $${Math.round(a.cushion)} of the fail line. Balance: ${fmtCurrency(a.balance)}`);
            }
        }
    });
}

function filterAccounts(filter, e) {
    accountFilter = filter;
    document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
    if (e?.target) e.target.classList.add('active');
    updateAccounts();
}

// ═══════════════════════════════════════════════════════
//  TOAST NOTIFICATION SYSTEM
// ═══════════════════════════════════════════════════════
let _toastQueue = [];
function showToast(type, title, message, duration = 7000) {
    const container = document.getElementById('alertToastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `alert-toast toast-${type}`;
    const icons = { danger: '🔴', warning: '⚠️', success: '✅', info: 'ℹ️' };
    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || '🔔'}</div>
        <div class="toast-body">
            <div class="toast-title">${title}</div>
            <div class="toast-msg">${message}</div>
        </div>
        <button class="toast-close" onclick="dismissToast(this.closest('.alert-toast'))">✕</button>`;
    container.appendChild(toast);
    if (duration > 0) setTimeout(() => dismissToast(toast), duration);
}
function dismissToast(el) {
    if (!el || el.classList.contains('removing')) return;
    el.classList.add('removing');
    setTimeout(() => el.remove(), 300);
}

function updateAnalytics() {
    const tbody = document.getElementById('analyticsBody');
    tbody.innerHTML = '';
    const tpls = groupByTemplate(allData);
    const sorted = Object.entries(tpls).filter(([, d]) => d.trades > 0).sort((a, b) => b[1].totalPnL - a[1].totalPnL);
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">No trades yet</td></tr>'; return; }
    sorted.forEach(([name, d]) => {
        const tw = d.avgWin * (d.trades * d.winRate / 100);
        const tl = Math.abs(d.avgLoss * (d.trades * (100 - d.winRate) / 100));
        const pf = tl > 0 ? (tw / tl).toFixed(2) : '∞';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>${name}</strong></td><td style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</td><td>${d.trades}</td><td>${Math.round(d.winRate)}%</td><td>${fmtCurrency(d.avgWin)}</td><td>${fmtCurrency(d.avgLoss)}</td><td>${fmtCurrency(d.bestTrade)}</td><td>${pf}</td>`;
    });
}

function updateTradeLog() {
    const tbody = document.getElementById('tradeLogBody');
    tbody.innerHTML = '';
    if (!allData.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">No trades yet</td></tr>'; return; }
    const sorted = [...allData].sort((a, b) => new Date(b.trade_date) - new Date(a.trade_date)).slice(0, 200);
    sorted.forEach(t => {
        const pnl = parseFloat(t.pnl || 0);
        const row = tbody.insertRow();
        const accLabel = t.account !== 'N/A' ? getAccLabel(t.account) : 'N/A';
        row.dataset.search = `${t.trade_date} ${t.account} ${accLabel} ${t.market_condition || ''} ${t.notes || ''}`.toLowerCase();
        if (t.no_trade_day) {
            row.style.opacity = '0.55';
            row.innerHTML = `<td>${t.trade_date}</td><td colspan="7" style="color:var(--text-muted);font-style:italic;">📅 No-Trade Day — ${t.notes || ''}</td>`;
        } else {
            row.innerHTML = `<td>${t.trade_date}</td><td>${accLabel}</td><td>${t.market_condition || '—'}</td><td>$${t.risk_template}</td><td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.contracts}</td><td>${t.cycle}</td><td>${t.notes || '—'}</td>`;
        }
    });
}

function filterTradeLog() {
    const q = document.getElementById('tradeLogSearch').value.toLowerCase();
    document.querySelectorAll('#tradeLogBody tr').forEach(row => { row.style.display = !q || (row.dataset.search || '').includes(q) ? '' : 'none'; });
}

function updateRiskMonitor() {
    const grid = document.getElementById('riskGrid');
    grid.innerHTML = '';
    const byAcc = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        const bal = 50000 + acc.pnl;
        const high = acc.highestBalance;
        const failLine = high >= SAFETY_NET ? 50100 : high - MAX_DRAWDOWN;
        const cushion = bal - failLine;
        const cushionPct = Math.max(0, Math.min(100, (cushion / MAX_DRAWDOWN) * 100));
        const level = cushion <= 0 ? 'danger' : cushion <= 500 ? 'warning' : 'safe';
        const nickname = getNickname(i);
        const card = document.createElement('div');
        card.className = `acc-card${level === 'danger' ? ' at-risk' : level === 'warning' ? ' warning-card' : ''}`;
        card.innerHTML = `
            <div class="acc-header">
                <div><div class="acc-num">PA #${i}</div>${nickname ? `<div class="acc-nickname">✏️ ${nickname}</div>` : ''}</div>
                <span class="badge ${level === 'danger' ? 'badge-danger' : level === 'warning' ? 'badge-warning' : 'badge-success'}">${level === 'danger' ? 'AT RISK' : level === 'warning' ? 'WARNING' : 'SAFE'}</span>
            </div>
            <div class="acc-progress">
                <div class="prog-header"><span>Balance: ${fmtCurrency(bal)}</span><span>${Math.round(cushionPct)}% Cushion</span></div>
                <div class="prog-bar"><div class="prog-fill ${level === 'danger' ? 'red' : ''}" style="width:${cushionPct}%"></div></div>
            </div>
            <div class="acc-stats">
                <div><div class="acc-stat-lbl">P&L</div><div class="acc-stat-val" style="color:${acc.pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(acc.pnl)}</div></div>
                <div><div class="acc-stat-lbl">Fail Line</div><div class="acc-stat-val">${fmtCurrency(failLine)}</div></div>
                <div><div class="acc-stat-lbl">Cushion</div><div class="acc-stat-val" style="color:var(--${level==='safe'?'success':level==='warning'?'warning':'danger'})">${fmtCurrency(cushion)}</div></div>
                <div><div class="acc-stat-lbl">Peak Balance</div><div class="acc-stat-val">${fmtCurrency(high)}</div></div>
            </div>
            <div class="risk-info ${level}">
                ${level==='danger'?'⚠️ CRITICAL: At or below fail line!':level==='warning'?'⚠️ Less than $500 from fail line':high>=SAFETY_NET?'✅ Safety net locked — fail line at $50,100 forever':`✅ Safe — ${fmtCurrency(SAFETY_NET-high)} to safety net`}
            </div>`;
        grid.appendChild(card);
    }
}

function updateCyclePerformance() {
    const trades = allData.filter(t => !t.no_trade_day);
    const totalPnL = sumPnL(trades);
    const activeAcc = getActiveAccountCount();
    document.getElementById('cycleAccText').textContent = `${activeAcc} active account${activeAcc !== 1 ? 's' : ''}`;
    const activeGoal = activeAcc * GOAL_PER_ACCOUNT;
    const prog = activeAcc > 0 ? Math.min((totalPnL / activeGoal) * 100, 100) : 0;
    document.getElementById('firstPayoutProg').textContent = Math.round(prog) + '%';
    document.getElementById('firstPayoutSub').textContent = totalPnL >= activeGoal ? `✅ Qualified` : `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} remaining`;
    const tradingDays = [...new Set(trades.map(t => t.trade_date))].length;
    const dAvg = tradingDays > 0 ? totalPnL / tradingDays : 0;
    document.getElementById('dailyAvg').textContent = fmtCurrency(dAvg);
    document.getElementById('dailyTarget').textContent = activeAcc > 0 ? `Target: $${activeAcc * DAILY_TARGET_MIN}–$${activeAcc * DAILY_TARGET_MAX}/day` : 'No active accounts';
    const totalWithdrawn = payoutData.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
    document.getElementById('totalPayoutsAmt').textContent = fmtCurrency(totalWithdrawn);
    document.getElementById('payoutCountSub').textContent = payoutData.length === 0 ? 'No payouts yet' : `${payoutData.length} payout(s) recorded`;
    const cycleData = groupByCycle(trades);
    const cycleNums = Object.keys(cycleData).map(Number).sort((a, b) => a - b);
    const curCycle = cycleNums.length ? Math.max(...cycleNums) : 1;
    document.getElementById('currentCycleStatus').textContent = `Cycle ${curCycle}`;
    document.getElementById('cycleInfoSub').textContent = totalPnL < activeGoal ? `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} to first payout` : 'Monthly farming cycle active';
    const tbody = document.getElementById('cycleCompBody');
    tbody.innerHTML = '';
    if (!cycleNums.length) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;">No cycle data yet</td></tr>';
    else cycleNums.forEach(cn => {
        const d = cycleData[cn];
        const status = d.totalPnL >= activeGoal ? '✅ Payout Ready' : d.totalPnL >= activeGoal * 0.75 ? '🟡 Near Goal' : '🔵 In Progress';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>Cycle ${cn}</strong></td><td style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</td><td>${d.trades}</td><td>${d.tradingDays}</td><td>${fmtCurrency(d.dailyAvg)}</td><td>${Math.round(d.winRate)}%</td><td>${fmtCurrency(d.bestDay)}</td><td>${fmtCurrency(d.worstDay)}</td><td>${status}</td>`;
    });
    if (charts.cyclePnL) { charts.cyclePnL.destroy(); delete charts.cyclePnL; }
    if (charts.cycleDailyAvg) { charts.cycleDailyAvg.destroy(); delete charts.cycleDailyAvg; }
    if (cycleNums.length) {
        const labels = cycleNums.map(c => `Cycle ${c}`);
        const pnlVals = cycleNums.map(c => cycleData[c].totalPnL);
        charts.cyclePnL = new Chart(document.getElementById('cyclePnLChart'), {
            type: 'bar',
            data: { labels, datasets: [{ data: pnlVals, backgroundColor: pnlVals.map(v => v >= 0 ? 'rgba(34,211,160,0.7)' : 'rgba(240,92,106,0.7)'), borderRadius: 6, borderSkipped: false }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: 'rgba(99,179,237,0.07)' }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
        });
        charts.cycleDailyAvg = new Chart(document.getElementById('cycleDailyChart'), {
            type: 'line',
            data: { labels, datasets: [{ data: cycleNums.map(c => cycleData[c].dailyAvg), borderColor: '#3b7ef8', backgroundColor: 'rgba(59,126,248,0.08)', fill: true, tension: 0.4, borderWidth: 2.5, pointRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: 'rgba(99,179,237,0.07)' }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
        });
    }
    const detGrid = document.getElementById('cycleDetailsGrid');
    detGrid.innerHTML = '';
    [...cycleNums].reverse().forEach(cn => {
        const d = cycleData[cn];
        const card = document.createElement('div');
        card.className = 'tmpl-card';
        card.innerHTML = `
            <div class="tmpl-header">
                <div class="tmpl-icon" style="background:${d.totalPnL>=activeGoal?'linear-gradient(135deg,#22d3a0,#059669)':'linear-gradient(135deg,#3b7ef8,#9b6ffa)'}">🌾</div>
                <div><div class="tmpl-name">Cycle ${cn}</div><div class="tmpl-desc">${d.tradingDays} trading days • ${d.trades} trades</div></div>
            </div>
            <div class="tmpl-stats">
                <div><div class="tmpl-stat-val" style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div>
                <div><div class="tmpl-stat-val">${d.trades}</div><div class="tmpl-stat-lbl">Trades</div></div>
                <div><div class="tmpl-stat-val">${Math.round(d.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div>
            </div>
            <div class="tmpl-details">
                <div class="tmpl-row"><span>Daily Avg</span><span>${fmtCurrency(d.dailyAvg)}</span></div>
                <div class="tmpl-row"><span>Best Day</span><span>${fmtCurrency(d.bestDay)}</span></div>
                <div class="tmpl-row"><span>Worst Day</span><span>${fmtCurrency(d.worstDay)}</span></div>
            </div>`;
        detGrid.appendChild(card);
    });
}

function updatePayoutPage() {
    const trades = allData.filter(t => !t.no_trade_day);
    const totalPnL = sumPnL(trades);
    const totalWithdrawn = payoutData.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
    document.getElementById('totalWithdrawn').textContent = fmtCurrency(totalWithdrawn);
    document.getElementById('withdrawnCount').textContent = `${payoutData.length} payout(s)`;
    const activeAcc = getActiveAccountCount();
    const activeGoal = activeAcc * GOAL_PER_ACCOUNT;
    const available = totalPnL >= activeGoal ? activeAcc * PAYOUT_PER_ACCOUNT : 0;
    document.getElementById('availableWithdrawal').textContent = fmtCurrency(available);
    document.getElementById('withdrawalStatus').textContent = available > 0 ? '✅ Qualified' : `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} to qualify`;
    const lastPayout = payoutData.length > 0 ? payoutData[payoutData.length - 1] : null;
    document.getElementById('cyclePhase').textContent = lastPayout ? `Cycle ${lastPayout.new_cycle}` : 'Cycle 1';
    document.getElementById('phaseInfo').textContent = lastPayout ? 'Monthly farming cycle active' : 'Building to first payout';
    const tbody = document.getElementById('payoutHistBody');
    tbody.innerHTML = '';
    if (!payoutData.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem;">No payouts recorded yet</td></tr>'; return; }
    [...payoutData].sort((a, b) => new Date(b.payout_date) - new Date(a.payout_date)).forEach(p => {
        const row = tbody.insertRow();
        row.innerHTML = `<td>${p.payout_date}</td><td><strong>${p.payout_type||'—'}</strong></td><td style="color:var(--success)">${fmtCurrency(parseFloat(p.amount||0))}</td><td>PA #${p.account}</td><td>Cycle ${p.cycle_completed}</td><td>Cycle ${p.new_cycle}</td><td>${p.notes||'—'}</td>`;
    });
}

function updateSettingsPage() {
    const active = getActiveAccountCount();
    const setTxt = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    const setVal2 = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };

    // Profile display
    const p = currentProfile || {};
    setTxt('profileDisplayUsername', p.username || '—');
    setTxt('profileDisplayName2', p.display_name || '—');
    setTxt('profileDisplayBio', p.journal_bio || '—');
    setTxt('profileDisplayFirm', p.firm_name || '—');

    setTxt('settingsGoal', USER_ACCOUNT_GOAL);
    setTxt('settingsActive', active);
    setTxt('settingsPortGoal', fmtCurrency(USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT));
    setTxt('settingsPortCalc', `$${GOAL_PER_ACCOUNT.toLocaleString()} × ${USER_ACCOUNT_GOAL} accounts`);
    setTxt('settingsPayout', fmtCurrency(USER_ACCOUNT_GOAL * PAYOUT_PER_ACCOUNT));
    setTxt('settingsPayCalc', `$${PAYOUT_PER_ACCOUNT.toLocaleString()} × ${USER_ACCOUNT_GOAL} accounts`);

    const goalVal = [1, 5, 10, 20, 50, 100].includes(USER_ACCOUNT_GOAL) ? USER_ACCOUNT_GOAL.toString() : 'custom';
    setVal2('accountGoalSelect', goalVal);
    const customWrap = document.getElementById('customGoalWrap');
    if (goalVal === 'custom' && customWrap) { customWrap.style.display = 'block'; setVal2('customGoalInput', USER_ACCOUNT_GOAL); }

    // Populate goal fields from profile
    setVal2('settingsGoalPerAcc', p.goal_per_account || GOAL_PER_ACCOUNT);
    setVal2('settingsPayoutPerAcc', p.payout_per_account || PAYOUT_PER_ACCOUNT);
    setVal2('settingsDailyMin', p.daily_target_min || 250);
    setVal2('settingsDailyMax', p.daily_target_max || 300);
    setVal2('settingsMaxDD', p.max_drawdown || 2500);
    setVal2('settingsStartBal', p.starting_balance || 50000);

    const tbody = document.getElementById('settingsAccBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const byAcc = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        const nickname = getNickname(i);
        const status = acc.trades === 0 ? '<span style="color:var(--text-muted)">Not Started</span>' : acc.pnl >= GOAL_PER_ACCOUNT ? '<span style="color:var(--success)">✅ Goal Reached</span>' : '<span style="color:var(--accent)">In Progress</span>';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>PA #${i}</strong></td><td style="color:var(--cyan)">${nickname || '<span style="color:var(--text-dim)">—</span>'}</td><td>${status}</td><td style="color:${acc.pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(acc.pnl)}</td><td>${Math.round(acc.progress)}%</td><td>${acc.trades}</td><td>${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</td><td>${fmtCurrency(Math.max(0, GOAL_PER_ACCOUNT - acc.pnl))}</td>`;
    }
}

// ═══════════════════════════════════════════════════════
//  NAVIGATION
// ═══════════════════════════════════════════════════════
const PAGE_TITLES = {
    overview: 'Overview', cyclePerformance: 'Cycle Performance', templates: 'Templates',
    accounts: 'Accounts', analytics: 'Analytics', riskMonitor: 'Risk Monitor',
    psychology: '🧠 Trading Psychology', addTrade: 'Add Trade', logPayout: 'Log Payout',
    tradeLog: 'Trade Log', shareJournal: '🔗 Share Journal', deleteData: 'Delete Data',
    settings: 'Settings', adminPanel: 'Admin Panel', investorPortal: '💼 Investor Portal',
    debugPanel: '🔧 Debug Panel'
};

function navigateTo(page) {
    if (page === 'debugPanel') { openDebugPanel(); return; }

    // INVESTOR GUARD — pure investors can only access investorPortal and settings
    const isInvestor = currentProfile?.role === 'investor';
    const investorAllowed = ['investorPortal', 'settings'];
    if (isInvestor && !investorAllowed.includes(page)) {
        // Silently redirect to their portal
        page = 'investorPortal';
    }

    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById(page + 'Page');
    if (el) el.classList.add('active');
    document.getElementById('pageTitle').textContent = PAGE_TITLES[page] || page;
    if (page === 'adminPanel')     loadAdminData();
    if (page === 'shareJournal')   updateShareJournalPage();
    if (page === 'psychology')     updatePsychPage();
    if (page === 'investorPortal') updateInvestorPortalPage();
    if (window.innerWidth <= 1024) closeSidebar();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.addEventListener('click', () => navigateTo(item.dataset.page));
});

// Close investor user-search dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dd     = document.getElementById('ipUserDropdown');
    const search = document.getElementById('ipUserSearch');
    if (dd && !dd.contains(e.target) && e.target !== search) {
        dd.style.display = 'none';
    }
});

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const open = sidebar.classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show', open);
}
function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
}

// ═══════════════════════════════════════════════════════
//  FORM HELPERS
// ═══════════════════════════════════════════════════════
function populateDropdowns() {
    ['tradeAccount', 'leadAccount', 'deleteAccSelect', 'payoutAccount'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const isPayoutAcc = id === 'payoutAccount';
        el.innerHTML = `<option value="">Select account</option>`;
        if (isPayoutAcc) el.innerHTML += '<option value="all">All Accounts</option>';
        for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
            const nick = getNickname(i);
            el.innerHTML += `<option value="${i}">${nick ? `PA #${i} — ${nick}` : `PA Account #${i}`}</option>`;
        }
    });
    const followers = document.getElementById('followerCheckboxes');
    followers.innerHTML = '';
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const nick = getNickname(i);
        followers.innerHTML += `<label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;padding:0.4rem;border-radius:5px;background:var(--bg-elevated);font-size:0.8rem;"><input type="checkbox" class="follower-checkbox" value="${i}" style="accent-color:var(--accent);cursor:pointer;"> ${nick ? `PA #${i} — ${nick}` : `PA #${i}`}</label>`;
    }
}

function setTodayDates() {
    const today = new Date().toISOString().split('T')[0];
    ['tradeDate', 'payoutDate'].forEach(id => { const el = document.getElementById(id); if (el) el.value = today; });
    const suggestedCycle = payoutData.length > 0 ? payoutData[payoutData.length - 1].new_cycle : 1;
    const cycleEl = document.getElementById('tradeCycle');
    if (cycleEl && suggestedCycle) cycleEl.value = suggestedCycle;
}

// ═══════════════════════════════════════════════════════
//  ONBOARDING — 3 templates: trader / investor / journal
// ═══════════════════════════════════════════════════════
let _onboardStep = 0;
const ONBOARD_STEPS = 2;

function startOnboarding() {
    const role = currentProfile?.role || 'user';
    // Hide all templates first
    ['trader','investor','journal'].forEach(t => {
        const el = document.getElementById('obTemplate_' + t);
        if (el) el.style.display = 'none';
    });
    // Show correct template based on role
    const template = role === 'investor' ? 'investor' : role === 'journal' ? 'journal' : 'trader';
    const tmpl = document.getElementById('obTemplate_' + template);
    if (tmpl) tmpl.style.display = 'block';

    if (template === 'trader') {
        _onboardStep = 0;
        const p = currentProfile;
        const setV = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
        setV('obUsername', p?.username || window._pendingUsername || '');
        setV('obDisplayName', p?.display_name || '');
        setV('obBio', p?.journal_bio || '');
        setV('obFirmName', p?.firm_name || '');
        setV('obSocialLink', p?.google_link || '');
        setV('obAccountGoal', p?.account_goal || 20);
        setV('obGoalAcc', p?.goal_per_account || 4600);
        setV('obPayoutAcc', p?.payout_per_account || 2000);
        setV('obDailyMin', p?.daily_target_min || 250);
        setV('obDailyMax', p?.daily_target_max || 300);
        setV('obMaxDD', p?.max_drawdown || 2500);
        setV('obStartBal', p?.starting_balance || 50000);
        renderOnboardStep();
    } else if (template === 'investor') {
        const p = currentProfile;
        const setV = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
        setV('obInvName', p?.display_name || '');
        setV('obInvEmail', currentUser?.email?.includes('@propfarmpro.app') ? '' : (currentUser?.email || ''));
    } else if (template === 'journal') {
        const setV = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
        setV('obJournalName', currentProfile?.username || '');
        setV('obJournalEmail', currentUser?.email?.includes('@propfarmpro.app') ? '' : (currentUser?.email || ''));
    }
    document.getElementById('onboardOverlay').classList.remove('hidden');
}

function renderOnboardStep() {
    for (let i = 0; i < ONBOARD_STEPS; i++) {
        const s = document.getElementById('onboardStep' + i);
        if (s) s.classList.toggle('active', i === _onboardStep);
    }
    const prog = document.getElementById('onboardProgress');
    if (prog) {
        prog.innerHTML = '';
        for (let i = 0; i < ONBOARD_STEPS; i++) {
            const dot = document.createElement('div');
            dot.className = 'onboard-dot' + (i === _onboardStep ? ' active' : i < _onboardStep ? ' done' : '');
            prog.appendChild(dot);
        }
    }
    const backBtn = document.getElementById('onboardBackBtn');
    const nextBtn = document.getElementById('onboardNextBtn');
    if (backBtn) backBtn.style.display = _onboardStep > 0 ? 'block' : 'none';
    if (nextBtn) nextBtn.textContent = _onboardStep === ONBOARD_STEPS - 1 ? "🌾 Let's Farm!" : 'Next →';
}

function onboardBack() { if (_onboardStep > 0) { _onboardStep--; renderOnboardStep(); } }

async function onboardNext() {
    if (_onboardStep === 0) {
        const uname = document.getElementById('obUsername')?.value.trim();
        if (!uname || uname.length < 3) { showAlert('Please enter a username (at least 3 chars).', 'error'); return; }
    }
    if (_onboardStep === ONBOARD_STEPS - 1) {
        await saveOnboardingData();
        document.getElementById('onboardOverlay').classList.add('hidden');
        showAlert('🌾 Welcome! Your dashboard is ready. Happy farming!', 'success');
        return;
    }
    _onboardStep++;
    renderOnboardStep();
}

async function saveOnboardingData() {
    const g = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
    const updates = {
        id: currentUser.id,
        username: g('obUsername')?.trim() || null,
        display_name: g('obDisplayName')?.trim() || null,
        journal_bio: g('obBio')?.trim() || null,
        firm_name: g('obFirmName')?.trim() || null,
        google_link: g('obSocialLink')?.trim() || null,
        account_goal: parseInt(g('obAccountGoal')) || 20,
        goal_per_account: parseFloat(g('obGoalAcc')) || 4600,
        payout_per_account: parseFloat(g('obPayoutAcc')) || 2000,
        daily_target_min: parseFloat(g('obDailyMin')) || 250,
        daily_target_max: parseFloat(g('obDailyMax')) || 300,
        max_drawdown: parseFloat(g('obMaxDD')) || 2500,
        starting_balance: parseFloat(g('obStartBal')) || 50000,
        onboarded: true,
    };
    try {
        await sbClient.from('profiles').upsert(updates);
        currentProfile = { ...currentProfile, ...updates };
        USER_ACCOUNT_GOAL = updates.account_goal;
        applyProfileToConfig(updates);
        const name = updates.username || 'Trader';
        document.getElementById('userAvatar').textContent = name.substring(0, 2).toUpperCase();
        document.getElementById('userName').textContent = name;
        document.getElementById('heroName').textContent = name;
        updateAllViews();
    } catch(e) { showAlert('Could not save: ' + e.message, 'error'); }
}

async function saveInvestorOnboarding() {
    const name = document.getElementById('obInvName')?.value.trim();
    const display = document.getElementById('obInvDisplay')?.value.trim();
    const email = document.getElementById('obInvEmail')?.value.trim();
    if (!name) { showAlert('Please enter your name.', 'error'); return; }
    try {
        await sbClient.from('profiles').upsert({
            id: currentUser.id,
            username: display || name,
            display_name: name,
            email: email || currentUser.email || null,
            onboarded: true,
        });
        currentProfile = { ...currentProfile, username: display || name, display_name: name, onboarded: true };
        document.getElementById('onboardOverlay').classList.add('hidden');
        document.getElementById('userAvatar').textContent = (display || name).substring(0,2).toUpperCase();
        document.getElementById('userName').textContent = display || name;
        showAlert('💼 Welcome to your Investor Portal!', 'success');
        navigateTo('investor');
    } catch(e) { showAlert('Could not save: ' + e.message, 'error'); }
}

async function saveJournalOnboarding() {
    const name = document.getElementById('obJournalName')?.value.trim();
    const email = document.getElementById('obJournalEmail')?.value.trim();
    if (!name) { showAlert('Please enter your name.', 'error'); return; }
    try {
        await sbClient.from('profiles').upsert({
            id: currentUser.id,
            username: name,
            email: email || currentUser.email || null,
            onboarded: true,
        });
        currentProfile = { ...currentProfile, username: name, onboarded: true };
        document.getElementById('onboardOverlay').classList.add('hidden');
        document.getElementById('userAvatar').textContent = name.substring(0,2).toUpperCase();
        document.getElementById('userName').textContent = name;
        showAlert('📖 Welcome! You can now browse trading journals.', 'success');
        navigateTo('journal');
    } catch(e) { showAlert('Could not save: ' + e.message, 'error'); }
}



// ═══════════════════════════════════════════════════════
//  PROFILE MODAL
// ═══════════════════════════════════════════════════════
function openProfileModal() {
    const p = currentProfile || {};
    const setV = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
    setV('profileUsername', p.username);
    setV('profileDisplayName', p.display_name);
    setV('profileBio', p.journal_bio);
    setV('profileFirmName', p.firm_name);
    setV('profileSocialLink', p.google_link);
    // Only show real email (not internal @propfarmpro.app)
    const realEmail = (currentUser?.email || '').includes('@propfarmpro.app') ? '' : (currentUser?.email || '');
    setV('profileEmail', realEmail);
    document.getElementById('profileModal').classList.remove('hidden');
}

function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }

async function saveProfileModal() {
    const g = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
    const username = g('profileUsername');
    if (!username || username.length < 3) { showAlert('Username must be at least 3 characters.', 'error'); return; }
    const updates = {
        id: currentUser.id,
        username,
        display_name: g('profileDisplayName') || null,
        journal_bio: g('profileBio') || null,
        firm_name: g('profileFirmName') || null,
        google_link: g('profileSocialLink') || null,
    };
    // If real email provided, update auth email
    const newEmail = g('profileEmail');
    if (newEmail && !newEmail.includes('@propfarmpro.app')) {
        updates.email = newEmail;
        try { await sbClient.auth.updateUser({ email: newEmail }); } catch(e) {}
    }
    try {
        await sbClient.from('profiles').upsert(updates);
        currentProfile = { ...currentProfile, ...updates };
        document.getElementById('userAvatar').textContent = username.substring(0, 2).toUpperCase();
        document.getElementById('userName').textContent = username;
        document.getElementById('heroName').textContent = username;
        updateSettingsPage();
        closeProfileModal();
        showAlert('✅ Profile saved!', 'success');
    } catch(e) { showAlert('Save failed: ' + e.message, 'error'); }
}

// ═══════════════════════════════════════════════════════
//  CONTRACT SIZE EDITOR
// ═══════════════════════════════════════════════════════
let CONTRACT_SIZES = JSON.parse(localStorage.getItem('contract_sizes') || 'null') || { 100:1, 200:2, 300:3, 400:4, 500:5, 600:6 };

function buildContractEditor() {
    const el = document.getElementById('contractEditor');
    if (!el) return;
    el.innerHTML = '';
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const row = document.createElement('div');
        row.className = 'contract-row';
        row.innerHTML = `
            <div class="contract-label">$${risk} Risk Template</div>
            <div style="color:var(--text-muted);font-size:0.8rem;">Contracts:</div>
            <input type="number" class="contract-input" id="contractSize_${risk}" value="${CONTRACT_SIZES[risk] || Math.round(risk/100)}" min="1" max="50">
        `;
        el.appendChild(row);
    });
    // Rebuild trade form dropdown with updated contract sizes
    rebuildRiskDropdown();
}

function saveContractSizes() {
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const el = document.getElementById('contractSize_' + risk);
        if (el) CONTRACT_SIZES[risk] = parseInt(el.value) || Math.round(risk/100);
    });
    localStorage.setItem('contract_sizes', JSON.stringify(CONTRACT_SIZES));
    rebuildRiskDropdown();
    showAlert('✅ Contract sizes saved!', 'success');
}

function rebuildRiskDropdown() {
    const sel = document.getElementById('tradeRisk');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">Select risk</option>';
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const c = CONTRACT_SIZES[risk] || Math.round(risk/100);
        const opt = document.createElement('option');
        opt.value = risk;
        opt.textContent = `$${risk} (${c} contract${c !== 1 ? 's' : ''})`;
        sel.appendChild(opt);
    });
    if (prev) sel.value = prev;
}

function updateContracts(risk) {
    const c = risk ? (CONTRACT_SIZES[parseInt(risk)] || Math.round(parseInt(risk)/100)) : '';
    document.getElementById('tradeContracts').value = c;
}



function toggleNoTradeDay(checked) {
    ['tradeCondition', 'tradeRisk', 'tradePnL', 'tradeContracts', 'tradeAccount', 'leadAccount'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = checked;
        if (id !== 'tradeContracts') el.required = !checked;
    });
    document.querySelectorAll('.follower-checkbox').forEach(cb => cb.disabled = checked);
    if (checked && !document.getElementById('tradeNotes').value) document.getElementById('tradeNotes').value = 'No trading today — rest day';
}

function toggleCopierMode(checked) {
    document.getElementById('singleAccWrap').style.display = checked ? 'none' : 'block';
    document.getElementById('multiAccWrap').style.display = checked ? 'block' : 'none';
    document.getElementById('tradeAccount').required = !checked;
}

function resetTradeForm() {
    document.getElementById('tradeForm').reset();
    setTodayDates();
    toggleCopierMode(false);
    toggleNoTradeDay(false);
    document.getElementById('tradeContracts').value = '';
}

function resetPayoutForm() {
    document.getElementById('payoutForm').reset();
    document.getElementById('payoutDate').value = new Date().toISOString().split('T')[0];
}

// ═══════════════════════════════════════════════════════
//  CSV EXPORT
// ═══════════════════════════════════════════════════════
function exportCSV() {
    if (!allData.length) { showAlert('No data to export', 'error'); return; }
    const headers = ['Date', 'Account', 'Nickname', 'Condition', 'Risk', 'P&L', 'Contracts', 'Cycle', 'Notes', 'No-Trade Day'];
    const rows = allData.map(t => {
        const nick = getNickname(t.account) || '';
        return [t.trade_date, t.account, nick, t.market_condition, t.risk_template, t.pnl, t.contracts, t.cycle, (t.notes || '').replace(/"/g, '""'), t.no_trade_day ? 'Yes' : 'No'];
    });
    const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `prop_farm_pro_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    showAlert('✓ CSV exported', 'success');
}

// ═══════════════════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════════════════
function showAlert(msg, type) {
    const el = document.getElementById('alert');
    el.textContent = msg;
    el.className = `alert alert-${type} show`;
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), 5000);
}

function fmtCurrency(n) {
    const abs = Math.abs(Number(n) || 0);
    const f = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(abs);
    return n < 0 ? '(' + f + ')' : f;
}

function sumPnL(data) { return data.reduce((s, t) => s + parseFloat(t.pnl || 0), 0); }

function calcStreak(data) {
    if (!data.length) return { current: 0, longest: 0 };
    const sorted = [...data].sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date));
    let longest = 0, run = 0;
    sorted.forEach(t => { if (parseFloat(t.pnl || 0) > 0) { run++; longest = Math.max(longest, run); } else run = 0; });
    let curr = 0;
    for (let i = sorted.length - 1; i >= 0; i--) { if (parseFloat(sorted[i].pnl || 0) > 0) curr++; else break; }
    return { current: curr, longest };
}

function getAccountsAtGoal() {
    let count = 0;
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const pnl = allData.filter(t => t.account == i).reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        if (pnl >= GOAL_PER_ACCOUNT) count++;
    }
    return count;
}

function getActiveAccountCount() {
    return new Set(allData.filter(t => t.account && t.account !== 'N/A').map(t => parseInt(t.account)).filter(n => !isNaN(n))).size;
}

function groupByAccount(data) {
    const res = {};
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const trades = data.filter(t => parseInt(t.account) === i);
        const pnl = trades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0).length;
        let bal = 50000, high = 50000;
        [...trades].sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date)).forEach(t => { bal += parseFloat(t.pnl || 0); high = Math.max(high, bal); });
        res[i] = { pnl, trades: trades.length, winRate: trades.length > 0 ? (wins / trades.length) * 100 : 0, progress: Math.min(Math.max((pnl / GOAL_PER_ACCOUNT) * 100, 0), 100), highestBalance: high };
    }
    return res;
}

function groupByCycle(data) {
    const res = {};
    for (let c = 1; c <= 12; c++) {
        const ct = data.filter(t => parseInt(t.cycle) === c);
        if (!ct.length) continue;
        const pnl = ct.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = ct.filter(t => parseFloat(t.pnl || 0) > 0);
        const days = [...new Set(ct.map(t => t.trade_date))];
        const daily = {};
        ct.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
        const dVals = Object.values(daily);
        res[c] = { totalPnL: pnl, trades: ct.length, tradingDays: days.length, dailyAvg: days.length > 0 ? pnl / days.length : 0, winRate: ct.length > 0 ? (wins.length / ct.length) * 100 : 0, bestDay: dVals.length ? Math.max(...dVals) : 0, worstDay: dVals.length ? Math.min(...dVals) : 0 };
    }
    return res;
}

function groupByTemplate(data) {
    const build = (filter) => {
        const t = data.filter(filter).filter(x => !x.no_trade_day);
        const wins = t.filter(x => parseFloat(x.pnl || 0) > 0);
        const losses = t.filter(x => parseFloat(x.pnl || 0) < 0);
        return {
            totalPnL: t.reduce((s, x) => s + parseFloat(x.pnl || 0), 0), trades: t.length,
            winRate: t.length > 0 ? (wins.length / t.length) * 100 : 0,
            avgWin: wins.length > 0 ? wins.reduce((s, x) => s + parseFloat(x.pnl), 0) / wins.length : 0,
            avgLoss: losses.length > 0 ? losses.reduce((s, x) => s + parseFloat(x.pnl), 0) / losses.length : 0,
            bestTrade: t.length > 0 ? Math.max(...t.map(x => parseFloat(x.pnl || 0))) : 0
        };
    };
    const res = {};
    ['High Impact News', 'No Impact'].forEach(c => { res[c] = build(t => t.market_condition === c); });
    [100, 200, 300, 400, 500, 600].forEach(r => { res[`$${r} Risk`] = build(t => parseInt(t.risk_template) === r); });
    return res;
}

function tmplIcon(name) {
    if (name.includes('High')) return '📰';
    if (name.includes('No Impact')) return '📉';
    const r = parseInt(name.replace(/\D/g, ''));
    if (r <= 200) return '🟢'; if (r <= 400) return '🟡'; return '🔴';
}
function tmplDesc(name) {
    if (name.includes('High')) return 'High volatility news sessions';
    if (name.includes('No Impact')) return 'Low volatility, calmer markets';
    const r = parseInt(name.replace(/\D/g, ''));
    return r ? `$${r} risk — ${r / 100} contract${r > 100 ? 's' : ''}` : 'Custom template';
}

// ═══════════════════════════════════════════════════════
//  INVESTOR PORTAL
//  Privacy rules: investors NEVER see PA balance, $50k, raw P&L,
//  account numbers, or the words prop/PA/fail/breach/blown.
// ═══════════════════════════════════════════════════════

// ── Constants (admin-only, never injected into investor UI) ──
const IP_PA_START    = 50000;
const IP_PA_GOAL     = 4600;   // profit target
const IP_WARN_L1_BAL = 48500;  // 3% drop → yellow
const IP_WARN_L2_BAL = 47500;  // 5% drop → orange — DANGER ZONE (fail line)
const IP_WARN_L3_BAL = 46000;  // 8% drop → red — near blown
const IP_FAIL_LINE   = 47500;  // actual fail line — account blown if balance hits this

// ── State ──
let ipInvestors      = [];
let ipModeRequests   = [];
let ipEquityChartObj = null;
let ipSelectedMode   = null;   // tracks mode option selected in modal

// ── Core math (all three methods stay in sync) ──
function ipMultiplier(entry, payout) {
    // Method 2 multiplier: (payout - entry) / PA_GOAL
    return (payout - entry) / IP_PA_GOAL;
}
function ipDisplayValue(entry, payout, masterPnl) {
    const failPnl = IP_FAIL_LINE - IP_PA_START; // -2500 at default
    if (masterPnl <= failPnl) return 0; // blown — value is $0
    if (masterPnl < 0) {
        // Between fail line and start: scale linearly from $0 → entry
        return entry * (masterPnl - failPnl) / (0 - failPnl);
    }
    // Normal growth: entry → payout
    return entry + masterPnl * ((payout - entry) / IP_PA_GOAL);
}
function ipCyclePct(masterPnl) {
    // Method 3: same % the PA is up/down
    return (masterPnl / IP_PA_START) * 100;
}
function ipWarningLevel(masterPnl) {
    const bal = IP_PA_START + masterPnl;
    if (bal <= IP_FAIL_LINE) return 4;  // AT or BELOW fail line — account blown
    if (bal <= IP_WARN_L3_BAL) return 3; // near blown — red alert
    if (bal <= IP_WARN_L2_BAL) return 2; // approaching danger — orange
    if (bal <= IP_WARN_L1_BAL) return 1; // drawdown — yellow
    return 0;
}
function fmtPnl(n) {
    // Formats scaled P&L: +$X.XX or −$X.XX  (investor-facing)
    const abs = Math.abs(Number(n) || 0);
    const f = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2}).format(abs);
    return (Number(n) >= 0 ? '+' : '−') + f;
}
function ipRiskLabel(riskTemplate) {
    // $100 risk → "Conservative"   $300 risk → "Base"
    const r = parseInt(riskTemplate);
    if (r === 300) return 'Base';
    return 'Conservative';
}
function ipModeBadgeHtml(mode) {
    const cls = mode === 'base' ? 'base' : 'conservative';
    const label = mode === 'base' ? '⚡ Base' : '🛡 Conservative';
    return `<span class="ip-mode-badge ${cls}">${label}</span>`;
}
function ipWarnDot(level) {
    return ['🟢','🟡','🟠','🔴','💀'][level] || '🟢';
}

// ── Trade filtering by mode ──
function ipGetTradesForInvestor(inv) {
    const accNum = parseInt(inv.linked_account);
    if (!accNum) return [];
    const mode = inv.mode || 'conservative';
    // Filter trades by risk template matching the investor's mode
    // conservative → $100 risk; base → $300 risk
    return allData.filter(t => {
        if (parseInt(t.account) !== accNum) return false;
        if (t.no_trade_day) return false;
        const r = parseInt(t.risk_template);
        if (mode === 'base') return r === 300;
        return r === 100;
    });
}
function ipPnlForInvestor(inv) {
    return ipGetTradesForInvestor(inv).reduce((s,t) => s + parseFloat(t.pnl||0), 0);
}
// Admin needs total PA P&L regardless of mode
function ipGetAllTradesForAccount(accNum) {
    if (!accNum) return [];
    return allData.filter(t => parseInt(t.account) === parseInt(accNum) && !t.no_trade_day);
}
function ipPaBalanceForAccount(accNum) {
    const pnl = ipGetAllTradesForAccount(accNum).reduce((s,t) => s + parseFloat(t.pnl||0), 0);
    return IP_PA_START + pnl;
}

// ── DB load ──
async function ipLoadState() {
    try {
        const [invRes, reqRes] = await Promise.all([
            sbClient.from('investor_portal_investors').select('*').order('created_at', {ascending:true}),
            sbClient.from('investor_mode_requests').select('*').order('created_at', {ascending:false})
        ]);
        if (invRes.data) ipInvestors = invRes.data;
        if (reqRes.data) ipModeRequests = reqRes.data;

        // For investor users: allData is empty (they have no own trades).
        // Load all trades visible to them so ipGetAllTradesForAccount works.
        if (!allData.length) {
            const { data: tradeRows } = await sbClient.from('trades').select('*').order('trade_date', {ascending: true});
            if (tradeRows && tradeRows.length) allData = tradeRows;
        }
        return;
    } catch(_) {}
    // localStorage fallback
    try { ipInvestors    = JSON.parse(localStorage.getItem('pfp_investors')     || '[]'); } catch(_) { ipInvestors = []; }
    try { ipModeRequests = JSON.parse(localStorage.getItem('pfp_mode_requests') || '[]'); } catch(_) { ipModeRequests = []; }
}

async function ipSaveInvestors() {
    try {
        for (const inv of ipInvestors) {
            const { error } = await sbClient.from('investor_portal_investors').upsert({
                id: inv.id,
                name: inv.name,
                email: inv.email,
                entry_point: inv.entry_point,
                payout_target: inv.payout_target,
                linked_account: inv.linked_account,
                mode: inv.mode || 'conservative',
                created_at: inv.created_at
            }, { onConflict: 'id' });
            if (error) {
                console.error('ipSaveInvestors upsert error:', error);
                showAlert('DB error saving investor: ' + error.message, 'error');
                return false; // stop and let caller know
            }
        }
        localStorage.setItem('pfp_investors', JSON.stringify(ipInvestors));
        return true;
    } catch(e) {
        console.error('ipSaveInvestors exception:', e);
        showAlert('Failed to save investor: ' + e.message, 'error');
        return false;
    }
}

// ── Main render router ──
async function updateInvestorPortalPage() {
    await ipLoadState();
    const isAdmin  = currentProfile?.role === 'admin';
    const myEmail  = (currentUser?.email || currentProfile?.email || '').toLowerCase();
    const myInv    = ipInvestors.find(i => i.email?.toLowerCase() === myEmail);

    // Role guard
    const pg     = document.getElementById('investorPortalPage');
    const denied = pg?.querySelector('.ip-denied');
    if (denied) denied.remove();

    if (currentProfile?.role !== 'admin' && currentProfile?.role !== 'investor') {
        ['ipAdminSection','ipInvestorSection','ipNotRegistered'].forEach(id => {
            const el = document.getElementById(id); if (el) el.style.display = 'none';
        });
        if (pg) {
            const div = document.createElement('div');
            div.className = 'ip-denied';
            div.style.cssText = 'text-align:center;padding:4rem 2rem;background:var(--bg-card);border:1px dashed var(--border-glow);border-radius:var(--radius);margin-top:1rem;';
            div.innerHTML = '<div style="font-size:3rem;margin-bottom:1rem;">🔒</div><h3 style="font-size:1.2rem;font-weight:700;margin-bottom:.5rem;">Investor Access Only</h3><p style="color:var(--text-muted);font-size:.875rem;max-width:340px;margin:0 auto;">This section is restricted to registered investors.</p>';
            pg.prepend(div);
        }
        return;
    }

    document.getElementById('ipAdminSection').style.display  = isAdmin ? 'block' : 'none';
    document.getElementById('ipInvestorSection').style.display = 'none';
    document.getElementById('ipNotRegistered').style.display   = 'none';

    if (isAdmin) ipRenderAdmin();

    if (myInv) {
        document.getElementById('ipInvestorSection').style.display = 'block';
        ipRenderInvestorView(myInv);
    } else if (!isAdmin) {
        document.getElementById('ipNotRegistered').style.display = 'block';
    }
}

// ════════════════════════════════════════════════════════
//  ADMIN RENDER
// ════════════════════════════════════════════════════════
function ipRenderAdmin() {
    const el = id => document.getElementById(id);

    // Populate account selector
    const sel = el('ipLinkAccountSelect');
    if (sel) {
        const cur = sel.value;
        sel.innerHTML = '<option value="">— Select Account —</option>';
        for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
            const nick = getNickname(i);
            const o = document.createElement('option');
            o.value = i;
            o.textContent = nick ? `Account #${i} — ${nick}` : `Account #${i}`;
            if (String(i) === String(cur)) o.selected = true;
            sel.appendChild(o);
        }
    }

    // PA Health Panel — real numbers, admin only
    // Use all data combined for global PA health display
    const allPnl = allData.filter(t=>!t.no_trade_day).reduce((s,t)=>s+parseFloat(t.pnl||0),0);
    const paBal  = IP_PA_START + allPnl;
    const paPct  = Math.min((allPnl / IP_PA_GOAL) * 100, 100).toFixed(1);
    const globalWL = ipWarningLevel(allPnl);
    if (el('ipAdminPaBal'))      el('ipAdminPaBal').textContent      = fmtCurrency(paBal);
    if (el('ipAdminPaProgress')) {
        el('ipAdminPaProgress').textContent  = `${allPnl >= 0 ? '+' : ''}${fmtCurrency(allPnl)} (${paPct}%)`;
        el('ipAdminPaProgress').style.color  = allPnl >= 0 ? 'var(--success)' : 'var(--danger)';
    }
    if (el('ipAdminWarnDot')) el('ipAdminWarnDot').textContent = ipWarnDot(globalWL);
    const atRisk = ipInvestors.filter(inv => {
        const pnl = ipGetAllTradesForAccount(inv.linked_account).reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        return ipWarningLevel(pnl) > 0;
    }).length;
    if (el('ipAdminAtRisk')) el('ipAdminAtRisk').textContent = atRisk;

    // Overview metrics
    const linked  = [...new Set(ipInvestors.map(i=>i.linked_account).filter(Boolean))];
    const atGoal  = ipInvestors.filter(inv => ipPnlForInvestor(inv) >= IP_PA_GOAL).length;
    const pending = ipModeRequests.filter(r => r.status === 'pending').length;
    if (el('ipInvestorCount')) el('ipInvestorCount').textContent = ipInvestors.length;
    if (el('ipLinkedCount'))   el('ipLinkedCount').textContent   = linked.length;
    if (el('ipAtGoalCount'))   el('ipAtGoalCount').textContent   = atGoal;
    if (el('ipPendingCount'))  el('ipPendingCount').textContent  = pending;

    // Bell badge
    const badge = el('ipBellBadge');
    if (badge) { badge.textContent = pending; badge.style.display = pending ? 'inline' : 'none'; }

    // Notification list (render but keep panel open/closed state)
    ipRenderNotifList();

    // Investor table
    const tbody = el('ipInvestorTableBody');
    if (!tbody) return;
    if (!ipInvestors.length) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted);">No investors yet. Add one below.</td></tr>';
        return;
    }
    const wlColors = ['','rgba(245,166,35,0.06)','rgba(240,130,60,0.08)','rgba(240,92,106,0.1)'];
    const wlBorder = ['','rgba(245,166,35,0.25)','rgba(240,130,60,0.3)','rgba(240,92,106,0.35)'];
    tbody.innerHTML = ipInvestors.map((inv, idx) => {
        const entry  = parseFloat(inv.entry_point)   || 115;
        const payout = parseFloat(inv.payout_target) || 800;
        const masterPnl = ipGetAllTradesForAccount(inv.linked_account).reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        const dv    = ipDisplayValue(entry, payout, masterPnl);
        const pct   = Math.min(Math.max((dv - entry) / (payout - entry) * 100, 0), 100);
        const wl    = ipWarningLevel(masterPnl);
        const mode  = inv.mode || 'conservative';
        const hasPending = ipModeRequests.some(r => r.investor_id === inv.id && r.status === 'pending');
        const rowStyle = wl > 0 ? `background:${wlColors[wl]};outline:1px solid ${wlBorder[wl]};` : '';
        const accNum  = inv.linked_account;
        const nick    = accNum ? getNickname(parseInt(accNum)) : null;
        const accLabel = accNum
            ? `<span style="font-family:'JetBrains Mono',monospace;font-size:0.82rem;color:var(--cyan);">#${accNum}</span>${nick ? `<br><span style="font-size:0.72rem;color:var(--text-muted);">${nick}</span>` : ''}`
            : `<span style="color:var(--text-dim);font-size:0.8rem;">— none —</span>`;
        return `<tr style="${rowStyle}">
            <td><strong>${inv.name || '—'}</strong></td>
            <td style="color:var(--text-muted);font-size:0.82rem;">${inv.email || '—'}</td>
            <td>${accLabel}</td>
            <td style="font-family:'JetBrains Mono',monospace;">${fmtCurrency(entry)}</td>
            <td>${ipModeBadgeHtml(mode)}${hasPending ? ' <span style="font-size:0.7rem;color:var(--warning);">⏳</span>' : ''}</td>
            <td style="font-family:'JetBrains Mono',monospace;color:${dv>=payout?'var(--gold)':dv>=entry?'var(--success)':'var(--danger)'};">${fmtCurrency(dv)}</td>
            <td>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <div style="flex:1;height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;max-width:80px;">
                        <div style="height:100%;width:${pct.toFixed(0)}%;background:${dv>=payout?'var(--gold)':'var(--accent)'};border-radius:3px;transition:width 1s;"></div>
                    </div>
                    <span style="font-size:0.72rem;color:var(--text-muted);">${pct.toFixed(0)}%</span>
                </div>
            </td>
            <td style="font-size:1.1rem;">${ipWarnDot(wl)}</td>
            <td style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                <button class="btn btn-secondary" style="padding:0.2rem 0.5rem;font-size:0.72rem;" onclick="ipAdminViewAs(${idx})">👁 View</button>
                ${hasPending ? `<button class="btn btn-secondary" style="padding:0.2rem 0.5rem;font-size:0.72rem;" onclick="ipToggleNotifPanel()">🔔</button>` : ''}
                <button class="btn btn-danger" style="padding:0.2rem 0.5rem;font-size:0.72rem;" onclick="ipRemoveInvestor(${idx})">✕</button>
            </td>
        </tr>`;
    }).join('');
}

function ipRenderNotifList() {
    const list = document.getElementById('ipNotifList');
    if (!list) return;
    const pending = ipModeRequests.filter(r => r.status === 'pending');
    const count   = document.getElementById('ipNotifCount');
    if (count) count.textContent = pending.length ? `${pending.length} pending` : 'All clear ✓';
    if (!pending.length) {
        list.innerHTML = '<div style="padding:1.25rem;text-align:center;color:var(--text-muted);font-size:0.875rem;">No pending requests ✓</div>';
        return;
    }
    list.innerHTML = pending.map(r => {
        const inv   = ipInvestors.find(i => i.id === r.investor_id);
        const name  = inv?.name || inv?.email || 'Unknown';
        const init  = name.substring(0,2).toUpperCase();
        const from  = r.current_mode  === 'base' ? '⚡ Base' : '🛡 Conservative';
        const to    = r.requested_mode === 'base' ? '⚡ Base' : '🛡 Conservative';
        const ts    = r.created_at ? new Date(r.created_at).toLocaleString() : '';
        const isUrgent = r.urgent;
        return `<div style="padding:0.875rem 1.25rem;border-bottom:1px solid var(--border);${isUrgent?'background:rgba(240,130,60,0.04);':''}">
            <div style="display:flex;gap:0.75rem;align-items:flex-start;margin-bottom:0.6rem;">
                <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;flex-shrink:0;">${init}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-weight:600;font-size:0.875rem;">${name} ${isUrgent ? '<span style="background:rgba(240,92,106,0.15);color:var(--danger);border-radius:4px;padding:1px 5px;font-size:0.68rem;font-weight:700;">URGENT</span>' : ''}</div>
                    <div style="font-size:0.78rem;color:var(--text-muted);">${from} → ${to}</div>
                    ${r.message ? `<div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.25rem;font-style:italic;">"${r.message}"</div>` : ''}
                    <div style="font-size:0.7rem;color:var(--text-dim);margin-top:0.2rem;">${ts}</div>
                </div>
            </div>
            <div style="display:flex;gap:0.5rem;">
                <input type="text" placeholder="Reply (optional)" id="ipReplyInput_${r.id}" class="form-input" style="flex:1;padding:0.35rem 0.6rem;font-size:0.8rem;">
                <button class="btn btn-success" style="padding:0.3rem 0.625rem;font-size:0.8rem;" onclick="ipRespondRequest('${r.id}','approved')">✅ Approve</button>
                <button class="btn btn-danger"  style="padding:0.3rem 0.625rem;font-size:0.8rem;" onclick="ipRespondRequest('${r.id}','denied')">❌ Deny</button>
            </div>
        </div>`;
    }).join('');
}

function ipToggleNotifPanel() {
    const panel = document.getElementById('ipNotifPanel');
    if (!panel) return;
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

async function ipRespondRequest(reqId, decision) {
    const req = ipModeRequests.find(r => r.id === reqId);
    if (!req) return;
    const reply = document.getElementById(`ipReplyInput_${reqId}`)?.value.trim() || null;
    req.status      = decision;
    req.admin_reply = reply;
    req.responded_at = new Date().toISOString();

    // If approved — update investor mode in memory and DB
    if (decision === 'approved') {
        const inv = ipInvestors.find(i => i.id === req.investor_id);
        if (inv) {
            inv.mode = req.requested_mode;
            try {
                await sbClient.from('investor_portal_investors')
                    .update({ mode: req.requested_mode })
                    .eq('id', inv.id);
            } catch(_) {}
        }
    }

    // Persist request update
    try {
        await sbClient.from('investor_mode_requests').update({
            status: decision, admin_reply: reply, responded_at: req.responded_at
        }).eq('id', reqId);
    } catch(_) {}
    localStorage.setItem('pfp_mode_requests', JSON.stringify(ipModeRequests));
    localStorage.setItem('pfp_investors', JSON.stringify(ipInvestors));

    ipRenderAdmin();
    showAlert(decision === 'approved' ? '✅ Request approved — mode updated.' : '❌ Request denied.', decision === 'approved' ? 'success' : 'error');
}

// Admin preview: view the investor portal as a specific investor
function ipAdminViewAs(idx) {
    const inv = ipInvestors[idx];
    if (!inv) return;
    document.getElementById('ipAdminSection').style.display   = 'none';
    document.getElementById('ipInvestorSection').style.display = 'block';
    ipRenderInvestorView(inv, true);
    showAlert(`👁 Viewing portal as: ${inv.name || inv.email}`, 'success');
    // Add a "back to admin" button at top of investor view
    const sec = document.getElementById('ipInvestorSection');
    const existing = sec.querySelector('.ip-admin-back');
    if (existing) existing.remove();
    const back = document.createElement('div');
    back.className = 'ip-admin-back';
    back.style.cssText = 'margin-bottom:1rem;';
    back.innerHTML = `<button class="btn btn-secondary" onclick="ipAdminBackFromPreview()" style="padding:0.4rem 0.875rem;font-size:0.82rem;">← Back to Admin View</button> <span style="color:var(--text-muted);font-size:0.82rem;">Previewing as <strong>${inv.name || inv.email}</strong></span>`;
    sec.prepend(back);
}
function ipAdminBackFromPreview() {
    const sec = document.getElementById('ipInvestorSection');
    const back = sec.querySelector('.ip-admin-back');
    if (back) back.remove();
    document.getElementById('ipAdminSection').style.display   = 'block';
    document.getElementById('ipInvestorSection').style.display = 'none';
}

// ════════════════════════════════════════════════════════
//  INVESTOR VIEW RENDER
//  Privacy: nothing here exposes PA numbers to investors.
// ════════════════════════════════════════════════════════
function ipRenderInvestorView(inv, isAdminPreview) {
    window.currentInvestorRecord = inv; // store for email report
    const el = id => document.getElementById(id);

    const entry   = parseFloat(inv.entry_point)   || 115;
    const payout  = parseFloat(inv.payout_target) || 800;
    const mode    = inv.mode || 'conservative';
    const mult    = ipMultiplier(entry, payout);

    // Use all trades from the linked account for value calculation
    const trades = ipGetAllTradesForAccount(inv.linked_account)
        .sort((a,b) => new Date(a.trade_date) - new Date(b.trade_date));

    const masterPnl = trades.reduce((s,t) => s + parseFloat(t.pnl||0), 0);
    const dv        = ipDisplayValue(entry, payout, masterPnl);
    const profit    = dv - entry;
    const progPct   = Math.min(Math.max((dv - entry) / (payout - entry) * 100, 0), 100);
    const atGoal    = dv >= payout;
    const cyclePct  = ipCyclePct(masterPnl);
    const warnLevel = ipWarningLevel(masterPnl);

    // ── Warning banners ──
    const isBlown = warnLevel === 4;
    ['ipWarnL1','ipWarnL2','ipWarnL3'].forEach((id, i) => {
        const bannerEl = el(id);
        if (bannerEl) {
            if (warnLevel === i+1) bannerEl.classList.add('show');
            else bannerEl.classList.remove('show');
        }
    });
    // WarnL4 — terminated state
    const l4 = el('ipWarnL4');
    if (l4) { if (isBlown) l4.classList.add('show'); else l4.classList.remove('show'); }

    // Hide all interactive elements when blown — show terminated state only
    ['ipInvHeader','ipEquitySection','ipMilestonesSection','ipTradeSection','ipModeBadge','ipModeReqBtn','ipPendingBadge'].forEach(id => {
        const e2 = el(id); if (e2) e2.style.display = isBlown ? 'none' : '';
    });

    // Level 2+: auto-create urgent admin notification (once per session)
    if (warnLevel >= 2 && !isAdminPreview) {
        ipAutoUrgentNotify(inv);
    }

    // ── Hero card ──
    const dvEl = el('ipDisplayValue');
    if (dvEl) {
        dvEl.textContent = fmtCurrency(dv);
        dvEl.style.color = atGoal ? 'var(--gold)' : 'var(--text)';
        dvEl.style.textShadow = atGoal ? '0 0 40px rgba(255,209,102,0.5)' : '';
    }
    if (el('ipEntryDisplay'))  el('ipEntryDisplay').textContent  = fmtCurrency(entry);
    if (el('ipPayoutDisplay')) el('ipPayoutDisplay').textContent = fmtCurrency(payout);
    if (el('ipEntryDisplay2'))  el('ipEntryDisplay2').textContent  = fmtCurrency(entry);
    if (el('ipPayoutDisplay2')) el('ipPayoutDisplay2').textContent = fmtCurrency(payout);

    // Cycle % gain badge (Method 3 — same % as PA)
    const gainBadge = el('ipCycleGainBadge');
    if (gainBadge) {
        const sign = cyclePct >= 0 ? '+' : '';
        gainBadge.textContent = `${sign}${cyclePct.toFixed(2)}%`;
        gainBadge.className = cyclePct >= 0 ? 'ipv-gain' : 'ipv-gain neg';
    }

    // Mode badge + request button
    const modeBadge = el('ipModeBadge');
    if (modeBadge) {
        modeBadge.className = `ip-mode-badge ${mode === 'base' ? 'base' : 'conservative'}`;
        modeBadge.textContent = mode === 'base' ? '⚡ Base' : '🛡 Conservative';
    }

    // Check for pending request — disable button if pending
    const pendingReq = ipModeRequests.find(r =>
        r.investor_id === inv.id && r.status === 'pending'
    );
    const modeBtn     = el('ipModeReqBtn');
    const pendingBadge = el('ipPendingBadge');
    if (modeBtn && pendingBadge) {
        if (pendingReq) {
            modeBtn.style.display    = 'none';
            pendingBadge.style.display = 'inline-flex';
        } else {
            // Check for recently denied
            const lastReq = [...ipModeRequests]
                .filter(r => r.investor_id === inv.id)
                .sort((a,b) => new Date(b.created_at)-new Date(a.created_at))[0];
            modeBtn.style.display    = warnLevel === 3 ? 'none' : 'inline-flex'; // disabled at level 3
            pendingBadge.style.display = 'none';
            if (lastReq?.status === 'denied') {
                // Show "reviewed" notice briefly
                modeBtn.title = 'Your last request was reviewed — no change at this time.';
            }
        }
    }

    // Header goal glow
    const hdr = el('ipInvHeader');
    if (hdr) {
        hdr.style.borderColor = atGoal ? 'rgba(240,192,64,0.45)' : 'rgba(255,255,255,0.09)';
        if (atGoal) hdr.style.boxShadow = '0 24px 70px rgba(0,0,0,0.65),0 0 60px rgba(240,192,64,0.15),inset 0 1px 0 rgba(255,255,255,0.07)';
    }

    // ── Ring progress ──
    const ring = el('ipRingFill');
    const ringPct = el('ipRingPct');
    const CIRCUMFERENCE = 376.99;
    if (ring && ringPct) {
        const pctClamped = Math.max(0, Math.min(100, progPct));
        const offset = CIRCUMFERENCE - (pctClamped / 100) * CIRCUMFERENCE;
        requestAnimationFrame(() => { ring.style.strokeDashoffset = offset; });
        const ringColor = isBlown ? '#f05c6a' : atGoal ? '#f0c040' : pctClamped > 60 ? '#2ecc9a' : '#4a8eff';
        ring.style.stroke = ringColor;
        ringPct.textContent = isBlown ? '0%' : atGoal ? '100%' : pctClamped.toFixed(0) + '%';
        ringPct.style.color = ringColor;
    }

    // ── Progress bar ──
    if (el('ipInvProgLeft2')) el('ipInvProgLeft2').textContent = fmtCurrency(entry);
    if (el('ipInvProgRight')) el('ipInvProgRight').textContent = fmtCurrency(payout);
    const fill = el('ipInvProgFill');
    if (fill) {
        fill.style.width = progPct.toFixed(1) + '%';
        fill.style.background = atGoal
            ? 'linear-gradient(90deg,#f0c040,#ffb700)'
            : isBlown ? '#f05c6a'
            : 'linear-gradient(90deg,#4a8eff 0%,#a78bfa 55%,#f0c040 100%)';
        fill.style.boxShadow = atGoal ? '0 0 16px rgba(240,192,64,0.6)' : '0 0 14px rgba(74,142,255,0.5)';
    }
    if (el('ipInvProgPct')) el('ipInvProgPct').textContent = atGoal ? '🎉 Payout Reached!' : isBlown ? 'Cycle Closed' : progPct.toFixed(1) + '% to payout';

    // ── Stats ──
    const scaledPnls = trades.map(t => parseFloat(t.pnl||0) * mult);
    const wins       = scaledPnls.filter(v => v > 0);
    const best       = scaledPnls.length ? Math.max(...scaledPnls) : null;
    const worst      = scaledPnls.length ? Math.min(...scaledPnls) : null;
    const winRate    = scaledPnls.length ? (wins.length / scaledPnls.length * 100) : 0;
    if (el('ipStatBest'))     el('ipStatBest').textContent     = best  !== null ? fmtPnl(best)  : '—';
    if (el('ipStatWorst'))    el('ipStatWorst').textContent    = worst !== null ? fmtPnl(worst) : '—';
    if (el('ipStatSessions')) el('ipStatSessions').textContent = trades.length;
    if (el('ipStatWinRate'))  el('ipStatWinRate').textContent  = trades.length ? winRate.toFixed(0) + '%' : '—';

    // ── Milestone track (nodes with connector lines) ──
    const chips = el('ipMilestoneChips');
    if (chips) {
        const nodes = Array.from({length:11}, (_, i) => {
            const targetDv = entry + (payout - entry) * (i / 10);
            const isGoal   = i === 10;
            const passed   = i > 0 && masterPnl >= reqProfit(i, entry, payout, mult);
            const isCur    = !passed && i > 0 &&
                masterPnl >= reqProfit(i-1, entry, payout, mult) &&
                masterPnl < reqProfit(i, entry, payout, mult);
            const dotCls   = isGoal && passed ? 'goal' : passed ? 'done' : isCur ? 'now' : 'pend';
            const lblCls   = isGoal && passed ? 'goal' : passed ? 'done' : isCur ? 'now' : '';
            const icon     = isGoal ? (passed ? '🏆' : '★') : passed ? '✓' : isCur ? '●' : i === 0 ? '◆' : String(i);
            const lineColor = passed ? 'rgba(46,204,154,0.4)' : 'rgba(255,255,255,0.06)';
            return `<div class="ipv-ms-node" style="min-width:${i === 0 || i === 10 ? 56 : 52}px;">
                ${i < 10 ? `<div class="ipv-ms-line" style="background:${lineColor};"></div>` : ''}
                <div class="ipv-ms-dot ${dotCls}">${icon}</div>
                <div class="ipv-ms-lbl ${lblCls}">${fmtCurrency(targetDv)}</div>
            </div>`;
        });
        chips.innerHTML = nodes.join('');
        if (el('ipMilestonesLabel')) {
            const reached = Array.from({length:11}, (_,i)=>i).filter(i=> i>0 && masterPnl >= reqProfit(i,entry,payout,mult)).length;
            el('ipMilestonesLabel').textContent = `${reached} / 11 checkpoints reached`;
        }
    }

    // ── Equity chart — gradient fill, glowing gold line ──
    const ctx = el('ipEquityChart');
    if (ctx) {
        const sorted  = [...trades].sort((a,b) => new Date(a.trade_date) - new Date(b.trade_date));
        const labels  = ['Start'];
        const dvData  = [entry];
        let cumPnl = 0;
        sorted.forEach(t => {
            cumPnl += parseFloat(t.pnl||0);
            labels.push(t.trade_date);
            dvData.push(ipDisplayValue(entry, payout, cumPnl));
        });
        const benchData = labels.map((_,i) => entry + (payout - entry) * (i / Math.max(labels.length-1,1)));

        if (ipEquityChartObj) { ipEquityChartObj.destroy(); ipEquityChartObj = null; }
        const chartCanvas = ctx.getContext('2d');
        // Gold gradient fill — use canvas actual height
        const canvasHeight = ctx.clientHeight || 230;
        const grad = chartCanvas.createLinearGradient(0, 0, 0, canvasHeight);
        grad.addColorStop(0,   'rgba(240,192,64,0.28)');
        grad.addColorStop(0.5, 'rgba(240,192,64,0.07)');
        grad.addColorStop(1,   'rgba(240,192,64,0)');

        ipEquityChartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Your Value',
                        data: dvData,
                        borderColor: '#f0c040',
                        backgroundColor: grad,
                        fill: true, tension: 0.4,
                        pointRadius: sorted.length > 25 ? 0 : 4,
                        pointBackgroundColor: '#f0c040',
                        pointBorderColor: '#0a1020',
                        pointBorderWidth: 2,
                        borderWidth: 2.5,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Target Path',
                        data: benchData,
                        borderColor: 'rgba(255,255,255,0.15)',
                        backgroundColor: 'transparent',
                        fill: false, tension: 0,
                        pointRadius: 0, borderWidth: 1.5,
                        borderDash: [5, 4],
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeOutQuart' },
                interaction: { mode:'index', intersect:false },
                plugins: {
                    legend: { display:false },
                    tooltip: {
                        backgroundColor: 'rgba(6,11,25,0.97)',
                        borderColor: 'rgba(240,192,64,0.3)',
                        borderWidth: 1,
                        titleColor: 'rgba(255,255,255,0.55)',
                        bodyColor: '#f0c040',
                        padding: 12,
                        cornerRadius: 12,
                        titleFont: { family:'Space Grotesk', weight:'600', size:11 },
                        bodyFont: { family:'JetBrains Mono', size:12 },
                        callbacks: {
                            title: items => items[0].label,
                            label: c => c.dataset.label === 'Target Path' ? null : ` ${fmtCurrency(c.raw)}`
                        }
                    }
                },
                scales: {
                    x: { ticks:{ color:'rgba(255,255,255,0.22)', maxTicksLimit:6, font:{size:10,family:"'JetBrains Mono'"} }, grid:{ color:'rgba(255,255,255,0.04)' }, border:{ display:false } },
                    y: {
                        min: Math.min(entry * 0.97, Math.min(...dvData) * 0.97),
                        max: payout * 1.05,
                        ticks:{ color:'rgba(240,192,64,0.55)', font:{size:10,family:"'JetBrains Mono'"}, callback: v => '$' + v.toFixed(0) },
                        grid:{ color:'rgba(255,255,255,0.04)' },
                        border:{ display:false }
                    }
                }
            }
        });
    }

    // ── Session history ──
    const tBody = el('ipTradeBody');
    const tCount = el('ipTradeCount');
    const tradesSorted = [...trades].sort((a,b) => new Date(b.trade_date)-new Date(a.trade_date));
    if (tCount) tCount.textContent = `${tradesSorted.length} session${tradesSorted.length!==1?'s':''}`;
    if (tBody) {
        if (!tradesSorted.length) {
            tBody.innerHTML = `<div style="text-align:center;padding:2.5rem;color:rgba(255,255,255,0.25);font-size:0.85rem;">No sessions recorded yet.</div>`;
        } else {
            const orderedOldNew = [...trades];
            const runMap = new Map();
            let rp = 0;
            orderedOldNew.forEach(t => { rp += parseFloat(t.pnl||0); runMap.set(t.id||t.trade_date+t.pnl, rp); });
            tBody.innerHTML = tradesSorted.map((t,i) => {
                const pnl    = parseFloat(t.pnl||0);
                const scaled = pnl * mult;
                const runP   = runMap.get(t.id||t.trade_date+t.pnl) ?? 0;
                const runDv  = ipDisplayValue(entry, payout, runP);
                const win    = scaled >= 0;
                const riskLbl = ipRiskLabel(t.risk_template);
                const strategy = riskLbl === 'Base' ? '<span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.6rem;border-radius:10px;font-size:0.7rem;font-weight:700;background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.25);color:#a78bfa;">⚡ Base</span>' : '<span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.6rem;border-radius:10px;font-size:0.7rem;font-weight:700;background:rgba(46,204,154,0.1);border:1px solid rgba(46,204,154,0.25);color:#2ecc9a;">🛡 Conservative</span>';
                const valColor = runDv>=payout?'#f0c040':runDv>entry?'#2ecc9a':runDv>0?'rgba(255,255,255,0.65)':'#f05c6a';
                return `<div style="display:grid;grid-template-columns:36px 1fr auto auto auto;gap:1rem;align-items:center;padding:0.875rem 1.75rem;border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.025)'" onmouseout="this.style.background=''">
                    <span style="font-size:0.7rem;font-weight:700;color:rgba(255,255,255,0.2);font-family:'JetBrains Mono',monospace;">${String(tradesSorted.length-i).padStart(2,'0')}</span>
                    <span style="font-size:0.82rem;color:rgba(255,255,255,0.45);">${t.trade_date}</span>
                    <span>${strategy}</span>
                    <span style="font-family:'JetBrains Mono',monospace;font-size:0.88rem;font-weight:700;color:${win?'#2ecc9a':'#f05c6a'};">${fmtPnl(scaled)}</span>
                    <span style="font-family:'JetBrains Mono',monospace;font-size:0.88rem;font-weight:700;color:${valColor};text-align:right;">${fmtCurrency(runDv)}</span>
                </div>`;
            }).join('');
        }
    }

    // ── Init particles + 3D tilt (once per view) ──
    _ipInitEffects();
}

// Helper to compute required master P&L for milestone i
function reqProfit(i, entry, payout, mult) {
    if (i <= 0) return 0;
    const targetDv = entry + (payout - entry) * (i / 10);
    return (targetDv - entry) / mult;
}

// ── Particle background + 3D tilt initializer (idempotent) ──
let _ipEffectsInit = false;
function _ipInitEffects() {
    // 3D tilt on cards
    document.querySelectorAll('.ip-tilt').forEach(card => {
        if (card._tiltBound) return;
        card._tiltBound = true;
        card.addEventListener('mousemove', e => {
            const r = card.getBoundingClientRect();
            const x = (e.clientX - r.left) / r.width  - 0.5;
            const y = (e.clientY - r.top)  / r.height - 0.5;
            card.style.transform = `perspective(900px) rotateY(${x*8}deg) rotateX(${-y*6}deg) scale(1.01)`;
        });
        card.addEventListener('mouseleave', () => { card.style.transform = ''; });
    });

    if (_ipEffectsInit) return;
    _ipEffectsInit = true;

    // Floating particle canvas
    const canvas = document.getElementById('ipParticleCanvas');
    if (!canvas) return;
    const pc = canvas.getContext('2d');
    let W = canvas.width  = window.innerWidth;
    let H = canvas.height = window.innerHeight;
    window.addEventListener('resize', () => { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; });

    const PARTICLES = 55;
    const pts = Array.from({length:PARTICLES}, () => ({
        x: Math.random()*W, y: Math.random()*H,
        vx: (Math.random()-0.5)*0.35, vy: (Math.random()-0.5)*0.35,
        r: Math.random()*2+0.5,
        a: Math.random()*0.5+0.1,
        c: ['#4a8eff','#a78bfa','#2ecc9a','#f0c040'][Math.floor(Math.random()*4)]
    }));

    function animateParticles() {
        pc.clearRect(0,0,W,H);
        pts.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x<0) p.x=W; if (p.x>W) p.x=0;
            if (p.y<0) p.y=H; if (p.y>H) p.y=0;
            pc.beginPath();
            pc.arc(p.x, p.y, p.r, 0, Math.PI*2);
            pc.fillStyle = p.c + Math.round(p.a*255).toString(16).padStart(2,'0');
            pc.fill();
        });
        // Draw connecting lines between nearby particles
        for (let i=0;i<pts.length;i++) for (let j=i+1;j<pts.length;j++) {
            const dx=pts[i].x-pts[j].x, dy=pts[i].y-pts[j].y;
            const d=Math.sqrt(dx*dx+dy*dy);
            if (d<120) {
                pc.beginPath();
                pc.moveTo(pts[i].x,pts[i].y);
                pc.lineTo(pts[j].x,pts[j].y);
                pc.strokeStyle = `rgba(74,142,255,${(1-d/120)*0.12})`;
                pc.lineWidth = 0.6;
                pc.stroke();
            }
        }
        requestAnimationFrame(animateParticles);
    }
    animateParticles();
    if (el('ipInvProgLeft2')) el('ipInvProgLeft2').textContent = fmtCurrency(entry);
    if (el('ipInvProgRight')) el('ipInvProgRight').textContent = fmtCurrency(payout);
    if (el('ipInvProgFill')) {
        const fill = el('ipInvProgFill');
        fill.style.width      = progPct.toFixed(1) + '%';
        fill.style.background = atGoal
            ? 'linear-gradient(90deg,var(--gold),#ffb700)'
            : 'linear-gradient(90deg,var(--accent),var(--purple))';
    }
    if (el('ipInvProgPct')) el('ipInvProgPct').textContent = atGoal
        ? '🎉 Payout Reached!'
        : progPct.toFixed(1) + '% to payout';

    // ── Stats row (all scaled — Method 2) ──
    const scaledPnls = trades.map(t => parseFloat(t.pnl||0) * mult);
    const wins       = scaledPnls.filter(v => v > 0);
    const best       = scaledPnls.length ? Math.max(...scaledPnls) : null;
    const worst      = scaledPnls.length ? Math.min(...scaledPnls) : null;
    const winRate    = scaledPnls.length ? (wins.length / scaledPnls.length * 100) : 0;
    if (el('ipStatBest'))      el('ipStatBest').textContent      = best  !== null ? fmtPnl(best)  : '—';
    if (el('ipStatWorst'))     el('ipStatWorst').textContent     = worst !== null ? fmtPnl(worst) : '—';
    if (el('ipStatSessions'))  el('ipStatSessions').textContent  = trades.length;
    if (el('ipStatWinRate'))   el('ipStatWinRate').textContent   = trades.length ? winRate.toFixed(0) + '%' : '—';
    if (el('ipStatCycleGain')) {
        const cg = el('ipStatCycleGain');
        cg.textContent = fmtPnl(profit);
        cg.style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // ── Milestone chips — dollar values only ──
    const chips = el('ipMilestoneChips');
    if (chips) {
        chips.innerHTML = Array.from({length:11}, (_, i) => {
            const targetDv   = entry + (payout - entry) * (i / 10);
            const isGoal     = i === 10;
            const passed     = i > 0 && masterPnl >= reqProfit(i, entry, payout, mult);
            const current    = !passed && i > 0 &&
                masterPnl >= reqProfit(i-1, entry, payout, mult) &&
                masterPnl < reqProfit(i, entry, payout, mult);
            const dotCls = isGoal && passed ? 'goal' : passed ? 'done' : current ? 'now' : 'pend';
            const lblCls = isGoal && passed ? 'goal' : passed ? 'done' : current ? 'now' : '';
            const icon = isGoal && passed ? '🏆' : passed ? '✓' : current ? '●' : i === 0 ? '◆' : String(i);
            const lineColor = passed ? 'rgba(46,204,154,0.4)' : 'rgba(255,255,255,0.06)';
            return `<div class="ipv-ms-node" style="min-width:${i === 0 || i === 10 ? 56 : 52}px;">
                ${i < 10 ? `<div class="ipv-ms-line" style="background:${lineColor};"></div>` : ''}
                <div class="ipv-ms-dot ${dotCls}">${icon}</div>
                <div class="ipv-ms-lbl ${lblCls}">${fmtCurrency(targetDv)}</div>
            </div>`;
        }).join('');
    }

    // ── Equity chart — ONE gold line (investor value) + ONE grey dashed benchmark ──
    const ctx = el('ipEquityChart');
    if (ctx) {
        const sorted = [...trades].sort((a,b) => new Date(a.trade_date) - new Date(b.trade_date));
        const labels  = ['Start'];
        const dvData  = [entry];
        let cumPnl = 0;
        sorted.forEach(t => {
            cumPnl += parseFloat(t.pnl||0);
            labels.push(t.trade_date);
            dvData.push(ipDisplayValue(entry, payout, cumPnl));
        });

        // Grey benchmark: straight line from entry to payout across the same # points
        const benchData = labels.map((_, i) =>
            entry + (payout - entry) * (i / Math.max(labels.length - 1, 1))
        );

        if (ipEquityChartObj) { ipEquityChartObj.destroy(); ipEquityChartObj = null; }
        ipEquityChartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Your Account Value',
                        data: dvData,
                        borderColor: '#ffd166',
                        backgroundColor: 'rgba(255,209,102,0.08)',
                        fill: true, tension: 0.35,
                        pointRadius: sorted.length > 20 ? 0 : 3,
                        pointBackgroundColor: '#ffd166',
                        borderWidth: 2.5,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Benchmark Path',
                        data: benchData,
                        borderColor: 'rgba(120,140,180,0.35)',
                        backgroundColor: 'transparent',
                        fill: false, tension: 0,
                        pointRadius: 0,
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#7a8bb5', font:{ size:11 } } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                // Only show investor value, not the benchmark PA info
                                if (ctx.dataset.label === 'Benchmark Path') return null;
                                return ` Your value: ${fmtCurrency(ctx.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks:{ color:'#3d4f78', maxTicksLimit:6, font:{size:10} }, grid:{ color:'rgba(99,179,237,0.05)' } },
                    y: {
                        min: entry * 0.97,   // don't show below entry (hides PA crash math)
                        max: payout * 1.02,
                        ticks:{ color:'#ffd166', font:{size:10}, callback: v => `$${v.toFixed(0)}` },
                        grid:{ color:'rgba(99,179,237,0.06)' }
                    }
                }
            }
        });
    }

    // ── Trade log — investor-safe columns ──
    const tBody = el('ipTradeBody');
    const tCount = el('ipTradeCount');
    const tradesSorted = [...trades].sort((a,b) => new Date(b.trade_date)-new Date(a.trade_date));
    if (tCount) tCount.textContent = `${tradesSorted.length} session${tradesSorted.length !== 1 ? 's' : ''}`;
    if (tBody) {
        if (!tradesSorted.length) {
            tBody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:1.5rem;color:var(--text-muted);">No sessions recorded yet.</td></tr>`;
        } else {
            // Build running investor value map (old→new)
            const orderedOldNew = [...trades];
            const runMap = new Map();
            let rp = 0;
            orderedOldNew.forEach(t => {
                rp += parseFloat(t.pnl||0);
                runMap.set(t.id || t.trade_date + t.pnl, rp);
            });
            tBody.innerHTML = tradesSorted.map((t, i) => {
                const pnl    = parseFloat(t.pnl||0);
                const scaled = pnl * mult;
                const runP   = runMap.get(t.id || t.trade_date + t.pnl) ?? 0;
                const runDv  = ipDisplayValue(entry, payout, runP);
                const riskLbl = ipRiskLabel(t.risk_template);
                const win = scaled >= 0;
                const resultLabel = win ? 'Profitable' : 'Loss';
                const resultColor = win ? 'var(--success)' : 'var(--danger)';
                return `<tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:0.75rem 1.25rem;color:var(--text-dim);font-size:0.78rem;">${tradesSorted.length - i}</td>
                    <td style="padding:0.75rem 1rem;font-size:0.82rem;color:var(--text-muted);">${t.trade_date}</td>
                    <td style="padding:0.75rem 1rem;font-size:0.82rem;font-weight:600;color:${resultColor};">${fmtPnl(scaled)}</td>
                    <td style="padding:0.75rem 1rem;">${ipModeBadgeHtml(riskLbl === 'Base' ? 'base' : 'conservative')}</td>
                    <td style="padding:0.75rem 1rem;text-align:right;font-family:'JetBrains Mono',monospace;font-size:0.85rem;font-weight:700;color:${runDv>=payout?'var(--gold)':runDv>0?'var(--text)':'var(--danger)'};">${fmtCurrency(runDv)}</td>
                </tr>`;
            }).join('');
        }
    }

    // ── Milestone breakdown table — no PA columns ──
    const mBody = el('ipMilestoneBody');
    if (mBody) {
        mBody.innerHTML = Array.from({length:11}, (_, i) => {
            const targetDv  = entry + (payout - entry) * (i / 10);
            const gain      = targetDv - entry;
            const passed    = i > 0 && masterPnl >= reqProfit(i, entry, payout, mult);
            const isCurrent = !passed && i > 0 &&
                masterPnl >= reqProfit(i-1, entry, payout, mult) &&
                masterPnl < reqProfit(i, entry, payout, mult);
            const badge = isCurrent
                ? `<span class="badge badge-success">▶ Here</span>`
                : passed
                ? `<span class="badge badge-active">✓ Done</span>`
                : `<span style="color:var(--text-dim);font-size:0.75rem;">○ Pending</span>`;
            return `<tr>
                <td>${badge}</td>
                <td style="font-size:0.82rem;">#${i+1} checkpoint</td>
                <td style="font-family:'JetBrains Mono',monospace;color:${targetDv>=payout?'var(--gold)':'var(--success)'};">${fmtCurrency(targetDv)}</td>
                <td style="font-family:'JetBrains Mono',monospace;color:${gain>0?'var(--success)':'var(--text-muted)'};">${gain > 0 ? '+' : ''}${fmtCurrency(gain)}</td>
                <td>${i === 10 ? `<span class="badge" style="background:rgba(255,209,102,0.12);color:var(--gold);border:1px solid rgba(255,209,102,0.3);">🏆 Payout</span>` : i === 0 ? `<span style="color:var(--text-dim);font-size:.75rem;">Start</span>` : ''}</td>
            </tr>`;
        }).join('');
    }
}

// ── Auto-urgent notify (level 2+) ──
function ipAutoUrgentNotify(inv) {
    // Create one urgent pending request if none exists yet
    const alreadyUrgent = ipModeRequests.some(r =>
        r.investor_id === inv.id && r.status === 'pending' && r.urgent
    );
    if (alreadyUrgent) return;
    const req = {
        id: crypto.randomUUID(), investor_id: inv.id, user_id: inv.user_id || null,
        current_mode: inv.mode || 'conservative', requested_mode: 'conservative',
        message: `[AUTO] Account reached warning level — mode change recommended.`,
        status: 'pending', urgent: true,
        created_at: new Date().toISOString()
    };
    ipModeRequests.unshift(req);
    try {
        sbClient.from('investor_mode_requests').insert({...req}).then(()=>{});
    } catch(_) {}
    localStorage.setItem('pfp_mode_requests', JSON.stringify(ipModeRequests));
}

// ════════════════════════════════════════════════════════
//  EMAIL REPORT SYSTEM (EmailJS — free, no backend)
//  Setup: https://www.emailjs.com
//  1. Create free account → Add Gmail service
//  2. Create a template with variables below
//  3. Fill in your keys here
// ════════════════════════════════════════════════════════
const EMAILJS_PUBLIC_KEY   = '2HRrFfKcifIKQ10XX';
const EMAILJS_SERVICE_ID   = 'service_i8ib6bt';
const EMAILJS_TEMPLATE_ID  = 'template_qpt1abj';
let _emailjsReady = false;
let _emailScheduleTimer = null;
const EMAIL_SEND_HOUR = 17; // 5:00 PM

// Initialize EmailJS once keys are set
function ipInitEmailJS() {
    if (!EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') return false;
    if (!_emailjsReady) {
        try { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); _emailjsReady = true; } catch(e) { return false; }
    }
    return true;
}

// Build the email report content for an investor
function ipBuildEmailData(inv) {
    const entry   = parseFloat(inv.entry_point)   || 115;
    const payout  = parseFloat(inv.payout_target) || 800;
    const mult    = ipMultiplier(entry, payout);
    const trades  = ipGetAllTradesForAccount(inv.linked_account)
        .sort((a,b) => new Date(a.trade_date) - new Date(b.trade_date));
    const masterPnl = trades.reduce((s,t) => s + parseFloat(t.pnl||0), 0);
    const dv        = ipDisplayValue(entry, payout, masterPnl);
    const profit    = dv - entry;
    const progPct   = Math.min(Math.max((dv - entry) / (payout - entry) * 100, 0), 100);
    const cyclePct  = ipCyclePct(masterPnl);
    const wins      = trades.filter(t => parseFloat(t.pnl||0) * mult > 0);
    const winRate   = trades.length ? (wins.length / trades.length * 100).toFixed(0) : 0;
    const mode      = inv.mode || 'conservative';

    // Today's trades
    const today = new Date().toISOString().split('T')[0];
    const todayTrades = trades.filter(t => t.trade_date === today);
    const todayPnl    = todayTrades.reduce((s,t) => s + parseFloat(t.pnl||0) * mult, 0);
    const todaySessions = todayTrades.length;

    const sign = profit >= 0 ? '+' : '';
    const todaySign = todayPnl >= 0 ? '+' : '';

    return {
        to_email:       inv.email || '',
        to_name:        inv.name  || inv.email?.split('@')[0] || 'Investor',
        report_date:    new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }),
        account_value:  fmtCurrency(dv),
        profit_loss:    `${sign}${fmtCurrency(profit)}`,
        progress_pct:   `${progPct.toFixed(1)}%`,
        cycle_pct:      `${cyclePct >= 0 ? '+' : ''}${cyclePct.toFixed(2)}%`,
        entry_amount:   fmtCurrency(entry),
        target_amount:  fmtCurrency(payout),
        strategy_mode:  mode === 'base' ? '⚡ Base' : '🛡 Conservative',
        total_sessions: trades.length,
        win_rate:       winRate + '%',
        today_pnl:      todaySessions > 0 ? `${todaySign}${fmtCurrency(Math.abs(todayPnl))}` : 'No session today',
        today_sessions: todaySessions,
        status_emoji:   dv >= payout ? '🏆 Payout Reached!' : profit >= 0 ? '📈 Positive' : '📉 Drawdown',
    };
}

// Send report to a single investor
async function ipSendEmailToInvestor(inv) {
    if (!ipInitEmailJS()) {
        throw new Error('EmailJS not configured. Add your keys in the source code.');
    }
    if (!inv.email) throw new Error(`No email for investor: ${inv.name}`);
    const data = ipBuildEmailData(inv);
    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, data);
}

// Send daily report to ALL investors (button click)
async function ipSendDailyReport(silent) {
    if (!ipInitEmailJS()) {
        showAlert('⚠️ Email not configured yet. See setup instructions.', 'error');
        if (!silent) ipShowEmailSetupModal();
        return;
    }
    if (!ipInvestors.length) { showAlert('No investors to email.', 'info'); return; }

    const investorsWithEmail = ipInvestors.filter(i => i.email);
    if (!investorsWithEmail.length) { showAlert('No investor emails found.', 'error'); return; }

    if (!silent) showAlert(`📧 Sending reports to ${investorsWithEmail.length} investor(s)...`, 'info');

    let sent = 0, failed = 0;
    for (const inv of investorsWithEmail) {
        try {
            await ipSendEmailToInvestor(inv);
            sent++;
        } catch(e) {
            console.error('Email failed for', inv.email, e);
            failed++;
        }
    }

    const msg = failed > 0
        ? `📧 ${sent} sent, ${failed} failed.`
        : `✅ Report sent to ${sent} investor${sent !== 1 ? 's' : ''}!`;
    showAlert(msg, sent > 0 ? 'success' : 'error');
    if (!silent) console.log('[EmailJS] Daily report:', { sent, failed, time: new Date().toLocaleTimeString() });
}

// ── 5 PM Auto-Scheduler ──
// Schedules a daily report at EMAIL_SEND_HOUR (5 PM).
// Requires the browser/tab to be open at that time.
function ipStartEmailScheduler() {
    if (_emailScheduleTimer) clearTimeout(_emailScheduleTimer);

    const now = new Date();
    const next5pm = new Date(now);
    next5pm.setHours(EMAIL_SEND_HOUR, 0, 0, 0);
    if (next5pm <= now) next5pm.setDate(next5pm.getDate() + 1); // push to tomorrow if already past

    const msUntil5pm = next5pm - now;
    console.log(`[EmailJS] Auto-report scheduled in ${Math.round(msUntil5pm/60000)} minutes (${next5pm.toLocaleTimeString()})`);

    _emailScheduleTimer = setTimeout(async () => {
        console.log('[EmailJS] Auto-sending daily investor report at 5 PM...');
        await ipSendDailyReport(true); // silent = true
        ipStartEmailScheduler(); // reschedule for next day
    }, msUntil5pm);
}

// ── Email Setup Guide Modal ──
function ipShowEmailSetupModal() {
    const existing = document.getElementById('ipEmailSetupModal');
    if (existing) { existing.style.display = 'flex'; return; }

    const modal = document.createElement('div');
    modal.id = 'ipEmailSetupModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:1.5rem;';
    modal.innerHTML = `
        <div style="background:#0c1525;border:1px solid rgba(74,142,255,0.25);border-radius:24px;padding:2.25rem;width:100%;max-width:500px;box-shadow:0 40px 100px rgba(0,0,0,0.7);">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;">
                <div>
                    <div style="font-size:1.4rem;margin-bottom:0.3rem;">📧 Email Setup</div>
                    <div style="color:rgba(255,255,255,0.4);font-size:0.85rem;">One-time setup — free, no backend needed</div>
                </div>
                <button onclick="document.getElementById('ipEmailSetupModal').style.display='none'" style="background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.4);font-size:1.2rem;">✕</button>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.875rem;font-size:0.85rem;color:rgba(255,255,255,0.65);line-height:1.7;">
                <div style="background:rgba(74,142,255,0.08);border:1px solid rgba(74,142,255,0.2);border-radius:12px;padding:1rem;">
                    <div style="color:#4a8eff;font-weight:700;margin-bottom:0.5rem;">Step 1 — Create free EmailJS account</div>
                    Go to <a href="https://www.emailjs.com" target="_blank" style="color:#4a8eff;">emailjs.com</a> → Sign up free (200 emails/month)
                </div>
                <div style="background:rgba(74,142,255,0.08);border:1px solid rgba(74,142,255,0.2);border-radius:12px;padding:1rem;">
                    <div style="color:#4a8eff;font-weight:700;margin-bottom:0.5rem;">Step 2 — Add Email Service</div>
                    Dashboard → Email Services → Add Service → Connect Gmail or SMTP
                </div>
                <div style="background:rgba(74,142,255,0.08);border:1px solid rgba(74,142,255,0.2);border-radius:12px;padding:1rem;">
                    <div style="color:#4a8eff;font-weight:700;margin-bottom:0.5rem;">Step 3 — Create Email Template</div>
                    Email Templates → Create New. Use these variables:<br>
                    <code style="background:rgba(0,0,0,0.3);padding:0.5rem;border-radius:6px;display:block;margin-top:0.5rem;font-size:0.78rem;color:#f0c040;">
                    {{to_name}}, {{account_value}}, {{profit_loss}},<br>
                    {{progress_pct}}, {{strategy_mode}}, {{win_rate}},<br>
                    {{today_pnl}}, {{report_date}}, {{status_emoji}}
                    </code>
                </div>
                <div style="background:rgba(74,142,255,0.08);border:1px solid rgba(74,142,255,0.2);border-radius:12px;padding:1rem;">
                    <div style="color:#4a8eff;font-weight:700;margin-bottom:0.5rem;">Step 4 — Add your keys to the code</div>
                    Find these lines in the &lt;script&gt; and replace with your keys:
                    <code style="background:rgba(0,0,0,0.3);padding:0.5rem;border-radius:6px;display:block;margin-top:0.5rem;font-size:0.78rem;color:#2ecc9a;">
                    const EMAILJS_PUBLIC_KEY = 'your_key';<br>
                    const EMAILJS_SERVICE_ID = 'service_xxx';<br>
                    const EMAILJS_TEMPLATE_ID = 'template_xxx';
                    </code>
                </div>
            </div>
            <div style="margin-top:1.5rem;display:flex;gap:0.75rem;">
                <a href="https://www.emailjs.com" target="_blank" class="btn btn-primary" style="flex:1;justify-content:center;text-decoration:none;">Open EmailJS →</a>
                <button onclick="document.getElementById('ipEmailSetupModal').style.display='none'" class="btn btn-secondary" style="flex:1;">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ════════════════════════════════════════════════════════
//  INVESTOR VIEW EMAIL BUTTON  (uses keys from admin system above)
// ════════════════════════════════════════════════════════

async function ipSendEmailReport(isAuto = false) {
    const btn = document.getElementById('ipEmailReportBtn');

    if (!ipInitEmailJS()) {
        ipShowEmailFeedback('⚙️ EmailJS not configured yet.', 'warn');
        ipShowEmailSetupModal();
        return;
    }

    const inv = window.currentInvestorRecord;
    if (!inv || !inv.email) { ipShowEmailFeedback('⚠️ No investor email on file.', 'warn'); return; }

    if (btn) { btn.disabled = true; btn.innerHTML = '<span style="animation:spin 0.7s linear infinite;display:inline-block;">↻</span> Sending…'; }

    try {
        await ipSendEmailToInvestor(inv);
        ipShowEmailFeedback(isAuto ? '✅ Auto-report sent at 5 PM!' : '✅ Report sent!', 'ok');
        if (typeof showAlert === 'function') showAlert('✅ Report emailed to ' + (inv.name || inv.email), 'success');
        localStorage.setItem('ip-last-auto-email', new Date().toDateString());
    } catch(err) {
        console.error('EmailJS error:', err);
        ipShowEmailFeedback('✗ Send failed — check keys & template.', 'err');
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<span>📤</span> Send Report Now'; }
    }
}

function ipShowEmailFeedback(msg, type) {
    const el = document.getElementById('ipEmailFeedback');
    if (!el) return;
    const colors = { ok: { bg:'rgba(46,204,154,0.1)', border:'rgba(46,204,154,0.3)', color:'#2ecc9a' },
                     warn: { bg:'rgba(245,166,35,0.1)', border:'rgba(245,166,35,0.3)', color:'#f5a623' },
                     err: { bg:'rgba(240,92,106,0.1)', border:'rgba(240,92,106,0.3)', color:'#f05c6a' } };
    const c = colors[type] || colors.warn;
    el.style.cssText = `display:block;background:${c.bg};border:1px solid ${c.border};color:${c.color};padding:0.45rem 0.625rem;border-radius:8px;font-size:0.7rem;font-weight:600;margin-top:0.6rem;`;
    el.textContent = msg;
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// ─── Auto-email toggle ───
let _autoEmailEnabled = false;
let _autoEmailTimer   = null;

function ipToggleAutoEmail() {
    _autoEmailEnabled = !_autoEmailEnabled;
    const tbtn = document.getElementById('ipAutoToggle');
    const lbl  = document.getElementById('ipAutoEmailStatus');
    if (tbtn) tbtn.classList.toggle('on', _autoEmailEnabled);
    if (lbl)  lbl.textContent = _autoEmailEnabled ? 'Enabled — sends at 5:00 PM' : 'Off — toggle to enable';
    localStorage.setItem('ip-auto-email', _autoEmailEnabled ? '1' : '0');
    if (_autoEmailEnabled) { ipScheduleAutoEmail(); if (typeof showAlert==='function') showAlert('⏰ Auto-send at 5 PM enabled','success'); }
    else { if (_autoEmailTimer) { clearTimeout(_autoEmailTimer); _autoEmailTimer = null; } if (typeof showAlert==='function') showAlert('🔕 Auto-send disabled','info'); }
}

function ipScheduleAutoEmail() {
    if (_autoEmailTimer) clearTimeout(_autoEmailTimer);
    const now = new Date(); const next = new Date(now);
    next.setHours(17,0,0,0);
    if (next <= now) next.setDate(next.getDate()+1);
    _autoEmailTimer = setTimeout(async () => {
        if (localStorage.getItem('ip-last-auto-email') === new Date().toDateString()) return;
        if (_autoEmailEnabled) { await ipSendEmailReport(true); ipScheduleAutoEmail(); }
    }, next - now);
}

window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('ip-auto-email') === '1') {
        _autoEmailEnabled = true;
        const tbtn = document.getElementById('ipAutoToggle');
        const lbl  = document.getElementById('ipAutoEmailStatus');
        if (tbtn) tbtn.classList.add('on');
        if (lbl)  lbl.textContent = 'Enabled — sends at 5:00 PM';
        ipScheduleAutoEmail();
    }
});

// ════════════════════════════════════════════════════════
//  MODE REQUEST MODAL (investor-side)
// ════════════════════════════════════════════════════════
function ipOpenModeModal(preselect) {
    ipSelectedMode = preselect || null;
    document.getElementById('ipModeModal').style.display  = 'flex';
    document.getElementById('ipModeReqMsg').value         = '';
    document.getElementById('ipModeOptCons').className    = 'ip-mode-opt';
    document.getElementById('ipModeOptBase').className    = 'ip-mode-opt';
    if (preselect === 'conservative') ipSelectModeOption('conservative');
    if (preselect === 'base')         ipSelectModeOption('base');
}
function ipCloseModeModal() {
    document.getElementById('ipModeModal').style.display = 'none';
    ipSelectedMode = null;
}
function ipSelectModeOption(mode) {
    ipSelectedMode = mode;
    document.getElementById('ipModeOptCons').className = 'ip-mode-opt' + (mode === 'conservative' ? ' selected-cons' : '');
    document.getElementById('ipModeOptBase').className = 'ip-mode-opt' + (mode === 'base' ? ' selected-base' : '');
}
async function ipSubmitModeRequest() {
    if (!ipSelectedMode) { showAlert('Please select a mode first.', 'error'); return; }
    const myEmail = (currentUser?.email || currentProfile?.email || '').toLowerCase();
    const inv = ipInvestors.find(i => i.email?.toLowerCase() === myEmail);
    if (!inv) { showAlert('Investor profile not found.', 'error'); return; }

    const message = document.getElementById('ipModeReqMsg')?.value.trim() || null;
    const req = {
        id: crypto.randomUUID(),
        investor_id: inv.id,
        user_id: currentUser?.id || null,
        current_mode: inv.mode || 'conservative',
        requested_mode: ipSelectedMode,
        message,
        status: 'pending',
        created_at: new Date().toISOString()
    };
    ipModeRequests.unshift(req);
    try {
        await sbClient.from('investor_mode_requests').insert(req);
    } catch(_) {}
    localStorage.setItem('pfp_mode_requests', JSON.stringify(ipModeRequests));

    ipCloseModeModal();
    ipRenderInvestorView(inv);
    showAlert('✓ Request sent — your account manager will review it shortly.', 'success');
}

// ════════════════════════════════════════════════════════
//  USER SEARCH (admin add form)
// ════════════════════════════════════════════════════════
let ipAllProfilesCache = [];

async function ipLoadProfiles() {
    // Always refresh cache when explicitly called
    try {
        const { data, error } = await sbClient.from('profiles').select('id,username,email,role').order('created_at',{ascending:false});
        if (error) { console.error('ipLoadProfiles error:', error); return; }
        if (data) ipAllProfilesCache = data;
    } catch(e) { console.error('ipLoadProfiles exception:', e); }
}

async function ipSearchUsers() {
    if (!ipAllProfilesCache.length) await ipLoadProfiles();
    const q  = (document.getElementById('ipUserSearch')?.value || '').toLowerCase().trim();
    const dd = document.getElementById('ipUserDropdown');
    if (!dd) return;
    if (!q) { dd.style.display = 'none'; return; }
    const matches = ipAllProfilesCache.filter(p =>
        (p.email||'').toLowerCase().includes(q) || (p.username||'').toLowerCase().includes(q)
    ).slice(0, 8);
    if (!matches.length) {
        dd.style.display = 'block';
        dd.innerHTML = '<div style="padding:0.75rem 1rem;color:var(--text-muted);font-size:0.85rem;">No users found — try different search</div>';
        return;
    }
    dd.style.display = 'block';
    dd.innerHTML = matches.map(p => {
        const hasEmail = p.email && !p.email.startsWith('uid:');
        return `<div class="ip-user-option"
                     data-uid="${(p.id||'').replace(/"/g,'')}"
                     data-email="${(p.email||'').replace(/"/g,'&quot;')}"
                     data-name="${(p.username||p.email||'').replace(/"/g,'&quot;')}"
                     style="padding:0.625rem 1rem;cursor:pointer;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <span>
                <strong style="font-size:0.875rem;">${p.username || '(no username)'}</strong><br>
                <span style="font-size:0.75rem;color:${hasEmail ? 'var(--text-muted)' : 'var(--warning)'};">
                    ${hasEmail ? p.email : '⚠ no email — run Debug Panel → Sync Emails'}
                </span>
            </span>
            <span style="font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:8px;background:var(--bg-elevated);color:var(--text-muted);">${p.role||'user'}</span>
        </div>`;
    }).join('');
    // Attach click handlers via JS (not inline onclick — avoids JSON escaping bugs)
    dd.querySelectorAll('.ip-user-option').forEach(el => {
        el.addEventListener('mouseenter', () => el.style.background = 'var(--bg-hover)');
        el.addEventListener('mouseleave', () => el.style.background = '');
        el.addEventListener('click', () => {
            ipSelectUser(el.dataset.uid, el.dataset.email, el.dataset.name);
        });
    });
}

function ipSelectUser(id, email, name) {
    // email may be empty if not synced yet — store id always
    document.getElementById('ipSelectedUserId').value    = id || '';
    document.getElementById('ipSelectedUserEmail').value = email || '';
    document.getElementById('ipSelectedUserName').value  = name || '';

    const disp = document.getElementById('ipSelectedUser');
    if (disp) {
        const emailDisplay = email
            ? `<span style="color:var(--text-muted);font-size:0.8rem;">(${email})</span>`
            : `<span style="color:var(--warning);font-size:0.8rem;">⚠ no email stored — will use user ID</span>`;
        disp.innerHTML = `<span style="color:var(--text);">✓ <strong>${name||id}</strong> ${emailDisplay}</span>`;
    }
    const search = document.getElementById('ipUserSearch');
    if (search) search.value = name || email || id;
    document.getElementById('ipUserDropdown').style.display = 'none';
    const nameField = document.getElementById('ipNewName');
    if (nameField && !nameField.value) nameField.value = name || '';
    ipPreviewFormula();
}

function ipPreviewFormula() {
    const fp  = document.getElementById('ipFormulaPreview');
    const sel = document.getElementById('ipLinkAccountSelect');
    const accNum = parseInt(sel?.value);
    const entry  = parseFloat(document.getElementById('ipNewEntry')?.value)  || 115;
    const payout = parseFloat(document.getElementById('ipNewPayout')?.value) || 800;
    if (!fp) return;
    fp.style.display = 'flex';
    const mult = ipMultiplier(entry, payout);
    const fm   = document.getElementById('ipFormulaMultiplier');
    const fe   = document.getElementById('ipFormulaEntry');
    const fp2  = document.getElementById('ipFormulaPaPnl');
    const fv   = document.getElementById('ipFormulaCurrentVal');
    if (fm) fm.textContent = mult.toFixed(4);
    if (fe) fe.textContent = fmtCurrency(entry);
    if (accNum && fp2 && fv) {
        const pnl = ipGetAllTradesForAccount(accNum).reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        const dv  = ipDisplayValue(entry, payout, pnl);
        fp2.textContent = fmtCurrency(pnl);
        fv.textContent  = fmtCurrency(dv);
    } else {
        if (fp2) fp2.textContent = '—';
        if (fv)  fv.textContent  = '—';
    }
}

// ── ADD / REMOVE ──
async function ipAddInvestor() {
    let email  = document.getElementById('ipSelectedUserEmail')?.value.trim();
    const uid    = document.getElementById('ipSelectedUserId')?.value.trim();
    const name   = document.getElementById('ipNewName')?.value.trim() || document.getElementById('ipSelectedUserName')?.value.trim();
    const acc    = parseInt(document.getElementById('ipLinkAccountSelect')?.value);
    const entry  = parseFloat(document.getElementById('ipNewEntry')?.value);
    const payout = parseFloat(document.getElementById('ipNewPayout')?.value) || 800;
    const mode   = document.getElementById('ipNewMode')?.value || 'conservative';

    if (!uid && !email) { showAlert('Select a user from the dropdown first', 'error'); return; }
    if (!acc)           { showAlert('Select a linked account number', 'error'); return; }
    if (isNaN(entry) || entry <= 0) { showAlert('Enter a valid entry amount', 'error'); return; }

    // If email is missing but we have uid, try to get it from their profile or auth
    if (!email && uid) {
        const { data: prof } = await sbClient.from('profiles').select('email').eq('id', uid).maybeSingle();
        if (prof?.email && !prof.email.includes('@propfarmpro.app')) {
            email = prof.email;
        } else {
            // Use a placeholder so we can still save — email will sync when user logs in
            showAlert('⚠ This user has no email stored. Run Debug Panel > Sync Emails, or have them log in once. Adding by user ID.', 'error');
            // Still continue — we'll track by uid and set email = empty for now
        }
    }

    const emailToStore = email || `uid:${uid}`; // fallback identifier

    const existing = ipInvestors.findIndex(i =>
        (email && i.email?.toLowerCase() === email.toLowerCase()) ||
        (uid && i.user_id === uid)
    );

    const inv = {
        id: existing >= 0 ? ipInvestors[existing].id : crypto.randomUUID(),
        name: name || email || uid,
        email: emailToStore,
        entry_point: entry,
        payout_target: payout,
        linked_account: acc,
        mode,
        created_at: existing >= 0 ? ipInvestors[existing].created_at : new Date().toISOString()
    };
    if (existing >= 0) ipInvestors[existing] = inv; else ipInvestors.push(inv);

    // Step 1: Update their profile role to investor
    let roleUpdated = false;
    try {
        const profileId = uid;
        if (profileId) {
            const updates = { role: 'investor', approved: true };
            if (email && !email.includes('@propfarmpro.app')) updates.email = email;
            const { error: roleErr } = await sbClient.from('profiles').update(updates).eq('id', profileId);
            if (roleErr) {
                console.error('Role update error:', roleErr);
                showAlert('Warning: could not update role — ' + roleErr.message, 'error');
            } else {
                roleUpdated = true;
            }
        }
    } catch(e) {
        console.error('Role update exception:', e);
    }

    // Step 2: Save investor record to DB
    const saved = await ipSaveInvestors();
    if (!saved) {
        // Remove from local array since DB save failed
        if (existing < 0) ipInvestors.pop();
        return;
    }

    ipClearNewForm();
    ipAllProfilesCache = []; // force refresh next search
    ipRenderAdmin();
    if (typeof loadAdminData === 'function') setTimeout(loadAdminData, 300);

    const roleMsg = roleUpdated ? ' Role → investor ✓' : '';
    showAlert(`✓ ${name||email||uid} added as investor (${mode === 'base' ? '⚡ Base' : '🛡 Conservative'}).${roleMsg}`, 'success');
}

async function ipRemoveInvestor(idx) {
    const inv = ipInvestors[idx];
    if (!confirm(`Remove ${inv.name||inv.email} from the investor portal?`)) return;
    try { await sbClient.from('investor_portal_investors').delete().eq('id', inv.id); } catch(_) {}
    ipInvestors.splice(idx, 1);
    await ipSaveInvestors();
    ipRenderAdmin();
    showAlert(`Removed ${inv.name||inv.email}`, 'success');
}

function ipClearNewForm() {
    ['ipUserSearch','ipNewName'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
    const entry=document.getElementById('ipNewEntry');   if(entry)  entry.value='115';
    const pay  =document.getElementById('ipNewPayout');  if(pay)    pay.value='800';
    const mode =document.getElementById('ipNewMode');    if(mode)   mode.value='conservative';
    ['ipSelectedUserId','ipSelectedUserEmail','ipSelectedUserName'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
    const disp = document.getElementById('ipSelectedUser');
    if (disp) disp.innerHTML = '<span>No user selected</span>';
    const dd = document.getElementById('ipUserDropdown');
    if (dd) dd.style.display = 'none';
    const sel = document.getElementById('ipLinkAccountSelect'); if(sel) sel.value='';
    const fp  = document.getElementById('ipFormulaPreview');    if(fp)  fp.style.display='none';
}

// ── Legacy stubs (prevent errors if called) ──
async function ipSaveMasterAccount() {}
async function ipUpdateProfit()      {}
async function ipSaveProfit()        {}
let ipMasterAccountNum = null;
let ipMasterProfit     = 0;

// ═══════════════════════════════════════════════════════
//  🔧 DEBUG TOOL — call window.debugDashboard() in console
// ═══════════════════════════════════════════════════════
window.debugDashboard = async function() {
    console.group('🔧 PropFarm Pro — Debug Report');

    // 1. Auth
    const { data: { session } } = await sbClient.auth.getSession();
    console.group('1️⃣  Auth / Session');
    console.log('Session active:', !!session);
    console.log('User id:', currentUser?.id || 'none');
    console.log('User email:', currentUser?.email || 'none');
    console.groupEnd();

    // 2. Profile
    console.group('2️⃣  Profile (in memory)');
    console.log('currentProfile:', currentProfile);
    console.log('role:', currentProfile?.role || 'MISSING');
    console.log('approved:', currentProfile?.approved);
    console.groupEnd();

    // 3. Live DB profile
    if (currentUser) {
        console.group('3️⃣  Profile (live from Supabase)');
        const { data: liveProf, error: pe } = await sbClient.from('profiles').select('*').eq('id', currentUser.id).single();
        if (pe) console.error('Profile fetch error:', pe);
        else console.log(liveProf);
        console.groupEnd();
    }

    // 4. Sidebar display
    console.group('4️⃣  Sidebar display');
    console.log('#userRole text:', document.getElementById('userRole')?.textContent);
    console.log('#userRole class:', document.getElementById('userRole')?.className);
    console.log('Admin nav visible:', document.getElementById('adminNavItem')?.style.display);
    console.log('Investor nav visible:', document.getElementById('investorPortalNavItem')?.style.display);
    console.groupEnd();

    // 5. Investor portal
    console.group('5️⃣  Investor portal data');
    console.log('ipInvestors count:', ipInvestors?.length || 0);
    console.log('ipInvestors:', ipInvestors);
    // Try live fetch
    try {
        const { data: ipRows, error: ipe } = await sbClient.from('investor_portal_investors').select('*');
        if (ipe) console.error('investor_portal_investors fetch error:', ipe);
        else console.log('DB rows:', ipRows);
    } catch(e) { console.warn('investor_portal_investors table may not exist yet:', e.message); }
    console.groupEnd();

    // 6. Admin table profiles (if admin)
    if (currentProfile?.role === 'admin') {
        console.group('6️⃣  All profiles (admin view)');
        const { data: allProfs, error: ape } = await sbClient.from('profiles').select('id, username, email, role, approved');
        if (ape) console.error(ape); else console.table(allProfs);
        console.groupEnd();
    }

    console.groupEnd();
    console.log('✅ Debug complete. Check each group above for issues.');
    return '✅ Debug complete — check the console groups above.';
};
console.log('%c🔧 PropFarm Debug ready — run debugDashboard() in console anytime', 'color:#3b7ef8;font-weight:bold;font-size:12px;');

// ── AUTH BUTTON ALIASES (new form uses these) ──
async function authDoLogin() { await handleLogin({ preventDefault: ()=>{} }); }
async function authDoSignup() { await handleSignup({ preventDefault: ()=>{} }); }
async function authDoReset() { await handlePasswordReset({ preventDefault: ()=>{} }); }
async function authDoGoogle() { await handleGoogleAuth(); }



// ═══════════════════════════════════════════════════════
//  FULL DEBUG PANEL — STATE & HELPERS
// ═══════════════════════════════════════════════════════
let _dbgAllProfiles   = [];
let _dbgAllTrades     = [];
let _dbgAllPayouts    = [];
let _dbgAllInvestors  = [];
let _dbgAllModeReqs   = [];
let _dbgLogs          = [];
let _dbgIssues        = 0;
let _dbgFixSelectedId = '';
let _dbgFixSelectedEmail = '';
let _dbgFixSelectedName  = '';
let _dbgLogCurrentFilter = 'all';

function openDebugPanel()  { document.getElementById('debugPanelOverlay').style.display='block'; document.body.style.overflow='hidden'; }
function closeDebugPanel() { document.getElementById('debugPanelOverlay').style.display='none'; document.body.style.overflow=''; }

function dbgShowTab(tab) {
    document.querySelectorAll('.dbg-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.querySelectorAll('.dbg-tab-panel').forEach(p => p.style.display = p.id === 'dbgTab_' + tab ? '' : 'none');
}

function dbgLog(msg, type) {
    _dbgLogs.push({ msg: String(msg), type: type || 'dim', ts: new Date().toLocaleTimeString() });
    if (type === 'err' || type === 'warn') _dbgIssues++;
    dbgRenderLog();
}
function dbgRenderLog() {
    const el = document.getElementById('dbgFullLog');
    const cnt = document.getElementById('dbgLogCountEl');
    if (!el) return;
    const filter = _dbgLogCurrentFilter;
    const visible = filter === 'all' ? _dbgLogs : _dbgLogs.filter(l => l.type === filter);
    el.innerHTML = visible.length ? visible.map(l =>
        `<div class="dl-${l.type}" style="${l.type==='err'?'background:rgba(240,92,106,0.06);padding:0 4px;border-radius:3px;':''}">`+
        `<span style="color:#3d4f78;margin-right:0.5rem;">[${l.ts}]</span>${esc(l.msg)}</div>`
    ).join('') : '<span style="color:#3d4f78;">No entries for this filter.</span>';
    el.scrollTop = el.scrollHeight;
    if (cnt) cnt.textContent = visible.length + ' / ' + _dbgLogs.length + ' entries';
}
function dbgLogFilter(f) {
    _dbgLogCurrentFilter = f;
    document.querySelectorAll('.dbg-log-filter').forEach(b => b.classList.toggle('active', b.dataset.f === f));
    dbgRenderLog();
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function dCard(id, val, state) {
    const el = document.getElementById('dsc_'+id); const v = document.getElementById('dscv_'+id);
    if (el) { el.className = 'dsc' + (state ? ' '+state : ''); }
    if (v)  { v.textContent = val; v.style.color = state==='ok'?'#22d3a0':state==='err'?'#f05c6a':state==='warn'?'#f5a623':'#e8f0ff'; }
}
function dbgResult(elId, lines) {
    const el = document.getElementById(elId);
    if (el) el.innerHTML = lines.map(l => `<div class="dl-${l[1]||'dim'}">${esc(l[0])}</div>`).join('');
}

function dbgClearAll() {
    _dbgLogs = []; _dbgIssues = 0; dbgRenderLog();
    document.getElementById('dbgFullLog').innerHTML = '<span style="color:#3d4f78;">Cleared.</span>';
    document.getElementById('dbgLogCountEl').textContent = '';
    ['auth','role','profile','db','users','trades','investors','issues'].forEach(id => dCard(id,'—',''));
    document.getElementById('dbgOverviewResults').innerHTML = 'Click "Run All Tests" to see results...';
    ['dbgAuthInfo','dbgProfileInfo','dbgAuthTests','dbgTablesInfo','dbgConfigInfo','dbgRLSTests',
     'dbgTradesPerUser','dbgInvestorRecords','dbgInvestorMismatch'].forEach(id => {
        const e = document.getElementById(id); if(e) e.innerHTML = 'Run tests to load...';
    });
}

// ═══════════════════════════════════════════════════════
//  RUN ALL TESTS
// ═══════════════════════════════════════════════════════
async function dbgRunAll() {
    dbgClearAll();
    _dbgIssues = 0;
    const btn  = document.getElementById('dbgRunAllBtn');
    const spin = document.getElementById('dbgRunAllSpinner');
    if (btn)  btn.disabled = true;
    if (spin) spin.style.display = '';

    dbgLog('════════════════════════════════════════════', 'dim');
    dbgLog('  PROP FARM PRO — FULL DIAGNOSTIC', 'head');
    dbgLog('  ' + new Date().toLocaleString(), 'dim');
    dbgLog('════════════════════════════════════════════', 'dim');

    await dbgTestAuth();
    await dbgTestDatabase();
    await dbgLoadAllData();
    await dbgTestUsers();
    await dbgTestTrades();
    await dbgTestInvestorData();
    await dbgTestRLSPolicies();

    // Summary
    dCard('issues', _dbgIssues === 0 ? 'None ✓' : _dbgIssues + ' found', _dbgIssues === 0 ? 'ok' : 'err');
    const passCount = _dbgLogs.filter(l => l.type === 'ok').length;
    const errCount  = _dbgLogs.filter(l => l.type === 'err').length;
    const warnCount = _dbgLogs.filter(l => l.type === 'warn').length;
    document.getElementById('dbgOverviewResults').innerHTML =
        `<div class="dl-ok">✓ ${passCount} checks passed</div>` +
        (errCount  ? `<div class="dl-err">✗ ${errCount} errors</div>` : '') +
        (warnCount ? `<div class="dl-warn">⚠ ${warnCount} warnings</div>` : '') +
        `<div class="dl-dim">── Run individual tabs for details ──</div>`;

    dbgLog('', 'dim');
    dbgLog('  DIAGNOSTIC COMPLETE — ' + passCount + ' pass, ' + errCount + ' errors, ' + warnCount + ' warnings', errCount > 0 ? 'err' : warnCount > 0 ? 'warn' : 'ok');

    if (btn)  btn.disabled = false;
    if (spin) spin.style.display = 'none';
}

// ═══════════════════════════════════════════════════════
//  1. AUTH TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestAuth() {
    dbgLog('', 'dim');
    dbgLog('[ AUTH & SESSION ]', 'head');
    const lines = [];
    try {
        const { data: { session }, error } = await sbClient.auth.getSession();
        if (error) { dbgLog('✗ getSession() error: ' + error.message, 'err'); dCard('auth','Error','err'); return; }

        if (!session) {
            dbgLog('✗ No active session', 'err'); dCard('auth','None','err'); return;
        }
        dCard('auth','Active','ok');
        dbgLog('✓ Session active', 'ok');

        const u = session.user;
        const authEmail = u.email || '(none)';
        const provider = u.app_metadata?.provider || 'email';
        const expiry = new Date(session.expires_at * 1000);
        const expiresIn = Math.round((expiry - Date.now()) / 60000);

        dbgLog('  User ID   : ' + u.id, 'dim');
        dbgLog('  Auth email: ' + authEmail + (u.email ? '' : ' ⚠ MISSING'), u.email ? 'ok' : 'warn');
        dbgLog('  Provider  : ' + provider, 'info');
        dbgLog('  Expires   : ' + expiry.toLocaleString() + ' (' + expiresIn + ' min)', expiresIn < 60 ? 'warn' : 'ok');

        lines.push(['User ID: ' + u.id, 'dim']);
        lines.push(['Auth email: ' + authEmail, u.email ? 'ok' : 'err']);
        lines.push(['Provider: ' + provider, 'info']);
        lines.push(['Session expires: ' + expiry.toLocaleString(), expiresIn < 60 ? 'warn' : 'ok']);

        // Profile
        dbgLog('', 'dim');
        dbgLog('[ PROFILE (in memory) ]', 'head');
        if (!currentProfile) {
            dbgLog('✗ currentProfile is null — profile never loaded', 'err');
            dCard('role','null','err'); dCard('profile','null','err');
            lines.push(['currentProfile: null', 'err']);
        } else {
            const role = currentProfile.role || 'MISSING';
            const approved = currentProfile.approved;
            const emailInProfile = currentProfile.email;

            dCard('role', role, role === 'admin' ? 'ok' : role === 'investor' ? 'warn' : 'ok');
            dCard('profile', currentProfile.username || u.id.slice(0,8), 'ok');

            dbgLog('✓ Profile loaded', 'ok');
            dbgLog('  username : ' + (currentProfile.username || '(none)'), 'dim');
            dbgLog('  role     : ' + role, role === 'user' || role === 'admin' || role === 'investor' ? 'ok' : 'err');
            dbgLog('  approved : ' + approved, approved ? 'ok' : 'err');
            dbgLog('  email    : ' + (emailInProfile || '⚠ MISSING — role lookups will fail!'), emailInProfile ? 'ok' : 'warn');
            dbgLog('  onboarded: ' + currentProfile.onboarded, 'dim');

            if (!emailInProfile) {
                dbgLog('  → FIX: Go to Quick Fixes tab → Sync Missing Emails', 'warn');
            }
            if (!approved && role !== 'admin') {
                dbgLog('  → FIX: User not approved — go to Quick Fixes → Approve All Pending', 'warn');
            }
            lines.push(['role: ' + role, 'info']);
            lines.push(['email in profile: ' + (emailInProfile || 'MISSING'), emailInProfile ? 'ok' : 'err']);
            lines.push(['approved: ' + approved, approved ? 'ok' : 'err']);
        }

        // Nav state
        dbgLog('', 'dim');
        dbgLog('[ NAV STATE ]', 'head');
        const adminNavVis  = document.getElementById('adminNavItem')?.style.display !== 'none';
        const invNavVis    = document.getElementById('investorNavSection')?.style.display !== 'none';
        const traderVis    = document.getElementById('traderNavMain')?.style.display !== 'none';
        const bodyInvestor = document.body.classList.contains('role-investor');
        dbgLog('  Admin nav  : ' + (adminNavVis ? 'visible' : 'hidden'), 'dim');
        dbgLog('  Investor nav: ' + (invNavVis ? 'visible' : 'hidden'), 'dim');
        dbgLog('  Trader nav : ' + (traderVis ? 'visible' : 'hidden'), 'dim');
        dbgLog('  body.role-investor: ' + bodyInvestor, 'dim');
        if (currentProfile?.role === 'investor' && traderVis) {
            dbgLog('  ✗ INVESTOR CAN SEE TRADER NAV — role guard not working', 'err');
        }
        if (currentProfile?.role === 'admin' && !adminNavVis) {
            dbgLog('  ✗ ADMIN NAV HIDDEN for admin user', 'err');
        }

        dbgResult('dbgAuthInfo', lines);
        dbgResult('dbgProfileInfo', [
            ['id: ' + u.id, 'dim'],
            ['username: ' + (currentProfile?.username||'—'), 'dim'],
            ['role: ' + (currentProfile?.role||'—'), 'info'],
            ['email (profile): ' + (currentProfile?.email||'MISSING'), currentProfile?.email ? 'ok' : 'err'],
            ['approved: ' + (currentProfile?.approved), currentProfile?.approved ? 'ok' : 'err'],
            ['onboarded: ' + (currentProfile?.onboarded||false), 'dim'],
            ['account_goal: ' + (currentProfile?.account_goal||'—'), 'dim'],
        ]);
        dbgResult('dbgAuthTests', [
            ['✓ Session active', 'ok'],
            [u.email ? '✓ Auth email present' : '✗ Auth email missing', u.email ? 'ok' : 'err'],
            [currentProfile ? '✓ Profile loaded' : '✗ Profile null', currentProfile ? 'ok' : 'err'],
            [currentProfile?.email ? '✓ Email in profile' : '✗ Email missing from profile (role lookups fail)', currentProfile?.email ? 'ok' : 'err'],
            [currentProfile?.approved ? '✓ Approved' : '✗ Not approved', currentProfile?.approved ? 'ok' : 'err'],
            [currentProfile?.role ? '✓ Role set: ' + currentProfile.role : '✗ No role', currentProfile?.role ? 'ok' : 'err'],
        ]);
    } catch(e) {
        dbgLog('✗ Auth test exception: ' + e.message, 'err');
        dCard('auth','Error','err');
    }
}

// ═══════════════════════════════════════════════════════
//  2. DATABASE TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestDatabase() {
    dbgLog('', 'dim');
    dbgLog('[ DATABASE & TABLES ]', 'head');

    const url  = document.getElementById('supabaseUrl')?.value  || window._SUPA_URL  || '(not found)';
    const key  = document.getElementById('supabaseKey')?.value  || window._SUPA_KEY  || '(not found)';
    const urlOk = url.includes('supabase.co');
    dbgLog('  URL : ' + (url.length > 40 ? url.slice(0,40)+'...' : url), urlOk ? 'ok' : 'err');
    dbgLog('  Key : ' + (key.length > 20 ? key.slice(0,20)+'...' : key), key.length > 10 ? 'ok' : 'err');
    dbgResult('dbgConfigInfo', [
        ['Supabase URL: ' + (urlOk ? '✓ valid' : '✗ ' + url), urlOk ? 'ok' : 'err'],
        ['Anon Key: ' + (key.length > 10 ? '✓ present (' + key.length + ' chars)' : '✗ missing/short'), key.length > 10 ? 'ok' : 'err'],
        ['sbClient: ' + (sbClient ? '✓ initialized' : '✗ null'), sbClient ? 'ok' : 'err'],
    ]);

    const tables = ['profiles', 'trades', 'payouts', 'investor_portal_investors', 'investor_mode_requests'];
    const tableLines = [];
    let dbOk = true;

    for (const tbl of tables) {
        try {
            const { data, error } = await sbClient.from(tbl).select('id').limit(1);
            if (error) {
                dbgLog('✗ Table "' + tbl + '": ' + error.message, 'err');
                tableLines.push(['✗ ' + tbl + ' — ' + error.message, 'err']);
                dbOk = false;
            } else {
                dbgLog('✓ Table "' + tbl + '" accessible', 'ok');
                tableLines.push(['✓ ' + tbl, 'ok']);
            }
        } catch(e) {
            dbgLog('✗ Table "' + tbl + '" error: ' + e.message, 'err');
            tableLines.push(['✗ ' + tbl + ' — exception: ' + e.message, 'err']);
            dbOk = false;
        }
    }
    dCard('db', dbOk ? 'Connected' : 'Errors', dbOk ? 'ok' : 'err');
    dbgResult('dbgTablesInfo', tableLines);
}

// ═══════════════════════════════════════════════════════
//  3. LOAD ALL DATA
// ═══════════════════════════════════════════════════════
async function dbgLoadAllData() {
    dbgLog('', 'dim');
    dbgLog('[ LOADING ALL DATA ]', 'head');
    try {
        const [pr, tr, py, iv, mr] = await Promise.all([
            sbClient.from('profiles').select('*').order('created_at', {ascending:false}),
            sbClient.from('trades').select('*'),
            sbClient.from('payouts').select('*'),
            sbClient.from('investor_portal_investors').select('*'),
            sbClient.from('investor_mode_requests').select('*'),
        ]);
        _dbgAllProfiles  = pr.data || [];
        _dbgAllTrades    = tr.data || [];
        _dbgAllPayouts   = py.data || [];
        _dbgAllInvestors = iv.data || [];
        _dbgAllModeReqs  = mr.data || [];

        dbgLog('  Profiles : ' + _dbgAllProfiles.length, 'ok');
        dbgLog('  Trades   : ' + _dbgAllTrades.length, 'ok');
        dbgLog('  Payouts  : ' + _dbgAllPayouts.length, 'ok');
        dbgLog('  Investors: ' + _dbgAllInvestors.length, 'ok');
        dbgLog('  Mode Reqs: ' + _dbgAllModeReqs.length, 'ok');

        dCard('users',     _dbgAllProfiles.length, 'ok');
        dCard('trades',    _dbgAllTrades.length, 'ok');
        dCard('investors', _dbgAllInvestors.length, _dbgAllInvestors.length > 0 ? 'ok' : 'warn');
    } catch(e) {
        dbgLog('✗ Data load error: ' + e.message, 'err');
    }
}

// ═══════════════════════════════════════════════════════
//  4. USER TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestUsers() {
    dbgLog('', 'dim');
    dbgLog('[ USER AUDIT ]', 'head');
    const missingEmail    = _dbgAllProfiles.filter(p => !p.email || p.email.includes('@propfarmpro.app'));
    const pending         = _dbgAllProfiles.filter(p => !p.approved && p.role !== 'admin');
    const noRole          = _dbgAllProfiles.filter(p => !p.role);
    const investors       = _dbgAllProfiles.filter(p => p.role === 'investor');
    const admins          = _dbgAllProfiles.filter(p => p.role === 'admin');

    dbgLog('  Total users      : ' + _dbgAllProfiles.length, 'ok');
    dbgLog('  Admins           : ' + admins.length, admins.length > 0 ? 'ok' : 'warn');
    dbgLog('  Investors        : ' + investors.length, 'info');
    dbgLog('  Pending approval : ' + pending.length, pending.length > 0 ? 'warn' : 'ok');
    dbgLog('  Missing email    : ' + missingEmail.length + (missingEmail.length > 0 ? ' ← RUN SYNC EMAILS FIX' : ''), missingEmail.length > 0 ? 'warn' : 'ok');
    dbgLog('  No role set      : ' + noRole.length, noRole.length > 0 ? 'warn' : 'ok');

    if (admins.length === 0) dbgLog('  ⚠ NO ADMIN FOUND — go to Quick Fixes and set your role to admin', 'err');
    if (missingEmail.length > 0) dbgLog('  → ' + missingEmail.map(p=>p.username||p.id.slice(0,8)).join(', '), 'warn');

    dbgRenderUsersTable(_dbgAllProfiles);
}

function dbgRenderUsersTable(profiles) {
    const tbody = document.getElementById('dbgUsersBody');
    if (!tbody) return;
    const tradeCounts = {};
    _dbgAllTrades.forEach(t => { tradeCounts[t.user_id] = (tradeCounts[t.user_id]||0) + 1; });

    if (!profiles.length) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:#7a8bb5;">No profiles found</td></tr>';
        return;
    }

    tbody.innerHTML = profiles.map(p => {
        const emailOk = p.email && !p.email.includes('@propfarmpro.app');
        const roleColor = p.role === 'admin' ? '#ffd166' : p.role === 'investor' ? '#9b6ffa' : '#7a8bb5';
        const tc = tradeCounts[p.id] || 0;
        const created = p.created_at ? new Date(p.created_at).toLocaleDateString() : '—';
        return `<tr style="${!emailOk ? 'background:rgba(245,166,35,0.04);' : ''}">
            <td class="dtd"><strong>${esc(p.username||'(none)')}</strong></td>
            <td class="dtd" style="font-size:0.72rem;font-family:'JetBrains Mono',monospace;color:${emailOk?'#7a8bb5':'#f5a623'};">${esc(p.email||'⚠ missing')}</td>
            <td class="dtd" style="color:${roleColor};font-weight:700;">${p.role||'user'}</td>
            <td class="dtd" style="color:${p.approved?'#22d3a0':'#f05c6a'};">${p.approved ? '✓' : '✗ pending'}</td>
            <td class="dtd">${emailOk ? '<span style="color:#22d3a0;">✓</span>' : '<span style="color:#f5a623;">⚠</span>'}</td>
            <td class="dtd" style="font-family:'JetBrains Mono',monospace;">${tc}</td>
            <td class="dtd">${p.onboarded ? '✓' : '—'}</td>
            <td class="dtd" style="font-size:0.7rem;color:#7a8bb5;">${created}</td>
            <td class="dtd">
                <div style="display:flex;gap:0.2rem;flex-wrap:wrap;">
                    <button onclick="dbgQuickRole('${p.id}','investor','${(p.email||'').replace(/'/g,'')}')" style="background:#9b6ffa22;border:1px solid #9b6ffa44;border-radius:4px;padding:0.15rem 0.4rem;color:#9b6ffa;font-size:0.68rem;cursor:pointer;">💼</button>
                    <button onclick="dbgQuickRole('${p.id}','admin','${(p.email||'').replace(/'/g,'')}')"    style="background:#ffd16622;border:1px solid #ffd16644;border-radius:4px;padding:0.15rem 0.4rem;color:#ffd166;font-size:0.68rem;cursor:pointer;">👑</button>
                    <button onclick="dbgQuickRole('${p.id}','user','${(p.email||'').replace(/'/g,'')}')"    style="background:#1a2035;border:1px solid rgba(99,179,237,0.2);border-radius:4px;padding:0.15rem 0.4rem;color:#7a8bb5;font-size:0.68rem;cursor:pointer;">👤</button>
                    ${!emailOk ? `<button onclick="dbgSyncOneEmail('${p.id}')" style="background:#f5a62322;border:1px solid #f5a62344;border-radius:4px;padding:0.15rem 0.4rem;color:#f5a623;font-size:0.68rem;cursor:pointer;">📧</button>` : ''}
                    ${!p.approved ? `<button onclick="dbgApproveOne('${p.id}')" style="background:#22d3a022;border:1px solid #22d3a044;border-radius:4px;padding:0.15rem 0.4rem;color:#22d3a0;font-size:0.68rem;cursor:pointer;">✓ approve</button>` : ''}
                </div>
            </td>
        </tr>`;
    }).join('');
    document.getElementById('dbgUserCount').textContent = profiles.length + ' users';
}

function dbgLoadUsers() { dbgLoadAllData().then(() => dbgRenderUsersTable(_dbgAllProfiles)); }

function dbgFilterUsers() {
    const q   = (document.getElementById('dbgUserFilter')?.value||'').toLowerCase();
    const role = document.getElementById('dbgRoleFilter')?.value||'';
    const app  = document.getElementById('dbgApprovedFilter')?.value||'';
    let list = _dbgAllProfiles;
    if (q)    list = list.filter(p => (p.username||'').toLowerCase().includes(q)||(p.email||'').toLowerCase().includes(q));
    if (role) list = list.filter(p => (p.role||'user') === role);
    if (app === 'approved') list = list.filter(p => p.approved);
    if (app === 'pending')  list = list.filter(p => !p.approved && p.role !== 'admin');
    dbgRenderUsersTable(list);
}

// ═══════════════════════════════════════════════════════
//  5. TRADE TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestTrades() {
    dbgLog('', 'dim');
    dbgLog('[ TRADE DATA ]', 'head');
    const totalPnl = _dbgAllTrades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
    const myTrades = _dbgAllTrades.filter(t => t.user_id === currentUser?.id);
    dbgLog('  Total trades : ' + _dbgAllTrades.length, 'ok');
    dbgLog('  Total P&L    : $' + totalPnl.toFixed(2), totalPnl >= 0 ? 'ok' : 'warn');
    dbgLog('  Total payouts: ' + _dbgAllPayouts.length, 'ok');
    dbgLog('  My trades    : ' + myTrades.length, 'ok');

    const el = document.getElementById('dbgTotalTrades');  if(el) el.textContent = _dbgAllTrades.length;
    const ep = document.getElementById('dbgTotalPnl');     if(ep) ep.textContent = '$' + totalPnl.toFixed(2);
    const epay = document.getElementById('dbgTotalPayouts'); if(epay) epay.textContent = _dbgAllPayouts.length;
    const em = document.getElementById('dbgMyTrades');     if(em) em.textContent = myTrades.length;

    // Per-user breakdown
    const byUser = {};
    _dbgAllTrades.forEach(t => { if(!byUser[t.user_id]) byUser[t.user_id] = 0; byUser[t.user_id]++; });
    const sorted = Object.entries(byUser).sort((a,b)=>b[1]-a[1]).slice(0,20);
    const lines = sorted.map(([uid, cnt]) => {
        const p = _dbgAllProfiles.find(x => x.id === uid);
        return ['  ' + (p?.username||uid.slice(0,8)).padEnd(20) + ' : ' + cnt + ' trades', 'dim'];
    });
    dbgResult('dbgTradesPerUser', lines.length ? lines : [['No trades found','warn']]);
}

async function dbgTestTradeWrite() {
    const el = document.getElementById('dbgTradeWriteResult');
    el.innerHTML = '<span style="color:#7a8bb5;">Running...</span>';
    const lines = [];
    const testId = crypto.randomUUID();
    try {
        // INSERT
        const { error: ie } = await sbClient.from('trades').insert([{
            id: testId, user_id: currentUser.id, trade_date: '2000-01-01',
            cycle: 99, account: 'DEBUG', pnl: 0.01, notes: '__DBG_TEST__', no_trade_day: false
        }]);
        if (ie) { lines.push(['✗ INSERT failed: '+ie.message,'err']); dbgResult('dbgTradeWriteResult',lines); return; }
        lines.push(['✓ INSERT ok','ok']);
        // SELECT
        const { data, error: se } = await sbClient.from('trades').select('id').eq('id',testId).single();
        lines.push(se ? ['✗ SELECT failed: '+se.message,'err'] : ['✓ SELECT ok — found id: '+data.id.slice(0,12)+'...','ok']);
        // DELETE
        const { error: de } = await sbClient.from('trades').delete().eq('id',testId);
        lines.push(de ? ['✗ DELETE failed: '+de.message,'err'] : ['✓ DELETE ok','ok']);
    } catch(e) { lines.push(['✗ Exception: '+e.message,'err']); }
    dbgResult('dbgTradeWriteResult', lines);
    lines.forEach(l => dbgLog('  Trade write test: ' + l[0], l[1]));
}

async function dbgTestPayoutWrite() {
    const el = document.getElementById('dbgPayoutWriteResult');
    el.innerHTML = '<span style="color:#7a8bb5;">Running...</span>';
    const lines = [];
    const testId = crypto.randomUUID();
    try {
        const { error: ie } = await sbClient.from('payouts').insert([{
            id: testId, user_id: currentUser.id, payout_date: '2000-01-01',
            payout_type: '__DBG_TEST__', amount: 0.01
        }]);
        if (ie) { lines.push(['✗ INSERT failed: '+ie.message,'err']); dbgResult('dbgPayoutWriteResult',lines); return; }
        lines.push(['✓ INSERT ok','ok']);
        const { data, error: se } = await sbClient.from('payouts').select('id').eq('id',testId).single();
        lines.push(se ? ['✗ SELECT failed: '+se.message,'err'] : ['✓ SELECT ok','ok']);
        const { error: de } = await sbClient.from('payouts').delete().eq('id',testId);
        lines.push(de ? ['✗ DELETE failed: '+de.message,'err'] : ['✓ DELETE ok','ok']);
    } catch(e) { lines.push(['✗ Exception: '+e.message,'err']); }
    dbgResult('dbgPayoutWriteResult', lines);
}

// ═══════════════════════════════════════════════════════
//  6. INVESTOR DATA TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestInvestorData() {
    dbgLog('', 'dim');
    dbgLog('[ INVESTOR PORTAL ]', 'head');
    const pending = _dbgAllModeReqs.filter(r => r.status === 'pending');
    dbgLog('  Investor records : ' + _dbgAllInvestors.length, _dbgAllInvestors.length >= 0 ? 'ok' : 'warn');
    dbgLog('  Mode requests    : ' + _dbgAllModeReqs.length, 'ok');
    dbgLog('  Pending requests : ' + pending.length, pending.length > 0 ? 'warn' : 'ok');

    // Check role mismatches
    let mismatches = 0;
    const mismatchLines = [];
    for (const inv of _dbgAllInvestors) {
        const prof = _dbgAllProfiles.find(p => p.email?.toLowerCase() === inv.email?.toLowerCase());
        if (prof && prof.role !== 'investor' && prof.role !== 'admin') {
            mismatches++;
            dbgLog('  ✗ Role mismatch: ' + (inv.name||inv.email) + ' is in portal but profile role = "' + prof.role + '"', 'err');
            mismatchLines.push({inv, prof});
        }
        if (!prof && inv.email) {
            dbgLog('  ⚠ No profile found for investor email: ' + inv.email, 'warn');
        }
    }
    if (mismatches === 0) dbgLog('  ✓ No role mismatches', 'ok');

    // Render investor records
    const recEl = document.getElementById('dbgInvestorRecords');
    if (recEl) {
        if (!_dbgAllInvestors.length) {
            recEl.innerHTML = '<div class="dl-warn">No investor records yet.</div>';
        } else {
            recEl.innerHTML = _dbgAllInvestors.map(inv => {
                const prof = _dbgAllProfiles.find(p => p.email?.toLowerCase() === inv.email?.toLowerCase());
                const roleOk = prof && (prof.role === 'investor' || prof.role === 'admin');
                return `<div style="padding:0.5rem 0;border-bottom:1px solid rgba(99,179,237,0.08);">` +
                    `<span class="dl-${roleOk?'ok':'err'}">${roleOk?'✓':'✗'}</span> ` +
                    `<strong>${esc(inv.name||'—')}</strong> ` +
                    `<span style="color:#7a8bb5;font-size:0.72rem;">${esc(inv.email||'no email')}</span> ` +
                    `Mode: <span style="color:#9b6ffa;">${inv.mode}</span> ` +
                    `Acct: #${inv.linked_account||'—'} ` +
                    `Entry: $${inv.entry_point} ` +
                    (prof ? `Profile role: <span style="color:${roleOk?'#22d3a0':'#f05c6a'}">${prof.role}</span>` : '<span style="color:#f5a623;">⚠ no profile match</span>') +
                    `</div>`;
            }).join('');
        }
    }

    // Mismatch summary
    const mmEl = document.getElementById('dbgInvestorMismatch');
    if (mmEl) {
        if (mismatchLines.length === 0) {
            mmEl.innerHTML = '<span class="dl-ok">✓ All investor roles match their portal records.</span>';
        } else {
            mmEl.innerHTML = mismatchLines.map(({inv, prof}) =>
                `<div style="margin-bottom:0.5rem;padding:0.5rem;background:rgba(240,92,106,0.06);border-radius:6px;">
                    <span class="dl-err">✗ ${esc(inv.name||inv.email)}</span> — in portal but profile role = "${prof.role}"
                    <button onclick="dbgQuickRole('${prof.id}','investor','${(prof.email||'').replace(/'/g,'')}')" style="margin-left:0.5rem;background:#9b6ffa22;border:1px solid #9b6ffa44;border-radius:4px;padding:0.15rem 0.5rem;color:#9b6ffa;font-size:0.72rem;cursor:pointer;">Fix → investor</button>
                </div>`
            ).join('');
        }
    }
}

async function dbgTestInvestorWrite() {
    const el = document.getElementById('dbgInvestorWriteResult');
    el.innerHTML = '<span style="color:#7a8bb5;">Running...</span>';
    const lines = [];
    const testId = crypto.randomUUID();
    try {
        const { error: ie } = await sbClient.from('investor_portal_investors').insert([{
            id: testId, name: '__DBG_TEST__', email: 'debug_test@propfarmpro.app',
            entry_point: 1, payout_target: 1, mode: 'conservative'
        }]);
        if (ie) { lines.push(['✗ INSERT failed: '+ie.message+' (check RLS — admin insert policy needed)','err']); dbgResult('dbgInvestorWriteResult',lines); return; }
        lines.push(['✓ INSERT ok','ok']);
        const { data, error: se } = await sbClient.from('investor_portal_investors').select('id').eq('id',testId).single();
        lines.push(se ? ['✗ SELECT failed: '+se.message,'err'] : ['✓ SELECT ok','ok']);
        const { error: ue } = await sbClient.from('investor_portal_investors').update({name:'__DBG_TEST_UPDATE__'}).eq('id',testId);
        lines.push(ue ? ['✗ UPDATE failed: '+ue.message,'err'] : ['✓ UPDATE ok','ok']);
        const { error: de } = await sbClient.from('investor_portal_investors').delete().eq('id',testId);
        lines.push(de ? ['✗ DELETE failed: '+de.message,'err'] : ['✓ DELETE ok','ok']);
    } catch(e) { lines.push(['✗ Exception: '+e.message,'err']); }
    dbgResult('dbgInvestorWriteResult', lines);
    lines.forEach(l => dbgLog('  Investor write: ' + l[0], l[1]));
}

async function dbgTestModeRequestWrite() {
    const el = document.getElementById('dbgModeReqResult');
    el.innerHTML = '<span style="color:#7a8bb5;">Running...</span>';
    const lines = [];
    if (!_dbgAllInvestors.length) { dbgResult('dbgModeReqResult',[['⚠ No investor records to test with — add an investor first','warn']]); return; }
    const testId = crypto.randomUUID();
    const invId = _dbgAllInvestors[0].id;
    try {
        const { error: ie } = await sbClient.from('investor_mode_requests').insert([{
            id: testId, investor_id: invId, user_id: currentUser.id,
            current_mode: 'conservative', requested_mode: 'base',
            status: 'pending', message: '__DBG_TEST__'
        }]);
        if (ie) { lines.push(['✗ INSERT failed: '+ie.message,'err']); dbgResult('dbgModeReqResult',lines); return; }
        lines.push(['✓ INSERT ok','ok']);
        const { error: ue } = await sbClient.from('investor_mode_requests').update({status:'approved',admin_reply:'test'}).eq('id',testId);
        lines.push(ue ? ['✗ UPDATE (approve) failed: '+ue.message,'err'] : ['✓ UPDATE (approve) ok','ok']);
        const { error: de } = await sbClient.from('investor_mode_requests').delete().eq('id',testId);
        lines.push(de ? ['✗ DELETE failed: '+de.message,'err'] : ['✓ DELETE ok','ok']);
    } catch(e) { lines.push(['✗ Exception: '+e.message,'err']); }
    dbgResult('dbgModeReqResult', lines);
}

// ═══════════════════════════════════════════════════════
//  7. RLS POLICY TESTS
// ═══════════════════════════════════════════════════════
async function dbgTestRLSPolicies() {
    dbgLog('', 'dim');
    dbgLog('[ RLS POLICY TESTS ]', 'head');
    const results = [];

    // Profiles: can we SELECT own row?
    try {
        const { error } = await sbClient.from('profiles').select('id').eq('id', currentUser.id).single();
        const ok = !error;
        dbgLog((ok ? '✓' : '✗') + ' profiles SELECT own', ok ? 'ok' : 'err');
        results.push([(ok?'✓':'✗') + ' profiles: SELECT own row', ok?'ok':'err']);
    } catch(e) { results.push(['✗ profiles SELECT exception: '+e.message,'err']); }

    // Profiles: can we SELECT all? (admin only)
    try {
        const { data, error } = await sbClient.from('profiles').select('id').limit(5);
        const ok = !error && data;
        dbgLog((ok ? '✓' : '✗') + ' profiles SELECT all (admin policy)', ok ? 'ok' : 'err');
        results.push([(ok?'✓':'✗') + ' profiles: SELECT all (' + (ok?data.length+' rows':'error: '+error?.message) + ')', ok?'ok':'err']);
    } catch(e) { results.push(['✗ profiles SELECT all exception','err']); }

    // Trades: SELECT
    try {
        const { data, error } = await sbClient.from('trades').select('id').eq('user_id', currentUser.id).limit(5);
        const ok = !error;
        dbgLog((ok?'✓':'✗') + ' trades SELECT own', ok?'ok':'err');
        results.push([(ok?'✓':'✗') + ' trades: SELECT own (' + (ok?data?.length+' rows':error?.message) + ')', ok?'ok':'err']);
    } catch(e) { results.push(['✗ trades SELECT exception','err']); }

    // investor_portal_investors: SELECT
    try {
        const { data, error } = await sbClient.from('investor_portal_investors').select('id').limit(5);
        const ok = !error;
        dbgLog((ok?'✓':'✗') + ' investor_portal_investors SELECT', ok?'ok':'err');
        results.push([(ok?'✓':'✗') + ' investor_portal_investors: SELECT (' + (ok?data?.length+' rows':error?.message)+')', ok?'ok':'err']);
    } catch(e) { results.push(['✗ investor_portal_investors SELECT exception','err']); }

    // investor_mode_requests: SELECT
    try {
        const { data, error } = await sbClient.from('investor_mode_requests').select('id').limit(5);
        const ok = !error;
        dbgLog((ok?'✓':'✗') + ' investor_mode_requests SELECT', ok?'ok':'err');
        results.push([(ok?'✓':'✗') + ' investor_mode_requests: SELECT (' + (ok?data?.length+' rows':error?.message)+')', ok?'ok':'err']);
    } catch(e) { results.push(['✗ investor_mode_requests SELECT exception','err']); }

    dbgResult('dbgRLSTests', results);
}

// ═══════════════════════════════════════════════════════
//  QUICK FIXES
// ═══════════════════════════════════════════════════════
async function dbgQuickRole(userId, role, email) {
    if (!confirm('Set role → "' + role + '" for ' + (email||userId.slice(0,8)) + '?')) return;
    const updates = { role };
    if (role === 'investor' || role === 'admin') updates.approved = true;
    if (email && !email.includes('@propfarmpro.app')) updates.email = email;
    const { error } = await sbClient.from('profiles').update(updates).eq('id', userId);
    if (error) { alert('Failed: ' + error.message); return; }
    dbgLog('✓ Role updated: ' + (email||userId.slice(0,8)) + ' → ' + role, 'ok');
    if (typeof showAlert === 'function') showAlert('✓ Role set to ' + role, 'success');
    if (currentUser?.id === userId) { await loadProfile(); updateSidebarRole(); }
    await dbgLoadAllData();
    dbgRenderUsersTable(_dbgAllProfiles);
}

async function dbgApproveOne(userId) {
    const { error } = await sbClient.from('profiles').update({approved:true}).eq('id', userId);
    if (error) { alert('Failed: '+error.message); return; }
    dbgLog('✓ Approved: ' + userId.slice(0,8), 'ok');
    await dbgLoadAllData();
    dbgRenderUsersTable(_dbgAllProfiles);
}

// Fix dropdown search in Quick Fixes tab
async function dbgFixSearchUsers() {
    if (!_dbgAllProfiles.length) await dbgLoadAllData();
    const q = (document.getElementById('dbgFixSearch')?.value||'').toLowerCase().trim();
    const dd = document.getElementById('dbgFixDropdown');
    if (!dd) return;
    if (!q) { dd.style.display='none'; return; }
    const matches = _dbgAllProfiles.filter(p =>
        (p.email||'').toLowerCase().includes(q)||(p.username||'').toLowerCase().includes(q)
    ).slice(0,6);
    if (!matches.length) { dd.style.display='none'; return; }
    dd.style.display='block';
    dd.innerHTML = matches.map(p => {
        const roleColor = p.role==='admin'?'#ffd166':p.role==='investor'?'#9b6ffa':'#7a8bb5';
        return `<div class="dbg-fix-opt" data-uid="${p.id}" data-email="${(p.email||'').replace(/"/g,'&quot;')}" data-name="${(p.username||'').replace(/"/g,'&quot;')}"
            style="padding:0.45rem 0.75rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;border-bottom:1px solid rgba(99,179,237,0.08);">
            <span><strong>${esc(p.username||'(no name)')}</strong> <span style="color:#7a8bb5;font-size:0.72rem;">${esc(p.email||'no email')}</span></span>
            <span style="color:${roleColor};font-size:0.7rem;">${p.role||'user'}</span>
        </div>`;
    }).join('');
    dd.querySelectorAll('.dbg-fix-opt').forEach(el => {
        el.addEventListener('mouseenter', ()=>el.style.background='#1a2035');
        el.addEventListener('mouseleave', ()=>el.style.background='');
        el.addEventListener('click', ()=>{
            _dbgFixSelectedId    = el.dataset.uid;
            _dbgFixSelectedEmail = el.dataset.email;
            _dbgFixSelectedName  = el.dataset.name;
            const disp = document.getElementById('dbgFixSelected');
            if (disp) disp.innerHTML = `<span style="color:#e8f0ff;">✓ <strong>${esc(_dbgFixSelectedName||_dbgFixSelectedEmail)}</strong> <span style="color:#7a8bb5;font-size:0.72rem;">${esc(_dbgFixSelectedEmail)}</span></span>`;
            document.getElementById('dbgFixSearch').value = _dbgFixSelectedName || _dbgFixSelectedEmail;
            dd.style.display='none';
        });
    });
}
document.addEventListener('click', e => {
    const dd = document.getElementById('dbgFixDropdown');
    if (dd && !dd.contains(e.target) && e.target.id !== 'dbgFixSearch') dd.style.display='none';
});

async function dbgApplyRoleFix() {
    const resEl = document.getElementById('dbgFixRoleResult');
    if (!_dbgFixSelectedId) { resEl.innerHTML='<span style="color:#f5a623;">Select a user first</span>'; return; }
    const role = document.getElementById('dbgFixRoleSelect')?.value;
    const updates = { role };
    if (role === 'investor' || role === 'admin') updates.approved = true;
    if (_dbgFixSelectedEmail && !_dbgFixSelectedEmail.includes('@propfarmpro.app')) updates.email = _dbgFixSelectedEmail;
    const { error } = await sbClient.from('profiles').update(updates).eq('id', _dbgFixSelectedId);
    if (error) { resEl.innerHTML='<span style="color:#f05c6a;">✗ '+esc(error.message)+'</span>'; return; }
    resEl.innerHTML='<span style="color:#22d3a0;">✓ Role set to '+role+'</span>';
    dbgLog('✓ Role fix applied: ' + (_dbgFixSelectedEmail||_dbgFixSelectedId.slice(0,8)) + ' → ' + role, 'ok');
    if (typeof showAlert === 'function') showAlert('✓ Role updated to ' + role, 'success');
    if (currentUser?.id === _dbgFixSelectedId) { await loadProfile(); updateSidebarRole(); }
    await dbgLoadAllData(); dbgRenderUsersTable(_dbgAllProfiles);
}

async function dbgSyncEmails() {
    const resEl = document.getElementById('dbgSyncEmailResult');
    resEl.innerHTML = '<span style="color:#7a8bb5;">Syncing...</span>';
    if (!_dbgAllProfiles.length) await dbgLoadAllData();
    const missing = _dbgAllProfiles.filter(p => !p.email || p.email.includes('@propfarmpro.app'));
    const lines = [['Profiles needing sync: ' + missing.length, missing.length > 0 ? 'warn' : 'ok']];
    let synced = 0;
    // Sync current user's own email
    if (currentUser?.email && !currentUser.email.includes('@propfarmpro.app')) {
        const me = missing.find(p => p.id === currentUser.id);
        if (me) {
            const { error } = await sbClient.from('profiles').update({email: currentUser.email}).eq('id', currentUser.id);
            if (!error) { synced++; lines.push(['✓ Synced self: ' + currentUser.email, 'ok']); }
        }
    }
    // Use adminAllProfiles cache (has emails from loadAdminData)
    if (typeof adminAllProfiles !== 'undefined' && adminAllProfiles.length) {
        for (const p of missing) {
            if (p.id === currentUser?.id) continue; // already handled
            const cached = adminAllProfiles.find(a => a.id === p.id);
            if (cached?.email && !cached.email.includes('@propfarmpro.app')) {
                const { error } = await sbClient.from('profiles').update({email: cached.email}).eq('id', p.id);
                if (!error) { synced++; lines.push(['✓ Synced: '+(p.username||p.id.slice(0,8))+' → '+cached.email, 'ok']); }
                else lines.push(['✗ Failed: '+(p.username||p.id.slice(0,8))+' — '+error.message, 'err']);
            }
        }
    }
    const remaining = missing.length - synced;
    lines.push(['Synced: '+synced+' | Could not auto-sync: '+remaining, synced > 0 ? 'ok' : 'warn']);
    if (remaining > 0) lines.push(['Remaining users must log in once to trigger auto-sync', 'warn']);
    dbgResult('dbgSyncEmailResult', lines);
    if (typeof showAlert === 'function') showAlert('✓ Synced ' + synced + ' email(s)', 'success');
    await dbgLoadAllData(); dbgRenderUsersTable(_dbgAllProfiles);
}

async function dbgSyncOneEmail(userId) {
    if (userId === currentUser?.id && currentUser.email && !currentUser.email.includes('@propfarmpro.app')) {
        const { error } = await sbClient.from('profiles').update({email: currentUser.email}).eq('id', userId);
        if (!error) { if (typeof showAlert==='function') showAlert('✓ Email synced!','success'); await dbgLoadAllData(); dbgRenderUsersTable(_dbgAllProfiles); return; }
    }
    const cached = typeof adminAllProfiles !== 'undefined' ? adminAllProfiles.find(p => p.id === userId) : null;
    if (cached?.email && !cached.email.includes('@propfarmpro.app')) {
        const { error } = await sbClient.from('profiles').update({email: cached.email}).eq('id', userId);
        if (!error) { if (typeof showAlert==='function') showAlert('✓ Email synced!','success'); await dbgLoadAllData(); dbgRenderUsersTable(_dbgAllProfiles); return; }
    }
    alert('Cannot auto-sync this email — ask the user to log in once to trigger it automatically.');
}

async function dbgApproveAll() {
    const resEl = document.getElementById('dbgApproveResult');
    resEl.innerHTML = '<span style="color:#7a8bb5;">Approving...</span>';
    if (!_dbgAllProfiles.length) await dbgLoadAllData();
    const pending = _dbgAllProfiles.filter(p => !p.approved && p.role !== 'admin');
    if (!pending.length) { resEl.innerHTML='<span style="color:#22d3a0;">✓ No pending users</span>'; return; }
    const { error } = await sbClient.from('profiles').update({approved:true}).in('id', pending.map(p=>p.id));
    if (error) { resEl.innerHTML='<span style="color:#f05c6a;">✗ '+esc(error.message)+'</span>'; return; }
    resEl.innerHTML='<span style="color:#22d3a0;">✓ Approved '+pending.length+' users</span>';
    dbgLog('✓ Approved all pending: ' + pending.length + ' users', 'ok');
    if (typeof showAlert==='function') showAlert('✓ Approved '+pending.length+' users','success');
    await dbgLoadAllData(); dbgRenderUsersTable(_dbgAllProfiles);
}

async function dbgInspectUser() {
    const q = (document.getElementById('dbgInspectInput')?.value||'').trim();
    const el = document.getElementById('dbgInspectResult');
    if (!q) { el.innerHTML='<span style="color:#f5a623;">Enter email or username</span>'; return; }
    if (!_dbgAllProfiles.length) await dbgLoadAllData();
    const lc = q.toLowerCase();
    const p = _dbgAllProfiles.find(x => (x.email||'').toLowerCase()===lc || (x.username||'').toLowerCase()===lc);
    if (!p) { el.innerHTML='<span style="color:#f05c6a;">User not found: '+esc(q)+'</span>'; return; }
    const tc = _dbgAllTrades.filter(t=>t.user_id===p.id).length;
    const pc = _dbgAllPayouts.filter(t=>t.user_id===p.id).length;
    const inv = _dbgAllInvestors.find(i => (i.email||'').toLowerCase() === (p.email||'').toLowerCase());
    const lines = [
        ['id: '+p.id, 'dim'],
        ['username: '+(p.username||'—'), 'info'],
        ['email: '+(p.email||'⚠ MISSING'), p.email?'ok':'err'],
        ['role: '+(p.role||'—'), 'info'],
        ['approved: '+p.approved, p.approved?'ok':'err'],
        ['onboarded: '+p.onboarded, 'dim'],
        ['account_goal: '+(p.account_goal||'—'), 'dim'],
        ['trades: '+tc, 'dim'],
        ['payouts: '+pc, 'dim'],
        ['investor record: '+(inv ? 'YES — mode='+inv.mode+' acct=#'+inv.linked_account : 'none'), inv?'ok':'dim'],
        ['created: '+(p.created_at?new Date(p.created_at).toLocaleString():'—'), 'dim'],
    ];
    el.innerHTML = lines.map(l=>`<div class="dl-${l[1]}">${esc(l[0])}</div>`).join('');
}

async function dbgRefreshMySession() {
    const el = document.getElementById('dbgRefreshResult');
    await loadProfile();
    updateSidebarRole();
    if (typeof updateAllViews === 'function') updateAllViews();
    el.innerHTML = '<span style="color:#22d3a0;">✓ Session refreshed — role: ' + esc(currentProfile?.role||'—') + '</span>';
    dbgLog('✓ Session refreshed', 'ok');
    if (typeof showAlert==='function') showAlert('✓ Session refreshed','success');
}

async function dbgCleanTestData() {
    const el = document.getElementById('dbgCleanResult');
    let cleaned = 0;
    try {
        const { data: td } = await sbClient.from('trades').delete().eq('notes','__DBG_TEST__').select('id');
        cleaned += (td||[]).length;
        const { data: pd } = await sbClient.from('payouts').delete().eq('payout_type','__DBG_TEST__').select('id');
        cleaned += (pd||[]).length;
        const { data: id } = await sbClient.from('investor_portal_investors').delete().eq('name','__DBG_TEST__').select('id');
        cleaned += (id||[]).length;
        const { data: md } = await sbClient.from('investor_mode_requests').delete().eq('message','__DBG_TEST__').select('id');
        cleaned += (md||[]).length;
        el.innerHTML = '<span style="color:#22d3a0;">✓ Cleaned '+cleaned+' test record(s)</span>';
        dbgLog('✓ Test data cleaned: '+cleaned+' records removed','ok');
    } catch(e) { el.innerHTML='<span style="color:#f05c6a;">✗ '+esc(e.message)+'</span>'; }
}


</script>

<!-- ══════════════════════════════════════════
     THEME SWITCHER
══════════════════════════════════════════ -->
<button id="themeSwitcherBtn" onclick="toggleThemePanel()" title="Change theme">🎨</button>

<div id="themeSwitcherPanel">
    <div class="ts-title">🎨 Choose Theme</div>
    <div class="ts-themes">
        <button class="ts-theme-btn active" data-t="default" onclick="setTheme('default',this)">
            <div class="ts-swatch">
                <span style="background:#3b7ef8;"></span>
                <span style="background:#9b6ffa;"></span>
                <span style="background:#22d3a0;"></span>
            </div>
            <div class="ts-label">Midnight</div>
        </button>
        <button class="ts-theme-btn" data-t="aurora" onclick="setTheme('aurora',this)">
            <div class="ts-swatch">
                <span style="background:#7c3aed;"></span>
                <span style="background:#0284c7;"></span>
                <span style="background:#e0e7ff;"></span>
            </div>
            <div class="ts-label">Aurora</div>
        </button>
        <button class="ts-theme-btn" data-t="cosmic" onclick="setTheme('cosmic',this)">
            <div class="ts-swatch">
                <span style="background:#a855f7;"></span>
                <span style="background:#c084fc;"></span>
                <span style="background:#22d3ee;"></span>
            </div>
            <div class="ts-label">Cosmic</div>
        </button>
        <button class="ts-theme-btn" data-t="ocean" onclick="setTheme('ocean',this)">
            <div class="ts-swatch">
                <span style="background:#0ea5e9;"></span>
                <span style="background:#2dd4bf;"></span>
                <span style="background:#818cf8;"></span>
            </div>
            <div class="ts-label">Ocean</div>
        </button>
        <button class="ts-theme-btn" data-t="ember" onclick="setTheme('ember',this)" style="grid-column:1/-1;">
            <div class="ts-swatch">
                <span style="background:#f97316;"></span>
                <span style="background:#ef4444;"></span>
                <span style="background:#fbbf24;"></span>
            </div>
            <div class="ts-label">Ember</div>
        </button>
    </div>
    <div style="margin-top:0.9rem;padding-top:0.75rem;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:0.62rem;color:var(--text-muted);">Theme saved automatically</span>
        <button onclick="toggleThemePanel()" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:0.75rem;">✕ Close</button>
    </div>
</div>

<script>
// ── Theme Switcher ──
function setTheme(name, btn) {
    document.documentElement.setAttribute('data-theme', name === 'default' ? '' : name);
    localStorage.setItem('mj-theme', name);
    document.querySelectorAll('.ts-theme-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    // Update switcher button glow to match accent
    const style = getComputedStyle(document.documentElement);
    const accent = style.getPropertyValue('--accent').trim();
    document.getElementById('themeSwitcherBtn').style.background = accent || '#3b7ef8';
}

function toggleThemePanel() {
    document.getElementById('themeSwitcherPanel').classList.toggle('open');
}

// Close panel when clicking outside
document.addEventListener('click', function(e) {
    const panel = document.getElementById('themeSwitcherPanel');
    const btn   = document.getElementById('themeSwitcherBtn');
    if (panel && !panel.contains(e.target) && e.target !== btn) {
        panel.classList.remove('open');
    }
});

// Load saved theme on startup
(function() {
    const saved = localStorage.getItem('mj-theme') || 'default';
    document.documentElement.setAttribute('data-theme', saved === 'default' ? '' : saved);
    // Mark active button
    window.addEventListener('DOMContentLoaded', function() {
        const activeBtn = document.querySelector(`.ts-theme-btn[data-t="${saved}"]`);
        if (activeBtn) {
            document.querySelectorAll('.ts-theme-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
        }
    });
})();
</script>
</body>
</html>
